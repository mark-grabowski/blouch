<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Simulation Example from Grabowski (2024) Walkthrough • blouch</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Simulation Example from Grabowski (2024) Walkthrough">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">blouch</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Empirical-Example.html">Empirical Example from Grabowski (2024)</a></li>
    <li><a class="dropdown-item" href="../articles/Simulation-Example.html">Simulation Example from Grabowski (2024)</a></li>
    <li><a class="dropdown-item" href="../articles/Basic_Models-Examples.html">Basic Models</a></li>
    <li><a class="dropdown-item" href="../articles/Multi-optima_Models-Examples.html">Multi-Optima Models</a></li>
    <li><a class="dropdown-item" href="../articles/Varying_Effects_Models-Examples.html">Varying Effects Models</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mark-grabowski/blouch"><span class="fa fa-brands fa-github"></span> Github</a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Simulation Example from Grabowski (2024) Walkthrough</h1>
                        <h4 data-toc-skip class="author">Mark
Grabowski</h4>
            
            <h4 data-toc-skip class="date">2025-10-14</h4>
      

      <div class="d-none name"><code>Simulation-Example.Rmd</code></div>
    </div>

    
    
<p>This is the Simulation Example from Grabowski (in press). In this
example, we will simulate data for a model where Y adapts to four
different optima that are influenced by the predictor trait X, and each
optima has a different scaling relationship with X. Below, data is
simulated following the multi-optima adaptive generative model, and then
<em>Blouch</em> uses the multilevel multi-optima adaptive model with
varying effects (varying intercepts and varying slopes) and the
non-multilevel version of the same model to estimate the known parameter
values.</p>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mark-grabowski.github.io/blouch/">blouch</a></span><span class="op">)</span></span></code></pre></div>
<p><em>Blouch</em> uses RStan to implement Stan. The following code
enables some compiler optimizations to improve the estimation speed of
the model, and is taken from: <a href="https://github.com/stan-dev/rstan/wiki/RStan-Getting-Started" class="external-link uri">https://github.com/stan-dev/rstan/wiki/RStan-Getting-Started</a></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#options(mc.cores = parallel::detectCores())</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>mc.cores <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="co">#2 For R package checks - use line above on your own machine</span></span>
<span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/rstan_options.html" class="external-link">rstan_options</a></span><span class="op">(</span>auto_write <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dotR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"HOME"</span><span class="op">)</span>, <span class="st">".R"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">dotR</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">dotR</span><span class="op">)</span></span>
<span><span class="va">M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dotR</span>, <span class="st">"Makevars"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.create</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span></span>
<span><span class="va">arch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">R.version</span><span class="op">$</span><span class="va">arch</span> <span class="op">==</span> <span class="st">"aarch64"</span>, <span class="st">"arm64"</span>, <span class="st">"x86_64"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"\nCXX14FLAGS += -O3 -mtune=native -arch"</span>, <span class="va">arch</span>, <span class="st">"-ftemplate-depth-256"</span><span class="op">)</span>,</span>
<span>    file <span class="op">=</span> <span class="va">M</span>, sep <span class="op">=</span> <span class="st">"\n"</span>, append <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>The <em>Blouch</em> package includes the primate phylogeny from the
10KTrees Project (Arnold et al. 2010), which is used for various
simulations and comes from <a href="https://10ktrees.nunn-lab.org/" class="external-link uri">https://10ktrees.nunn-lab.org/</a>. This is Version 3 of
their primate phylogeny with 301 tips. Here we randomly reduce the tip
number to 100 for a more manageable tree using functions from the
<em>ape</em> R package (Paradis et al. 2004). Note that the set.seed R
function below is used to make the generated X an Y data repeatable
(i.e. the data generated in R), but this step does not lead to
repeatability for the MCMC sampling. Hence there will be some small
differences between the parameter estimates and published results.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Four regimes with one adaptive trait and multiple slopes per optima but single alpha parameter</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="co">#Set sequence of random numbers for reproducability</span></span>
<span><span class="va">N</span><span class="op">&lt;-</span><span class="fl">100</span> <span class="co">#Number of species</span></span>
<span></span>
<span><span class="va">phy</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/drop.tip.html" class="external-link">keep.tip</a></span><span class="op">(</span><span class="va">tree.10K</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">tree.10K</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">]</span><span class="op">)</span> </span>
<span><span class="va">phy</span><span class="op">&lt;-</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/multi2di.html" class="external-link">multi2di</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span> <span class="co">#Collapse or resolve multichotomies in phylogenetic trees.</span></span>
<span></span>
<span><span class="va">l.tree</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/branching.times.html" class="external-link">branching.times</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span><span class="op">)</span> <span class="co">## Rescale tree to height 1</span></span>
<span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">/</span><span class="va">l.tree</span> </span></code></pre></div>
<p>Lets plot the tree with nodes labeled - these will be where we will
be placing our regime shifts in the next step. We will use nodes 164,
192, and 104, which results in 4 regimes - the shifts+the root
regime.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Set regimes - manually - 4 regimes</span></span>
<span><span class="co">#Locate nodes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">phy</span>,no.margin<span class="op">=</span><span class="cn">TRUE</span>,edge.width<span class="op">=</span><span class="fl">2</span>,cex<span class="op">=</span><span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/nodelabels.html" class="external-link">nodelabels</a></span><span class="op">(</span>frame<span class="op">=</span><span class="st">"none"</span>,adj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.1</span>,<span class="op">-</span><span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/nodelabels.html" class="external-link">tiplabels</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Simulation-Example_files/figure-html/Explore_nodes-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="combine-data-and-tree-and-paint-regimes-on-tree-">Combine data and tree and paint regimes on tree.<a class="anchor" aria-label="anchor" href="#combine-data-and-tree-and-paint-regimes-on-tree-"></a>
</h2>
<p>Next we will use the <em>treeplyr</em> package (Uyeda and Harmon,
2014) make.treedata function to combine the data and tree based on the
taxa names. See <a href="https://github.com/uyedaj/treeplyr" class="external-link uri">https://github.com/uyedaj/treeplyr</a> for more on this
package. This step is basically to make a dummy trdata object containing
the tree and a blank “dat” dataset object.</p>
<p>Then we will place the regime shifts on the tree that were identified
earlier using <em>Blouch’s</em> set.converge.regimes R function. This
function also produces a plot of the tree with the colored regimes. In
addition, we will manually plot the tree with the shifts colored to make
sure we have done everything correctly.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu">treeplyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/treeplyr/man/make.treedata.html" class="external-link">make.treedata</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">trdata</span><span class="op">)</span></span>
<span></span>
<span><span class="va">shifts</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">164</span>,<span class="fl">192</span>,<span class="fl">104</span><span class="op">)</span> <span class="co">#Location of nodes with regime shifts #100 species</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/set.converge.regimes.html">set.converge.regimes</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="va">shifts</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="co">#&gt;   [1] OU1 OU1 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4</span></span>
<span><span class="co">#&gt;  [19] OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4</span></span>
<span><span class="co">#&gt;  [37] OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4</span></span>
<span><span class="co">#&gt;  [55] OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4</span></span>
<span><span class="co">#&gt;  [73] OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU4 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt;  [91] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [109] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2</span></span>
<span><span class="co">#&gt; [127] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span><span class="co">#&gt; [145] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span><span class="co">#&gt; [163] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span><span class="co">#&gt; [181] OU2 OU3 OU3 OU3 OU3 OU3 OU3 OU3 OU3 OU3 OU3 OU3 OU3 OU3 OU3 OU3 OU3 OU3</span></span>
<span><span class="co">#&gt; Levels: OU1 OU2 OU3 OU4</span></span>
<span><span class="co">#&gt; [1] "#E64B35FF" "#4DBBD5FF" "#00A087FF" "#3C5488FF"</span></span></code></pre></div>
<p><img src="Simulation-Example_files/figure-html/Set_regimes-1.png" width="700"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="co">#Check if code worked</span></span>
<span><span class="va">shifts.total</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span>,<span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">node.label</span><span class="op">)</span></span>
<span><span class="va">edge.regimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">shifts.total</span><span class="op">[</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">edge</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">reg.colors</span><span class="op">&lt;-</span><span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/pal_npg.html" class="external-link">pal_npg</a></span><span class="op">(</span>palette<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"nrc"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">reg.colors</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "#E64B35FF" "#4DBBD5FF" "#00A087FF" "#3C5488FF"</span></span>
<span><span class="co">#plot(trdata$phy,edge.color = reg.colors[edge.regimes], edge.width = 1,show.tip.label=FALSE)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>,edge.color <span class="op">=</span> <span class="va">reg.colors</span><span class="op">[</span><span class="va">edge.regimes</span><span class="op">]</span>, edge.width <span class="op">=</span> <span class="fl">1</span>,show.tip.label<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="Simulation-Example_files/figure-html/Set_regimes-2.png" width="700"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#FigS1a.plot&lt;-recordPlot()</span></span>
<span></span>
<span><span class="co">#pdf("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch Project - SBR2/Blouch ms/R2/Figures/FigS1a.pdf", width=5, height=7 )</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>,edge.color <span class="op">=</span> <span class="va">reg.colors</span><span class="op">[</span><span class="va">edge.regimes</span><span class="op">]</span>, edge.width <span class="op">=</span> <span class="fl">1</span>,show.tip.label<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#dev.off()</span></span>
<span></span>
<span><span class="va">reg_tips</span><span class="op">&lt;-</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span></span>
<span><span class="va">reg_tips</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">reg_tips</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="get-info-on-phylogeny">Get info on phylogeny<a class="anchor" aria-label="anchor" href="#get-info-on-phylogeny"></a>
</h2>
<p>Next we will build a regimes object that will include both internal
node and tip regimes, and use <em>Blouch’s</em> lineage.constructor R
function to trace lineages from the tips to the root and determine the
regime at each node - this R function is built into <em>Blouch</em> and
it uses it internally given an empirical dataset, but here we use the
function as part of our data simulation.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">regimes_internal</span> <span class="op">&lt;-</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">node.label</span> <span class="co">#Get internal regimes at nodes</span></span>
<span><span class="va">regimes_tip</span> <span class="op">&lt;-</span> <span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span> <span class="co">#Get regimes at tips</span></span>
<span><span class="va">regimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/concat.factor.html">concat.factor</a></span><span class="op">(</span><span class="va">regimes_tip</span>, <span class="va">regimes_internal</span><span class="op">)</span> <span class="co">#Combine these into a list</span></span>
<span><span class="va">anc_maps</span><span class="op">&lt;-</span><span class="st">"regimes"</span> <span class="co">#Type of regime placement - currently only at nodes</span></span>
<span><span class="va">lineages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span>, <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="fu"><a href="../reference/lineage.constructor.html">lineage.constructor</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>, <span class="va">e</span>, <span class="va">anc_maps</span>, <span class="va">regimes</span><span class="op">)</span><span class="op">)</span> <span class="co">#Trace lineage from tips (n) to root and determine regimes of each node or branch</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="set-trueknown-parameter-values">Set true/known parameter values<a class="anchor" aria-label="anchor" href="#set-trueknown-parameter-values"></a>
</h2>
<p>Next we set our true/known parameter values. These are for the
half-life (hl), and stationary variance (vy), which in our simulation we
translate to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
(a) and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msubsup><mi>σ</mi><mi>y</mi><mn>2</mn></msubsup><annotation encoding="application/x-tex">\sigma^2_y</annotation></semantics></math>
(sigma2_y). We set the ancestral value at the root (vX0) to 0, and the
instantaneous variance of the BM process (Sxx) to to 10.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hl</span><span class="op">&lt;-</span><span class="fl">0.1</span> <span class="co">#Half life</span></span>
<span><span class="va">a</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span> <span class="co">#hl expressed as alpha parameter</span></span>
<span><span class="va">vy</span><span class="op">&lt;-</span><span class="fl">0.01</span> <span class="co">#Stationary Variance</span></span>
<span><span class="va">sigma2_y</span><span class="op">&lt;-</span><span class="va">vy</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span><span class="op">)</span><span class="op">)</span>; <span class="co">#Vy expressed as random fluctuations of Y</span></span>
<span></span>
<span><span class="va">vX0</span><span class="op">&lt;-</span><span class="fl">0</span> <span class="co">#Ancestral value at root</span></span>
<span><span class="va">sigma2_x</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span> <span class="co">#Variance of BM Process</span></span>
<span><span class="co">#Sxx&lt;-10</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="simulate-x-data">Simulate X data<a class="anchor" aria-label="anchor" href="#simulate-x-data"></a>
</h2>
<p>We first simulate the X data following a Brownian-Motion Process
using the fastBM function from the phytools package (Revell 2011) and
the parameter values set above. We then plot the values using the
phenogram function from the same package to make sure things look as
they should.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#X&lt;-phytools::fastBM(phy,a=vX0,sig2=sigma2_x[1,1],internal=FALSE) #Simulate X BM variable on tree, with BM scaling 10</span></span>
<span><span class="va">X</span><span class="op">&lt;-</span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/fastBM.html" class="external-link">fastBM</a></span><span class="op">(</span><span class="va">phy</span>,a<span class="op">=</span><span class="va">vX0</span>,sig2<span class="op">=</span><span class="va">sigma2_x</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>,internal<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="co">#Simulate X BM variable on tree, with BM scaling 10</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span></span>
<span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/phenogram.html" class="external-link">phenogram</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">X</span>,spread.labels<span class="op">=</span><span class="cn">TRUE</span>,spread.cost<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="co">#Plot X data</span></span>
<span><span class="co">#&gt; Optimizing the positions of the tip labels...</span></span></code></pre></div>
<p><img src="Simulation-Example_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="simulate-y-data">Simulate Y data<a class="anchor" aria-label="anchor" href="#simulate-y-data"></a>
</h2>
<p>Next we need to simulate the Y data - we are using four different
optima (intercepts) with four different slopes. We use the R function
weight.matrix, which <em>Blouch</em> includes to produce the
optima_matrix object, which has the weighting for each lineage based on
the amount of time spent in each regime (see Hansen 1997 for
derivation). This is followed by using the R function calc_adaptive_dmX
from <em>Blouch</em>, which calculates the design matrix where the
observed predictor X variables for each species are multiplied by the
the phylogenetic correction factor, following Hansen et al. (2008), and
these values are stored in the object pred_X.</p>
<p>We set values for our optima/intercepts (optima) and slopes (beta),
and then use a linear model to construct a deterministic relationship
between our set parameter values and mu, a vector of mean values for
each species in our analysis.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">optima_matrix</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/weight.matrix.html">weight.matrix</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>, <span class="va">a</span>, <span class="va">lineages</span><span class="op">)</span> <span class="co">#Calculate optima/intercepts matrix</span></span>
<span><span class="va">pred_X</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/calc_adaptive_dmX.html">calc_adaptive_dmX</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">a</span>,<span class="va">X</span><span class="op">)</span> <span class="co">#Calculate design matrix</span></span>
<span></span>
<span><span class="va">optima</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span><span class="op">)</span> <span class="co">#Simulated optima/intercepts</span></span>
<span><span class="va">beta</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.75</span>,<span class="fl">0.5</span>,<span class="fl">0.35</span>,<span class="fl">0.25</span><span class="op">)</span> <span class="co">#Simulated slopes</span></span>
<span></span>
<span><span class="va">mu</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="va">N</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span> <span class="co">#Generative function to produce average Y values for each combination of optima/intercepts and slopes following Blouch approach</span></span>
<span>  <span class="va">mu</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="va">optima_matrix</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">optima</span><span class="op">+</span><span class="va">beta</span><span class="op">[</span><span class="va">reg_tips</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">pred_X</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="calculating-v">Calculating V<a class="anchor" aria-label="anchor" href="#calculating-v"></a>
</h2>
<p>From there we will construct a variance/covariance matrix (V) based
on our previously set parameter values and the <em>Blouch</em> R
function calc_adaptive_V, following Hansen et al. (2008). Finally we
sill simulate Y values based on our mean vector mu and our covariance
matrix V.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_reg</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">regimes</span><span class="op">)</span><span class="op">)</span> <span class="co">#Count number of regimes</span></span>
<span><span class="va">Z_adaptive</span><span class="op">&lt;-</span><span class="fl">1</span> <span class="co">#Number of adaptive X traits</span></span>
<span><span class="va">V</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/calc_adaptive_V.html">calc_adaptive_V</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">a</span>, <span class="va">sigma2_y</span>,  <span class="va">beta</span>,  <span class="va">sigma2_x</span>, <span class="va">Z_adaptive</span><span class="op">)</span> <span class="co">#Calculate V based on set values</span></span>
<span><span class="va">Y</span><span class="op">&lt;-</span><span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1</span>,<span class="va">mu</span>,<span class="va">V</span><span class="op">)</span> <span class="co">#Simulate Y variables centered on mu with covariariance matrix V </span></span></code></pre></div>
<p>Let’s make a simple plot of data, and look at a simple ordinary least
squares regression of Y on X. The intercept and slope values will give
us an idea of how to center our priors below.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">Y</span>,X<span class="op">=</span><span class="va">X</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">X</span>,y<span class="op">=</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Simulation-Example_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">X</span>,<span class="va">df</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = Y ~ X, data = df)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co">#&gt; -2.6787 -0.9310 -0.2816  1.1371  1.7977 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)   2.8006     0.1254  22.339   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; X             0.1544     0.1101   1.402    0.164    </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 1.1 on 98 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.01966,    Adjusted R-squared:  0.009659 </span></span>
<span><span class="co">#&gt; F-statistic: 1.966 on 1 and 98 DF,  p-value: 0.1641</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="simulating-measurement-error">Simulating measurement error<a class="anchor" aria-label="anchor" href="#simulating-measurement-error"></a>
</h2>
<p>Next we will simulate measurement error - we will use a standard
deviation of measurement error of 0.01, which we will provide to
<em>Blouch</em> as a vector (X_error and Y_error), and use the rnorm
function to add error to our X and Y variables. In other words, we are
telling <em>Blouch</em> that the estimated error on X and Y is 0.01, and
providing it with X and Y variables that are offset by a random amount
of error with this standard deviation.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Simulate errors</span></span>
<span><span class="va">Z_X_error</span><span class="op">&lt;-</span><span class="fl">1</span> <span class="co">#Number of X traits with error</span></span>
<span><span class="va">X_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0.01</span>,nrow<span class="op">=</span><span class="va">N</span>,ncol<span class="op">=</span><span class="va">Z_X_error</span><span class="op">)</span></span>
<span><span class="va">X_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">X_error</span><span class="op">)</span></span>
<span><span class="va">Y_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Y_with_error</span><span class="op">&lt;-</span><span class="va">Y</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span> <span class="co">#Add ME to Y</span></span>
<span><span class="va">X_with_error</span><span class="op">&lt;-</span><span class="va">X</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span> <span class="co">#Add ME to X</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data-setup-for-blouch">Data setup for <em>Blouch</em><a class="anchor" aria-label="anchor" href="#data-setup-for-blouch"></a>
</h2>
<p>The line below combines the existing trdata file from make.trdata
which has regime info for the tips with the X and Y values and their
errors.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Make trdata file</span></span>
<span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span>,<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Y_with_error</span>,<span class="va">Y_error</span>,<span class="va">X_with_error</span>,<span class="va">X_error</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>                                               </span></code></pre></div>
<p>First we will run the multilevel multi-optima adaptive model with
varying effects. This will allow our intercepts (optima) and slopes to
vary with the regimes. As a multilevel model, information can be shared
across the regimes, which can produce more accurate parameter
estimates.</p>
<p>Below are the priors used for this simulation. See Grabowski (in
press) for more on setting these priors. To change these values requires
you to open the Stan function, in this case blouchOU_reg_adapt_mlm_ve,
and manually edit them. Unfortunately there is no way around this at
present, but trust me - it will be worth</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Set Priors</span></span>
<span><span class="va">hl.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span>,<span class="fl">0.75</span><span class="op">)</span></span>
<span><span class="va">vy.prior</span><span class="op">&lt;-</span><span class="fl">20</span></span>
<span><span class="va">optima.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2.8</span>,<span class="fl">1</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span>
<span><span class="va">beta.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.16</span>,<span class="fl">0.25</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span>
<span><span class="va">sigma.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="exploring-priors">Exploring Priors<a class="anchor" aria-label="anchor" href="#exploring-priors"></a>
</h2>
<p>At this point one would want to explore if the priors are appropriate
- do the prior distributions look consistent with what we know about our
system? See Grabowski (in press) for more on setting priors.</p>
<p>Half-life Prior plot</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hl.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1000</span>,meanlog<span class="op">=</span><span class="va">hl.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,sdlog<span class="op">=</span><span class="va">hl.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"prior.hl.sims"</span></span>
<span></span>
<span><span class="va">hl.prior.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.hl.sims</span>,fill<span class="op">=</span><span class="st">"prior.hl.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#labs(title="Prior vs. Posterior Distribution ",x="Half-life", y = "Density")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"Half-life"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#scale_fill_manual(labels=c("Posterior","Prior"))+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">hl</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hl.prior.plot</span></span></code></pre></div>
<p><img src="Simulation-Example_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>Vy Prior Plot</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vy.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1000</span>,rate<span class="op">=</span><span class="va">vy.prior</span><span class="op">)</span></span>
<span><span class="va">vy.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">vy.sims</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vy.sims</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"prior.vy.sims"</span></span>
<span></span>
<span><span class="va">vy.prior.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.vy.sims</span>,fill<span class="op">=</span><span class="st">"prior.vy.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">vy.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#labs(title="Prior vs. Posterior Distribution ",x="vy", y = "Density")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"vy"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">vy</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#scale_fill_manual(labels=c("Posterior","Prior"))+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">vy.prior.plot</span></span></code></pre></div>
<p><img src="Simulation-Example_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">beta.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1000</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">a.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl.sims</span></span>
<span><span class="va">sigma2_y.sims</span><span class="op">&lt;-</span><span class="va">vy.sims</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mypal</span> <span class="op">&lt;-</span> <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/pal_npg.html" class="external-link">pal_npg</a></span><span class="op">(</span><span class="st">"nrc"</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,by<span class="op">=</span><span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">p</span><span class="op">&lt;-</span><span class="va">p</span><span class="op">+</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html" class="external-link">stat_function</a></span><span class="op">(</span>fun<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span>,<span class="va">i</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="../reference/calc_adaptive_cov_plot.html">calc_adaptive_cov_plot</a></span><span class="op">(</span><span class="va">a.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,<span class="va">sigma2_y.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,<span class="va">beta.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,<span class="va">x</span><span class="op">)</span><span class="op">}</span>,</span>
<span>                              args<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>i<span class="op">=</span><span class="va">i</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,lwd<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">p</span><span class="op">&lt;-</span><span class="va">p</span><span class="op">+</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"Time Since MRCA"</span>, y <span class="op">=</span> <span class="st">"Covariance"</span><span class="op">)</span></span>
<span><span class="va">p</span></span></code></pre></div>
<p><img src="Simulation-Example_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="exploring-priors-1">Exploring Priors<a class="anchor" aria-label="anchor" href="#exploring-priors-1"></a>
</h2>
<p>Lets check out our simulated data with reasonable values for the
priors shown in light grey lines. These are the “.sims” values - the
priors are based on the intercept and slope of the OLS regression above,
with standard deviations set by visualizing the priors versus the data.
See Grabowski (in press) for more on setting these priors.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">optima.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">beta.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">100</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">Y_with_error</span>,X<span class="op">=</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">X_with_error</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prior.slope.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>  </span>
<span> <span class="fu">ggplot2</span><span class="fu">::</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">Y</span>,x<span class="op">=</span><span class="va">X</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima.sims</span>,slope<span class="op">=</span><span class="va">beta.sims</span>,alpha<span class="op">=</span><span class="fl">0.15</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Adaptive X"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prior.slope.plot</span></span></code></pre></div>
<p><img src="Simulation-Example_files/figure-html/Exploring_priors-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="explore-priors---built-in-functions">Explore Priors - built in functions<a class="anchor" aria-label="anchor" href="#explore-priors---built-in-functions"></a>
</h2>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/hl.prior.plot.code.html">hl.prior.plot.code</a></span><span class="op">(</span><span class="va">hl.prior</span><span class="op">)</span></span></code></pre></div>
<p><img src="Simulation-Example_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vy.prior.plot.code.html">vy.prior.plot.code</a></span><span class="op">(</span><span class="va">vy.prior</span><span class="op">)</span></span></code></pre></div>
<p><img src="Simulation-Example_files/figure-html/unnamed-chunk-10-2.png" width="700"></p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/covariance.prior.direct.plot.code.html">covariance.prior.direct.plot.code</a></span><span class="op">(</span><span class="va">hl.prior</span>,<span class="va">vy.prior</span><span class="op">)</span></span></code></pre></div>
<p><img src="Simulation-Example_files/figure-html/unnamed-chunk-10-3.png" width="700"></p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/reg.adapt.prior.plot.code.html">reg.adapt.prior.plot.code</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="va">optima.prior</span>,<span class="va">beta.prior</span><span class="op">)</span></span></code></pre></div>
<p><img src="Simulation-Example_files/figure-html/unnamed-chunk-10-4.png" width="700"></p>
<p>We will use the helper function blouch.reg.adapt.prep() to setup the
dat object for Stan. This function and the other helper functions
included with <em>Blouch</em> require trdata files, and then the names
of the columns that contain Y and (sometimes depending on the model) X
data and error data. “Z_adaptive” is the number of predictors, with
“regimes” the name of the column where the tip regime data is located.
See help info for each function and other articles on github.com for
functionality.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/blouch.reg.adapt.mlm.prep.html">blouch.reg.adapt.mlm.prep</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="st">"Y_with_error"</span>,<span class="st">"Y_error"</span>,<span class="st">"X_with_error"</span>,<span class="st">"X_error"</span>,Z_adaptive<span class="op">=</span><span class="fl">1</span>,<span class="st">"regimes"</span>,<span class="va">hl.prior</span>,<span class="va">vy.prior</span>,<span class="va">optima.prior</span>,<span class="va">beta.prior</span>,<span class="va">sigma.prior</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="running-models">Running models<a class="anchor" aria-label="anchor" href="#running-models"></a>
</h2>
<p>Now let’s run the multi-level multi-optima adaptive model with
varying effects (blouchOU_reg_adapt_mlm_ve below).</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.adapt.mlm.ve</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span><span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_adapt_mlm_ve</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores<span class="op">=</span><span class="fl">2</span>,iter <span class="op">=</span><span class="fl">4000</span>, control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: There were 1 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span></code></pre></div>
<p>Stan prints out a lot of info, so lets just look at the parameter
estimates here and store the posterior distribution for later use. In a
real analysis we would explore the posterior distributions before
fitting additional models, but I have done so previously.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.adapt.mlm.ve</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima_bar"</span>,<span class="st">"beta_bar"</span>,<span class="st">"Rho[1,2]"</span>,<span class="st">"sigma"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_adapt_mlm_ve.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=4000; warmup=2000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=2000, total post-warmup draws=4000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;              mean se_mean   sd  2.5%   25%   50%   75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl           0.10    0.00 0.05  0.04  0.07  0.08  0.11  0.22  1386    1</span></span>
<span><span class="co">#&gt; vy           0.01    0.00 0.01  0.00  0.00  0.01  0.01  0.02  4968    1</span></span>
<span><span class="co">#&gt; optima_bar   2.56    0.01 0.53  1.49  2.21  2.55  2.89  3.62  4835    1</span></span>
<span><span class="co">#&gt; beta_bar[1]  0.32    0.00 0.16 -0.05  0.23  0.34  0.43  0.59  3225    1</span></span>
<span><span class="co">#&gt; Rho[1,2]    -0.30    0.01 0.35 -0.86 -0.59 -0.35 -0.06  0.45  3045    1</span></span>
<span><span class="co">#&gt; sigma[1]     1.27    0.01 0.39  0.70  0.98  1.20  1.47  2.20  4809    1</span></span>
<span><span class="co">#&gt; sigma[2]     0.39    0.01 0.24  0.12  0.23  0.33  0.49  1.06  2343    1</span></span>
<span><span class="co">#&gt; optima[1]    1.04    0.00 0.12  0.80  0.96  1.03  1.11  1.28  4429    1</span></span>
<span><span class="co">#&gt; optima[2]    1.87    0.00 0.12  1.63  1.79  1.87  1.95  2.14  4665    1</span></span>
<span><span class="co">#&gt; optima[3]    2.66    0.01 0.28  2.08  2.48  2.67  2.85  3.17  2787    1</span></span>
<span><span class="co">#&gt; optima[4]    3.99    0.00 0.17  3.75  3.89  3.97  4.05  4.39  1579    1</span></span>
<span><span class="co">#&gt; beta[1,1]    0.73    0.00 0.07  0.59  0.69  0.73  0.78  0.88  3951    1</span></span>
<span><span class="co">#&gt; beta[2,1]    0.47    0.00 0.08  0.31  0.42  0.47  0.52  0.63  5855    1</span></span>
<span><span class="co">#&gt; beta[3,1]    0.13    0.00 0.20 -0.28  0.00  0.15  0.28  0.48  2433    1</span></span>
<span><span class="co">#&gt; beta[4,1]    0.27    0.00 0.06  0.16  0.23  0.27  0.31  0.40  4297    1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Tue Oct 14 21:37:44 2025.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span></span>
<span><span class="va">post.mlm.ve</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.adapt.mlm.ve</span><span class="op">)</span> <span class="co">#Extract posterior distribution </span></span></code></pre></div>
<p>Now let’s run the non-multilevel version of the same model. We will
compare these models in terms of their predictive performance below. The
priors are the same but without the prior on sigma.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Set Priors</span></span>
<span><span class="va">hl.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span>,<span class="fl">0.75</span><span class="op">)</span></span>
<span><span class="va">vy.prior</span><span class="op">&lt;-</span><span class="fl">20</span></span>
<span><span class="va">optima.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2.8</span>,<span class="fl">1</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span>
<span><span class="va">beta.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.16</span>,<span class="fl">0.25</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span></code></pre></div>
<p>And a slightly different (non-mlm) helper function</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/blouch.reg.adapt.prep.html">blouch.reg.adapt.prep</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="st">"Y_with_error"</span>,<span class="st">"Y_error"</span>,<span class="st">"X_with_error"</span>,<span class="st">"X_error"</span>,Z_adaptive<span class="op">=</span><span class="fl">1</span>,<span class="st">"regimes"</span>,<span class="va">hl.prior</span>,<span class="va">vy.prior</span>,<span class="va">optima.prior</span>,<span class="va">beta.prior</span><span class="op">)</span></span></code></pre></div>
<p>Run the model</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.adapt.ve</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span><span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_adapt_ve</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores<span class="op">=</span><span class="fl">2</span>,iter <span class="op">=</span><span class="fl">4000</span>, control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Again we can also compare a few of the parameter estimates with the
values we set earlier.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.adapt.ve</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_adapt_ve.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=4000; warmup=2000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=2000, total post-warmup draws=4000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd  2.5%   25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.09       0 0.04  0.04  0.07 0.08 0.11  0.19  1779    1</span></span>
<span><span class="co">#&gt; vy        0.01       0 0.01  0.00  0.00 0.01 0.01  0.03  5293    1</span></span>
<span><span class="co">#&gt; optima[1] 1.05       0 0.11  0.84  0.98 1.05 1.12  1.29  5447    1</span></span>
<span><span class="co">#&gt; optima[2] 1.89       0 0.12  1.66  1.81 1.88 1.96  2.12  5498    1</span></span>
<span><span class="co">#&gt; optima[3] 2.59       0 0.25  2.10  2.43 2.59 2.75  3.07  5553    1</span></span>
<span><span class="co">#&gt; optima[4] 3.98       0 0.13  3.76  3.90 3.97 4.05  4.27  3239    1</span></span>
<span><span class="co">#&gt; beta[1,1] 0.72       0 0.07  0.59  0.67 0.72 0.76  0.84  5668    1</span></span>
<span><span class="co">#&gt; beta[2,1] 0.45       0 0.08  0.30  0.39 0.45 0.50  0.60  7130    1</span></span>
<span><span class="co">#&gt; beta[3,1] 0.08       0 0.17 -0.26 -0.03 0.08 0.20  0.43  5168    1</span></span>
<span><span class="co">#&gt; beta[4,1] 0.26       0 0.06  0.16  0.23 0.26 0.30  0.38  5485    1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Tue Oct 14 21:48:15 2025.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="va">post.ve</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.adapt.ve</span><span class="op">)</span><span class="co">#Extract posterior distribution </span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="plotting-posterior-versus-prior-distributions">Plotting posterior versus prior distributions<a class="anchor" aria-label="anchor" href="#plotting-posterior-versus-prior-distributions"></a>
</h2>
<p>Great. We can see from the marginal likelihood tables that
<em>Blouch</em> is fairly accurate at recovering our known parameter
values. But a more effective way to look at the full estimated posterior
distribution and compare it to the prior is to plot the results.</p>
<p>Lets use the non-multi-optima adaptive model with varying effects -
the other model’s posteriors looks quite similar. For all plots the
dotted line is the true values of the parameter.</p>
<p>First the half-life (hl):</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post</span><span class="op">&lt;-</span><span class="va">post.ve</span></span>
<span><span class="co">#post&lt;-post.mlm.ve</span></span>
<span><span class="va">mypal</span> <span class="op">&lt;-</span> <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/pal_npg.html" class="external-link">pal_npg</a></span><span class="op">(</span><span class="st">"nrc"</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">mypal</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/grDevices/palette.html" class="external-link">palette</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="va">hl.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1000</span>,meanlog<span class="op">=</span><span class="va">hl.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,sdlog<span class="op">=</span><span class="va">hl.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"prior.hl.sims"</span></span>
<span></span>
<span><span class="va">hl.post</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">hl</span><span class="op">)</span> <span class="co">#Using this model's posterior</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">hl.post</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"post.hl.sims"</span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">hl.sims</span>,<span class="va">hl.post</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hl.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.hl.sims</span>, fill<span class="op">=</span><span class="va">mypal</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">post.hl.sims</span>, fill<span class="op">=</span><span class="va">mypal</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"Half-life"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">hl</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="co">#ggsci::scale_fill_npg(name="",labels=c("Posterior","Prior"))</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="va">mypal</span>,name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Posterior"</span>,<span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hl.plot</span></span></code></pre></div>
<p><img src="Simulation-Example_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<p>Now the stationary variance parameter (Vy):</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vy.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1000</span>,rate<span class="op">=</span><span class="va">vy.prior</span><span class="op">)</span></span>
<span><span class="va">vy.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">vy.sims</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vy.sims</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"prior.vy.sims"</span></span>
<span></span>
<span><span class="va">vy.post</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">vy</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vy.post</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"post.vy.sims"</span></span>
<span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">vy.sims</span>,<span class="va">vy.post</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vy.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.vy.sims</span>, fill<span class="op">=</span><span class="va">mypal</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">post.vy.sims</span>, fill<span class="op">=</span><span class="va">mypal</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"Vy"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">vy</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="co">#ggsci::scale_fill_npg(name="",labels=c("Posterior","Prior"))</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="va">mypal</span>,name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Posterior"</span>,<span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vy.plot</span></span></code></pre></div>
<p><img src="Simulation-Example_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<p>Now lets plot the covariance as a function of distance from the tips
- this gives an idea of the decay of covariance in the OU process. We
will use <em>Blouch</em>’s R helper function,
calc_multiadaptive_cov_plot.R to make these plots, which calculates the
expected covariance for an adaptive model given values of alpha,
sigma2_y, beta, and x, which is a sequence of values across the X
axis.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hl.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1000</span>,meanlog<span class="op">=</span><span class="va">hl.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,sdlog<span class="op">=</span><span class="va">hl.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">vy.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1000</span>,rate<span class="op">=</span><span class="va">vy.prior</span><span class="op">)</span></span>
<span><span class="va">beta.cov.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1000</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">a.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl.sims</span></span>
<span><span class="va">sigma2_y.sims</span><span class="op">&lt;-</span><span class="va">vy.sims</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#mypal &lt;- ggsci::pal_npg("nrc", alpha = 0.4)(2)</span></span>
<span></span>
<span><span class="va">x</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,by<span class="op">=</span><span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="va">covariance.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">covariance.plot</span><span class="op">&lt;-</span><span class="va">covariance.plot</span><span class="op">+</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html" class="external-link">stat_function</a></span><span class="op">(</span>fun<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span>,<span class="va">i</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="../reference/calc_adaptive_cov_plot.html">calc_adaptive_cov_plot</a></span><span class="op">(</span><span class="va">a.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,<span class="va">sigma2_y.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,<span class="va">beta.cov.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,<span class="va">x</span><span class="op">)</span><span class="op">}</span>,</span>
<span>                              args<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>i<span class="op">=</span><span class="va">i</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,lwd<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">covariance.plot</span><span class="op">&lt;-</span><span class="va">covariance.plot</span><span class="op">+</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html" class="external-link">stat_function</a></span><span class="op">(</span>fun<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span>,<span class="va">i</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="../reference/calc_adaptive_cov_plot.html">calc_adaptive_cov_plot</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">a</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="va">post</span><span class="op">$</span><span class="va">sigma2_y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="va">post</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="va">x</span><span class="op">)</span><span class="op">}</span>,</span>
<span>                              args<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>i<span class="op">=</span><span class="va">i</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,color<span class="op">=</span><span class="va">mypal</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,lwd<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">covariance.plot</span><span class="op">&lt;-</span><span class="va">covariance.plot</span><span class="op">+</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"Time Since MRCA"</span>, y <span class="op">=</span> <span class="st">"Covariance"</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="va">mypal</span>,name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Posterior"</span>,<span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">covariance.plot</span></span></code></pre></div>
<p><img src="Simulation-Example_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
<p>Finally lets plot the regression results - the posterior compared to
the prior and the true values (dotted lines).</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">optima.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">beta.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">100</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">optima.post</span><span class="op">&lt;-</span><span class="va">post</span><span class="op">$</span><span class="va">optima</span></span>
<span><span class="va">beta.post</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">beta</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">beta.post</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"post.beta.1"</span>,<span class="st">"post.beta.2"</span>,<span class="st">"post.beta.3"</span>,<span class="st">"post.beta.4"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">mu.link.11</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x.seq</span><span class="op">)</span><span class="op">{</span><span class="va">optima.post</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">+</span><span class="va">x.seq</span><span class="op">*</span><span class="va">beta.post</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">}</span></span>
<span><span class="va">mu.link.12</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x.seq</span><span class="op">)</span><span class="op">{</span><span class="va">optima.post</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">+</span><span class="va">x.seq</span><span class="op">*</span><span class="va">beta.post</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">}</span></span>
<span></span>
<span><span class="va">mu.link.21</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x.seq</span><span class="op">)</span><span class="op">{</span><span class="va">optima.post</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">+</span><span class="va">x.seq</span><span class="op">*</span><span class="va">beta.post</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">}</span></span>
<span><span class="va">mu.link.22</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x.seq</span><span class="op">)</span><span class="op">{</span><span class="va">optima.post</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span><span class="op">+</span><span class="va">x.seq</span><span class="op">*</span><span class="va">beta.post</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span><span class="op">}</span></span>
<span></span>
<span><span class="va">x.seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, to<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> , length.out<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">mu.11</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">x.seq</span> , <span class="va">mu.link.11</span> <span class="op">)</span></span>
<span><span class="va">mu.12</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">x.seq</span> , <span class="va">mu.link.12</span> <span class="op">)</span></span>
<span><span class="va">mu.21</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">x.seq</span> , <span class="va">mu.link.21</span> <span class="op">)</span></span>
<span><span class="va">mu.22</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">x.seq</span> , <span class="va">mu.link.22</span> <span class="op">)</span></span>
<span></span>
<span><span class="va">mu.mean.11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">mu.11</span><span class="op">)</span></span>
<span><span class="va">mu.mean.12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">mu.12</span><span class="op">)</span></span>
<span><span class="va">mu.mean.21</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">mu.21</span><span class="op">)</span></span>
<span><span class="va">mu.mean.22</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">mu.22</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mu.mean.11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mu.mean.11</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mu.mean.12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mu.mean.12</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.mean.11</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"mu.mean.11"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.mean.12</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"mu.mean.12"</span></span>
<span></span>
<span><span class="va">mu.mean.21</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mu.mean.21</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mu.mean.22</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mu.mean.22</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.mean.21</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"mu.mean.21"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.mean.22</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"mu.mean.22"</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="va">mu.CI.11</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span> <span class="va">mu.11</span> , MARGIN<span class="op">=</span><span class="fl">2</span>, FUN<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/rethinking/man/HPDI.html" class="external-link">PI</a></span> , prob<span class="op">=</span><span class="fl">0.89</span> <span class="op">)</span></span>
<span><span class="va">mu.CI.12</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span> <span class="va">mu.12</span> , MARGIN<span class="op">=</span><span class="fl">2</span>, FUN<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/rethinking/man/HPDI.html" class="external-link">PI</a></span> , prob<span class="op">=</span><span class="fl">0.89</span> <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">mu.CI.11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mu.CI.11</span><span class="op">)</span><span class="op">)</span>,<span class="va">x.seq</span><span class="op">)</span></span>
<span><span class="va">mu.CI.12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mu.CI.12</span><span class="op">)</span><span class="op">)</span>,<span class="va">x.seq</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mu.CI.21</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span> <span class="va">mu.21</span> , MARGIN<span class="op">=</span><span class="fl">2</span>, FUN<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/rethinking/man/HPDI.html" class="external-link">PI</a></span> , prob<span class="op">=</span><span class="fl">0.89</span> <span class="op">)</span></span>
<span><span class="va">mu.CI.22</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span> <span class="va">mu.22</span> , MARGIN<span class="op">=</span><span class="fl">2</span>, FUN<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/rethinking/man/HPDI.html" class="external-link">PI</a></span> , prob<span class="op">=</span><span class="fl">0.89</span> <span class="op">)</span></span>
<span></span>
<span><span class="va">mu.CI.21</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mu.CI.21</span><span class="op">)</span><span class="op">)</span>,<span class="va">x.seq</span><span class="op">)</span></span>
<span><span class="va">mu.CI.22</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mu.CI.22</span><span class="op">)</span><span class="op">)</span>,<span class="va">x.seq</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.CI.11</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"min.5.5"</span>,<span class="st">"max.94.5"</span>,<span class="st">"x.seq"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.CI.12</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"min.5.5"</span>,<span class="st">"max.94.5"</span>,<span class="st">"x.seq"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.CI.21</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"min.5.5"</span>,<span class="st">"max.94.5"</span>,<span class="st">"x.seq"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.CI.22</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"min.5.5"</span>,<span class="st">"max.94.5"</span>,<span class="st">"x.seq"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">dat</span><span class="op">$</span><span class="va">Y_obs</span>,X<span class="op">=</span><span class="va">dat</span><span class="op">$</span><span class="va">X_obs</span>,Regimes<span class="op">=</span><span class="va">regimes_tip</span><span class="op">)</span></span>
<span><span class="va">df11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x.seq</span>,<span class="va">mu.mean.11</span><span class="op">)</span></span>
<span><span class="va">df12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x.seq</span>,<span class="va">mu.mean.12</span><span class="op">)</span></span>
<span><span class="va">df21</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x.seq</span>,<span class="va">mu.mean.21</span><span class="op">)</span></span>
<span><span class="va">df22</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x.seq</span>,<span class="va">mu.mean.22</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#mypal.reg &lt;- ggsci::pal_npg("nrc", alpha = 0.7)(length(beta))</span></span>
<span></span>
<span><span class="va">regression.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">Y</span>,x<span class="op">=</span><span class="va">X</span>,color<span class="op">=</span><span class="va">Regimes</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima.sims</span>,slope<span class="op">=</span><span class="va">beta.sims</span>,alpha<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df11</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,y<span class="op">=</span><span class="va">mu.mean.11</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mu.CI.11</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,ymin<span class="op">=</span><span class="va">min.5.5</span>,ymax<span class="op">=</span><span class="va">max.94.5</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span>,alpha<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df12</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,y<span class="op">=</span><span class="va">mu.mean.12</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mu.CI.12</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,ymin<span class="op">=</span><span class="va">min.5.5</span>,ymax<span class="op">=</span><span class="va">max.94.5</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span>,alpha<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df21</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,y<span class="op">=</span><span class="va">mu.mean.21</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mu.CI.21</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,ymin<span class="op">=</span><span class="va">min.5.5</span>,ymax<span class="op">=</span><span class="va">max.94.5</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span>,alpha<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df22</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,y<span class="op">=</span><span class="va">mu.mean.22</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mu.CI.22</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,ymin<span class="op">=</span><span class="va">min.5.5</span>,ymax<span class="op">=</span><span class="va">max.94.5</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span>,alpha<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    legend.margin <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">6</span>, <span class="fl">6</span>, <span class="fl">6</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"X - Adaptation Model"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">regression.plot</span></span></code></pre></div>
<p><img src="Simulation-Example_files/figure-html/Plot_regressions-1.png" width="700">
Posterior predicted means (black line) and 89% compatibility intervals
(light grey region) are shown above for the optimal intercepts and
slopes. Species values for each regime are shown in colored circles
matching legend colors, with priors for intercept and slope shown in
light grey lines. Dotted lines are true values of parameters.</p>
<p>Let’s combine all four plots into one plot</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">regression.plot</span><span class="op">&lt;-</span><span class="va">regression.plot</span><span class="op">+</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"none"</span><span class="op">)</span></span>
<span><span class="va">fig</span><span class="op">&lt;-</span><span class="fu">ggpubr</span><span class="fu">::</span><span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/ggarrange.html" class="external-link">ggarrange</a></span><span class="op">(</span><span class="va">hl.plot</span>, <span class="va">vy.plot</span>,<span class="va">covariance.plot</span>,<span class="va">regression.plot</span>,ncol<span class="op">=</span><span class="fl">2</span>,nrow<span class="op">=</span><span class="fl">2</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A)"</span>,<span class="st">"B)"</span>,<span class="st">"C)"</span>,<span class="st">"D)"</span><span class="op">)</span>,common.legend <span class="op">=</span> <span class="cn">TRUE</span>,legend<span class="op">=</span><span class="st">"top"</span><span class="op">)</span></span>
<span><span class="co">#fig&lt;-ggpubr::annotate_figure(fig,top=paste("Multi-Optima Adaptive Model - Varying Effects,\n hl=",hl,sep=""))</span></span>
<span><span class="co">#ggplot2::ggsave("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch Project - SBR2/Blouch ms/R2/Figures/Fig2.pdf", plot = fig, width=7, height=7 )</span></span>
<span><span class="va">fig</span></span></code></pre></div>
<p><img src="Simulation-Example_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="model-comparison-using-psis">Model Comparison using PSIS<a class="anchor" aria-label="anchor" href="#model-comparison-using-psis"></a>
</h2>
<p>Lets do some model comparison using Pareto-Smoothed Importance
Sampling (PSIS) from the R Package <em>loo</em> (Vehtari et al. 2023).
loo estimates leave-one-out cross validation for Bayesian analyses. Here
we are looking for Pareto k values below ~0.7, which suggest the results
are accurate. The two species with consistently high Pareto shape values
across the models are <em>Daubentonia madagascariensis</em>, the sole
member of the distinct lemur family, and <em>Tarsius bancanus</em>, the
only tarsier included in the phylogeny – both are distinct due to their
long period of independent evolution (i.e. have long single branch on
the phylogeny). This leads to it being hard to predict based on other
species in the tree. PSIS also provides a way to look at outliers in our
analysis.</p>
<p>We then compare the two models using the loo_compare function from
the same package.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Mlm varying effects model</span></span>
<span><span class="va">loo_mlm_ve</span> <span class="op">&lt;-</span> <span class="fu">loo</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo.html" class="external-link">loo</a></span><span class="op">(</span><span class="va">fit.reg.adapt.mlm.ve</span>, save_psis <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Some Pareto k diagnostic values are too high. See help('pareto-k-diagnostic') for details.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">loo_mlm_ve</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Computed from 4000 by 100 log-likelihood matrix.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;          Estimate   SE</span></span>
<span><span class="co">#&gt; elpd_loo     31.1  7.0</span></span>
<span><span class="co">#&gt; p_loo         5.5  1.4</span></span>
<span><span class="co">#&gt; looic       -62.3 14.0</span></span>
<span><span class="co">#&gt; ------</span></span>
<span><span class="co">#&gt; MCSE of elpd_loo is NA.</span></span>
<span><span class="co">#&gt; MCSE and ESS estimates assume MCMC draws (r_eff in [0.5, 2.0]).</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Pareto k diagnostic values:</span></span>
<span><span class="co">#&gt;                          Count Pct.    Min. ESS</span></span>
<span><span class="co">#&gt; (-Inf, 0.7]   (good)     98    98.0%   1761    </span></span>
<span><span class="co">#&gt;    (0.7, 1]   (bad)       2     2.0%   &lt;NA&gt;    </span></span>
<span><span class="co">#&gt;    (1, Inf)   (very bad)  0     0.0%   &lt;NA&gt;    </span></span>
<span><span class="co">#&gt; See help('pareto-k-diagnostic') for details.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">loo_mlm_ve</span><span class="op">)</span> <span class="co">#4X6</span></span></code></pre></div>
<p><img src="Simulation-Example_files/figure-html/Model_comparison_PSIS-1.png" width="700"></p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">loo_mlm_ve.plot</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/grDevices/recordplot.html" class="external-link">recordPlot</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Varying effects model</span></span>
<span><span class="va">loo_ve</span> <span class="op">&lt;-</span> <span class="fu">loo</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo.html" class="external-link">loo</a></span><span class="op">(</span><span class="va">fit.reg.adapt.ve</span>, save_psis <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">loo_ve</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Computed from 4000 by 100 log-likelihood matrix.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;          Estimate   SE</span></span>
<span><span class="co">#&gt; elpd_loo     31.6  7.2</span></span>
<span><span class="co">#&gt; p_loo         5.3  1.4</span></span>
<span><span class="co">#&gt; looic       -63.1 14.3</span></span>
<span><span class="co">#&gt; ------</span></span>
<span><span class="co">#&gt; MCSE of elpd_loo is 0.1.</span></span>
<span><span class="co">#&gt; MCSE and ESS estimates assume MCMC draws (r_eff in [0.6, 1.7]).</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; All Pareto k estimates are good (k &lt; 0.7).</span></span>
<span><span class="co">#&gt; See help('pareto-k-diagnostic') for details.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">loo_ve</span><span class="op">)</span> <span class="co">#4X6</span></span></code></pre></div>
<p><img src="Simulation-Example_files/figure-html/Model_comparison_PSIS-2.png" width="700"></p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">loo_ve</span>,label_points<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="co">#Label outliers</span></span>
<span><span class="va">loo_ve.plot</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/grDevices/recordplot.html" class="external-link">recordPlot</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">loo</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html" class="external-link">loo_compare</a></span><span class="op">(</span><span class="va">loo_mlm_ve</span>, <span class="va">loo_ve</span><span class="op">)</span></span>
<span><span class="co">#&gt;        elpd_diff se_diff</span></span>
<span><span class="co">#&gt; model2  0.0       0.0   </span></span>
<span><span class="co">#&gt; model1 -0.4       0.4</span></span>
<span></span>
<span><span class="fl">0.2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="fl">0.6</span><span class="op">*</span><span class="fl">1.86</span> <span class="co">#95% comparability interval of the difference, z-score of 1.86</span></span>
<span><span class="co">#&gt; [1] -0.916  1.316</span></span></code></pre></div>
<p>Let’s combine the two plots into one</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#pdf(file="/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch Project - SBR2/Blouch ms/R2/Figures/FigS4.pdf", width=12, height=4 )</span></span>
<span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">loo_mlm_ve.plot</span>,<span class="va">loo_ve.plot</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A)"</span>,<span class="st">"B)"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Package `gridGraphics` is required to handle base-R plots.</span></span>
<span><span class="co">#&gt; Substituting empty plot.</span></span>
<span><span class="co">#&gt; Warning: Package `gridGraphics` is required to handle base-R plots.</span></span>
<span><span class="co">#&gt; Substituting empty plot.</span></span></code></pre></div>
<p><img src="Simulation-Example_files/figure-html/unnamed-chunk-18-1.png" width="700"></p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#fig&lt;-ggpubr::ggarrange(loo_mlm_ve.plot, loo_ve.plot,ncol=2,nrow=1, labels = c("A)","B)"),common.legend = TRUE,legend="top")</span></span>
<span><span class="co">#fig&lt;-ggpubr::annotate_figure(fig,top=paste("Multi-Optima Adaptive Model - Varying Effects,\n hl=",hl,sep=""))</span></span>
<span></span>
<span><span class="co">#dev.off()</span></span></code></pre></div>
<p>These results suggest the models are indistinguishable - the standard
error of the difference between the expected log pointwise predictive
density (elpd) for the three models is as big or larger than the
difference.</p>
</div>
<div class="section level2">
<h2 id="model-comparison-using-bayes-factors">Model Comparison using Bayes Factors<a class="anchor" aria-label="anchor" href="#model-comparison-using-bayes-factors"></a>
</h2>
<p>Now lets compare our two models using Bayes Factors. Here we use the
<em>bridgesampling</em> R package (Gronau et al. 2020). Looking below,
we can read the results as the data is X times more likely under a model
that assumes the first mode rather than second model.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Bayes Factors</span></span>
<span><span class="va">lml.fit.reg.adapt.mlm.ve</span><span class="op">&lt;-</span><span class="fu">bridgesampling</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bridgesampling/man/bridge_sampler.html" class="external-link">bridge_sampler</a></span><span class="op">(</span><span class="va">fit.reg.adapt.mlm.ve</span>,silent<span class="op">=</span><span class="cn">TRUE</span>,maxiter<span class="op">=</span><span class="fl">5000</span><span class="op">)</span></span>
<span><span class="va">lml.fit.reg.adapt.ve</span><span class="op">&lt;-</span><span class="fu">bridgesampling</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bridgesampling/man/bridge_sampler.html" class="external-link">bridge_sampler</a></span><span class="op">(</span><span class="va">fit.reg.adapt.ve</span>,silent<span class="op">=</span><span class="cn">TRUE</span>,maxiter<span class="op">=</span><span class="fl">5000</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">bridgesampling</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bridgesampling/man/bf.html" class="external-link">bf</a></span><span class="op">(</span><span class="va">lml.fit.reg.adapt.ve</span>,<span class="va">lml.fit.reg.adapt.mlm.ve</span><span class="op">)</span></span>
<span><span class="co">#&gt; Estimated Bayes factor in favor of lml.fit.reg.adapt.ve over lml.fit.reg.adapt.mlm.ve: 66.60532</span></span></code></pre></div>
<p>Here, the non-multilevel varying effects model is best supported
compared to the multilevel version of the same model.</p>
</div>
<div class="section level2">
<h2 id="trace-for-estimated-parameters">Trace for estimated parameters<a class="anchor" aria-label="anchor" href="#trace-for-estimated-parameters"></a>
</h2>
<p>Lets focus on the non-multilevel varying effects model as it had the
best Pareto k values - none were &gt;0.7 Let’s look at the traceplot,
which givea a visualization of degree of chain convergence.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-traceplot.html" class="external-link">traceplot</a></span><span class="op">(</span><span class="va">fit.reg.adapt.mlm.ve</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span>,<span class="st">"Rho[1,2]"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="Simulation-Example_files/figure-html/Traceplots-1.png" width="700"></p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-traceplot.html" class="external-link">traceplot</a></span><span class="op">(</span><span class="va">fit.reg.adapt.ve</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="Simulation-Example_files/figure-html/Traceplots-2.png" width="700"></p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#plot.mlm&lt;-rstan::traceplot(fit.reg.adapt.mlm.ve,pars = c("hl","vy","optima_bar","beta_bar","Rho","sigma","optima","beta"))</span></span>
<span><span class="co">#plot.ve&lt;-rstan::traceplot(fit.reg.adapt.ve,pars = c(c("hl","vy","optima","beta","beta_e")))</span></span>
<span></span>
<span><span class="co">#fig&lt;-ggpubr::ggarrange(plot.mlm, plot.ve,ncol=1,nrow=2, labels = c("A)","B)"),common.legend = TRUE,legend="top")</span></span>
<span><span class="co">#fig&lt;-ggpubr::annotate_figure(fig,top=paste("Multi-Optima Direct Effect - Varying Effects, hl=",hl,sep=""))</span></span>
<span><span class="co">#ggplot2::ggsave("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch Project - SBR2/Blouch ms/R2/Figures/FigS2.pdf", plot = fig, width=9, height=7)</span></span>
<span><span class="co">#fig</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="predictive-checks">Predictive Checks<a class="anchor" aria-label="anchor" href="#predictive-checks"></a>
</h2>
<p>Now lets run prior and posterior predictive checks for our two
models. Prior predictive checks generate predictions from the model
using only the prior distributions in order to assess whether the priors
are appropriate – they are equivalent to running the model without data
(Gabry et al. 2019). Posterior predictive checks generate data according
to the posterior predictive distribution and compare it to the observed
data to assess the fit of the model (Gabry et al. 2019). <em>Blouch</em>
includes Stan functions to run prior and posterior predictive checks for
each of the included models and their use is demonstrated below in the
simulation and empirical examples.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">########################################################################################################</span></span>
<span><span class="va">fit.reg.adapt.ve.priorpc</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_adapt_ve_priorpc</span>,data<span class="op">=</span><span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores<span class="op">=</span><span class="fl">2</span>, iter <span class="op">=</span><span class="fl">2000</span>,algorithm<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Fixed_param"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.adapt.ve.priorpc</span><span class="op">)</span></span>
<span></span>
<span><span class="va">num.plots</span><span class="op">&lt;-</span><span class="fl">5</span></span>
<span><span class="va">plots</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/ysim.ppc.plot.code.html">ysim.ppc.plot.code</a></span><span class="op">(</span><span class="va">dat</span>,<span class="va">post</span>,<span class="fl">1</span><span class="op">:</span><span class="va">num.plots</span><span class="op">)</span></span>
<span><span class="va">plots</span><span class="op">&lt;-</span><span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span>grobs<span class="op">=</span><span class="va">plots</span>, ncol<span class="op">=</span><span class="fl">5</span>, nrow<span class="op">=</span><span class="fl">1</span>,common.legend<span class="op">=</span><span class="cn">TRUE</span>,legend<span class="op">=</span><span class="st">"top"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Simulation-Example_files/figure-html/Prior_Post_Checks-1.png" width="700"></p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tgrob</span> <span class="op">&lt;-</span> <span class="fu">ggpubr</span><span class="fu">::</span><span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/text_grob.html" class="external-link">text_grob</a></span><span class="op">(</span><span class="st">"Multi-Optima Adaptive Model - Varying Efects - Prior PC"</span>,size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">plots.prior</span><span class="op">&lt;-</span><span class="fu">ggpubr</span><span class="fu">::</span><span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/annotate_figure.html" class="external-link">annotate_figure</a></span><span class="op">(</span><span class="va">plots</span>,top<span class="op">=</span><span class="va">tgrob</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit.reg.adapt.ve.postpc</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_adapt_ve_postpc</span>,data<span class="op">=</span><span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores<span class="op">=</span><span class="fl">2</span>, iter <span class="op">=</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.adapt.ve.postpc</span><span class="op">)</span></span>
<span></span>
<span><span class="va">num.plots</span><span class="op">&lt;-</span><span class="fl">5</span></span>
<span><span class="va">plots</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/ysim.ppc.plot.code.html">ysim.ppc.plot.code</a></span><span class="op">(</span><span class="va">dat</span>,<span class="va">post</span>,<span class="fl">1</span><span class="op">:</span><span class="va">num.plots</span><span class="op">)</span></span>
<span><span class="va">plots</span><span class="op">&lt;-</span><span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span>grobs<span class="op">=</span><span class="va">plots</span>, ncol<span class="op">=</span><span class="fl">5</span>, nrow<span class="op">=</span><span class="fl">1</span>,common.legend<span class="op">=</span><span class="cn">TRUE</span>,legend<span class="op">=</span><span class="st">"top"</span><span class="op">)</span></span></code></pre></div>
<p><img src="Simulation-Example_files/figure-html/Prior_Post_Checks-2.png" width="700"></p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tgrob</span> <span class="op">&lt;-</span> <span class="fu">ggpubr</span><span class="fu">::</span><span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/text_grob.html" class="external-link">text_grob</a></span><span class="op">(</span><span class="st">"Multi-Optima Adaptive Model - Varying Efects - Posterior PC"</span>,size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">plots.post</span><span class="op">&lt;-</span><span class="fu">ggpubr</span><span class="fu">::</span><span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/annotate_figure.html" class="external-link">annotate_figure</a></span><span class="op">(</span><span class="va">plots</span>,top<span class="op">=</span><span class="va">tgrob</span><span class="op">)</span></span>
<span><span class="va">fig</span><span class="op">&lt;-</span><span class="fu">ggpubr</span><span class="fu">::</span><span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/ggarrange.html" class="external-link">ggarrange</a></span><span class="op">(</span><span class="va">plots.prior</span>, <span class="va">plots.post</span>,ncol<span class="op">=</span><span class="fl">1</span>,nrow<span class="op">=</span><span class="fl">2</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A)"</span>,<span class="st">"B)"</span><span class="op">)</span>,common.legend <span class="op">=</span> <span class="cn">TRUE</span>,legend<span class="op">=</span><span class="st">"top"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#ggplot2::ggsave("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch Project - SBR2/Blouch ms/R2/Figures/FigS5.pdf", plot = fig, width=9, height=5)</span></span>
<span></span>
<span><span class="co">#plot(post$Y_sim_obs[4,],dat$Y_obs)</span></span>
<span></span>
<span><span class="va">plots.prior</span></span></code></pre></div>
<p><img src="Simulation-Example_files/figure-html/Prior_Post_Checks-3.png" width="700"></p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots.post</span></span></code></pre></div>
<p><img src="Simulation-Example_files/figure-html/Prior_Post_Checks-4.png" width="700"></p>
<p>Posterior predictive checks show that the model is well fit as it
generates data that are a close approximation of the true dataset.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Arnold, C., L. J. Matthews, and C. L. Nunn. 2010. The 10kTrees
Website: A New Online Resource for Primate Phylogeny. Evolutionary
Anthropology 19:114-118.</p>
<p>Gabry J., Simpson D., Vehtari A., Betancourt M., Gelman A. 2019.
Visualization in Bayesian workflow. Journal of the Royal Statistical
Society: Series A (Statistics in Society). 182:389–402.</p>
<p>Gronau Q.F., Singmann H., Wagenmakers E.-J. 2020. bridgesampling: An
R Package for Estimating Normalizing Constants. Journal of Statistical
Software. 92:1–29.</p>
<p>Hansen T.F. 1997. Stabilizing Selection and the Comparative Analysis
of Adaptation. Evolution. 51:1341–1351.</p>
<p>McElreath R. 2020. Statistical rethinking: A Bayesian course with
examples in R and Stan. CRC press.</p>
<p>Paradis E., Claude J., Strimmer K. 2004. APE: Analyses of
Phylogenetics and Evolution in R language. Bioinformatics.
20:289–290.</p>
<p>Revell L.J. 2011. phytools: an R package for phylogenetic comparative
biology (and other things). Methods Ecol. Evol. 3:217–223.</p>
<p>Uyeda J.C., Harmon L.J. 2014. A Novel Bayesian Method for Inferring
and Interpreting the Dynamics of Adaptive Landscapes from Phylogenetic
Comparative Data. Systematic Biology. 63:902–918.</p>
<p>Vehtari A., Gabry J., Magnusson M., Yao Y., Bürkner P.-C., Paananen
T., Gelman A. 2023. loo: Efficient leave-one-out cross-validation and
WAIC for Bayesian models.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Mark Grabowski.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
