<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="blouch">
<title>Varying Effects and Multilevel Models Walkthrough â€¢ blouch</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Varying Effects and Multilevel Models Walkthrough">
<meta property="og:description" content="blouch">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary" data-bs-theme="dark"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">blouch</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Empirical-Example.html">Empirical Example from Grabowski (in revision)</a>
    <a class="dropdown-item" href="../articles/Simulation-Example.html">Simulation Example from Grabowski (in revision)</a>
    <a class="dropdown-item" href="../articles/Basic_Models-Examples.html">Basic Models</a>
    <a class="dropdown-item" href="../articles/Multi-optima_Models-Examples.html">Multi-Optima Models</a>
    <a class="dropdown-item" href="../articles/Varying_Effects_Models-Examples.html">Varying Effects Models</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/mark-grabowski/blouch">
    <span class="fa fa-brands fa-github"></span>
     
    Github
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Varying Effects and Multilevel Models Walkthrough</h1>
                        <h4 data-toc-skip class="author">Mark
Grabowski</h4>
            
            <h4 data-toc-skip class="date">2024-06-20</h4>
      
      
      <div class="d-none name"><code>Varying_Effects_Models-Examples.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mark-grabowski.github.io/blouch/">blouch</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">########################################################################################################</span></span>
<span><span class="co">#For execution on a local, multicore CPU with excess RAM we recommend calling</span></span>
<span><span class="co">#options(mc.cores = parallel::detectCores())</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>mc.cores <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="co">#2 For R package checks - use line above on your own machine</span></span>
<span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/rstan_options.html" class="external-link">rstan_options</a></span><span class="op">(</span>auto_write <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dotR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"HOME"</span><span class="op">)</span>, <span class="st">".R"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">dotR</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">dotR</span><span class="op">)</span></span>
<span><span class="va">M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dotR</span>, <span class="st">"Makevars"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.create</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span></span>
<span><span class="va">arch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">R.version</span><span class="op">$</span><span class="va">arch</span> <span class="op">==</span> <span class="st">"aarch64"</span>, <span class="st">"arm64"</span>, <span class="st">"x86_64"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"\nCXX14FLAGS += -O3 -mtune=native -arch"</span>, <span class="va">arch</span>, <span class="st">"-ftemplate-depth-256"</span><span class="op">)</span>,</span>
<span>    file <span class="op">=</span> <span class="va">M</span>, sep <span class="op">=</span> <span class="st">"\n"</span>, append <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Here I walk you through the varying effects models of
<em>Blouch</em>. By varying effects I mean varying intercepts and
slopes, which to my knowledge has not been done previously for OU models
in the adaptation-inertia framework. We will run three different models
below - a multilevel model which pools information across the regimes, a
non-centered version of the same model to aid in exploring the
posterior, and a non-multilevel version of the varying effects model.
This article is an abbreviated versions of the Simulation Example
article - most of the steps of analysis will be the same and are not
repeated here. Note that the Stan runs are also too few iterations and
use only 1 chain and 1 core.</p>
<div class="section level2">
<h2 id="multi-optima-direct-effect-model-with-varying-effects---single-predictor">Multi-optima Direct Effect Model with Varying Effects - Single
Predictor<a class="anchor" aria-label="anchor" href="#multi-optima-direct-effect-model-with-varying-effects---single-predictor"></a>
</h2>
<p>First we will create a phylogeny by randomly sampling from the 10K
Trees phylogeny</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">########################################################################################################</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">N</span><span class="op">&lt;-</span><span class="fl">50</span> <span class="co">#Number of species</span></span>
<span><span class="co">#set.seed(1) #Set seed to get same random species each time</span></span>
<span></span>
<span><span class="va">phy</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/drop.tip.html" class="external-link">keep.tip</a></span><span class="op">(</span><span class="va">tree.10K</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">tree.10K</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">]</span><span class="op">)</span> </span>
<span><span class="va">phy</span><span class="op">&lt;-</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/multi2di.html" class="external-link">multi2di</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span></span>
<span></span>
<span><span class="va">l.tree</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/branching.times.html" class="external-link">branching.times</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span><span class="op">)</span> <span class="co">## rescale tree to height 1</span></span>
<span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">/</span><span class="va">l.tree</span> </span>
<span></span>
<span><span class="co">#Set regimes - manually - 2 regimes</span></span>
<span><span class="co">#Locate nodes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">phy</span>,no.margin<span class="op">=</span><span class="cn">TRUE</span>,edge.width<span class="op">=</span><span class="fl">2</span>,cex<span class="op">=</span><span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/nodelabels.html" class="external-link">nodelabels</a></span><span class="op">(</span>frame<span class="op">=</span><span class="st">"none"</span>,adj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.1</span>,<span class="op">-</span><span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/nodelabels.html" class="external-link">tiplabels</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/MODEMVE_setup-1.png" width="700"></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Paint Regimes on Tree</span></span>
<span></span>
<span><span class="va">shifts</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">84</span><span class="op">)</span> <span class="co">#Location of nodes with regime shifts</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu">treeplyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/treeplyr/man/make.treedata.html" class="external-link">make.treedata</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">trdata</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/set.converge.regimes.html">set.converge.regimes</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="va">shifts</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; Levels: OU1 OU2</span></span>
<span><span class="co">#&gt; [1] "#E64B35FF" "#4DBBD5FF"</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="co">#Check if manual setting code worked</span></span>
<span><span class="va">shifts.total</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span>,<span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">node.label</span><span class="op">)</span></span>
<span><span class="va">edge.regimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">shifts.total</span><span class="op">[</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">edge</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">edge.regimes</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; Levels: OU1 OU2</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">reg_tips</span><span class="op">&lt;-</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span></span>
<span><span class="va">reg_tips</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">reg_tips</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">reg.colors</span><span class="op">&lt;-</span><span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/pal_npg.html" class="external-link">pal_npg</a></span><span class="op">(</span>palette<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"nrc"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>,edge.color <span class="op">=</span> <span class="va">reg.colors</span><span class="op">[</span><span class="va">edge.regimes</span><span class="op">]</span>, edge.width <span class="op">=</span> <span class="fl">1</span>, cex <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/MODEMVE_setup-2.png" width="700"></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Phylogeny info</span></span>
<span><span class="va">n</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span></span>
<span></span>
<span><span class="va">regimes_internal</span> <span class="op">&lt;-</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">node.label</span></span>
<span><span class="va">regimes_tip</span> <span class="op">&lt;-</span> <span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span></span>
<span><span class="va">regimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/concat.factor.html">concat.factor</a></span><span class="op">(</span><span class="va">regimes_tip</span>, <span class="va">regimes_internal</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">anc_maps</span><span class="op">&lt;-</span><span class="st">"regimes"</span></span>
<span><span class="va">lineages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="fu"><a href="../reference/lineage.constructor.html">lineage.constructor</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>, <span class="va">e</span>, <span class="va">anc_maps</span>, <span class="va">regimes</span><span class="op">)</span><span class="op">)</span> <span class="co">#Trace lineage from tips (n) to root and determine regimes of each node or branch</span></span></code></pre></div>
<p>Simulate X and Y data</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#########################</span></span>
<span><span class="va">hl</span><span class="op">&lt;-</span><span class="fl">0.1</span> <span class="co">#0.1, 0.25, 0.75 - testing options</span></span>
<span><span class="va">a</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span></span>
<span><span class="va">vy</span><span class="op">&lt;-</span><span class="fl">0.01</span> <span class="co">#0.25,0.5 - testing options</span></span>
<span><span class="va">sigma2_y</span><span class="op">&lt;-</span><span class="va">vy</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span><span class="op">)</span><span class="op">)</span>;</span>
<span></span>
<span><span class="va">vX0</span><span class="op">&lt;-</span><span class="fl">0</span></span>
<span><span class="va">vY0</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">Sxx</span><span class="op">&lt;-</span><span class="fl">10</span> <span class="co">#Look at effects</span></span>
<span></span>
<span><span class="va">X</span><span class="op">&lt;-</span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/fastBM.html" class="external-link">fastBM</a></span><span class="op">(</span><span class="va">phy</span>,a<span class="op">=</span><span class="va">vX0</span>,sig2<span class="op">=</span><span class="va">Sxx</span>,internal<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="co">#Simulate X BM variable on tree, with scaling 10</span></span>
<span><span class="va">Z_direct</span><span class="op">&lt;-</span><span class="fl">1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span></span>
<span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/phenogram.html" class="external-link">phenogram</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">X</span>,spread.labels<span class="op">=</span><span class="cn">TRUE</span>,spread.cost<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="co">#Plot X data</span></span>
<span><span class="co">#&gt; Optimizing the positions of the tip labels...</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">dmX</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/weight.matrix.html">weight.matrix</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>, <span class="va">a</span>, <span class="va">lineages</span><span class="op">)</span> <span class="co">#Slouch approach</span></span>
<span><span class="va">optima</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">beta</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>,<span class="fl">0.15</span><span class="op">)</span> <span class="co">#Two Optima/Two Slopes</span></span>
<span><span class="va">mu</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="va">N</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">mu</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">&lt;-</span><span class="va">dmX</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">optima</span><span class="op">+</span><span class="va">beta</span><span class="op">[</span><span class="va">reg_tips</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">X</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>;</span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">V</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/calc_direct_V.html">calc_direct_V</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">sigma2_y</span>,<span class="va">a</span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">&lt;-</span><span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1</span>,<span class="va">mu</span>,<span class="va">V</span><span class="op">)</span></span>
<span></span>
<span><span class="co">###############################################################################################################</span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">Y</span>,X<span class="op">=</span><span class="va">X</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">X</span>,y<span class="op">=</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-4-2.png" width="700"></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">X</span>,<span class="va">df</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = Y ~ X, data = df)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co">#&gt; -1.40684  0.08761  0.21911  0.31485  0.49026 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  1.76428    0.08319   21.21  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; X            0.24933    0.02371   10.52 4.76e-14 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 0.5228 on 48 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.6973, Adjusted R-squared:  0.691 </span></span>
<span><span class="co">#&gt; F-statistic: 110.6 on 1 and 48 DF,  p-value: 4.761e-14</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">################################################################################################################</span></span>
<span><span class="co">#Simulate errors </span></span>
<span><span class="va">Z_X_error</span><span class="op">&lt;-</span><span class="fl">1</span> <span class="co">#Number of X traits with error</span></span>
<span><span class="va">X_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Y_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Y_with_error</span><span class="op">&lt;-</span><span class="va">Y</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">X_with_error</span><span class="op">&lt;-</span><span class="va">X</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span></span>
<span></span>
<span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Make trdata file</span></span>
<span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span>,<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Y_with_error</span>,<span class="va">Y_error</span>,<span class="va">X_with_error</span>,<span class="va">X_error</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Next we will set the priors for the estimated parameters - for this
model this includes the half-life, Vy, optima, and beta. For the latter
two parameters we will use the results of the linear model to inform our
priors.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Set Priors</span></span>
<span><span class="va">hl.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span>,<span class="fl">0.75</span><span class="op">)</span></span>
<span><span class="va">vy.prior</span><span class="op">&lt;-</span><span class="fl">5</span></span>
<span><span class="va">optima.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>,<span class="fl">0.5</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span>
<span><span class="va">beta.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.25</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="exploring-priors">Exploring Priors<a class="anchor" aria-label="anchor" href="#exploring-priors"></a>
</h2>
<p>At this point one would want to explore if the priors are appropriate
- do the prior distributions look consistent with what we know about our
system? See Grabowski (in revision) for more on setting priors.</p>
<p>Half-life Prior plot</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hl.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1000</span>,meanlog<span class="op">=</span><span class="va">hl.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,sdlog<span class="op">=</span><span class="va">hl.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"prior.hl.sims"</span></span>
<span></span>
<span><span class="va">hl.prior.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.hl.sims</span>,fill<span class="op">=</span><span class="st">"prior.hl.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#labs(title="Prior vs. Posterior Distribution ",x="Half-life", y = "Density")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"Half-life"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#scale_fill_manual(labels=c("Posterior","Prior"))+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">hl</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hl.prior.plot</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>Vy Prior Plot</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vy.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1000</span>,rate<span class="op">=</span><span class="va">vy.prior</span><span class="op">)</span></span>
<span><span class="va">vy.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">vy.sims</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vy.sims</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"prior.vy.sims"</span></span>
<span></span>
<span><span class="va">vy.prior.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.vy.sims</span>,fill<span class="op">=</span><span class="st">"prior.vy.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">vy.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#labs(title="Prior vs. Posterior Distribution ",x="vy", y = "Density")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"vy"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">vy</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#scale_fill_manual(labels=c("Posterior","Prior"))+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">vy.prior.plot</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>Prior on how shared branch lengths correspond to covariance</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl.sims</span>;</span>
<span><span class="va">sigma2_y.sims</span><span class="op">&lt;-</span><span class="va">vy.sims</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">)</span>;</span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span> <span class="cn">NULL</span> , xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> , ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> , xlab<span class="op">=</span><span class="st">"Time since MRCA"</span> , ylab<span class="op">=</span><span class="st">"Covariance"</span> ,cex.axis<span class="op">=</span><span class="fl">0.75</span>, mgp<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.25</span>,<span class="fl">0.25</span>,<span class="fl">0</span><span class="op">)</span>,tcl<span class="op">=</span><span class="op">-</span><span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="va">sigma2_y.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">/</span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">a.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span> <span class="op">*</span> <span class="va">a.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">a.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span> , add<span class="op">=</span><span class="cn">TRUE</span> , lwd<span class="op">=</span><span class="fl">4</span> , col<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/col.alpha.html" class="external-link">col.alpha</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0.15</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">0.25</span>,<span class="fl">0.25</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">covariance.prior.plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/recordplot.html" class="external-link">recordPlot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; null device </span></span>
<span><span class="co">#&gt;           1</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">covariance.prior.plot</span></span></code></pre></div>
<p>Slope and intercept Prior Plot</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">optima.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">beta.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">100</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prior.slope.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>  </span>
<span> <span class="fu">ggplot2</span><span class="fu">::</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">Y</span>,x<span class="op">=</span><span class="va">X</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima.sims</span>,slope<span class="op">=</span><span class="va">beta.sims</span>,alpha<span class="op">=</span><span class="fl">0.15</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Trait 1"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Trait 2"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prior.slope.plot</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>We will use the helper function blouch.reg.direct.prep() to setup the
dat file for Stan. Here â€œZ_directâ€ is the number of predictors, and
â€œregimesâ€ is the name of the regime column in trdata$dat.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Blouch prep code - Regimes + Direct Efffect model</span></span>
<span><span class="co">#source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/blouch/R Setup Code/blouch.prep.R")</span></span>
<span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/blouch.reg.direct.prep.html">blouch.reg.direct.prep</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="st">"Y_with_error"</span>,<span class="st">"Y_error"</span>,<span class="st">"X_with_error"</span>,<span class="st">"X_error"</span>,Z_direct<span class="op">=</span><span class="fl">1</span>,<span class="st">"regimes"</span>,<span class="va">hl.prior</span>,<span class="va">vy.prior</span>,<span class="va">optima.prior</span>,<span class="va">beta.prior</span><span class="op">)</span></span></code></pre></div>
<p>Multi-optima Direct Effect Model with Varying Effects</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.direct.ve</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_direct_ve</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores<span class="op">=</span><span class="fl">2</span>,iter <span class="op">=</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.direct.ve</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_ve.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.18       0 0.10 0.06 0.11 0.16 0.22  0.43   588 1.01</span></span>
<span><span class="co">#&gt; vy        0.02       0 0.01 0.01 0.01 0.02 0.02  0.03   701 1.01</span></span>
<span><span class="co">#&gt; optima[1] 2.00       0 0.04 1.90 1.97 2.00 2.02  2.07  1617 1.00</span></span>
<span><span class="co">#&gt; optima[2] 0.98       0 0.13 0.67 0.92 1.00 1.06  1.18   745 1.01</span></span>
<span><span class="co">#&gt; beta[1,1] 0.26       0 0.01 0.24 0.25 0.26 0.27  0.28  2404 1.00</span></span>
<span><span class="co">#&gt; beta[2,1] 0.12       0 0.03 0.06 0.10 0.12 0.15  0.19  2360 1.00</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Thu Jun 20 18:41:44 2024.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.direct.ve</span><span class="op">)</span></span></code></pre></div>
<p>Now lets look at the prior vs.Â posterior plots for the parameters
Half-life plot</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hl.post</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">hl</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">hl.post</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"post.hl.sims"</span></span>
<span></span>
<span><span class="va">hl.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.hl.sims</span>,fill<span class="op">=</span><span class="st">"prior.hl.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">post.hl.sims</span>,fill<span class="op">=</span><span class="st">"post.hl.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">hl.post</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#labs(title="Prior vs. Posterior Distribution ",x="Half-life", y = "Density")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"Half-life"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#scale_fill_manual(labels=c("Posterior","Prior"))+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">hl</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Posterior"</span>,<span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hl.plot</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>Vy Prior vs.Â posterior plot</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vy.post</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">vy</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vy.post</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"post.vy.sims"</span></span>
<span></span>
<span></span>
<span><span class="va">vy.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.vy.sims</span>,fill<span class="op">=</span><span class="st">"prior.vy.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">vy.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">post.vy.sims</span>,fill<span class="op">=</span><span class="st">"post.vy.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">vy.post</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#labs(title="Prior vs. Posterior Distribution ",x="vy", y = "Density")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"vy"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">vy</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#scale_fill_manual(labels=c("Posterior","Prior"))+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Posterior"</span>,<span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vy.plot</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<p>Prior versus posterior on how shared branch lengths correspond to
covariance</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span> <span class="cn">NULL</span> , xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> , ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> , xlab<span class="op">=</span><span class="st">"Time since MRCA"</span> , ylab<span class="op">=</span><span class="st">"Covariance"</span> ,cex.axis<span class="op">=</span><span class="fl">0.75</span>, mgp<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.25</span>,<span class="fl">0.25</span>,<span class="fl">0</span><span class="op">)</span>,tcl<span class="op">=</span><span class="op">-</span><span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="va">sigma2_y.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">/</span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">a.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span> <span class="op">*</span> <span class="va">a.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">a.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span> , add<span class="op">=</span><span class="cn">TRUE</span> , lwd<span class="op">=</span><span class="fl">4</span> , col<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/col.alpha.html" class="external-link">col.alpha</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0.15</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">sigma2_y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">/</span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">post</span><span class="op">$</span><span class="va">a</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span> <span class="op">*</span> <span class="va">post</span><span class="op">$</span><span class="va">a</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">post</span><span class="op">$</span><span class="va">a</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span> , add<span class="op">=</span><span class="cn">TRUE</span> , lwd<span class="op">=</span><span class="fl">4</span> , col<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/col.alpha.html" class="external-link">col.alpha</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">0.25</span>,<span class="fl">0.25</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">covariance.plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/recordplot.html" class="external-link">recordPlot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; null device </span></span>
<span><span class="co">#&gt;           1</span></span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">covariance.plot</span></span></code></pre></div>
<p>Prior vs.Â Posterior Plot for Regression</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">optima.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">beta.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">100</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">optima.post</span><span class="op">&lt;-</span><span class="va">post</span><span class="op">$</span><span class="va">optima</span></span>
<span><span class="va">beta.post</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">beta</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">beta.post</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"post.beta.1"</span>,<span class="st">"post.beta.2"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mu.link.11</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x.seq</span><span class="op">)</span><span class="op">{</span><span class="va">optima.post</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">+</span><span class="va">x.seq</span><span class="op">*</span><span class="va">beta.post</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">}</span></span>
<span><span class="va">mu.link.12</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x.seq</span><span class="op">)</span><span class="op">{</span><span class="va">optima.post</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">+</span><span class="va">x.seq</span><span class="op">*</span><span class="va">beta.post</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">}</span></span>
<span></span>
<span><span class="va">x.seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, to<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> , length.out<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">mu.11</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">x.seq</span> , <span class="va">mu.link.11</span> <span class="op">)</span></span>
<span><span class="va">mu.12</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">x.seq</span> , <span class="va">mu.link.12</span> <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">mu.mean.11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">mu.11</span><span class="op">)</span></span>
<span><span class="va">mu.mean.12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">mu.12</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mu.mean.11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mu.mean.11</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mu.mean.12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mu.mean.12</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.mean.11</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"mu.mean.11"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.mean.12</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"mu.mean.12"</span></span>
<span></span>
<span><span class="va">mu.CI.11</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span> <span class="va">mu.11</span> , MARGIN<span class="op">=</span><span class="fl">2</span>, FUN<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/rethinking/man/HPDI.html" class="external-link">PI</a></span> , prob<span class="op">=</span><span class="fl">0.89</span> <span class="op">)</span></span>
<span><span class="va">mu.CI.12</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span> <span class="va">mu.12</span> , MARGIN<span class="op">=</span><span class="fl">2</span>, FUN<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/rethinking/man/HPDI.html" class="external-link">PI</a></span> , prob<span class="op">=</span><span class="fl">0.89</span> <span class="op">)</span></span>
<span></span>
<span><span class="va">mu.CI.11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mu.CI.11</span><span class="op">)</span><span class="op">)</span>,<span class="va">x.seq</span><span class="op">)</span></span>
<span><span class="va">mu.CI.12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mu.CI.12</span><span class="op">)</span><span class="op">)</span>,<span class="va">x.seq</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.CI.11</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"min.5.5"</span>,<span class="st">"max.94.5"</span>,<span class="st">"x.seq"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.CI.12</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"min.5.5"</span>,<span class="st">"max.94.5"</span>,<span class="st">"x.seq"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">dat</span><span class="op">$</span><span class="va">Y_obs</span>,X<span class="op">=</span><span class="va">dat</span><span class="op">$</span><span class="va">X_obs</span>,Regimes<span class="op">=</span><span class="va">regimes_tip</span><span class="op">)</span></span>
<span><span class="va">df11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x.seq</span>,<span class="va">mu.mean.11</span><span class="op">)</span></span>
<span><span class="va">df12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x.seq</span>,<span class="va">mu.mean.12</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">slope.plot.1</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">Y</span>,x<span class="op">=</span><span class="va">X</span>,color<span class="op">=</span><span class="va">Regimes</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima.sims</span>,slope<span class="op">=</span><span class="va">beta.sims</span>,alpha<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df11</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,y<span class="op">=</span><span class="va">mu.mean.11</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mu.CI.11</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,ymin<span class="op">=</span><span class="va">min.5.5</span>,ymax<span class="op">=</span><span class="va">max.94.5</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span>,alpha<span class="op">=</span><span class="fl">0.25</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df12</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,y<span class="op">=</span><span class="va">mu.mean.12</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mu.CI.12</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,ymin<span class="op">=</span><span class="va">min.5.5</span>,ymax<span class="op">=</span><span class="va">max.94.5</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span>,alpha<span class="op">=</span><span class="fl">0.25</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>  panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Direct effect trait"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">slope.plot.1</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
<p>`Multilevel Multi-optima Direct Effect Model with Varying Effects</p>
<p>Next we will set the priors for the estimated parameters - for this
model this includes the half-life, Vy, optima, and beta. For the latter
two parameters we will use the results of the linear model to inform our
priors.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Set Priors</span></span>
<span><span class="va">hl.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span>,<span class="fl">0.75</span><span class="op">)</span></span>
<span><span class="va">vy.prior</span><span class="op">&lt;-</span><span class="fl">5</span></span>
<span><span class="va">optima.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>,<span class="fl">0.5</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span>
<span><span class="va">beta.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="va">sigma.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>We will use the helper function blouch.reg.direct.prep() to setup the
dat file for Stan. Here â€œZ_directâ€ is the number of predictors, and
â€œregimesâ€ is the name of the regime column in trdata$dat.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/blouch.reg.direct.mlm.prep.html">blouch.reg.direct.mlm.prep</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="st">"Y_with_error"</span>,<span class="st">"Y_error"</span>,<span class="st">"X_with_error"</span>,<span class="st">"X_error"</span>,Z_direct<span class="op">=</span><span class="fl">1</span>,<span class="st">"regimes"</span>,<span class="va">hl.prior</span>,<span class="va">vy.prior</span>,<span class="va">optima.prior</span>,<span class="va">beta.prior</span>,<span class="va">sigma.prior</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.direct.mlm.ve</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_direct_mlm_ve</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores<span class="op">=</span><span class="fl">2</span>,iter<span class="op">=</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Warning: There were 16 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span></code></pre></div>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.direct.mlm.ve</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima_bar"</span>,<span class="st">"beta_bar"</span>,<span class="st">"Rho"</span>,<span class="st">"sigma"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_mlm_ve.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;             mean se_mean   sd  2.5%   25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl          0.20    0.01 0.13  0.06  0.12 0.17 0.24  0.57   485 1.01</span></span>
<span><span class="co">#&gt; vy          0.02    0.00 0.01  0.01  0.01 0.02 0.02  0.04   519 1.01</span></span>
<span><span class="co">#&gt; optima_bar  1.48    0.01 0.39  0.69  1.23 1.48 1.73  2.27  1968 1.00</span></span>
<span><span class="co">#&gt; beta_bar[1] 0.13    0.00 0.15 -0.23  0.05 0.15 0.22  0.39  1175 1.00</span></span>
<span><span class="co">#&gt; Rho[1,1]    1.00     NaN 0.00  1.00  1.00 1.00 1.00  1.00   NaN  NaN</span></span>
<span><span class="co">#&gt; Rho[1,2]    0.08    0.01 0.32 -0.56 -0.14 0.08 0.32  0.68  1922 1.00</span></span>
<span><span class="co">#&gt; Rho[2,1]    0.08    0.01 0.32 -0.56 -0.14 0.08 0.32  0.68  1922 1.00</span></span>
<span><span class="co">#&gt; Rho[2,2]    1.00    0.00 0.00  1.00  1.00 1.00 1.00  1.00  1562 1.00</span></span>
<span><span class="co">#&gt; sigma[1]    0.87    0.01 0.42  0.33  0.57 0.77 1.08  1.93  1508 1.00</span></span>
<span><span class="co">#&gt; sigma[2]    0.34    0.01 0.32  0.05  0.12 0.22 0.44  1.21  1154 1.00</span></span>
<span><span class="co">#&gt; optima[1]   1.99    0.00 0.05  1.89  1.97 2.00 2.02  2.08  1108 1.00</span></span>
<span><span class="co">#&gt; optima[2]   0.94    0.01 0.17  0.49  0.89 0.97 1.04  1.16   466 1.00</span></span>
<span><span class="co">#&gt; beta[1,1]   0.26    0.00 0.01  0.24  0.25 0.26 0.27  0.28  1863 1.00</span></span>
<span><span class="co">#&gt; beta[2,1]   0.13    0.00 0.03  0.07  0.11 0.13 0.15  0.20  1335 1.00</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Thu Jun 20 18:42:32 2024.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span></code></pre></div>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.direct.mlm.ve</span><span class="op">)</span></span></code></pre></div>
<p>Multilevel Multi-optima Direct Effect Model with Varying Effects -
Non centered</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.direct.mlm.ve.nc</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_direct_mlm_ve_nc</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores<span class="op">=</span><span class="fl">2</span>,iter<span class="op">=</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Warning: There were 48 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span></code></pre></div>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.direct.mlm.ve.nc</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima_bar"</span>,<span class="st">"beta_bar"</span>,<span class="st">"Rho"</span>,<span class="st">"sigma"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_mlm_ve_nc.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;            mean se_mean   sd  2.5%   25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl         0.20    0.00 0.13  0.06  0.12 0.17 0.25  0.55   729 1.00</span></span>
<span><span class="co">#&gt; vy         0.02    0.00 0.01  0.01  0.01 0.02 0.02  0.04   790 1.00</span></span>
<span><span class="co">#&gt; optima_bar 1.48    0.01 0.37  0.74  1.25 1.48 1.71  2.23   673 1.01</span></span>
<span><span class="co">#&gt; beta_bar   0.13    0.01 0.15 -0.24  0.05 0.15 0.22  0.38   428 1.00</span></span>
<span><span class="co">#&gt; Rho[1,1]   1.00     NaN 0.00  1.00  1.00 1.00 1.00  1.00   NaN  NaN</span></span>
<span><span class="co">#&gt; Rho[1,2]   0.06    0.01 0.32 -0.56 -0.16 0.06 0.30  0.67  1387 1.00</span></span>
<span><span class="co">#&gt; Rho[2,1]   0.06    0.01 0.32 -0.56 -0.16 0.06 0.30  0.67  1387 1.00</span></span>
<span><span class="co">#&gt; Rho[2,2]   1.00    0.00 0.00  1.00  1.00 1.00 1.00  1.00  1723 1.00</span></span>
<span><span class="co">#&gt; sigma[1]   0.87    0.01 0.42  0.33  0.57 0.78 1.09  1.87  1365 1.00</span></span>
<span><span class="co">#&gt; sigma[2]   0.32    0.01 0.27  0.04  0.12 0.22 0.43  1.03   638 1.00</span></span>
<span><span class="co">#&gt; optima[1]  2.00    0.00 0.05  1.89  1.97 2.00 2.03  2.09  1989 1.00</span></span>
<span><span class="co">#&gt; optima[2]  0.94    0.01 0.18  0.45  0.88 0.98 1.04  1.16   975 1.00</span></span>
<span><span class="co">#&gt; beta[1,1]  0.26    0.00 0.01  0.24  0.25 0.26 0.27  0.28  1906 1.00</span></span>
<span><span class="co">#&gt; beta[2,1]  0.13    0.00 0.03  0.06  0.11 0.13 0.15  0.20  1487 1.00</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Thu Jun 20 18:46:59 2024.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.direct.mlm.ve.nc</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="multlevel-multi-optima-direct-effect-model-with-varying-effects---multiple-predictors">Multlevel Multi-optima Direct Effect Model with Varying Effects -
Multiple Predictors<a class="anchor" aria-label="anchor" href="#multlevel-multi-optima-direct-effect-model-with-varying-effects---multiple-predictors"></a>
</h2>
<p>Two regimes with two direct effect predictors and multiple slopes per
optima but single alpha parameter</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Regimes model</span></span>
<span><span class="co">############################################################################################################</span></span>
<span><span class="co">########################################################################################################</span></span>
<span><span class="co">#Create phylogeny</span></span>
<span><span class="co">########################################################################################################</span></span>
<span><span class="va">N</span><span class="op">&lt;-</span><span class="fl">50</span> <span class="co">#Number of species</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="co">#Set seed to get same random species each time</span></span>
<span></span>
<span><span class="va">phy</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/drop.tip.html" class="external-link">keep.tip</a></span><span class="op">(</span><span class="va">tree.10K</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">tree.10K</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">]</span><span class="op">)</span> </span>
<span><span class="va">phy</span><span class="op">&lt;-</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/multi2di.html" class="external-link">multi2di</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span></span>
<span></span>
<span><span class="va">l.tree</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/branching.times.html" class="external-link">branching.times</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span><span class="op">)</span> <span class="co">## rescale tree to height 1</span></span>
<span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">/</span><span class="va">l.tree</span> </span>
<span></span>
<span><span class="va">tip.label</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span></span>
<span></span>
<span></span>
<span><span class="co">#Set regimes - manually - 2 regimes</span></span>
<span><span class="co">#Locate nodes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">phy</span>,no.margin<span class="op">=</span><span class="cn">TRUE</span>,edge.width<span class="op">=</span><span class="fl">2</span>,cex<span class="op">=</span><span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/nodelabels.html" class="external-link">nodelabels</a></span><span class="op">(</span>frame<span class="op">=</span><span class="st">"none"</span>,adj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.1</span>,<span class="op">-</span><span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/nodelabels.html" class="external-link">tiplabels</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/Multi_optima_model_setup-1.png" width="700"></p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Paint Regimes on Tree</span></span>
<span><span class="co">#source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/blouch/Simulation Code/Functions/set.converge.regimes.R") #Macbook Pro</span></span>
<span></span>
<span><span class="va">shifts</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">84</span><span class="op">)</span> <span class="co">#Location of nodes with regime shifts</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu">treeplyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/treeplyr/man/make.treedata.html" class="external-link">make.treedata</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">trdata</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/set.converge.regimes.html">set.converge.regimes</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="va">shifts</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; Levels: OU1 OU2</span></span>
<span><span class="co">#&gt; [1] "#E64B35FF" "#4DBBD5FF"</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/Multi_optima_model_setup-2.png" width="700"></p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Check if manual setting code worked</span></span>
<span><span class="va">shifts.total</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span>,<span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">node.label</span><span class="op">)</span></span>
<span><span class="va">edge.regimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">shifts.total</span><span class="op">[</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">edge</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">edge.regimes</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; Levels: OU1 OU2</span></span></code></pre></div>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">reg_tips</span><span class="op">&lt;-</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span></span>
<span><span class="va">reg_tips</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">reg_tips</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">reg.colors</span> <span class="op">&lt;-</span> <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/pal_aaas.html" class="external-link">pal_aaas</a></span><span class="op">(</span><span class="st">"default"</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">reg.colors</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "#3B4992B2" "#EE0000B2"</span></span></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>,edge.color <span class="op">=</span> <span class="va">reg.colors</span><span class="op">[</span><span class="va">edge.regimes</span><span class="op">]</span>, edge.width <span class="op">=</span> <span class="fl">1</span>, cex <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/Multi_optima_model_setup-3.png" width="700"></p>
<p>Format tree</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Simulate data</span></span>
<span><span class="va">n</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span></span>
<span><span class="va">regimes_internal</span> <span class="op">&lt;-</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">node.label</span></span>
<span><span class="va">regimes_tip</span> <span class="op">&lt;-</span> <span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span></span>
<span><span class="va">regimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/concat.factor.html">concat.factor</a></span><span class="op">(</span><span class="va">regimes_tip</span>, <span class="va">regimes_internal</span><span class="op">)</span></span>
<span><span class="va">anc_maps</span><span class="op">&lt;-</span><span class="st">"regimes"</span></span>
<span><span class="va">lineages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="fu"><a href="../reference/lineage.constructor.html">lineage.constructor</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>, <span class="va">e</span>, <span class="va">anc_maps</span>, <span class="va">regimes</span><span class="op">)</span><span class="op">)</span> <span class="co">#Trace lineage from tips (n) to root and determine regimes of each node or branch</span></span></code></pre></div>
<p>Simulate two direct effect traits</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#########################</span></span>
<span><span class="va">hl</span><span class="op">&lt;-</span><span class="fl">0.1</span> <span class="co">#0.1, 0.25, 0.75 - testing options</span></span>
<span><span class="va">a</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span></span>
<span><span class="va">vy</span><span class="op">&lt;-</span><span class="fl">0.01</span> <span class="co">#0.25,0.5 - testing options</span></span>
<span><span class="va">sigma2_y</span><span class="op">&lt;-</span><span class="va">vy</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span><span class="op">)</span><span class="op">)</span>;</span>
<span></span>
<span><span class="va">vX0</span><span class="op">&lt;-</span><span class="fl">0</span></span>
<span><span class="va">vY0</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">Sxx</span><span class="op">&lt;-</span><span class="fl">10</span> <span class="co">#Look at effects</span></span>
<span></span>
<span><span class="va">Z_direct</span><span class="op">&lt;-</span><span class="fl">2</span></span>
<span><span class="va">vcv</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>,<span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span> <span class="co">#No correlation between traits</span></span>
<span><span class="va">Xs</span><span class="op">&lt;-</span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/sim.corrs.html" class="external-link">sim.corrs</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">vcv</span><span class="op">)</span> <span class="co">#Simulated correlated BM Xs</span></span>
<span></span>
<span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/phenogram.html" class="external-link">phenogram</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">Xs</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,spread.labels<span class="op">=</span><span class="cn">TRUE</span>,spread.cost<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="co">#Plot X data</span></span>
<span><span class="co">#&gt; Optimizing the positions of the tip labels...</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-24-1.png" width="700"></p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/phenogram.html" class="external-link">phenogram</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">Xs</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,spread.labels<span class="op">=</span><span class="cn">TRUE</span>,spread.cost<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="co">#Plot X data</span></span>
<span><span class="co">#&gt; Optimizing the positions of the tip labels...</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-24-2.png" width="700"></p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">dmX</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/weight.matrix.html">weight.matrix</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>, <span class="va">a</span>, <span class="va">lineages</span><span class="op">)</span> <span class="co">#Slouch approach</span></span>
<span><span class="va">optima</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">beta</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>,<span class="fl">0.15</span>,<span class="fl">0.35</span>,<span class="fl">0.1</span><span class="op">)</span>,ncol<span class="op">=</span><span class="fl">2</span>,nrow<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="co">#Two traits on columns, two regimes on vertical</span></span>
<span></span>
<span><span class="va">mu</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="va">N</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">mu</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">&lt;-</span><span class="va">dmX</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">optima</span><span class="op">+</span><span class="va">Xs</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">beta</span><span class="op">[</span><span class="va">reg_tips</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="op">]</span><span class="op">)</span>;</span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">V</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/calc_direct_V.html">calc_direct_V</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">sigma2_y</span>,<span class="va">a</span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">&lt;-</span><span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1</span>,<span class="va">mu</span>,<span class="va">V</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">###############################################################################################################</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">Xs</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = Y ~ Xs)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co">#&gt; -0.61464 -0.13609  0.07935  0.16463  0.61405 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  2.08980    0.06595  31.685  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; Xs1          0.14188    0.04400   3.224   0.0023 ** </span></span>
<span><span class="co">#&gt; Xs2          0.58046    0.05540  10.477 6.97e-14 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 0.2857 on 47 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.7804, Adjusted R-squared:  0.771 </span></span>
<span><span class="co">#&gt; F-statistic: 83.49 on 2 and 47 DF,  p-value: 3.389e-16</span></span></code></pre></div>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">################################################################################################################</span></span>
<span></span>
<span></span>
<span><span class="co">################################################################################################################</span></span>
<span><span class="co">#Simulate errors </span></span>
<span><span class="va">Z_X_error</span><span class="op">&lt;-</span><span class="fl">2</span> <span class="co">#Number of X traits with error</span></span>
<span><span class="va">X_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0.01</span>,nrow<span class="op">=</span><span class="va">N</span>,ncol<span class="op">=</span><span class="va">Z_X_error</span><span class="op">)</span></span>
<span><span class="va">X_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">X_error</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">X_error</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X1_error"</span>,<span class="st">"X2_error"</span><span class="op">)</span></span>
<span><span class="va">Y_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Y_with_error</span><span class="op">&lt;-</span><span class="va">Y</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">X_with_error</span><span class="op">&lt;-</span><span class="va">Xs</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">X_with_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">X_with_error</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">X_with_error</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X1"</span>,<span class="st">"X2"</span><span class="op">)</span></span>
<span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Make trdata file</span></span>
<span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span>,<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Y_with_error</span>,<span class="va">Y_error</span>,<span class="va">X_with_error</span>,<span class="va">X_error</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Next we will set the priors for the estimated parameters - for this
model this includes the half-life, Vy, optima, and beta. For the latter
two parameters we will use the results of the linear model to inform our
priors.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Set Priors</span></span>
<span><span class="va">hl.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span>,<span class="fl">0.75</span><span class="op">)</span></span>
<span><span class="va">vy.prior</span><span class="op">&lt;-</span><span class="fl">5</span></span>
<span><span class="va">optima.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>,<span class="fl">0.5</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span>
<span><span class="va">beta.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.25</span><span class="op">)</span></span></code></pre></div>
<p>We will use the helper function blouch.reg.direct.prep() to setup the
dat file for Stan. Here â€œZ_directâ€ is the number of predictors, and
â€œregimesâ€ is the name of the regime column in trdata$dat.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Test Blouch prep code - Regimes + Direct Efffect model</span></span>
<span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/blouch.reg.direct.prep.html">blouch.reg.direct.prep</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="st">"Y_with_error"</span>,<span class="st">"Y_error"</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X1"</span>,<span class="st">"X2"</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X1_error"</span>,<span class="st">"X2_error"</span><span class="op">)</span>,Z_direct<span class="op">=</span><span class="fl">2</span>,<span class="st">"regimes"</span>,<span class="va">hl.prior</span>,<span class="va">vy.prior</span>,<span class="va">optima.prior</span>,<span class="va">beta.prior</span><span class="op">)</span></span></code></pre></div>
<p>Multi-optima Direct Efect Model with Varying Effects</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.direct.ve</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_direct_ve</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores<span class="op">=</span><span class="fl">2</span>,iter <span class="op">=</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span></code></pre></div>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.direct.ve</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_ve.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.19       0 0.11 0.07 0.12 0.16 0.23  0.46   764    1</span></span>
<span><span class="co">#&gt; vy        0.01       0 0.01 0.01 0.01 0.01 0.01  0.02   784    1</span></span>
<span><span class="co">#&gt; optima[1] 2.05       0 0.04 1.97 2.03 2.05 2.08  2.13  1641    1</span></span>
<span><span class="co">#&gt; optima[2] 1.13       0 0.15 0.77 1.05 1.14 1.22  1.38  1098    1</span></span>
<span><span class="co">#&gt; beta[1,1] 0.21       0 0.02 0.16 0.20 0.21 0.23  0.26  1719    1</span></span>
<span><span class="co">#&gt; beta[1,2] 0.34       0 0.03 0.28 0.32 0.34 0.36  0.40  2226    1</span></span>
<span><span class="co">#&gt; beta[2,1] 0.17       0 0.08 0.00 0.12 0.17 0.23  0.33  2273    1</span></span>
<span><span class="co">#&gt; beta[2,2] 0.24       0 0.07 0.10 0.20 0.24 0.29  0.38  1912    1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Thu Jun 20 18:47:53 2024.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span></code></pre></div>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#plot(rethinking::precis(fit.reg.direct.ve,depth=3,pars = c("hl","vy","optima","beta")))</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.direct.ve</span><span class="op">)</span></span></code></pre></div>
<p>From there the posteriors should be explored, compared to the priors,
etc. One can also use the varying effects and multilevel models on
multiple predictors in the same fashion as above.</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="multlevel-multi-optima-adaptive-model-with-varying-effects---single-predictor">Multlevel Multi-optima Adaptive Model with Varying Effects - Single
Predictor<a class="anchor" aria-label="anchor" href="#multlevel-multi-optima-adaptive-model-with-varying-effects---single-predictor"></a>
</h2>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">########################################################################################################</span></span>
<span><span class="co">#Two regimes with adaptive trait and multiple slopes per optima but single alpha parameter</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">N</span><span class="op">&lt;-</span><span class="fl">50</span> <span class="co">#Number of species</span></span>
<span><span class="co">#set.seed(1) #Set seed to get same random species each time</span></span>
<span></span>
<span><span class="va">phy</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/drop.tip.html" class="external-link">keep.tip</a></span><span class="op">(</span><span class="va">tree.10K</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">tree.10K</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">]</span><span class="op">)</span> </span>
<span><span class="va">phy</span><span class="op">&lt;-</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/multi2di.html" class="external-link">multi2di</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span></span>
<span></span>
<span><span class="va">l.tree</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/branching.times.html" class="external-link">branching.times</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span><span class="op">)</span> <span class="co">## rescale tree to height 1</span></span>
<span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">/</span><span class="va">l.tree</span> </span>
<span></span>
<span><span class="co">#Set regimes - manually - 2 regimes</span></span>
<span><span class="co">#Locate nodes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">phy</span>,no.margin<span class="op">=</span><span class="cn">TRUE</span>,edge.width<span class="op">=</span><span class="fl">2</span>,cex<span class="op">=</span><span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/nodelabels.html" class="external-link">nodelabels</a></span><span class="op">(</span>frame<span class="op">=</span><span class="st">"none"</span>,adj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.1</span>,<span class="op">-</span><span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/nodelabels.html" class="external-link">tiplabels</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-30-1.png" width="700"></p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Paint Regimes on Tree</span></span>
<span><span class="va">shifts</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">84</span><span class="op">)</span> <span class="co">#Location of nodes with regime shifts</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu">treeplyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/treeplyr/man/make.treedata.html" class="external-link">make.treedata</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">trdata</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/set.converge.regimes.html">set.converge.regimes</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="va">shifts</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; Levels: OU1 OU2</span></span>
<span><span class="co">#&gt; [1] "#E64B35FF" "#4DBBD5FF"</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-30-2.png" width="700"></p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="co">#Check if manual setting code worked</span></span>
<span><span class="va">shifts.total</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span>,<span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">node.label</span><span class="op">)</span></span>
<span><span class="va">edge.regimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">shifts.total</span><span class="op">[</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">edge</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#print(edge.regimes)</span></span>
<span></span>
<span><span class="va">reg_tips</span><span class="op">&lt;-</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span></span>
<span><span class="va">reg_tips</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">reg_tips</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">reg.colors</span> <span class="op">&lt;-</span> <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/pal_aaas.html" class="external-link">pal_aaas</a></span><span class="op">(</span><span class="st">"default"</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">reg.colors</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "#3B4992B2" "#EE0000B2"</span></span></code></pre></div>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>,edge.color <span class="op">=</span> <span class="va">reg.colors</span><span class="op">[</span><span class="va">edge.regimes</span><span class="op">]</span>, edge.width <span class="op">=</span> <span class="fl">1</span>, cex <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-30-3.png" width="700"></p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Phylogeny info</span></span>
<span><span class="va">n</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span></span>
<span></span>
<span><span class="va">regimes_internal</span> <span class="op">&lt;-</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">node.label</span></span>
<span><span class="va">regimes_tip</span> <span class="op">&lt;-</span> <span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span></span>
<span><span class="va">regimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/concat.factor.html">concat.factor</a></span><span class="op">(</span><span class="va">regimes_tip</span>, <span class="va">regimes_internal</span><span class="op">)</span></span>
<span><span class="va">anc_maps</span><span class="op">&lt;-</span><span class="st">"regimes"</span></span>
<span><span class="va">lineages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="fu"><a href="../reference/lineage.constructor.html">lineage.constructor</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>, <span class="va">e</span>, <span class="va">anc_maps</span>, <span class="va">regimes</span><span class="op">)</span><span class="op">)</span> <span class="co">#Trace lineage from tips (n) to root and determine regimes of each node or branch</span></span></code></pre></div>
<p>Simulate X and Y data</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">###############################################################################################################################################################################</span></span>
<span><span class="va">hl</span><span class="op">&lt;-</span><span class="fl">0.1</span> <span class="co">#0.1, 0.25, 0.75 - testing options</span></span>
<span><span class="va">a</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span></span>
<span><span class="va">vy</span><span class="op">&lt;-</span><span class="fl">0.01</span> <span class="co">#0.25,0.5 - testing options</span></span>
<span><span class="va">sigma2_y</span><span class="op">&lt;-</span><span class="va">vy</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span><span class="op">)</span><span class="op">)</span>;</span>
<span></span>
<span><span class="va">vX0</span><span class="op">&lt;-</span><span class="fl">0</span></span>
<span><span class="va">vY0</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">sigma2_x</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span> <span class="co">#Variance of BM Process</span></span>
<span></span>
<span></span>
<span><span class="va">X</span><span class="op">&lt;-</span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/fastBM.html" class="external-link">fastBM</a></span><span class="op">(</span><span class="va">phy</span>,a<span class="op">=</span><span class="va">vX0</span>,sig2<span class="op">=</span><span class="va">sigma2_x</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>,internal<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="co">#Simulate X BM variable on tree, with scaling 10</span></span>
<span><span class="va">Z_adaptive</span><span class="op">&lt;-</span><span class="fl">1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span></span>
<span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/phenogram.html" class="external-link">phenogram</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">X</span>,spread.labels<span class="op">=</span><span class="cn">TRUE</span>,spread.cost<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="co">#Plot X data</span></span>
<span><span class="co">#&gt; Optimizing the positions of the tip labels...</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-31-1.png" width="700"></p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">optima_matrix</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/weight.matrix.html">weight.matrix</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>, <span class="va">a</span>, <span class="va">lineages</span><span class="op">)</span> <span class="co">#Slouch approach</span></span>
<span><span class="va">pred_X</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/calc_adaptive_dmX.html">calc_adaptive_dmX</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">a</span>,<span class="va">X</span><span class="op">)</span></span>
<span><span class="va">optima</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">beta</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>,<span class="fl">0.15</span><span class="op">)</span> <span class="co">#Two Optima/Two Slopes</span></span>
<span></span>
<span><span class="va">mu</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="va">N</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">mu</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="va">optima_matrix</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">optima</span><span class="op">+</span><span class="va">beta</span><span class="op">[</span><span class="va">reg_tips</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">pred_X</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">n_reg</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">regimes</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">V</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/calc_adaptive_V.html">calc_adaptive_V</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">a</span>, <span class="va">sigma2_y</span>, <span class="va">beta</span>,  <span class="va">sigma2_x</span>, <span class="va">Z_adaptive</span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">&lt;-</span><span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1</span>,<span class="va">mu</span>,<span class="va">V</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">###############################################################################################################</span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">Y</span>,X<span class="op">=</span><span class="va">X</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">X</span>,y<span class="op">=</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-31-2.png" width="700"></p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">X</span>,<span class="va">df</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = Y ~ X, data = df)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co">#&gt; -1.0413  0.0198  0.2015  0.3198  0.4192 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  1.73203    0.07808  22.183  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; X            0.19727    0.07037   2.803  0.00728 ** </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 0.4906 on 48 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.1407, Adjusted R-squared:  0.1228 </span></span>
<span><span class="co">#&gt; F-statistic: 7.858 on 1 and 48 DF,  p-value: 0.007278</span></span></code></pre></div>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">################################################################################################################</span></span>
<span></span>
<span><span class="co">################################################################################################################</span></span>
<span><span class="co">#Simulate errors </span></span>
<span><span class="va">Z_X_error</span><span class="op">&lt;-</span><span class="fl">1</span> <span class="co">#Number of X traits with error</span></span>
<span><span class="va">X_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Y_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Y_with_error</span><span class="op">&lt;-</span><span class="va">Y</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">X_with_error</span><span class="op">&lt;-</span><span class="va">X</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Make trdata file</span></span>
<span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span>,<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Y_with_error</span>,<span class="va">Y_error</span>,<span class="va">X_with_error</span>,<span class="va">X_error</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Next we will set the priors for the estimated parameters - for this
model this includes the half-life, Vy, optima, and beta. For the latter
two parameters we will use the results of the linear model to inform our
priors.</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Set Priors</span></span>
<span><span class="va">hl.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span>,<span class="fl">0.75</span><span class="op">)</span></span>
<span><span class="va">vy.prior</span><span class="op">&lt;-</span><span class="fl">5</span></span>
<span><span class="va">optima.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>,<span class="fl">0.5</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span>
<span><span class="va">beta.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.2</span>,<span class="fl">0.25</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="exploring-priors-1">Exploring Priors<a class="anchor" aria-label="anchor" href="#exploring-priors-1"></a>
</h2>
<p>At this point one would want to explore if the priors are appropriate
- do the prior distributions look consistent with what we know about our
system? See Grabowski (in revision) for more on setting priors.</p>
<p>Half-life Prior plot</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hl.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1000</span>,meanlog<span class="op">=</span><span class="va">hl.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,sdlog<span class="op">=</span><span class="va">hl.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"prior.hl.sims"</span></span>
<span></span>
<span><span class="va">hl.prior.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.hl.sims</span>,fill<span class="op">=</span><span class="st">"prior.hl.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#labs(title="Prior vs. Posterior Distribution ",x="Half-life", y = "Density")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"Half-life"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#scale_fill_manual(labels=c("Posterior","Prior"))+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">hl</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hl.prior.plot</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-33-1.png" width="700"></p>
<p>Vy Prior Plot</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vy.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1000</span>,rate<span class="op">=</span><span class="va">vy.prior</span><span class="op">)</span></span>
<span><span class="va">vy.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">vy.sims</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vy.sims</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"prior.vy.sims"</span></span>
<span></span>
<span><span class="va">vy.prior.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.vy.sims</span>,fill<span class="op">=</span><span class="st">"prior.vy.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">vy.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#labs(title="Prior vs. Posterior Distribution ",x="vy", y = "Density")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"vy"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">vy</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#scale_fill_manual(labels=c("Posterior","Prior"))+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">vy.prior.plot</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-34-1.png" width="700"></p>
<p>Prior on how shared branch lengths correspond to covariance</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl.sims</span>;</span>
<span><span class="va">sigma2_y.sims</span><span class="op">&lt;-</span><span class="va">vy.sims</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">)</span>;</span>
<span><span class="va">beta.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">100</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span> <span class="cn">NULL</span> , xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> , ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.4</span><span class="op">)</span> , xlab<span class="op">=</span><span class="st">"Time since MRCA"</span> , ylab<span class="op">=</span><span class="st">"Covariance"</span> ,cex.axis<span class="op">=</span><span class="fl">0.75</span>, mgp<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.25</span>,<span class="fl">0.25</span>,<span class="fl">0</span><span class="op">)</span>,tcl<span class="op">=</span><span class="op">-</span><span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="fu"><a href="../reference/calc_multiadaptive_cov_plot.html">calc_multiadaptive_cov_plot</a></span><span class="op">(</span><span class="va">a.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,<span class="va">sigma2_y.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,<span class="va">beta.sims</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="va">x</span><span class="op">)</span> , add<span class="op">=</span><span class="cn">TRUE</span> , lwd<span class="op">=</span><span class="fl">4</span> , col<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/col.alpha.html" class="external-link">col.alpha</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0.15</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-35-1.png" width="700"></p>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">0.25</span>,<span class="fl">0.25</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Slope and intercept Prior Plot</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">optima.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">beta.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">100</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prior.slope.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>  </span>
<span> <span class="fu">ggplot2</span><span class="fu">::</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">Y</span>,x<span class="op">=</span><span class="va">X</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima.sims</span>,slope<span class="op">=</span><span class="va">beta.sims</span>,alpha<span class="op">=</span><span class="fl">0.15</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Adaptive X"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prior.slope.plot</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-36-1.png" width="700"></p>
<p>We will use the helper function blouch.reg.adapt.prep() to setup the
dat file for Stan. Here â€œZ_adaptiveâ€ is the number of predictors, and
â€œregimesâ€ is the name of the regime column in trdata$dat.</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Test Blouch prep code - Regimes + Direct Efffect model</span></span>
<span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/blouch.reg.adapt.prep.html">blouch.reg.adapt.prep</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="st">"Y_with_error"</span>,<span class="st">"Y_error"</span>,<span class="st">"X_with_error"</span>,<span class="st">"X_error"</span>,Z_adaptive<span class="op">=</span><span class="fl">1</span>,<span class="st">"regimes"</span>,<span class="va">hl.prior</span>,<span class="va">vy.prior</span>,<span class="va">optima.prior</span>,<span class="va">beta.prior</span><span class="op">)</span></span></code></pre></div>
<p>First we will run the Multi-optima Adaptive Model with Varying
Effects</p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.adapt.ve</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_adapt_ve</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores<span class="op">=</span><span class="fl">2</span>,iter<span class="op">=</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span></code></pre></div>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.adapt.ve</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_adapt_ve.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd  2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.17       0 0.09  0.05 0.11 0.15 0.22  0.40   701    1</span></span>
<span><span class="co">#&gt; vy        0.01       0 0.01  0.00 0.01 0.01 0.02  0.03  1551    1</span></span>
<span><span class="co">#&gt; optima[1] 1.98       0 0.05  1.87 1.95 1.98 2.01  2.09  2529    1</span></span>
<span><span class="co">#&gt; optima[2] 0.85       0 0.13  0.55 0.79 0.86 0.93  1.05   790    1</span></span>
<span><span class="co">#&gt; beta[1,1] 0.26       0 0.05  0.18 0.23 0.25 0.29  0.40   968    1</span></span>
<span><span class="co">#&gt; beta[2,1] 0.16       0 0.13 -0.11 0.06 0.16 0.25  0.42  1335    1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Thu Jun 20 18:49:12 2024.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span></code></pre></div>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.adapt.ve</span><span class="op">)</span> <span class="co">#rstan::extract posterior distribution</span></span></code></pre></div>
<p>Prior vs.Â posterior</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hl.post</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">hl</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">hl.post</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"post.hl.sims"</span></span>
<span></span>
<span><span class="va">hl.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.hl.sims</span>,fill<span class="op">=</span><span class="st">"prior.hl.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">post.hl.sims</span>,fill<span class="op">=</span><span class="st">"post.hl.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">hl.post</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#labs(title="Prior vs. Posterior Distribution ",x="Half-life", y = "Density")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"Half-life"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#scale_fill_manual(labels=c("Posterior","Prior"))+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">hl</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Posterior"</span>,<span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hl.plot</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-40-1.png" width="700"></p>
<p>Prior vs.Â posterior plot</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vy.post</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">vy</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vy.post</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"post.vy.sims"</span></span>
<span></span>
<span><span class="va">vy.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.vy.sims</span>,fill<span class="op">=</span><span class="st">"prior.vy.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">vy.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">post.vy.sims</span>,fill<span class="op">=</span><span class="st">"post.vy.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">vy.post</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#labs(title="Prior vs. Posterior Distribution ",x="vy", y = "Density")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"vy"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">vy</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#scale_fill_manual(labels=c("Posterior","Prior"))+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Posterior"</span>,<span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vy.plot</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-41-1.png" width="700"></p>
<p>Adaptation model</p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl.sims</span>;</span>
<span><span class="va">sigma2_y.sims</span><span class="op">&lt;-</span><span class="va">vy.sims</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">)</span>;</span>
<span><span class="va">beta.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">100</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span> <span class="cn">NULL</span> , xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> , ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.3</span><span class="op">)</span> , xlab<span class="op">=</span><span class="st">"Time since MRCA"</span> , ylab<span class="op">=</span><span class="st">"Covariance"</span> ,cex.axis<span class="op">=</span><span class="fl">0.75</span>, mgp<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.25</span>,<span class="fl">0.25</span>,<span class="fl">0</span><span class="op">)</span>,tcl<span class="op">=</span><span class="op">-</span><span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="fu"><a href="../reference/calc_multiadaptive_cov_plot.html">calc_multiadaptive_cov_plot</a></span><span class="op">(</span><span class="va">a.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,<span class="va">sigma2_y.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,<span class="va">beta.sims</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="va">x</span><span class="op">)</span> , add<span class="op">=</span><span class="cn">TRUE</span> , lwd<span class="op">=</span><span class="fl">4</span> , col<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/col.alpha.html" class="external-link">col.alpha</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0.15</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="fu"><a href="../reference/calc_multiadaptive_cov_plot.html">calc_multiadaptive_cov_plot</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">a</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="va">post</span><span class="op">$</span><span class="va">sigma2_y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">beta</span><span class="op">)</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op">)</span>,<span class="va">x</span><span class="op">)</span> , add<span class="op">=</span><span class="cn">TRUE</span> , lwd<span class="op">=</span><span class="fl">4</span> , col<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/col.alpha.html" class="external-link">col.alpha</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co">#curve(calc_multiadaptive_cov(post$a[i],post$sigma2_y[i],beta,x,Z_adaptive,n_reg) , add=TRUE , lwd=4 , col=col.alpha(2,0.5))</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-42-1.png" width="700"></p>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#multiple traits</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">0.25</span>,<span class="fl">0.25</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">covariance.plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/recordplot.html" class="external-link">recordPlot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; null device </span></span>
<span><span class="co">#&gt;           1</span></span></code></pre></div>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Vt = sigma2_y /( 2 * a) * ((1 - exp(-2 * a * ta)) .* exp(-a * tij)); //From Hansen (1997)</span></span>
<span></span>
<span><span class="va">covariance.plot</span></span></code></pre></div>
<p>Priors + Posteriors</p>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">optima.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">beta.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">100</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">optima.post</span><span class="op">&lt;-</span><span class="va">post</span><span class="op">$</span><span class="va">optima</span></span>
<span><span class="va">beta.post</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">beta</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">beta.post</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"post.beta.1"</span>,<span class="st">"post.beta.2"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mu.link.11</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x.seq</span><span class="op">)</span><span class="op">{</span><span class="va">optima.post</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">+</span><span class="va">x.seq</span><span class="op">*</span><span class="va">beta.post</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">}</span></span>
<span><span class="va">mu.link.12</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x.seq</span><span class="op">)</span><span class="op">{</span><span class="va">optima.post</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">+</span><span class="va">x.seq</span><span class="op">*</span><span class="va">beta.post</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">}</span></span>
<span></span>
<span><span class="va">x.seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, to<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> , length.out<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">mu.11</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">x.seq</span> , <span class="va">mu.link.11</span> <span class="op">)</span></span>
<span><span class="va">mu.12</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">x.seq</span> , <span class="va">mu.link.12</span> <span class="op">)</span></span>
<span></span>
<span><span class="co">#mu.mean.11 &lt;-lapply( mu.11 , mean )</span></span>
<span><span class="co">#mu.mean.12 &lt;-lapply( mu.12 , mean )</span></span>
<span></span>
<span><span class="va">mu.mean.11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">mu.11</span><span class="op">)</span></span>
<span><span class="va">mu.mean.12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">mu.12</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mu.mean.11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mu.mean.11</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mu.mean.12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mu.mean.12</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.mean.11</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"mu.mean.11"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.mean.12</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"mu.mean.12"</span></span>
<span></span>
<span><span class="va">mu.CI.11</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span> <span class="va">mu.11</span> , MARGIN<span class="op">=</span><span class="fl">2</span>, FUN<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/rethinking/man/HPDI.html" class="external-link">PI</a></span> , prob<span class="op">=</span><span class="fl">0.89</span> <span class="op">)</span></span>
<span><span class="va">mu.CI.12</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span> <span class="va">mu.12</span> , MARGIN<span class="op">=</span><span class="fl">2</span>, FUN<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/rethinking/man/HPDI.html" class="external-link">PI</a></span> , prob<span class="op">=</span><span class="fl">0.89</span> <span class="op">)</span></span>
<span></span>
<span><span class="co">#mu.CI.11 &lt;- lapply( mu.11 , PI , prob=0.89 )</span></span>
<span><span class="co">#mu.CI.12 &lt;- lapply( mu.12 , PI , prob=0.89 )</span></span>
<span><span class="va">mu.CI.11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mu.CI.11</span><span class="op">)</span><span class="op">)</span>,<span class="va">x.seq</span><span class="op">)</span></span>
<span><span class="va">mu.CI.12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mu.CI.12</span><span class="op">)</span><span class="op">)</span>,<span class="va">x.seq</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.CI.11</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"min.5.5"</span>,<span class="st">"max.94.5"</span>,<span class="st">"x.seq"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.CI.12</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"min.5.5"</span>,<span class="st">"max.94.5"</span>,<span class="st">"x.seq"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#df&lt;-data.frame(Y=stan_sim_data$Y,X=stan_sim_data$direct_cov)</span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">dat</span><span class="op">$</span><span class="va">Y_obs</span>,X<span class="op">=</span><span class="va">dat</span><span class="op">$</span><span class="va">X_obs</span>,Regimes<span class="op">=</span><span class="va">regimes_tip</span><span class="op">)</span></span>
<span><span class="va">df11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x.seq</span>,<span class="va">mu.mean.11</span><span class="op">)</span></span>
<span><span class="va">df12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x.seq</span>,<span class="va">mu.mean.12</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">#slope.prior.plot&lt;-ggplot(data=reg.trdata$dat,aes(y=Sim1,x=X))+</span></span>
<span><span class="va">slope.plot.1</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">Y</span>,x<span class="op">=</span><span class="va">X</span>,color<span class="op">=</span><span class="va">Regimes</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima.sims</span>,slope<span class="op">=</span><span class="va">beta.sims</span>,alpha<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span><span class="op">+</span> <span class="co">#Prior</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df11</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,y<span class="op">=</span><span class="va">mu.mean.11</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mu.CI.11</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,ymin<span class="op">=</span><span class="va">min.5.5</span>,ymax<span class="op">=</span><span class="va">max.94.5</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span>,alpha<span class="op">=</span><span class="fl">0.25</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df12</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,y<span class="op">=</span><span class="va">mu.mean.12</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mu.CI.12</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,ymin<span class="op">=</span><span class="va">min.5.5</span>,ymax<span class="op">=</span><span class="va">max.94.5</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span>,alpha<span class="op">=</span><span class="fl">0.25</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#ggtitle("Prior vs. Posterior for Intercept and Slope")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Adaptive trait"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">slope.plot.1</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-43-1.png" width="700"></p>
<p>Multilevel Multi-optima Adaptive Model with Varying Effects Next we
will set the priors for the estimated parameters - for this model this
includes the half-life, Vy, optima, and beta. For the latter two
parameters we will use the results of the linear model to inform our
priors.</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Set Priors</span></span>
<span><span class="va">hl.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span>,<span class="fl">0.75</span><span class="op">)</span></span>
<span><span class="va">vy.prior</span><span class="op">&lt;-</span><span class="fl">5</span></span>
<span><span class="va">optima.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>,<span class="fl">0.5</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span>
<span><span class="va">beta.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.2</span>,<span class="fl">0.25</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span>
<span><span class="va">sigma.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>We will use the helper function blouch.reg.adapt.prep() to setup the
dat file for Stan. Here â€œZ_adaptiveâ€ is the number of predictors, and
â€œregimesâ€ is the name of the regime column in trdata$dat.</p>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Test Blouch prep code - Regimes + Direct Efffect model</span></span>
<span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/blouch.reg.adapt.mlm.prep.html">blouch.reg.adapt.mlm.prep</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="st">"Y_with_error"</span>,<span class="st">"Y_error"</span>,<span class="st">"X_with_error"</span>,<span class="st">"X_error"</span>,Z_adaptive<span class="op">=</span><span class="fl">1</span>,<span class="st">"regimes"</span>,<span class="va">hl.prior</span>,<span class="va">vy.prior</span>,<span class="va">optima.prior</span>,<span class="va">beta.prior</span>,<span class="va">sigma.prior</span><span class="op">)</span></span></code></pre></div>
<p>Now we run the Multilevel Multi-optima Adaptive Model with Varying
Effects, look at the results, and rstan::extract the posterior</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.adapt.mlm.ve</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_adapt_mlm_ve</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores<span class="op">=</span><span class="fl">2</span>,iter<span class="op">=</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Warning: There were 250 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span></code></pre></div>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.adapt.mlm.ve</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span>,<span class="st">"sigma"</span>,<span class="st">"optima_bar"</span>,<span class="st">"beta_bar"</span>,<span class="st">"Rho"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_adapt_mlm_ve.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;             mean se_mean   sd  2.5%   25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl          0.21    0.01 0.14  0.06  0.12 0.18 0.27  0.59   348    1</span></span>
<span><span class="co">#&gt; vy          0.01    0.00 0.01  0.00  0.01 0.01 0.02  0.03   600    1</span></span>
<span><span class="co">#&gt; optima[1]   1.99    0.00 0.06  1.87  1.95 1.98 2.02  2.11   943    1</span></span>
<span><span class="co">#&gt; optima[2]   0.78    0.01 0.21  0.20  0.71 0.82 0.91  1.04   403    1</span></span>
<span><span class="co">#&gt; beta[1,1]   0.28    0.00 0.08  0.18  0.23 0.26 0.31  0.50   395    1</span></span>
<span><span class="co">#&gt; beta[2,1]   0.21    0.01 0.15 -0.10  0.12 0.21 0.30  0.52   591    1</span></span>
<span><span class="co">#&gt; sigma[1]    0.92    0.01 0.41  0.37  0.62 0.85 1.12  1.94  1520    1</span></span>
<span><span class="co">#&gt; sigma[2]    0.29    0.01 0.30  0.02  0.08 0.18 0.38  1.05   902    1</span></span>
<span><span class="co">#&gt; optima_bar  1.45    0.01 0.37  0.72  1.22 1.44 1.69  2.22  1351    1</span></span>
<span><span class="co">#&gt; beta_bar[1] 0.23    0.00 0.15 -0.08  0.15 0.24 0.32  0.53  1078    1</span></span>
<span><span class="co">#&gt; Rho[1,1]    1.00     NaN 0.00  1.00  1.00 1.00 1.00  1.00   NaN  NaN</span></span>
<span><span class="co">#&gt; Rho[1,2]    0.07    0.01 0.45 -0.77 -0.28 0.07 0.42  0.84  1022    1</span></span>
<span><span class="co">#&gt; Rho[2,1]    0.07    0.01 0.45 -0.77 -0.28 0.07 0.42  0.84  1022    1</span></span>
<span><span class="co">#&gt; Rho[2,2]    1.00    0.00 0.00  1.00  1.00 1.00 1.00  1.00  1682    1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Thu Jun 20 18:51:15 2024.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span></code></pre></div>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.adapt.mlm.ve</span><span class="op">)</span> <span class="co">#rstan::extract posterior distribution</span></span></code></pre></div>
<p>Now we run the non-centered version of the Multilevel Multi-optima
Adaptive Model with Varying Effects</p>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.adapt.mlm.ve.nc</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_adapt_mlm_ve_nc</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores<span class="op">=</span><span class="fl">2</span>,iter<span class="op">=</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Warning: There were 6 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span></code></pre></div>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.adapt.mlm.ve</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span>,<span class="st">"sigma"</span>,<span class="st">"optima_bar"</span>,<span class="st">"beta_bar"</span>,<span class="st">"Rho"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_adapt_mlm_ve.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;             mean se_mean   sd  2.5%   25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl          0.21    0.01 0.14  0.06  0.12 0.18 0.27  0.59   348    1</span></span>
<span><span class="co">#&gt; vy          0.01    0.00 0.01  0.00  0.01 0.01 0.02  0.03   600    1</span></span>
<span><span class="co">#&gt; optima[1]   1.99    0.00 0.06  1.87  1.95 1.98 2.02  2.11   943    1</span></span>
<span><span class="co">#&gt; optima[2]   0.78    0.01 0.21  0.20  0.71 0.82 0.91  1.04   403    1</span></span>
<span><span class="co">#&gt; beta[1,1]   0.28    0.00 0.08  0.18  0.23 0.26 0.31  0.50   395    1</span></span>
<span><span class="co">#&gt; beta[2,1]   0.21    0.01 0.15 -0.10  0.12 0.21 0.30  0.52   591    1</span></span>
<span><span class="co">#&gt; sigma[1]    0.92    0.01 0.41  0.37  0.62 0.85 1.12  1.94  1520    1</span></span>
<span><span class="co">#&gt; sigma[2]    0.29    0.01 0.30  0.02  0.08 0.18 0.38  1.05   902    1</span></span>
<span><span class="co">#&gt; optima_bar  1.45    0.01 0.37  0.72  1.22 1.44 1.69  2.22  1351    1</span></span>
<span><span class="co">#&gt; beta_bar[1] 0.23    0.00 0.15 -0.08  0.15 0.24 0.32  0.53  1078    1</span></span>
<span><span class="co">#&gt; Rho[1,1]    1.00     NaN 0.00  1.00  1.00 1.00 1.00  1.00   NaN  NaN</span></span>
<span><span class="co">#&gt; Rho[1,2]    0.07    0.01 0.45 -0.77 -0.28 0.07 0.42  0.84  1022    1</span></span>
<span><span class="co">#&gt; Rho[2,1]    0.07    0.01 0.45 -0.77 -0.28 0.07 0.42  0.84  1022    1</span></span>
<span><span class="co">#&gt; Rho[2,2]    1.00    0.00 0.00  1.00  1.00 1.00 1.00  1.00  1682    1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Thu Jun 20 18:51:15 2024.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span></code></pre></div>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.adapt.mlm.ve</span><span class="op">)</span> <span class="co">#rstan::extract posterior distribution</span></span></code></pre></div>
<p>From there the posteriors should be explored, compared to the priors,
etc. following the format above</p>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="multi-optima-direct-effect-and-adaptive-models-with-varying-effects---multiple-predictors">Multi-optima Direct Effect and Adaptive models with Varying Effects
- Multiple predictors<a class="anchor" aria-label="anchor" href="#multi-optima-direct-effect-and-adaptive-models-with-varying-effects---multiple-predictors"></a>
</h2>
<p>Two regimes with 1 direct and 1 adaptive trait and two slopes per
regime per trait</p>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">########################################################################################################</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">N</span><span class="op">&lt;-</span><span class="fl">50</span> <span class="co">#Number of species</span></span>
<span><span class="co">#set.seed(1) #Set seed to get same random species each time</span></span>
<span></span>
<span><span class="va">phy</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/drop.tip.html" class="external-link">keep.tip</a></span><span class="op">(</span><span class="va">tree.10K</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">tree.10K</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">]</span><span class="op">)</span> </span>
<span><span class="va">phy</span><span class="op">&lt;-</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/multi2di.html" class="external-link">multi2di</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span></span>
<span></span>
<span><span class="va">l.tree</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/branching.times.html" class="external-link">branching.times</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span><span class="op">)</span> <span class="co">## rescale tree to height 1</span></span>
<span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">/</span><span class="va">l.tree</span> </span>
<span></span>
<span><span class="co">#Set regimes - manually - 2 regimes</span></span>
<span><span class="co">#Locate nodes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">phy</span>,no.margin<span class="op">=</span><span class="cn">TRUE</span>,edge.width<span class="op">=</span><span class="fl">2</span>,cex<span class="op">=</span><span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/nodelabels.html" class="external-link">nodelabels</a></span><span class="op">(</span>frame<span class="op">=</span><span class="st">"none"</span>,adj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.1</span>,<span class="op">-</span><span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/nodelabels.html" class="external-link">tiplabels</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-51-1.png" width="700"></p>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Paint Regimes on Tree</span></span>
<span><span class="va">shifts</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">84</span><span class="op">)</span> <span class="co">#Location of nodes with regime shifts</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu">treeplyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/treeplyr/man/make.treedata.html" class="external-link">make.treedata</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">trdata</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/set.converge.regimes.html">set.converge.regimes</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="va">shifts</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; Levels: OU1 OU2</span></span>
<span><span class="co">#&gt; [1] "#E64B35FF" "#4DBBD5FF"</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-51-2.png" width="700"></p>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Check if manual setting code worked</span></span>
<span><span class="va">shifts.total</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span>,<span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">node.label</span><span class="op">)</span></span>
<span><span class="va">edge.regimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">shifts.total</span><span class="op">[</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">edge</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">edge.regimes</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; Levels: OU1 OU2</span></span></code></pre></div>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">reg_tips</span><span class="op">&lt;-</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span></span>
<span><span class="va">reg_tips</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">reg_tips</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">reg.colors</span> <span class="op">&lt;-</span> <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/pal_aaas.html" class="external-link">pal_aaas</a></span><span class="op">(</span><span class="st">"default"</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">reg.colors</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "#3B4992B2" "#EE0000B2"</span></span></code></pre></div>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>,edge.color <span class="op">=</span> <span class="va">reg.colors</span><span class="op">[</span><span class="va">edge.regimes</span><span class="op">]</span>, edge.width <span class="op">=</span> <span class="fl">1</span>, cex <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-51-3.png" width="700"></p>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Phylogeny info</span></span>
<span><span class="va">n</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span></span>
<span></span>
<span><span class="va">regimes_internal</span> <span class="op">&lt;-</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">node.label</span></span>
<span><span class="va">regimes_tip</span> <span class="op">&lt;-</span> <span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span></span>
<span><span class="va">regimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/concat.factor.html">concat.factor</a></span><span class="op">(</span><span class="va">regimes_tip</span>, <span class="va">regimes_internal</span><span class="op">)</span></span>
<span><span class="va">anc_maps</span><span class="op">&lt;-</span><span class="st">"regimes"</span></span>
<span><span class="va">lineages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="fu"><a href="../reference/lineage.constructor.html">lineage.constructor</a></span><span class="op">(</span><span class="va">phy</span>, <span class="va">e</span>, <span class="va">anc_maps</span>, <span class="va">regimes</span><span class="op">)</span><span class="op">)</span> <span class="co">#Trace lineage from tips (n) to root and determine regimes of each node or branch</span></span></code></pre></div>
<p>Simulate X and Y data using generative model</p>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">################################################################################################################</span></span>
<span><span class="va">hl</span><span class="op">&lt;-</span><span class="fl">0.1</span> <span class="co">#0.1, 0.25, 0.75 - testing options</span></span>
<span><span class="va">a</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span></span>
<span><span class="va">vy</span><span class="op">&lt;-</span><span class="fl">0.01</span> <span class="co">#0.25,0.5 - testing options</span></span>
<span><span class="va">sigma2_y</span><span class="op">&lt;-</span><span class="va">vy</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span><span class="op">)</span><span class="op">)</span>;</span>
<span></span>
<span><span class="va">vX0</span><span class="op">&lt;-</span><span class="fl">0</span></span>
<span><span class="va">vY0</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">sigma2_x</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span> <span class="co">#Variance of BM Process</span></span>
<span></span>
<span><span class="va">Xa</span><span class="op">&lt;-</span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/fastBM.html" class="external-link">fastBM</a></span><span class="op">(</span><span class="va">phy</span>,a<span class="op">=</span><span class="va">vX0</span>,sig2<span class="op">=</span><span class="va">sigma2_x</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>,internal<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="co">#Simulate X BM variable on tree, with scaling 10</span></span>
<span><span class="va">Xd</span><span class="op">&lt;-</span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/fastBM.html" class="external-link">fastBM</a></span><span class="op">(</span><span class="va">phy</span>,a<span class="op">=</span><span class="va">vX0</span>,sig2<span class="op">=</span><span class="va">sigma2_x</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>,internal<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="co">#Simulate X BM variable on tree, with scaling 10</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">Xa</span><span class="op">)</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">Xd</span><span class="op">)</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span></span>
<span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/phenogram.html" class="external-link">phenogram</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">Xd</span>,spread.labels<span class="op">=</span><span class="cn">TRUE</span>,spread.cost<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="co">#Plot X data</span></span>
<span><span class="co">#&gt; Optimizing the positions of the tip labels...</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-52-1.png" width="700"></p>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/phenogram.html" class="external-link">phenogram</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">Xa</span>,spread.labels<span class="op">=</span><span class="cn">TRUE</span>,spread.cost<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="co">#Plot X data</span></span>
<span><span class="co">#&gt; Optimizing the positions of the tip labels...</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-52-2.png" width="700"></p>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">Xs</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Xd</span>,<span class="va">Xa</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Z_adaptive</span><span class="op">&lt;-</span><span class="fl">1</span></span>
<span><span class="va">Z_direct</span><span class="op">&lt;-</span><span class="fl">1</span></span>
<span></span>
<span><span class="va">optima_matrix</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/weight.matrix.html">weight.matrix</a></span><span class="op">(</span><span class="va">phy</span>, <span class="va">a</span>, <span class="va">lineages</span><span class="op">)</span> <span class="co">#Slouch approach</span></span>
<span><span class="va">pred_X</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/calc_mixed_dmX.html">calc_mixed_dmX</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">a</span>,<span class="va">Xs</span>,<span class="va">Z_direct</span>,<span class="va">Z_adaptive</span><span class="op">)</span></span>
<span><span class="va">optima</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1.5</span><span class="op">)</span></span>
<span><span class="va">beta</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>,<span class="fl">0.15</span>,<span class="fl">0.35</span>,<span class="fl">0.1</span><span class="op">)</span>,ncol<span class="op">=</span><span class="fl">2</span>,nrow<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="co">#Direct efect - column 1, Adaptive, column 2, slopes for regimes on rows</span></span>
<span></span>
<span><span class="va">mu</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="va">N</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">mu</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="va">optima_matrix</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">optima</span><span class="op">+</span><span class="va">pred_X</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">beta</span><span class="op">[</span><span class="va">reg_tips</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span><span class="va">n_reg</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">regimes</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">V</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/calc_adaptive_V.html">calc_adaptive_V</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">a</span>, <span class="va">sigma2_y</span>, <span class="va">beta</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,  <span class="va">sigma2_x</span>, <span class="va">Z_adaptive</span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">&lt;-</span><span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1</span>,<span class="va">mu</span>,<span class="va">V</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">###############################################################################################################</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">Xs</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = Y ~ Xs)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co">#&gt; -0.93155 -0.21355  0.02408  0.20233  0.83227 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  2.04855    0.08586   23.86   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; XsXd         0.29710    0.02281   13.03   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; XsXa         0.29441    0.01812   16.25   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 0.3719 on 47 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.9352, Adjusted R-squared:  0.9324 </span></span>
<span><span class="co">#&gt; F-statistic: 339.1 on 2 and 47 DF,  p-value: &lt; 2.2e-16</span></span></code></pre></div>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">################################################################################################################</span></span></code></pre></div>
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">###############################################################################################################</span></span>
<span><span class="co">#Simulate errors - original Hansen setup</span></span>
<span><span class="va">Z_X_error</span><span class="op">&lt;-</span><span class="fl">2</span> <span class="co">#Number of X traits with error</span></span>
<span><span class="va">X_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0.01</span>,nrow<span class="op">=</span><span class="va">N</span>,ncol<span class="op">=</span><span class="va">Z_X_error</span><span class="op">)</span></span>
<span><span class="va">X_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">X_error</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">X_error</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Xd_error"</span>,<span class="st">"Xa_error"</span><span class="op">)</span></span>
<span><span class="va">Y_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Y_with_error</span><span class="op">&lt;-</span><span class="va">Y</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">X_with_error</span><span class="op">&lt;-</span><span class="va">Xs</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">X_with_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">X_with_error</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">X_with_error</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Xd"</span>,<span class="st">"Xa"</span><span class="op">)</span></span>
<span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Make trdata file</span></span>
<span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span>,<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Y_with_error</span>,<span class="va">Y_error</span>,<span class="va">X_with_error</span>,<span class="va">X_error</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#names(trdata$dat)[6:7]&lt;-c("Xd_error","Xa_error")</span></span></code></pre></div>
<p>Plot Data</p>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Plot of data</span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">Y_with_error</span>,Xd<span class="op">=</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">Xd</span>,Xa<span class="op">=</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">Xa</span>,Regimes<span class="op">=</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">#slope.prior.plot&lt;-ggplot(data=reg.trdata$dat,aes(y=Sim1,x=X))+</span></span>
<span><span class="va">slope.plot.1</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">Y</span>,x<span class="op">=</span><span class="va">Xd</span>,color<span class="op">=</span><span class="va">Regimes</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#ggtitle("Prior vs. Posterior for Intercept and Slope")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Direct effect trait"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">slope.plot.1</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-54-1.png" width="700"></p>
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#slope.prior.plot&lt;-ggplot(data=reg.trdata$dat,aes(y=Sim1,x=X))+</span></span>
<span><span class="va">slope.plot.2</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">Y</span>,x<span class="op">=</span><span class="va">Xa</span>,color<span class="op">=</span><span class="va">Regimes</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#ggtitle("Prior vs. Posterior for Intercept and Slope")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Adaptive trait"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">slope.plot.2</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-54-2.png" width="700"></p>
<p>Next we will set the priors for the estimated parameters - for this
model this includes the half-life, Vy, optima, and beta. For the latter
two parameters we will use the results of the linear model to inform our
priors.</p>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Set Priors</span></span>
<span><span class="va">hl.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span>,<span class="fl">0.75</span><span class="op">)</span></span>
<span><span class="va">vy.prior</span><span class="op">&lt;-</span><span class="fl">20</span></span>
<span><span class="va">optima.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>,<span class="fl">0.25</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span>
<span><span class="va">beta.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.25</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="exploring-priors-2">Exploring Priors<a class="anchor" aria-label="anchor" href="#exploring-priors-2"></a>
</h2>
<p>At this point one would want to explore if the priors are appropriate
- do the prior distributions look consistent with what we know about our
system? See Grabowski (in revision) for more on setting priors.</p>
<p>Half-life Prior plot</p>
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hl.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1000</span>,meanlog<span class="op">=</span><span class="va">hl.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,sdlog<span class="op">=</span><span class="va">hl.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"prior.hl.sims"</span></span>
<span></span>
<span><span class="va">hl.prior.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.hl.sims</span>,fill<span class="op">=</span><span class="st">"prior.hl.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#labs(title="Prior vs. Posterior Distribution ",x="Half-life", y = "Density")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"Half-life"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#scale_fill_manual(labels=c("Posterior","Prior"))+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">hl</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hl.prior.plot</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-56-1.png" width="700"></p>
<p>Vy Prior Plot</p>
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vy.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1000</span>,rate<span class="op">=</span><span class="va">vy.prior</span><span class="op">)</span></span>
<span><span class="va">vy.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">vy.sims</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vy.sims</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"prior.vy.sims"</span></span>
<span></span>
<span><span class="va">vy.prior.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.vy.sims</span>,fill<span class="op">=</span><span class="st">"prior.vy.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">vy.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#labs(title="Prior vs. Posterior Distribution ",x="vy", y = "Density")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"vy"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">vy</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#scale_fill_manual(labels=c("Posterior","Prior"))+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">vy.prior.plot</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-57-1.png" width="700"></p>
<p>Prior on how shared branch lengths correspond to covariance</p>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl.sims</span>;</span>
<span><span class="va">sigma2_y.sims</span><span class="op">&lt;-</span><span class="va">vy.sims</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">)</span>;</span>
<span><span class="va">beta.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">100</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span> <span class="cn">NULL</span> , xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> , ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.4</span><span class="op">)</span> , xlab<span class="op">=</span><span class="st">"Time since MRCA"</span> , ylab<span class="op">=</span><span class="st">"Covariance"</span> ,cex.axis<span class="op">=</span><span class="fl">0.75</span>, mgp<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.25</span>,<span class="fl">0.25</span>,<span class="fl">0</span><span class="op">)</span>,tcl<span class="op">=</span><span class="op">-</span><span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="fu"><a href="../reference/calc_multiadaptive_cov_plot.html">calc_multiadaptive_cov_plot</a></span><span class="op">(</span><span class="va">a.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,<span class="va">sigma2_y.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,<span class="va">beta.sims</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="va">x</span><span class="op">)</span> , add<span class="op">=</span><span class="cn">TRUE</span> , lwd<span class="op">=</span><span class="fl">4</span> , col<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/col.alpha.html" class="external-link">col.alpha</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0.15</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-58-1.png" width="700"></p>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">0.25</span>,<span class="fl">0.25</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Slope and intercept Prior Plot</p>
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">optima.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">beta.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">100</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prior.slope.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>  </span>
<span> <span class="fu">ggplot2</span><span class="fu">::</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">Y</span>,x<span class="op">=</span><span class="va">Xd</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima.sims</span>,slope<span class="op">=</span><span class="va">beta.sims</span>,alpha<span class="op">=</span><span class="fl">0.15</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Direct Effect X"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prior.slope.plot</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-59-1.png" width="700"></p>
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">prior.slope.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>  </span>
<span> <span class="fu">ggplot2</span><span class="fu">::</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">Y</span>,x<span class="op">=</span><span class="va">Xa</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima.sims</span>,slope<span class="op">=</span><span class="va">beta.sims</span>,alpha<span class="op">=</span><span class="fl">0.15</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Adaptive X"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prior.slope.plot</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-59-2.png" width="700"></p>
<p>We will use the helper function blouch.reg.adapt.prep() to setup the
dat file for Stan. Here â€œZ_adaptiveâ€ is the number of predictors, and
â€œregimesâ€ is the name of the regime column in trdata$dat.</p>
<div class="sourceCode" id="cb109"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/blouch.reg.direct.adapt.prep.html">blouch.reg.direct.adapt.prep</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="st">"Y_with_error"</span>,<span class="st">"Y_error"</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Xd"</span>,<span class="st">"Xa"</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Xd_error"</span>,<span class="st">"Xa_error"</span><span class="op">)</span>,Z_direct<span class="op">=</span><span class="fl">1</span>,Z_adaptive<span class="op">=</span><span class="fl">1</span>,<span class="st">"regimes"</span>,<span class="va">hl.prior</span>,<span class="va">vy.prior</span>,<span class="va">optima.prior</span>,<span class="va">beta.prior</span><span class="op">)</span></span></code></pre></div>
<p>First we run the Multi-optima Direct Effect Adaptive Model with
Varying Effects</p>
<div class="sourceCode" id="cb110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.direct.adapt.ve</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_direct_adapt_ve</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores<span class="op">=</span><span class="fl">2</span>,iter<span class="op">=</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span></code></pre></div>
<p>Letâ€™s look at the results</p>
<div class="sourceCode" id="cb111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.direct.adapt.ve</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_adapt_ve.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd  2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.16       0 0.08  0.06 0.10 0.14 0.19  0.38   873    1</span></span>
<span><span class="co">#&gt; vy        0.01       0 0.01  0.00 0.00 0.01 0.02  0.05  2620    1</span></span>
<span><span class="co">#&gt; optima[1] 1.81       0 0.14  1.53 1.73 1.82 1.90  2.07  2917    1</span></span>
<span><span class="co">#&gt; optima[2] 1.47       0 0.21  1.04 1.32 1.47 1.62  1.88  3307    1</span></span>
<span><span class="co">#&gt; beta[1,1] 0.24       0 0.03  0.18 0.22 0.24 0.25  0.30  4302    1</span></span>
<span><span class="co">#&gt; beta[1,2] 0.39       0 0.05  0.33 0.36 0.38 0.41  0.53   890    1</span></span>
<span><span class="co">#&gt; beta[2,1] 0.16       0 0.05  0.06 0.12 0.16 0.19  0.26  2772    1</span></span>
<span><span class="co">#&gt; beta[2,2] 0.10       0 0.08 -0.06 0.04 0.10 0.15  0.25  3406    1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Thu Jun 20 18:58:00 2024.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span></code></pre></div>
<div class="sourceCode" id="cb112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.direct.adapt.ve</span><span class="op">)</span></span></code></pre></div>
<p>Rember, the true values are optima&lt;-c(2,1)
beta&lt;-data.frame(matrix(c(0.25,0.15,0.35,0.1),ncol=2,nrow=2)) Direct
effect - column 1, Adaptive, column 2, rows - slopes for regimes</p>
<p>Prior vs.Â posterior</p>
<div class="sourceCode" id="cb113"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hl.post</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">hl</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">hl.post</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"post.hl.sims"</span></span>
<span></span>
<span><span class="va">hl.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.hl.sims</span>,fill<span class="op">=</span><span class="st">"prior.hl.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">post.hl.sims</span>,fill<span class="op">=</span><span class="st">"post.hl.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">hl.post</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#labs(title="Prior vs. Posterior Distribution ",x="Half-life", y = "Density")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"Half-life"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#scale_fill_manual(labels=c("Posterior","Prior"))+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">hl</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Posterior"</span>,<span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hl.plot</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-63-1.png" width="700"></p>
<p>Prior vs.Â posterior plot</p>
<div class="sourceCode" id="cb114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vy.post</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">vy</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vy.post</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"post.vy.sims"</span></span>
<span></span>
<span><span class="va">vy.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.vy.sims</span>,fill<span class="op">=</span><span class="st">"prior.vy.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">vy.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">post.vy.sims</span>,fill<span class="op">=</span><span class="st">"post.vy.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">vy.post</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#labs(title="Prior vs. Posterior Distribution ",x="vy", y = "Density")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"vy"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">vy</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#scale_fill_manual(labels=c("Posterior","Prior"))+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Posterior"</span>,<span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vy.plot</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-64-1.png" width="700"></p>
<p>Adaptation model</p>
<div class="sourceCode" id="cb115"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl.sims</span>;</span>
<span><span class="va">sigma2_y.sims</span><span class="op">&lt;-</span><span class="va">vy.sims</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">)</span>;</span>
<span><span class="va">beta.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">100</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span> <span class="cn">NULL</span> , xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> , ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.3</span><span class="op">)</span> , xlab<span class="op">=</span><span class="st">"Time since MRCA"</span> , ylab<span class="op">=</span><span class="st">"Covariance"</span> ,cex.axis<span class="op">=</span><span class="fl">0.75</span>, mgp<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.25</span>,<span class="fl">0.25</span>,<span class="fl">0</span><span class="op">)</span>,tcl<span class="op">=</span><span class="op">-</span><span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="fu"><a href="../reference/calc_multiadaptive_cov_plot.html">calc_multiadaptive_cov_plot</a></span><span class="op">(</span><span class="va">a.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,<span class="va">sigma2_y.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,<span class="va">beta.sims</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="va">x</span><span class="op">)</span> , add<span class="op">=</span><span class="cn">TRUE</span> , lwd<span class="op">=</span><span class="fl">4</span> ,</span>
<span>  <span class="co">#curve(calc_multiadaptive_cov_plot(a.sims[i,],sigma2_y.sims[i,],beta.sims[i,],x) , add=TRUE , lwd=4 ,</span></span>
<span>        col<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/col.alpha.html" class="external-link">col.alpha</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0.15</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="fu"><a href="../reference/calc_multiadaptive_cov_plot.html">calc_multiadaptive_cov_plot</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">a</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="va">post</span><span class="op">$</span><span class="va">sigma2_y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">beta</span><span class="op">)</span><span class="op">[</span><span class="va">i</span>,,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>,<span class="va">x</span><span class="op">)</span> , add<span class="op">=</span><span class="cn">TRUE</span> , lwd<span class="op">=</span><span class="fl">4</span> , col<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/col.alpha.html" class="external-link">col.alpha</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co">#curve(calc_multiadaptive_cov(post$a[i],post$sigma2_y[i],beta,x,Z_adaptive,n_reg) , add=TRUE , lwd=4 , col=col.alpha(2,0.5))</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-65-1.png" width="700"></p>
<div class="sourceCode" id="cb116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#multiple traits</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">0.25</span>,<span class="fl">0.25</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">covariance.plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/recordplot.html" class="external-link">recordPlot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; null device </span></span>
<span><span class="co">#&gt;           1</span></span></code></pre></div>
<div class="sourceCode" id="cb117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Vt = sigma2_y /( 2 * a) * ((1 - exp(-2 * a * ta)) .* exp(-a * tij)); //From Hansen (1997)</span></span>
<span></span>
<span><span class="va">covariance.plot</span></span></code></pre></div>
<p>Now lets plot the prior vs.Â posterior plots</p>
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">optima.post</span><span class="op">&lt;-</span><span class="va">post</span><span class="op">$</span><span class="va">optima</span></span>
<span><span class="va">beta.post.Xd</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span>,,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">beta.post.Xa</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span>,,<span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">beta.post.Xd</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"post.beta.1"</span>,<span class="st">"post.beta.2"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">beta.post.Xa</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"post.beta.1"</span>,<span class="st">"post.beta.2"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mu.link.Xd1</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x.seq</span><span class="op">)</span><span class="op">{</span><span class="va">optima.post</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">+</span><span class="va">x.seq</span><span class="op">*</span><span class="va">beta.post.Xd</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">}</span></span>
<span><span class="va">mu.link.Xd2</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x.seq</span><span class="op">)</span><span class="op">{</span><span class="va">optima.post</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">+</span><span class="va">x.seq</span><span class="op">*</span><span class="va">beta.post.Xd</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">}</span></span>
<span></span>
<span><span class="va">x.seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">X_obs</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span>, to<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">X_obs</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> , length.out<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">mu.11</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">x.seq</span> , <span class="va">mu.link.Xd1</span> <span class="op">)</span></span>
<span><span class="va">mu.12</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">x.seq</span> , <span class="va">mu.link.Xd2</span> <span class="op">)</span></span>
<span></span>
<span><span class="va">mu.mean.11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">mu.11</span><span class="op">)</span></span>
<span><span class="va">mu.mean.12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">mu.12</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mu.mean.11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mu.mean.11</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mu.mean.12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mu.mean.12</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.mean.11</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"mu.mean.11"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.mean.12</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"mu.mean.12"</span></span>
<span></span>
<span><span class="va">mu.CI.11</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span> <span class="va">mu.11</span> , MARGIN<span class="op">=</span><span class="fl">2</span>, FUN<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/rethinking/man/HPDI.html" class="external-link">PI</a></span> , prob<span class="op">=</span><span class="fl">0.89</span> <span class="op">)</span></span>
<span><span class="va">mu.CI.12</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span> <span class="va">mu.12</span> , MARGIN<span class="op">=</span><span class="fl">2</span>, FUN<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/rethinking/man/HPDI.html" class="external-link">PI</a></span> , prob<span class="op">=</span><span class="fl">0.89</span> <span class="op">)</span></span>
<span></span>
<span><span class="va">mu.CI.11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mu.CI.11</span><span class="op">)</span><span class="op">)</span>,<span class="va">x.seq</span><span class="op">)</span></span>
<span><span class="va">mu.CI.12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mu.CI.12</span><span class="op">)</span><span class="op">)</span>,<span class="va">x.seq</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.CI.11</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"min.5.5"</span>,<span class="st">"max.94.5"</span>,<span class="st">"x.seq"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.CI.12</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"min.5.5"</span>,<span class="st">"max.94.5"</span>,<span class="st">"x.seq"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">dat</span><span class="op">$</span><span class="va">Y_obs</span>,X<span class="op">=</span><span class="va">dat</span><span class="op">$</span><span class="va">X_obs</span>,Regimes<span class="op">=</span><span class="va">regimes_tip</span><span class="op">)</span></span>
<span><span class="va">df11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x.seq</span>,<span class="va">mu.mean.11</span><span class="op">)</span></span>
<span><span class="va">df12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x.seq</span>,<span class="va">mu.mean.12</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mypal</span> <span class="op">&lt;-</span> <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/pal_npg.html" class="external-link">pal_npg</a></span><span class="op">(</span><span class="st">"nrc"</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">slope.plot.1</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">Y</span>,x<span class="op">=</span><span class="va">X.Xd</span>,color<span class="op">=</span><span class="va">Regimes</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima.sims</span>,slope<span class="op">=</span><span class="va">beta.sims</span>,alpha<span class="op">=</span><span class="fl">0.15</span><span class="op">)</span><span class="op">+</span> <span class="co">#Prior</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df11</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,y<span class="op">=</span><span class="va">mu.mean.11</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mu.CI.11</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,ymin<span class="op">=</span><span class="va">min.5.5</span>,ymax<span class="op">=</span><span class="va">max.94.5</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span>,alpha<span class="op">=</span><span class="fl">0.25</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df12</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,y<span class="op">=</span><span class="va">mu.mean.12</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mu.CI.12</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,ymin<span class="op">=</span><span class="va">min.5.5</span>,ymax<span class="op">=</span><span class="va">max.94.5</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span>,alpha<span class="op">=</span><span class="fl">0.25</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#ggtitle("Prior vs. Posterior for Intercept and Slope")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Direct effect trait"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">slope.plot.1</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-66-1.png" width="700"></p>
<div class="sourceCode" id="cb119"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="va">mu.link.Xa1</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x.seq</span><span class="op">)</span><span class="op">{</span><span class="va">optima.post</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">+</span><span class="va">x.seq</span><span class="op">*</span><span class="va">beta.post.Xa</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">}</span></span>
<span><span class="va">mu.link.Xa2</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x.seq</span><span class="op">)</span><span class="op">{</span><span class="va">optima.post</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">+</span><span class="va">x.seq</span><span class="op">*</span><span class="va">beta.post.Xa</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">}</span></span>
<span></span>
<span><span class="va">x.seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">X_obs</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>, to<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">X_obs</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span> , length.out<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">mu.11</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">x.seq</span> , <span class="va">mu.link.Xa1</span> <span class="op">)</span></span>
<span><span class="va">mu.12</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">x.seq</span> , <span class="va">mu.link.Xa2</span> <span class="op">)</span></span>
<span></span>
<span><span class="va">mu.mean.11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">mu.11</span><span class="op">)</span></span>
<span><span class="va">mu.mean.12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">mu.12</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mu.mean.11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mu.mean.11</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mu.mean.12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mu.mean.12</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.mean.11</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"mu.mean.11"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.mean.12</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"mu.mean.12"</span></span>
<span></span>
<span><span class="va">mu.CI.11</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span> <span class="va">mu.11</span> , MARGIN<span class="op">=</span><span class="fl">2</span>, FUN<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/rethinking/man/HPDI.html" class="external-link">PI</a></span> , prob<span class="op">=</span><span class="fl">0.89</span> <span class="op">)</span></span>
<span><span class="va">mu.CI.12</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span> <span class="va">mu.12</span> , MARGIN<span class="op">=</span><span class="fl">2</span>, FUN<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/rethinking/man/HPDI.html" class="external-link">PI</a></span> , prob<span class="op">=</span><span class="fl">0.89</span> <span class="op">)</span></span>
<span></span>
<span><span class="va">mu.CI.11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mu.CI.11</span><span class="op">)</span><span class="op">)</span>,<span class="va">x.seq</span><span class="op">)</span></span>
<span><span class="va">mu.CI.12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mu.CI.12</span><span class="op">)</span><span class="op">)</span>,<span class="va">x.seq</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.CI.11</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"min.5.5"</span>,<span class="st">"max.94.5"</span>,<span class="st">"x.seq"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.CI.12</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"min.5.5"</span>,<span class="st">"max.94.5"</span>,<span class="st">"x.seq"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">dat</span><span class="op">$</span><span class="va">Y_obs</span>,X<span class="op">=</span><span class="va">dat</span><span class="op">$</span><span class="va">X_obs</span>,Regimes<span class="op">=</span><span class="va">regimes_tip</span><span class="op">)</span></span>
<span><span class="va">df11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x.seq</span>,<span class="va">mu.mean.11</span><span class="op">)</span></span>
<span><span class="va">df12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x.seq</span>,<span class="va">mu.mean.12</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mypal</span> <span class="op">&lt;-</span> <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/pal_npg.html" class="external-link">pal_npg</a></span><span class="op">(</span><span class="st">"nrc"</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">slope.plot.2</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">Y</span>,x<span class="op">=</span><span class="va">X.Xa</span>,color<span class="op">=</span><span class="va">Regimes</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima.sims</span>,slope<span class="op">=</span><span class="va">beta.sims</span>,alpha<span class="op">=</span><span class="fl">0.15</span><span class="op">)</span><span class="op">+</span> <span class="co">#Prior</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df11</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,y<span class="op">=</span><span class="va">mu.mean.11</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mu.CI.11</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,ymin<span class="op">=</span><span class="va">min.5.5</span>,ymax<span class="op">=</span><span class="va">max.94.5</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span>,alpha<span class="op">=</span><span class="fl">0.25</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df12</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,y<span class="op">=</span><span class="va">mu.mean.12</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mu.CI.12</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,ymin<span class="op">=</span><span class="va">min.5.5</span>,ymax<span class="op">=</span><span class="va">max.94.5</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span>,alpha<span class="op">=</span><span class="fl">0.25</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#ggtitle("Prior vs. Posterior for Intercept and Slope")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Adaptive trait"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">slope.plot.2</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-66-2.png" width="700"></p>
<p>Now we run the Multilevel Multi-optima Direct Effect Adaptation Model
with Varying Effects, look at the results, and rstan::extract the
posterior</p>
<p>Next we will set the priors for the estimated parameters - for this
model this includes the half-life, Vy, optima, and beta. For the latter
two parameters we will use the results of the linear model to inform our
priors.</p>
<div class="sourceCode" id="cb120"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Set Priors</span></span>
<span><span class="va">hl.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span>,<span class="fl">0.75</span><span class="op">)</span></span>
<span><span class="va">vy.prior</span><span class="op">&lt;-</span><span class="fl">20</span></span>
<span><span class="va">optima.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>,<span class="fl">0.25</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span>
<span><span class="va">beta.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.25</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span>
<span><span class="va">sigma.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span></code></pre></div>
<p>We will use the helper function blouch.reg.adapt.prep() to setup the
dat file for Stan. Here â€œZ_adaptiveâ€ is the number of predictors, and
â€œregimesâ€ is the name of the regime column in trdata$dat.</p>
<div class="sourceCode" id="cb121"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/blouch.reg.direct.adapt.mlm.prep.html">blouch.reg.direct.adapt.mlm.prep</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="st">"Y_with_error"</span>,<span class="st">"Y_error"</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Xd"</span>,<span class="st">"Xa"</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Xd_error"</span>,<span class="st">"Xa_error"</span><span class="op">)</span>,Z_direct<span class="op">=</span><span class="fl">1</span>,Z_adaptive<span class="op">=</span><span class="fl">1</span>,<span class="st">"regimes"</span>,<span class="va">hl.prior</span>,<span class="va">vy.prior</span>,<span class="va">optima.prior</span>,<span class="va">beta.prior</span>,<span class="va">sigma.prior</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb122"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.direct.adapt.mlm.ve</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_direct_adapt_mlm_ve</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores<span class="op">=</span><span class="fl">2</span>,iter<span class="op">=</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Warning: There were 330 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span>
<span><span class="co">#&gt; Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#bulk-ess</span></span>
<span><span class="co">#&gt; Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#tail-ess</span></span></code></pre></div>
<div class="sourceCode" id="cb123"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.direct.adapt.mlm.ve</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span>,<span class="st">"sigma"</span>,<span class="st">"Rho"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_adapt_mlm_ve.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd  2.5%   25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.20    0.01 0.17  0.06  0.11 0.15 0.22  0.65   469 1.00</span></span>
<span><span class="co">#&gt; vy        0.02    0.00 0.02  0.00  0.00 0.01 0.02  0.06  1640 1.00</span></span>
<span><span class="co">#&gt; optima[1] 1.86    0.01 0.18  1.54  1.74 1.86 1.98  2.21   212 1.01</span></span>
<span><span class="co">#&gt; optima[2] 1.59    0.02 0.34  0.85  1.40 1.61 1.81  2.16   388 1.01</span></span>
<span><span class="co">#&gt; beta[1,1] 0.24    0.00 0.03  0.18  0.22 0.24 0.26  0.30  1388 1.00</span></span>
<span><span class="co">#&gt; beta[1,2] 0.42    0.01 0.11  0.32  0.36 0.39 0.43  0.70   474 1.00</span></span>
<span><span class="co">#&gt; beta[2,1] 0.18    0.00 0.06  0.05  0.15 0.19 0.22  0.28  1119 1.01</span></span>
<span><span class="co">#&gt; beta[2,2] 0.11    0.01 0.09 -0.05  0.05 0.12 0.17  0.30   183 1.01</span></span>
<span><span class="co">#&gt; sigma[1]  0.54    0.02 0.39  0.06  0.23 0.43 0.76  1.53   592 1.00</span></span>
<span><span class="co">#&gt; sigma[2]  0.26    0.01 0.30  0.01  0.06 0.15 0.34  1.11   432 1.01</span></span>
<span><span class="co">#&gt; sigma[3]  0.50    0.02 0.38  0.08  0.22 0.40 0.68  1.49   419 1.00</span></span>
<span><span class="co">#&gt; Rho[1,1]  1.00     NaN 0.00  1.00  1.00 1.00 1.00  1.00   NaN  NaN</span></span>
<span><span class="co">#&gt; Rho[1,2]  0.03    0.02 0.32 -0.54 -0.23 0.02 0.28  0.63   396 1.01</span></span>
<span><span class="co">#&gt; Rho[1,3]  0.05    0.01 0.30 -0.54 -0.16 0.04 0.26  0.64  1037 1.00</span></span>
<span><span class="co">#&gt; Rho[2,1]  0.03    0.02 0.32 -0.54 -0.23 0.02 0.28  0.63   396 1.01</span></span>
<span><span class="co">#&gt; Rho[2,2]  1.00    0.00 0.00  1.00  1.00 1.00 1.00  1.00   977 1.00</span></span>
<span><span class="co">#&gt; Rho[2,3]  0.05    0.02 0.31 -0.55 -0.20 0.06 0.29  0.61   294 1.01</span></span>
<span><span class="co">#&gt; Rho[3,1]  0.05    0.01 0.30 -0.54 -0.16 0.04 0.26  0.64  1037 1.00</span></span>
<span><span class="co">#&gt; Rho[3,2]  0.05    0.02 0.31 -0.55 -0.20 0.06 0.29  0.61   294 1.01</span></span>
<span><span class="co">#&gt; Rho[3,3]  1.00    0.00 0.00  1.00  1.00 1.00 1.00  1.00   853 1.00</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Thu Jun 20 19:00:50 2024.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span></code></pre></div>
<div class="sourceCode" id="cb124"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.direct.adapt.mlm.ve</span><span class="op">)</span></span></code></pre></div>
<p>Now we run the non-centered version of the Multilevel Multi-optima
Direct Effect Adaptive Model with Varying Effects</p>
<div class="sourceCode" id="cb125"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.direct.adapt.mlm.ve.nc</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_direct_adapt_mlm_ve_nc</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores<span class="op">=</span><span class="fl">2</span>,iter<span class="op">=</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Warning: There were 251 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span>
<span><span class="co">#&gt; Warning: The largest R-hat is NA, indicating chains have not mixed.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#r-hat</span></span>
<span><span class="co">#&gt; Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#bulk-ess</span></span>
<span><span class="co">#&gt; Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#tail-ess</span></span></code></pre></div>
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.direct.adapt.mlm.ve.nc</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span>,<span class="st">"sigma"</span>,<span class="st">"L_Rho"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_adapt_mlm_ve_nc.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;            mean se_mean   sd  2.5%   25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl         0.20    0.01 0.15  0.07  0.11 0.16 0.23  0.60   404 1.00</span></span>
<span><span class="co">#&gt; vy         0.02    0.00 0.02  0.00  0.01 0.01 0.02  0.06  1610 1.00</span></span>
<span><span class="co">#&gt; optima[1]  1.86    0.01 0.16  1.54  1.75 1.85 1.96  2.19   382 1.01</span></span>
<span><span class="co">#&gt; optima[2]  1.59    0.01 0.29  0.93  1.44 1.60 1.78  2.12  1194 1.00</span></span>
<span><span class="co">#&gt; beta[1,1]  0.24    0.00 0.03  0.18  0.22 0.24 0.26  0.29  1148 1.00</span></span>
<span><span class="co">#&gt; beta[1,2]  0.42    0.00 0.10  0.32  0.36 0.39 0.44  0.67   451 1.00</span></span>
<span><span class="co">#&gt; beta[2,1]  0.19    0.00 0.06  0.07  0.15 0.19 0.22  0.29   316 1.01</span></span>
<span><span class="co">#&gt; beta[2,2]  0.13    0.00 0.09 -0.05  0.08 0.14 0.19  0.30   720 1.00</span></span>
<span><span class="co">#&gt; sigma[1]   0.49    0.01 0.39  0.03  0.22 0.39 0.66  1.47   673 1.00</span></span>
<span><span class="co">#&gt; sigma[2]   0.26    0.03 0.31  0.00  0.05 0.14 0.35  1.03    87 1.02</span></span>
<span><span class="co">#&gt; sigma[3]   0.41    0.03 0.28  0.08  0.20 0.33 0.57  1.00    66 1.03</span></span>
<span><span class="co">#&gt; L_Rho[1,1] 1.00     NaN 0.00  1.00  1.00 1.00 1.00  1.00   NaN  NaN</span></span>
<span><span class="co">#&gt; L_Rho[1,2] 0.00     NaN 0.00  0.00  0.00 0.00 0.00  0.00   NaN  NaN</span></span>
<span><span class="co">#&gt; L_Rho[1,3] 0.00     NaN 0.00  0.00  0.00 0.00 0.00  0.00   NaN  NaN</span></span>
<span><span class="co">#&gt; L_Rho[2,1] 0.10    0.02 0.40 -0.66 -0.21 0.15 0.41  0.78   349 1.01</span></span>
<span><span class="co">#&gt; L_Rho[2,2] 0.90    0.00 0.11  0.61  0.87 0.93 0.98  1.00   792 1.00</span></span>
<span><span class="co">#&gt; L_Rho[2,3] 0.00     NaN 0.00  0.00  0.00 0.00 0.00  0.00   NaN  NaN</span></span>
<span><span class="co">#&gt; L_Rho[3,1] 0.09    0.01 0.40 -0.66 -0.20 0.06 0.40  0.81   997 1.01</span></span>
<span><span class="co">#&gt; L_Rho[3,2] 0.09    0.01 0.39 -0.70 -0.18 0.09 0.38  0.78  1142 1.00</span></span>
<span><span class="co">#&gt; L_Rho[3,3] 0.80    0.01 0.17  0.40  0.70 0.84 0.94  0.99   185 1.01</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Thu Jun 20 19:07:17 2024.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span></code></pre></div>
<div class="sourceCode" id="cb127"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.direct.adapt.mlm.ve.nc</span><span class="op">)</span></span></code></pre></div>
<p>From there the posteriors should be explored, compared to the priors,
etc. following the methods above.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Mark Grabowski.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
