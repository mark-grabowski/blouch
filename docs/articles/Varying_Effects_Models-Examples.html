<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Varying Effects Models-Examples • blouch</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Varying Effects Models-Examples">
<meta property="og:description" content="blouch">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">blouch</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Basic_Models-Examples.html">Basic Models-Examples</a>
    </li>
    <li>
      <a href="../articles/Empirical-Example.html">Empirical Example</a>
    </li>
    <li>
      <a href="../articles/Multi-optima_Models-Examples.html">Multi-optima Models-Examples</a>
    </li>
    <li>
      <a href="../articles/Simulation-Example.html">Simulation Example</a>
    </li>
    <li>
      <a href="../articles/Varying_Effects_Models-Examples.html">Varying Effects Models-Examples</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mark-grabowski/blouch/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Varying Effects Models-Examples</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mark-grabowski/blouch/blob/HEAD/vignettes/Varying_Effects_Models-Examples.Rmd" class="external-link"><code>vignettes/Varying_Effects_Models-Examples.Rmd</code></a></small>
      <div class="hidden name"><code>Varying_Effects_Models-Examples.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mark-grabowski/blouch" class="external-link">blouch</a></span><span class="op">)</span></span></code></pre></div>
<p>Here I walk you through the varying effects models of
<em>Blouch</em>. By varying effects I mean varying intercepts and
slopes, which to my knowledge has not been done previously for OU models
in the adaptation-inertia framework. We will run three different models
below - a multilevel model which pools information across the regimes, a
non-centered version of the same model to aid in exploring the
posterior, and a non-multilevel version of the varying effects model.
This article is an abbreviated versions of the Simulation Example
article - most of the steps of analysis will be the same and are not
repeated here. Note that the Stan runs are also too few iterations and
use only 1 chain and 1 core.</p>
<div class="section level2">
<h2 id="multi-optima-direct-effect-model-with-varying-effects---single-predictor">Multi-optima Direct Effect Model with Varying Effects - Single
Predictor<a class="anchor" aria-label="anchor" href="#multi-optima-direct-effect-model-with-varying-effects---single-predictor"></a>
</h2>
<p>First we will create a phylogeny by randomly sampling from the 10K
Trees phylogeny</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">########################################################################################################</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">N</span><span class="op">&lt;-</span><span class="fl">50</span> <span class="co">#Number of species</span></span>
<span><span class="co">#set.seed(1) #Set seed to get same random species each time</span></span>
<span></span>
<span><span class="va">phy</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/drop.tip.html" class="external-link">keep.tip</a></span><span class="op">(</span><span class="va">tree.10K</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">tree.10K</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">]</span><span class="op">)</span> </span>
<span><span class="va">phy</span><span class="op">&lt;-</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/multi2di.html" class="external-link">multi2di</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span></span>
<span></span>
<span><span class="va">l.tree</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/branching.times.html" class="external-link">branching.times</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span><span class="op">)</span> <span class="co">## rescale tree to height 1</span></span>
<span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">/</span><span class="va">l.tree</span> </span>
<span></span>
<span><span class="co">#Set regimes - manually - 2 regimes</span></span>
<span><span class="co">#Locate nodes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">phy</span>,no.margin<span class="op">=</span><span class="cn">TRUE</span>,edge.width<span class="op">=</span><span class="fl">2</span>,cex<span class="op">=</span><span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/nodelabels.html" class="external-link">nodelabels</a></span><span class="op">(</span>frame<span class="op">=</span><span class="st">"none"</span>,adj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.1</span>,<span class="op">-</span><span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/nodelabels.html" class="external-link">tiplabels</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/MODEMVE_setup-1.png" width="700"></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Paint Regimes on Tree</span></span>
<span></span>
<span><span class="va">shifts</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">84</span><span class="op">)</span> <span class="co">#Location of nodes with regime shifts</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu">treeplyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/treeplyr/man/make.treedata.html" class="external-link">make.treedata</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">trdata</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/set.converge.regimes.html">set.converge.regimes</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="va">shifts</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; Levels: OU1 OU2</span></span>
<span><span class="co">#&gt; [1] "#E64B35FF" "#4DBBD5FF"</span></span>
<span></span>
<span></span>
<span><span class="co">#Check if manual setting code worked</span></span>
<span><span class="va">shifts.total</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span>,<span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">node.label</span><span class="op">)</span></span>
<span><span class="va">edge.regimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">shifts.total</span><span class="op">[</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">edge</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">edge.regimes</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; Levels: OU1 OU2</span></span>
<span></span>
<span><span class="va">reg_tips</span><span class="op">&lt;-</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span></span>
<span><span class="va">reg_tips</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">reg_tips</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">reg.colors</span><span class="op">&lt;-</span><span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/pal_npg.html" class="external-link">pal_npg</a></span><span class="op">(</span>palette<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"nrc"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>,edge.color <span class="op">=</span> <span class="va">reg.colors</span><span class="op">[</span><span class="va">edge.regimes</span><span class="op">]</span>, edge.width <span class="op">=</span> <span class="fl">1</span>, cex <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/MODEMVE_setup-2.png" width="700"></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Phylogeny info</span></span>
<span><span class="va">n</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span></span>
<span></span>
<span><span class="va">regimes_internal</span> <span class="op">&lt;-</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">node.label</span></span>
<span><span class="va">regimes_tip</span> <span class="op">&lt;-</span> <span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span></span>
<span><span class="va">regimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/concat.factor.html">concat.factor</a></span><span class="op">(</span><span class="va">regimes_tip</span>, <span class="va">regimes_internal</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">anc_maps</span><span class="op">&lt;-</span><span class="st">"regimes"</span></span>
<span><span class="va">lineages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="fu"><a href="../reference/lineage.constructor.html">lineage.constructor</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>, <span class="va">e</span>, <span class="va">anc_maps</span>, <span class="va">regimes</span><span class="op">)</span><span class="op">)</span> <span class="co">#Trace lineage from tips (n) to root and determine regimes of each node or branch</span></span></code></pre></div>
<p>Simulate X and Y data</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#########################</span></span>
<span><span class="va">hl</span><span class="op">&lt;-</span><span class="fl">0.1</span> <span class="co">#0.1, 0.25, 0.75 - testing options</span></span>
<span><span class="va">a</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span></span>
<span><span class="va">vy</span><span class="op">&lt;-</span><span class="fl">0.01</span> <span class="co">#0.25,0.5 - testing options</span></span>
<span><span class="va">sigma2_y</span><span class="op">&lt;-</span><span class="va">vy</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span><span class="op">)</span><span class="op">)</span>;</span>
<span></span>
<span><span class="va">vX0</span><span class="op">&lt;-</span><span class="fl">0</span></span>
<span><span class="va">vY0</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">Sxx</span><span class="op">&lt;-</span><span class="fl">10</span> <span class="co">#Look at effects</span></span>
<span></span>
<span><span class="va">X</span><span class="op">&lt;-</span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/fastBM.html" class="external-link">fastBM</a></span><span class="op">(</span><span class="va">phy</span>,a<span class="op">=</span><span class="va">vX0</span>,sig2<span class="op">=</span><span class="va">Sxx</span>,internal<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="co">#Simulate X BM variable on tree, with scaling 10</span></span>
<span><span class="va">Z_direct</span><span class="op">&lt;-</span><span class="fl">1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span></span>
<span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/phenogram.html" class="external-link">phenogram</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">X</span>,spread.labels<span class="op">=</span><span class="cn">TRUE</span>,spread.cost<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="co">#Plot X data</span></span>
<span><span class="co">#&gt; Optimizing the positions of the tip labels...</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">dmX</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/weight.matrix.html">weight.matrix</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>, <span class="va">a</span>, <span class="va">lineages</span><span class="op">)</span> <span class="co">#Slouch approach</span></span>
<span><span class="va">optima</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">beta</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>,<span class="fl">0.15</span><span class="op">)</span> <span class="co">#Two Optima/Two Slopes</span></span>
<span><span class="va">mu</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="va">N</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">mu</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">&lt;-</span><span class="va">dmX</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">optima</span><span class="op">+</span><span class="va">beta</span><span class="op">[</span><span class="va">reg_tips</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">X</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>;</span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">V</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/calc_direct_V.html">calc_direct_V</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">sigma2_y</span>,<span class="va">a</span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">&lt;-</span><span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1</span>,<span class="va">mu</span>,<span class="va">V</span><span class="op">)</span></span>
<span></span>
<span><span class="co">###############################################################################################################</span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">Y</span>,X<span class="op">=</span><span class="va">X</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">X</span>,y<span class="op">=</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-3-2.png" width="700"></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">X</span>,<span class="va">df</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = Y ~ X, data = df)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co">#&gt; -1.40479  0.08649  0.21983  0.31704  0.49311 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  1.76546    0.08319   21.22  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; X            0.24859    0.02371   10.48 5.25e-14 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 0.5227 on 48 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.6961, Adjusted R-squared:  0.6897 </span></span>
<span><span class="co">#&gt; F-statistic: 109.9 on 1 and 48 DF,  p-value: 5.254e-14</span></span>
<span></span>
<span><span class="co">################################################################################################################</span></span>
<span><span class="co">#Simulate errors </span></span>
<span><span class="va">Z_X_error</span><span class="op">&lt;-</span><span class="fl">1</span> <span class="co">#Number of X traits with error</span></span>
<span><span class="va">X_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Y_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Y_with_error</span><span class="op">&lt;-</span><span class="va">Y</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">X_with_error</span><span class="op">&lt;-</span><span class="va">X</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span></span>
<span></span>
<span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Make trdata file</span></span>
<span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span>,<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Y_with_error</span>,<span class="va">Y_error</span>,<span class="va">X_with_error</span>,<span class="va">X_error</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We will use the helper function blouch.reg.direct.prep() to setup the
dat file for Stan. Here “Z_direct” is the number of predictors, and
“regimes” is the name of the regime column in trdata$dat.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Test Blouch prep code - Regimes + Direct Efffect model</span></span>
<span><span class="co">#source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/blouch/R Setup Code/blouch.prep.R")</span></span>
<span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/blouch.reg.direct.prep.html">blouch.reg.direct.prep</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="st">"Y_with_error"</span>,<span class="st">"Y_error"</span>,<span class="st">"X_with_error"</span>,<span class="st">"X_error"</span>,Z_direct<span class="op">=</span><span class="fl">1</span>,<span class="st">"regimes"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##################################################################################################################</span></span>
<span><span class="co">#Plot of data</span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">dat</span><span class="op">$</span><span class="va">Y_obs</span>,X<span class="op">=</span><span class="va">dat</span><span class="op">$</span><span class="va">X_obs</span>,Regimes<span class="op">=</span><span class="va">regimes_tip</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#slope.prior.plot&lt;-ggplot(data=reg.trdata$dat,aes(y=Sim1,x=X))+</span></span>
<span><span class="va">slope.plot.1</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">Y</span>,x<span class="op">=</span><span class="va">X</span>,color<span class="op">=</span><span class="va">Regimes</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Direct Effect Trait"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">slope.plot.1</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>Multilevel Multi-optima Direct Effect Model with Varying Effects</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.direct.mlm.ve</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_direct_mlm_ve</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">1</span>,cores<span class="op">=</span><span class="fl">1</span>,iter<span class="op">=</span><span class="fl">400</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'blouchOU_reg_direct_mlm_ve' NOW (CHAIN 1).</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Gradient evaluation took 0.00073 seconds</span></span>
<span><span class="co">#&gt; Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 7.3 seconds.</span></span>
<span><span class="co">#&gt; Chain 1: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Iteration:   1 / 400 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  40 / 400 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  80 / 400 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 120 / 400 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 160 / 400 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 200 / 400 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 201 / 400 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 240 / 400 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 280 / 400 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 320 / 400 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 360 / 400 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 400 / 400 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1:  Elapsed Time: 5.275 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 1:                2.145 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1:                7.42 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 1:</span></span>
<span><span class="co">#&gt; Warning: The largest R-hat is NA, indicating chains have not mixed.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#r-hat</span></span>
<span><span class="co">#&gt; Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#bulk-ess</span></span>
<span><span class="co">#&gt; Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#tail-ess</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.direct.mlm.ve</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima_bar"</span>,<span class="st">"beta_bar"</span>,<span class="st">"Rho"</span>,<span class="st">"sigma"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_mlm_ve.</span></span>
<span><span class="co">#&gt; 1 chains, each with iter=400; warmup=200; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=200, total post-warmup draws=200.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;              mean se_mean   sd  2.5%   25%   50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl           0.28    0.08 0.28  0.06  0.14  0.20 0.29  1.26    14 1.09</span></span>
<span><span class="co">#&gt; vy           0.02    0.00 0.01  0.01  0.01  0.02 0.02  0.07    15 1.08</span></span>
<span><span class="co">#&gt; optima_bar  -0.27    0.23 0.70 -1.77 -0.66 -0.24 0.25  0.98     9 1.30</span></span>
<span><span class="co">#&gt; beta_bar[1]  0.95    0.22 0.91 -0.10  0.23  0.66 1.54  3.20    18 1.14</span></span>
<span><span class="co">#&gt; Rho[1,1]     1.00     NaN 0.00  1.00  1.00  1.00 1.00  1.00   NaN  NaN</span></span>
<span><span class="co">#&gt; Rho[1,2]    -0.21    0.04 0.31 -0.74 -0.44 -0.23 0.00  0.37    59 1.02</span></span>
<span><span class="co">#&gt; Rho[2,1]    -0.21    0.04 0.31 -0.74 -0.44 -0.23 0.00  0.37    59 1.02</span></span>
<span><span class="co">#&gt; Rho[2,2]     1.00    0.00 0.00  1.00  1.00  1.00 1.00  1.00   212 0.99</span></span>
<span><span class="co">#&gt; sigma[1]     1.47    0.13 0.47  0.71  1.13  1.44 1.76  2.45    13 1.14</span></span>
<span><span class="co">#&gt; sigma[2]     0.79    0.13 0.63  0.07  0.22  0.61 1.26  2.17    23 1.11</span></span>
<span><span class="co">#&gt; optima[1]    2.00    0.00 0.05  1.90  1.98  2.00 2.03  2.08   161 1.00</span></span>
<span><span class="co">#&gt; optima[2]    0.81    0.11 0.43 -0.67  0.80  0.94 1.01  1.13    15 1.09</span></span>
<span><span class="co">#&gt; beta[1,1]    0.26    0.00 0.01  0.24  0.25  0.26 0.26  0.27   292 1.00</span></span>
<span><span class="co">#&gt; beta[2,1]    0.14    0.00 0.03  0.07  0.12  0.13 0.16  0.20   126 1.02</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Mon Sep 25 13:54:10 2023.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="co">#plot(rethinking::precis(fit.reg.direct.mlm.ve,depth=3,pars = c("hl","vy","optima_bar","beta_bar","Rho","sigma","optima","beta")))</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.direct.mlm.ve</span><span class="op">)</span></span></code></pre></div>
<p>Multilevel Multi-optima Direct Effect Model with Varying Effects -
Non centered</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.direct.mlm.ve.nc</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_direct_mlm_ve_nc</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">1</span>,cores<span class="op">=</span><span class="fl">1</span>,iter <span class="op">=</span><span class="fl">400</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'blouchOU_reg_direct_mlm_ve_nc' NOW (CHAIN 1).</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Gradient evaluation took 0.000634 seconds</span></span>
<span><span class="co">#&gt; Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 6.34 seconds.</span></span>
<span><span class="co">#&gt; Chain 1: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Iteration:   1 / 400 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  40 / 400 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  80 / 400 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 120 / 400 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 160 / 400 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 200 / 400 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 201 / 400 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 240 / 400 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 280 / 400 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 320 / 400 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 360 / 400 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 400 / 400 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1:  Elapsed Time: 25.152 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 1:                47.297 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1:                72.449 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 1:</span></span>
<span><span class="co">#&gt; Warning: There were 21 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span>
<span><span class="co">#&gt; Warning: The largest R-hat is NA, indicating chains have not mixed.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#r-hat</span></span>
<span><span class="co">#&gt; Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#bulk-ess</span></span>
<span><span class="co">#&gt; Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#tail-ess</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.direct.mlm.ve.nc</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima_bar"</span>,<span class="st">"beta_bar"</span>,<span class="st">"Rho"</span>,<span class="st">"sigma"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_mlm_ve_nc.</span></span>
<span><span class="co">#&gt; 1 chains, each with iter=400; warmup=200; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=200, total post-warmup draws=200.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;             mean se_mean   sd  2.5%   25%   50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl          0.30    0.03 0.26  0.08  0.16  0.22 0.33  1.17    69 1.00</span></span>
<span><span class="co">#&gt; vy          0.02    0.00 0.01  0.01  0.01  0.02 0.02  0.06    83 1.00</span></span>
<span><span class="co">#&gt; optima_bar -0.18    0.12 0.70 -1.45 -0.68 -0.10 0.36  1.08    35 1.00</span></span>
<span><span class="co">#&gt; beta_bar    0.56    0.07 0.52 -0.45  0.22  0.37 0.90  1.73    50 1.00</span></span>
<span><span class="co">#&gt; Rho[1,1]    1.00     NaN 0.00  1.00  1.00  1.00 1.00  1.00   NaN  NaN</span></span>
<span><span class="co">#&gt; Rho[1,2]   -0.06    0.03 0.31 -0.64 -0.30 -0.09 0.16  0.55   146 1.01</span></span>
<span><span class="co">#&gt; Rho[2,1]   -0.06    0.03 0.31 -0.64 -0.30 -0.09 0.16  0.55   146 1.01</span></span>
<span><span class="co">#&gt; Rho[2,2]    1.00    0.00 0.00  1.00  1.00  1.00 1.00  1.00   183 0.99</span></span>
<span><span class="co">#&gt; sigma[1]    1.36    0.10 0.56  0.53  0.92  1.28 1.79  2.50    31 1.00</span></span>
<span><span class="co">#&gt; sigma[2]    0.49    0.03 0.35  0.08  0.20  0.41 0.67  1.33   109 1.00</span></span>
<span><span class="co">#&gt; optima[1]   2.00    0.00 0.05  1.90  1.96  2.00 2.03  2.10   196 1.01</span></span>
<span><span class="co">#&gt; optima[2]   0.79    0.05 0.43 -0.57  0.76  0.91 0.98  1.10    69 1.00</span></span>
<span><span class="co">#&gt; beta[1,1]   0.26    0.00 0.01  0.24  0.25  0.26 0.27  0.28   147 1.00</span></span>
<span><span class="co">#&gt; beta[2,1]   0.14    0.00 0.03  0.08  0.11  0.13 0.16  0.20   206 1.00</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Mon Sep 25 13:55:32 2023.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="co">#plot(rethinking::precis(fit.reg.direct.mlm.ve.nc,depth=3,pars = c("hl","vy","optima_bar","beta_bar","Rho","sigma","optima","beta")))</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.direct.mlm.ve.nc</span><span class="op">)</span></span></code></pre></div>
<p>Multi-optima Direct Effect Model with Varying Effects</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.direct.ve</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_direct_ve</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">1</span>,cores<span class="op">=</span><span class="fl">1</span>,iter <span class="op">=</span><span class="fl">400</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLING FOR MODEL 'blouchOU_reg_direct_ve' NOW (CHAIN 1).</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Gradient evaluation took 0.000642 seconds</span></span>
<span><span class="co">#&gt; Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 6.42 seconds.</span></span>
<span><span class="co">#&gt; Chain 1: Adjust your expectations accordingly!</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1: Iteration:   1 / 400 [  0%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  40 / 400 [ 10%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration:  80 / 400 [ 20%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 120 / 400 [ 30%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 160 / 400 [ 40%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 200 / 400 [ 50%]  (Warmup)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 201 / 400 [ 50%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 240 / 400 [ 60%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 280 / 400 [ 70%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 320 / 400 [ 80%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 360 / 400 [ 90%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: Iteration: 400 / 400 [100%]  (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1: </span></span>
<span><span class="co">#&gt; Chain 1:  Elapsed Time: 2.28 seconds (Warm-up)</span></span>
<span><span class="co">#&gt; Chain 1:                1.79 seconds (Sampling)</span></span>
<span><span class="co">#&gt; Chain 1:                4.07 seconds (Total)</span></span>
<span><span class="co">#&gt; Chain 1:</span></span>
<span><span class="co">#&gt; Warning: There were 1 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span>
<span><span class="co">#&gt; Warning: The largest R-hat is NA, indicating chains have not mixed.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#r-hat</span></span>
<span><span class="co">#&gt; Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#bulk-ess</span></span>
<span><span class="co">#&gt; Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#tail-ess</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.direct.ve</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_ve.</span></span>
<span><span class="co">#&gt; 1 chains, each with iter=400; warmup=200; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=200, total post-warmup draws=200.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd  2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.45    0.11 0.41  0.12 0.19 0.30 0.55  1.54    13    1</span></span>
<span><span class="co">#&gt; vy        0.03    0.01 0.02  0.01 0.02 0.02 0.03  0.09    14    1</span></span>
<span><span class="co">#&gt; optima[1] 1.98    0.01 0.08  1.80 1.95 1.99 2.02  2.10    91    1</span></span>
<span><span class="co">#&gt; optima[2] 0.52    0.17 0.65 -1.39 0.46 0.80 0.91  1.06    14    1</span></span>
<span><span class="co">#&gt; beta[1,1] 0.26    0.00 0.01  0.24 0.25 0.26 0.26  0.28   307    1</span></span>
<span><span class="co">#&gt; beta[2,1] 0.15    0.00 0.03  0.09 0.13 0.15 0.17  0.21   236    1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Mon Sep 25 13:55:45 2023.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="co">#plot(rethinking::precis(fit.reg.direct.ve,depth=3,pars = c("hl","vy","optima","beta")))</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.direct.ve</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="multlevel-multi-optima-direct-effect-model-with-varying-effects---multiple-predictors">Multlevel Multi-optima Direct Effect Model with Varying Effects -
Multiple Predictors<a class="anchor" aria-label="anchor" href="#multlevel-multi-optima-direct-effect-model-with-varying-effects---multiple-predictors"></a>
</h2>
<p>Two regimes with two direct effect predictors and multiple slopes per
optima but single alpha parameter</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Regimes model</span></span>
<span><span class="co">############################################################################################################</span></span>
<span><span class="co">########################################################################################################</span></span>
<span><span class="co">#Create phylogeny</span></span>
<span><span class="co">########################################################################################################</span></span>
<span><span class="va">N</span><span class="op">&lt;-</span><span class="fl">50</span> <span class="co">#Number of species</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="co">#Set seed to get same random species each time</span></span>
<span></span>
<span><span class="va">phy</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/drop.tip.html" class="external-link">keep.tip</a></span><span class="op">(</span><span class="va">tree.10K</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">tree.10K</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">]</span><span class="op">)</span> </span>
<span><span class="va">phy</span><span class="op">&lt;-</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/multi2di.html" class="external-link">multi2di</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span></span>
<span></span>
<span><span class="va">l.tree</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/branching.times.html" class="external-link">branching.times</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span><span class="op">)</span> <span class="co">## rescale tree to height 1</span></span>
<span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">/</span><span class="va">l.tree</span> </span>
<span></span>
<span><span class="va">tip.label</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span></span>
<span></span>
<span></span>
<span><span class="co">#Set regimes - manually - 2 regimes</span></span>
<span><span class="co">#Locate nodes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">phy</span>,no.margin<span class="op">=</span><span class="cn">TRUE</span>,edge.width<span class="op">=</span><span class="fl">2</span>,cex<span class="op">=</span><span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/nodelabels.html" class="external-link">nodelabels</a></span><span class="op">(</span>frame<span class="op">=</span><span class="st">"none"</span>,adj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.1</span>,<span class="op">-</span><span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/nodelabels.html" class="external-link">tiplabels</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/Multi_optima_model_setup-1.png" width="700"></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Paint Regimes on Tree</span></span>
<span><span class="co">#source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/blouch/Simulation Code/Functions/set.converge.regimes.R") #Macbook Pro</span></span>
<span></span>
<span><span class="va">shifts</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">84</span><span class="op">)</span> <span class="co">#Location of nodes with regime shifts</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu">treeplyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/treeplyr/man/make.treedata.html" class="external-link">make.treedata</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">trdata</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/set.converge.regimes.html">set.converge.regimes</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="va">shifts</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; Levels: OU1 OU2</span></span>
<span><span class="co">#&gt; [1] "#E64B35FF" "#4DBBD5FF"</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/Multi_optima_model_setup-2.png" width="700"></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Check if manual setting code worked</span></span>
<span><span class="va">shifts.total</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span>,<span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">node.label</span><span class="op">)</span></span>
<span><span class="va">edge.regimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">shifts.total</span><span class="op">[</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">edge</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">edge.regimes</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; Levels: OU1 OU2</span></span>
<span></span>
<span><span class="va">reg_tips</span><span class="op">&lt;-</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span></span>
<span><span class="va">reg_tips</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">reg_tips</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">reg.colors</span> <span class="op">&lt;-</span> <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/pal_aaas.html" class="external-link">pal_aaas</a></span><span class="op">(</span><span class="st">"default"</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">reg.colors</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "#3B4992B2" "#EE0000B2"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>,edge.color <span class="op">=</span> <span class="va">reg.colors</span><span class="op">[</span><span class="va">edge.regimes</span><span class="op">]</span>, edge.width <span class="op">=</span> <span class="fl">1</span>, cex <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/Multi_optima_model_setup-3.png" width="700"></p>
<p>Format tree</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Simulate data</span></span>
<span><span class="va">n</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span></span>
<span><span class="va">regimes_internal</span> <span class="op">&lt;-</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">node.label</span></span>
<span><span class="va">regimes_tip</span> <span class="op">&lt;-</span> <span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span></span>
<span><span class="va">regimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/concat.factor.html">concat.factor</a></span><span class="op">(</span><span class="va">regimes_tip</span>, <span class="va">regimes_internal</span><span class="op">)</span></span>
<span><span class="va">anc_maps</span><span class="op">&lt;-</span><span class="st">"regimes"</span></span>
<span><span class="va">lineages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="fu"><a href="../reference/lineage.constructor.html">lineage.constructor</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>, <span class="va">e</span>, <span class="va">anc_maps</span>, <span class="va">regimes</span><span class="op">)</span><span class="op">)</span> <span class="co">#Trace lineage from tips (n) to root and determine regimes of each node or branch</span></span></code></pre></div>
<p>Simulate two direct effect traits</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#########################</span></span>
<span><span class="va">hl</span><span class="op">&lt;-</span><span class="fl">0.1</span> <span class="co">#0.1, 0.25, 0.75 - testing options</span></span>
<span><span class="va">a</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span></span>
<span><span class="va">vy</span><span class="op">&lt;-</span><span class="fl">0.01</span> <span class="co">#0.25,0.5 - testing options</span></span>
<span><span class="va">sigma2_y</span><span class="op">&lt;-</span><span class="va">vy</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span><span class="op">)</span><span class="op">)</span>;</span>
<span></span>
<span><span class="va">vX0</span><span class="op">&lt;-</span><span class="fl">0</span></span>
<span><span class="va">vY0</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">Sxx</span><span class="op">&lt;-</span><span class="fl">10</span> <span class="co">#Look at effects</span></span>
<span></span>
<span><span class="va">Z_direct</span><span class="op">&lt;-</span><span class="fl">2</span></span>
<span><span class="va">vcv</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>,<span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span> <span class="co">#No correlation between traits</span></span>
<span><span class="va">Xs</span><span class="op">&lt;-</span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/sim.corrs.html" class="external-link">sim.corrs</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">vcv</span><span class="op">)</span> <span class="co">#Simulated correlated BM Xs</span></span>
<span></span>
<span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/phenogram.html" class="external-link">phenogram</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">Xs</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,spread.labels<span class="op">=</span><span class="cn">TRUE</span>,spread.cost<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="co">#Plot X data</span></span>
<span><span class="co">#&gt; Optimizing the positions of the tip labels...</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/phenogram.html" class="external-link">phenogram</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">Xs</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,spread.labels<span class="op">=</span><span class="cn">TRUE</span>,spread.cost<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="co">#Plot X data</span></span>
<span><span class="co">#&gt; Optimizing the positions of the tip labels...</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-13-2.png" width="700"></p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">dmX</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/weight.matrix.html">weight.matrix</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>, <span class="va">a</span>, <span class="va">lineages</span><span class="op">)</span> <span class="co">#Slouch approach</span></span>
<span><span class="va">optima</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">beta</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>,<span class="fl">0.15</span>,<span class="fl">0.35</span>,<span class="fl">0.1</span><span class="op">)</span>,ncol<span class="op">=</span><span class="fl">2</span>,nrow<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="co">#Two traits on columns, two regimes on vertical</span></span>
<span></span>
<span><span class="va">mu</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="va">N</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">mu</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">&lt;-</span><span class="va">dmX</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">optima</span><span class="op">+</span><span class="va">Xs</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">beta</span><span class="op">[</span><span class="va">reg_tips</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="op">]</span><span class="op">)</span>;</span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">V</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/calc_direct_V.html">calc_direct_V</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">sigma2_y</span>,<span class="va">a</span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">&lt;-</span><span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1</span>,<span class="va">mu</span>,<span class="va">V</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">###############################################################################################################</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">Xs</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = Y ~ Xs)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co">#&gt; -0.6152 -0.1345  0.0522  0.1855  0.6367 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  2.08836    0.06612  31.586  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; Xs1          0.14271    0.04411   3.235  0.00223 ** </span></span>
<span><span class="co">#&gt; Xs2          0.57905    0.05554  10.426  8.2e-14 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 0.2864 on 47 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.7791, Adjusted R-squared:  0.7697 </span></span>
<span><span class="co">#&gt; F-statistic:  82.9 on 2 and 47 DF,  p-value: 3.866e-16</span></span>
<span></span>
<span><span class="co">################################################################################################################</span></span>
<span></span>
<span></span>
<span><span class="co">################################################################################################################</span></span>
<span><span class="co">#Simulate errors </span></span>
<span><span class="va">Z_X_error</span><span class="op">&lt;-</span><span class="fl">2</span> <span class="co">#Number of X traits with error</span></span>
<span><span class="va">X_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0.01</span>,nrow<span class="op">=</span><span class="va">N</span>,ncol<span class="op">=</span><span class="va">Z_X_error</span><span class="op">)</span></span>
<span><span class="va">X_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">X_error</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">X_error</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X1_error"</span>,<span class="st">"X2_error"</span><span class="op">)</span></span>
<span><span class="va">Y_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Y_with_error</span><span class="op">&lt;-</span><span class="va">Y</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">X_with_error</span><span class="op">&lt;-</span><span class="va">Xs</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">X_with_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">X_with_error</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">X_with_error</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X1"</span>,<span class="st">"X2"</span><span class="op">)</span></span>
<span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Make trdata file</span></span>
<span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span>,<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Y_with_error</span>,<span class="va">Y_error</span>,<span class="va">X_with_error</span>,<span class="va">X_error</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We will use the helper function blouch.reg.direct.prep() to setup the
dat file for Stan. Here “Z_direct” is the number of predictors, and
“regimes” is the name of the regime column in trdata$dat.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Test Blouch prep code - Regimes + Direct Efffect model</span></span>
<span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/blouch.reg.direct.prep.html">blouch.reg.direct.prep</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="st">"Y_with_error"</span>,<span class="st">"Y_error"</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X1"</span>,<span class="st">"X2"</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X1_error"</span>,<span class="st">"X2_error"</span><span class="op">)</span>,Z_direct<span class="op">=</span><span class="fl">2</span>,<span class="st">"regimes"</span><span class="op">)</span></span></code></pre></div>
<p>Multilevel Multi-optima Direct Efect Model with Varying Effects</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.direct.mlm.ve</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_direct_mlm_ve</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">1</span>,cores<span class="op">=</span><span class="fl">1</span>,iter <span class="op">=</span><span class="fl">400</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: There were 47 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span>
<span><span class="co">#&gt; Warning: The largest R-hat is NA, indicating chains have not mixed.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#r-hat</span></span>
<span><span class="co">#&gt; Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#bulk-ess</span></span>
<span><span class="co">#&gt; Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#tail-ess</span></span></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.direct.mlm.ve</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima_bar"</span>,<span class="st">"beta_bar"</span>,<span class="st">"Rho"</span>,<span class="st">"sigma"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_mlm_ve.</span></span>
<span><span class="co">#&gt; 1 chains, each with iter=400; warmup=200; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=200, total post-warmup draws=200.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;              mean se_mean   sd  2.5%   25%   50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl           0.13    0.02 0.09  0.05  0.06  0.12 0.16  0.41    12 1.13</span></span>
<span><span class="co">#&gt; vy           0.01    0.00 0.00  0.01  0.01  0.01 0.01  0.02    16 1.09</span></span>
<span><span class="co">#&gt; optima_bar  -0.24    0.09 0.60 -1.49 -0.54 -0.30 0.09  1.03    40 1.05</span></span>
<span><span class="co">#&gt; beta_bar[1]  0.56    0.14 0.65  0.01  0.18  0.32 0.69  2.82    23 1.00</span></span>
<span><span class="co">#&gt; beta_bar[2]  3.50    1.57 2.54  0.11  0.71  4.33 6.01  6.72     3 3.86</span></span>
<span><span class="co">#&gt; Rho[1,1]     1.00     NaN 0.00  1.00  1.00  1.00 1.00  1.00   NaN  NaN</span></span>
<span><span class="co">#&gt; Rho[1,2]    -0.06    0.10 0.35 -0.63 -0.36 -0.11 0.31  0.44    12 1.06</span></span>
<span><span class="co">#&gt; Rho[1,3]    -0.14    0.08 0.33 -0.72 -0.40 -0.13 0.06  0.52    19 1.03</span></span>
<span><span class="co">#&gt; Rho[2,1]    -0.06    0.10 0.35 -0.63 -0.36 -0.11 0.31  0.44    12 1.06</span></span>
<span><span class="co">#&gt; Rho[2,2]     1.00    0.00 0.00  1.00  1.00  1.00 1.00  1.00   124 0.99</span></span>
<span><span class="co">#&gt; Rho[2,3]     0.13    0.05 0.32 -0.55 -0.01  0.11 0.34  0.80    42 1.02</span></span>
<span><span class="co">#&gt; Rho[3,1]    -0.14    0.08 0.33 -0.72 -0.40 -0.13 0.06  0.52    19 1.03</span></span>
<span><span class="co">#&gt; Rho[3,2]     0.13    0.05 0.32 -0.55 -0.01  0.11 0.34  0.80    42 1.02</span></span>
<span><span class="co">#&gt; Rho[3,3]     1.00    0.00 0.00  1.00  1.00  1.00 1.00  1.00    71 0.99</span></span>
<span><span class="co">#&gt; sigma[1]     1.34    0.08 0.46  0.76  0.96  1.24 1.62  2.36    33 1.04</span></span>
<span><span class="co">#&gt; sigma[2]     0.41    0.09 0.48  0.03  0.08  0.22 0.59  1.71    27 1.04</span></span>
<span><span class="co">#&gt; sigma[3]     1.76    0.64 1.09  0.07  0.61  1.96 2.68  3.31     3 2.56</span></span>
<span><span class="co">#&gt; optima[1]    2.05    0.01 0.03  2.00  2.02  2.04 2.06  2.13    39 1.11</span></span>
<span><span class="co">#&gt; optima[2]    1.15    0.02 0.12  0.92  1.08  1.17 1.22  1.39    37 1.03</span></span>
<span><span class="co">#&gt; beta[1,1]    0.21    0.00 0.02  0.18  0.20  0.21 0.23  0.26    35 1.00</span></span>
<span><span class="co">#&gt; beta[1,2]    0.34    0.00 0.03  0.29  0.32  0.33 0.35  0.39    71 1.04</span></span>
<span><span class="co">#&gt; beta[2,1]    0.22    0.01 0.07  0.10  0.17  0.21 0.26  0.34    40 1.04</span></span>
<span><span class="co">#&gt; beta[2,2]    0.26    0.01 0.07  0.14  0.22  0.24 0.30  0.40    48 1.00</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Mon Sep 25 13:56:03 2023.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="co">#plot(rethinking::precis(fit.reg.direct.mlm.ve,depth=3,pars = c("hl","vy","optima_bar","beta_bar","Rho","sigma","optima","beta")))</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.direct.mlm.ve</span><span class="op">)</span></span></code></pre></div>
<p>Multilevel Multi-optima Direct Efect Model with Varying Effects -
non-centered</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.direct.mlm.ve.nc</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_direct_mlm_ve_nc</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">1</span>,cores<span class="op">=</span><span class="fl">1</span>,iter <span class="op">=</span><span class="fl">400</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: There were 7 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span>
<span><span class="co">#&gt; Warning: The largest R-hat is NA, indicating chains have not mixed.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#r-hat</span></span>
<span><span class="co">#&gt; Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#bulk-ess</span></span>
<span><span class="co">#&gt; Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#tail-ess</span></span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.direct.mlm.ve.nc</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima_bar"</span>,<span class="st">"beta_bar"</span>,<span class="st">"Rho"</span>,<span class="st">"sigma"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_mlm_ve_nc.</span></span>
<span><span class="co">#&gt; 1 chains, each with iter=400; warmup=200; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=200, total post-warmup draws=200.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;             mean se_mean   sd  2.5%   25%   50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl          0.17    0.01 0.09  0.07  0.11  0.15 0.21  0.46    84 1.00</span></span>
<span><span class="co">#&gt; vy          0.01    0.00 0.00  0.01  0.01  0.01 0.01  0.02   104 1.00</span></span>
<span><span class="co">#&gt; optima_bar -0.06    0.07 0.71 -1.38 -0.50 -0.04 0.33  1.30   112 1.00</span></span>
<span><span class="co">#&gt; beta_bar    0.42    0.10 0.23  0.11  0.25  0.36 0.57  0.90     5 1.09</span></span>
<span><span class="co">#&gt; Rho[1,1]    1.00     NaN 0.00  1.00  1.00  1.00 1.00  1.00   NaN  NaN</span></span>
<span><span class="co">#&gt; Rho[1,2]   -0.15    0.04 0.32 -0.72 -0.37 -0.20 0.05  0.47    53 1.02</span></span>
<span><span class="co">#&gt; Rho[1,3]   -0.06    0.04 0.30 -0.59 -0.27 -0.04 0.15  0.47    57 1.02</span></span>
<span><span class="co">#&gt; Rho[2,1]   -0.15    0.04 0.32 -0.72 -0.37 -0.20 0.05  0.47    53 1.02</span></span>
<span><span class="co">#&gt; Rho[2,2]    1.00    0.00 0.00  1.00  1.00  1.00 1.00  1.00   148 0.99</span></span>
<span><span class="co">#&gt; Rho[2,3]    0.04    0.03 0.30 -0.53 -0.19  0.07 0.26  0.56   114 1.01</span></span>
<span><span class="co">#&gt; Rho[3,1]   -0.06    0.04 0.30 -0.59 -0.27 -0.04 0.15  0.47    57 1.02</span></span>
<span><span class="co">#&gt; Rho[3,2]    0.04    0.03 0.30 -0.53 -0.19  0.07 0.26  0.56   114 1.01</span></span>
<span><span class="co">#&gt; Rho[3,3]    1.00    0.00 0.00  1.00  1.00  1.00 1.00  1.00   186 0.99</span></span>
<span><span class="co">#&gt; sigma[1]    1.51    0.05 0.50  0.65  1.14  1.49 1.87  2.51   102 1.00</span></span>
<span><span class="co">#&gt; sigma[2]    0.43    0.09 0.37  0.01  0.14  0.31 0.61  1.31    16 1.02</span></span>
<span><span class="co">#&gt; sigma[3]    0.38    0.08 0.37  0.01  0.11  0.26 0.50  1.33    20 1.08</span></span>
<span><span class="co">#&gt; optima[1]   2.05    0.00 0.04  1.98  2.02  2.04 2.07  2.12   163 1.00</span></span>
<span><span class="co">#&gt; optima[2]   1.14    0.01 0.14  0.77  1.08  1.16 1.22  1.37   111 1.00</span></span>
<span><span class="co">#&gt; beta[1,1]   0.22    0.00 0.02  0.17  0.21  0.22 0.23  0.26   190 1.00</span></span>
<span><span class="co">#&gt; beta[1,2]   0.33    0.00 0.03  0.28  0.31  0.34 0.35  0.39   144 1.01</span></span>
<span><span class="co">#&gt; beta[2,1]   0.22    0.01 0.07  0.07  0.18  0.23 0.26  0.34    92 1.00</span></span>
<span><span class="co">#&gt; beta[2,2]   0.27    0.01 0.06  0.15  0.22  0.27 0.31  0.39   141 1.00</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Mon Sep 25 13:56:58 2023.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="co">#plot(rethinking::precis(fit.reg.direct.mlm.ve.nc,depth=3,pars = c("hl","vy","optima_bar","beta_bar","Rho","sigma","optima","beta")))</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.direct.mlm.ve.nc</span><span class="op">)</span></span></code></pre></div>
<p>Multi-optima Direct Efect Model with Varying Effects</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.direct.ve</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_direct_ve</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">1</span>,cores<span class="op">=</span><span class="fl">1</span>,iter <span class="op">=</span><span class="fl">400</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: The largest R-hat is NA, indicating chains have not mixed.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#r-hat</span></span>
<span><span class="co">#&gt; Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#bulk-ess</span></span>
<span><span class="co">#&gt; Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#tail-ess</span></span></code></pre></div>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.direct.ve</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_ve.</span></span>
<span><span class="co">#&gt; 1 chains, each with iter=400; warmup=200; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=200, total post-warmup draws=200.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd  2.5%   25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.70    0.30 0.55  0.10  0.18 0.66 1.01  1.93     3 1.96</span></span>
<span><span class="co">#&gt; vy        0.03    0.01 0.02  0.01  0.01 0.03 0.05  0.08     4 1.84</span></span>
<span><span class="co">#&gt; optima[1] 2.04    0.00 0.08  1.87  2.00 2.04 2.08  2.21   407 1.00</span></span>
<span><span class="co">#&gt; optima[2] 0.32    0.44 0.80 -1.25 -0.31 0.44 1.07  1.24     3 2.04</span></span>
<span><span class="co">#&gt; beta[1,1] 0.22    0.00 0.03  0.16  0.20 0.22 0.23  0.28   443 1.01</span></span>
<span><span class="co">#&gt; beta[1,2] 0.34    0.00 0.03  0.27  0.32 0.34 0.36  0.40   460 1.00</span></span>
<span><span class="co">#&gt; beta[2,1] 0.23    0.01 0.09  0.05  0.16 0.22 0.28  0.43   169 1.01</span></span>
<span><span class="co">#&gt; beta[2,2] 0.22    0.01 0.07  0.07  0.17 0.22 0.27  0.35   168 1.02</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Mon Sep 25 13:57:10 2023.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="co">#plot(rethinking::precis(fit.reg.direct.ve,depth=3,pars = c("hl","vy","optima","beta")))</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.direct.ve</span><span class="op">)</span></span></code></pre></div>
<p>From there the posteriors should be explored, compared to the priors,
etc. See the Simulation Example for one example of how to do this.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="multlevel-multi-optima-adaptive-model-with-varying-effects---single-predictor">Multlevel Multi-optima Adaptive Model with Varying Effects - Single
Predictor<a class="anchor" aria-label="anchor" href="#multlevel-multi-optima-adaptive-model-with-varying-effects---single-predictor"></a>
</h2>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">########################################################################################################</span></span>
<span><span class="co">#Two regimes with adaptive trait and multiple slopes per optima but single alpha parameter</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">N</span><span class="op">&lt;-</span><span class="fl">50</span> <span class="co">#Number of species</span></span>
<span><span class="co">#set.seed(1) #Set seed to get same random species each time</span></span>
<span></span>
<span><span class="va">phy</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/drop.tip.html" class="external-link">keep.tip</a></span><span class="op">(</span><span class="va">tree.10K</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">tree.10K</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">]</span><span class="op">)</span> </span>
<span><span class="va">phy</span><span class="op">&lt;-</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/multi2di.html" class="external-link">multi2di</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span></span>
<span></span>
<span><span class="va">l.tree</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/branching.times.html" class="external-link">branching.times</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span><span class="op">)</span> <span class="co">## rescale tree to height 1</span></span>
<span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">/</span><span class="va">l.tree</span> </span>
<span></span>
<span><span class="co">#Set regimes - manually - 2 regimes</span></span>
<span><span class="co">#Locate nodes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">phy</span>,no.margin<span class="op">=</span><span class="cn">TRUE</span>,edge.width<span class="op">=</span><span class="fl">2</span>,cex<span class="op">=</span><span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/nodelabels.html" class="external-link">nodelabels</a></span><span class="op">(</span>frame<span class="op">=</span><span class="st">"none"</span>,adj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.1</span>,<span class="op">-</span><span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/nodelabels.html" class="external-link">tiplabels</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-22-1.png" width="700"></p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Paint Regimes on Tree</span></span>
<span><span class="va">shifts</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">84</span><span class="op">)</span> <span class="co">#Location of nodes with regime shifts</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu">treeplyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/treeplyr/man/make.treedata.html" class="external-link">make.treedata</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">trdata</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/set.converge.regimes.html">set.converge.regimes</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="va">shifts</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; Levels: OU1 OU2</span></span>
<span><span class="co">#&gt; [1] "#E64B35FF" "#4DBBD5FF"</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-22-2.png" width="700"></p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="co">#Check if manual setting code worked</span></span>
<span><span class="va">shifts.total</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span>,<span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">node.label</span><span class="op">)</span></span>
<span><span class="va">edge.regimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">shifts.total</span><span class="op">[</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">edge</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#print(edge.regimes)</span></span>
<span></span>
<span><span class="va">reg_tips</span><span class="op">&lt;-</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span></span>
<span><span class="va">reg_tips</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">reg_tips</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">reg.colors</span> <span class="op">&lt;-</span> <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/pal_aaas.html" class="external-link">pal_aaas</a></span><span class="op">(</span><span class="st">"default"</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">reg.colors</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "#3B4992B2" "#EE0000B2"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>,edge.color <span class="op">=</span> <span class="va">reg.colors</span><span class="op">[</span><span class="va">edge.regimes</span><span class="op">]</span>, edge.width <span class="op">=</span> <span class="fl">1</span>, cex <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-22-3.png" width="700"></p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Phylogeny info</span></span>
<span><span class="va">n</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span></span>
<span></span>
<span><span class="va">regimes_internal</span> <span class="op">&lt;-</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">node.label</span></span>
<span><span class="va">regimes_tip</span> <span class="op">&lt;-</span> <span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span></span>
<span><span class="va">regimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/concat.factor.html">concat.factor</a></span><span class="op">(</span><span class="va">regimes_tip</span>, <span class="va">regimes_internal</span><span class="op">)</span></span>
<span><span class="va">anc_maps</span><span class="op">&lt;-</span><span class="st">"regimes"</span></span>
<span><span class="va">lineages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="fu"><a href="../reference/lineage.constructor.html">lineage.constructor</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>, <span class="va">e</span>, <span class="va">anc_maps</span>, <span class="va">regimes</span><span class="op">)</span><span class="op">)</span> <span class="co">#Trace lineage from tips (n) to root and determine regimes of each node or branch</span></span></code></pre></div>
<p>Simulate X and Y data</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">###############################################################################################################################################################################</span></span>
<span><span class="va">hl</span><span class="op">&lt;-</span><span class="fl">0.1</span> <span class="co">#0.1, 0.25, 0.75 - testing options</span></span>
<span><span class="va">a</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span></span>
<span><span class="va">vy</span><span class="op">&lt;-</span><span class="fl">0.01</span> <span class="co">#0.25,0.5 - testing options</span></span>
<span><span class="va">sigma2_y</span><span class="op">&lt;-</span><span class="va">vy</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span><span class="op">)</span><span class="op">)</span>;</span>
<span></span>
<span><span class="va">vX0</span><span class="op">&lt;-</span><span class="fl">0</span></span>
<span><span class="va">vY0</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">sigma2_x</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span> <span class="co">#Variance of BM Process</span></span>
<span></span>
<span></span>
<span><span class="va">X</span><span class="op">&lt;-</span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/fastBM.html" class="external-link">fastBM</a></span><span class="op">(</span><span class="va">phy</span>,a<span class="op">=</span><span class="va">vX0</span>,sig2<span class="op">=</span><span class="va">sigma2_x</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>,internal<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="co">#Simulate X BM variable on tree, with scaling 10</span></span>
<span><span class="va">Z_adaptive</span><span class="op">&lt;-</span><span class="fl">1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span></span>
<span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/phenogram.html" class="external-link">phenogram</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">X</span>,spread.labels<span class="op">=</span><span class="cn">TRUE</span>,spread.cost<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="co">#Plot X data</span></span>
<span><span class="co">#&gt; Optimizing the positions of the tip labels...</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-23-1.png" width="700"></p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">optima_matrix</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/weight.matrix.html">weight.matrix</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>, <span class="va">a</span>, <span class="va">lineages</span><span class="op">)</span> <span class="co">#Slouch approach</span></span>
<span><span class="va">pred_X</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/calc_adaptive_dmX.html">calc_adaptive_dmX</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">a</span>,<span class="va">X</span><span class="op">)</span></span>
<span><span class="va">optima</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">beta</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>,<span class="fl">0.15</span><span class="op">)</span> <span class="co">#Two Optima/Two Slopes</span></span>
<span></span>
<span><span class="va">mu</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="va">N</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">mu</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="va">optima_matrix</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">optima</span><span class="op">+</span><span class="va">beta</span><span class="op">[</span><span class="va">reg_tips</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">pred_X</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">n_reg</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">regimes</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">V</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/calc_adaptive_V.html">calc_adaptive_V</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">a</span>, <span class="va">sigma2_y</span>, <span class="va">beta</span>,  <span class="va">sigma2_x</span>, <span class="va">Z_adaptive</span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">&lt;-</span><span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1</span>,<span class="va">mu</span>,<span class="va">V</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">###############################################################################################################</span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">Y</span>,X<span class="op">=</span><span class="va">X</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">X</span>,y<span class="op">=</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-23-2.png" width="700"></p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">X</span>,<span class="va">df</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = Y ~ X, data = df)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co">#&gt; -1.04977  0.02018  0.19840  0.31943  0.43449 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  1.73207    0.07814  22.167  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; X            0.19695    0.07042   2.797  0.00741 ** </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 0.491 on 48 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.1401, Adjusted R-squared:  0.1222 </span></span>
<span><span class="co">#&gt; F-statistic: 7.821 on 1 and 48 DF,  p-value: 0.007408</span></span>
<span></span>
<span><span class="co">################################################################################################################</span></span>
<span></span>
<span><span class="co">################################################################################################################</span></span>
<span><span class="co">#Simulate errors </span></span>
<span><span class="va">Z_X_error</span><span class="op">&lt;-</span><span class="fl">1</span> <span class="co">#Number of X traits with error</span></span>
<span><span class="va">X_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Y_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Y_with_error</span><span class="op">&lt;-</span><span class="va">Y</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">X_with_error</span><span class="op">&lt;-</span><span class="va">X</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Make trdata file</span></span>
<span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span>,<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Y_with_error</span>,<span class="va">Y_error</span>,<span class="va">X_with_error</span>,<span class="va">X_error</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We will use the helper function blouch.reg.adapt.prep() to setup the
dat file for Stan. Here “Z_adaptive” is the number of predictors, and
“regimes” is the name of the regime column in trdata$dat.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Test Blouch prep code - Regimes + Direct Efffect model</span></span>
<span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/blouch.reg.adapt.prep.html">blouch.reg.adapt.prep</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="st">"Y_with_error"</span>,<span class="st">"Y_error"</span>,<span class="st">"X_with_error"</span>,<span class="st">"X_error"</span>,Z_adaptive<span class="op">=</span><span class="fl">1</span>,<span class="st">"regimes"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">########################################################################################################</span></span>
<span></span>
<span><span class="co">#Plot of data</span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">dat</span><span class="op">$</span><span class="va">Y_obs</span>,X<span class="op">=</span><span class="va">dat</span><span class="op">$</span><span class="va">X_obs</span>,Regimes<span class="op">=</span><span class="va">regimes_tip</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">#slope.prior.plot&lt;-ggplot(data=reg.trdata$dat,aes(y=Sim1,x=X))+</span></span>
<span><span class="va">slope.plot.1</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">Y</span>,x<span class="op">=</span><span class="va">X</span>,color<span class="op">=</span><span class="va">Regimes</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#ggtitle("Prior vs. Posterior for Intercept and Slope")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Adaptive trait"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">slope.plot.1</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-25-1.png" width="700"></p>
<p>Now we run the Multilevel Multi-optima Adaptive Model with Varying
Effects, look at the results, and rstan::extract the posterior</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.adapt.mlm.ve</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_adapt_mlm_ve</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">1</span>,cores<span class="op">=</span><span class="fl">1</span>,iter<span class="op">=</span><span class="fl">400</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: There were 8 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span>
<span><span class="co">#&gt; Warning: The largest R-hat is NA, indicating chains have not mixed.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#r-hat</span></span>
<span><span class="co">#&gt; Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#bulk-ess</span></span>
<span><span class="co">#&gt; Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#tail-ess</span></span></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.adapt.mlm.ve</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_adapt_mlm_ve.</span></span>
<span><span class="co">#&gt; 1 chains, each with iter=400; warmup=200; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=200, total post-warmup draws=200.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd  2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.23    0.01 0.13  0.07 0.14 0.21 0.31  0.57   128    1</span></span>
<span><span class="co">#&gt; vy        0.01    0.00 0.01  0.00 0.01 0.01 0.02  0.03   224    1</span></span>
<span><span class="co">#&gt; optima[1] 1.98    0.00 0.06  1.86 1.94 1.98 2.03  2.11   248    1</span></span>
<span><span class="co">#&gt; optima[2] 0.79    0.02 0.20  0.25 0.69 0.83 0.92  1.07   123    1</span></span>
<span><span class="co">#&gt; beta[1,1] 0.30    0.01 0.08  0.19 0.24 0.29 0.34  0.49   181    1</span></span>
<span><span class="co">#&gt; beta[2,1] 0.15    0.01 0.17 -0.16 0.04 0.15 0.27  0.46   177    1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Mon Sep 25 13:57:42 2023.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="co">#plot(rethinking::precis(fit.reg.adapt.mlm.ve,depth=2,pars = c("hl","vy","optima","beta")))</span></span>
<span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.adapt.mlm.ve</span><span class="op">)</span> <span class="co">#rstan::extract posterior distribution</span></span></code></pre></div>
<p>Now we run the non-centered version of the Multilevel Multi-optima
Adaptive Model with Varying Effects</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.adapt.mlm.ve.nc</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_adapt_mlm_ve_nc</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">1</span>,cores<span class="op">=</span><span class="fl">1</span>,iter<span class="op">=</span><span class="fl">400</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: There were 1 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span>
<span><span class="co">#&gt; Warning: The largest R-hat is NA, indicating chains have not mixed.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#r-hat</span></span>
<span><span class="co">#&gt; Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#bulk-ess</span></span>
<span><span class="co">#&gt; Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#tail-ess</span></span></code></pre></div>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.adapt.mlm.ve.nc</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_adapt_mlm_ve_nc.</span></span>
<span><span class="co">#&gt; 1 chains, each with iter=400; warmup=200; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=200, total post-warmup draws=200.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd  2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.25    0.02 0.15  0.07 0.14 0.21 0.30  0.66    97 1.01</span></span>
<span><span class="co">#&gt; vy        0.01    0.00 0.01  0.00 0.01 0.01 0.02  0.03    83 1.01</span></span>
<span><span class="co">#&gt; optima[1] 1.99    0.00 0.07  1.87 1.95 1.98 2.02  2.12   177 1.00</span></span>
<span><span class="co">#&gt; optima[2] 0.75    0.03 0.26  0.00 0.66 0.82 0.90  1.04   105 1.01</span></span>
<span><span class="co">#&gt; beta[1,1] 0.31    0.01 0.10  0.19 0.25 0.29 0.34  0.58   107 1.02</span></span>
<span><span class="co">#&gt; beta[2,1] 0.19    0.02 0.18 -0.13 0.07 0.18 0.30  0.47    93 1.03</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Mon Sep 25 13:58:20 2023.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="co">#plot(rethinking::precis(fit.reg.adapt.mlm.ve.nc,depth=2,pars = c("hl","vy","optima","beta")))</span></span>
<span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.adapt.mlm.ve.nc</span><span class="op">)</span> <span class="co">#rstan::extract posterior distribution</span></span></code></pre></div>
<p>Finally we run the Multi-optima Adaptive Model with Varying
Effects</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.adapt.ve</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_adapt_ve</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">1</span>,cores<span class="op">=</span><span class="fl">1</span>,iter<span class="op">=</span><span class="fl">400</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: The largest R-hat is NA, indicating chains have not mixed.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#r-hat</span></span>
<span><span class="co">#&gt; Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#bulk-ess</span></span>
<span><span class="co">#&gt; Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#tail-ess</span></span></code></pre></div>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.adapt.ve</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_adapt_ve.</span></span>
<span><span class="co">#&gt; 1 chains, each with iter=400; warmup=200; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=200, total post-warmup draws=200.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd  2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.19    0.01 0.09  0.08 0.12 0.17 0.24  0.43    59    1</span></span>
<span><span class="co">#&gt; vy        0.01    0.00 0.01  0.00 0.01 0.01 0.02  0.03   134    1</span></span>
<span><span class="co">#&gt; optima[1] 1.98    0.00 0.06  1.89 1.94 1.98 2.02  2.10   228    1</span></span>
<span><span class="co">#&gt; optima[2] 0.86    0.01 0.14  0.47 0.81 0.88 0.95  1.07   103    1</span></span>
<span><span class="co">#&gt; beta[1,1] 0.28    0.01 0.06  0.19 0.24 0.27 0.32  0.42    77    1</span></span>
<span><span class="co">#&gt; beta[2,1] 0.11    0.01 0.14 -0.14 0.02 0.10 0.21  0.39   138    1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Mon Sep 25 13:58:39 2023.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="co">#plot(rethinking::precis(fit.reg.adapt.ve,depth=2,pars = c("hl","vy","optima","beta")))</span></span>
<span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.adapt.ve</span><span class="op">)</span> <span class="co">#rstan::extract posterior distribution</span></span></code></pre></div>
<p>From there the posteriors should be explored, compared to the priors,
etc. See the Simulation Example for one example of how to do this.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="multi-optima-direct-effect-and-adaptive-models-with-varying-effects---multiple-predictors">Multi-optima Direct Effect and Adaptive models with Varying Effects
- Multiple predictors<a class="anchor" aria-label="anchor" href="#multi-optima-direct-effect-and-adaptive-models-with-varying-effects---multiple-predictors"></a>
</h2>
<p>Two regimes with 1 direct and 1 adaptive trait and two slopes per
regime</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">########################################################################################################</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">N</span><span class="op">&lt;-</span><span class="fl">50</span> <span class="co">#Number of species</span></span>
<span><span class="co">#set.seed(1) #Set seed to get same random species each time</span></span>
<span></span>
<span><span class="va">phy</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/drop.tip.html" class="external-link">keep.tip</a></span><span class="op">(</span><span class="va">tree.10K</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">tree.10K</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">]</span><span class="op">)</span> </span>
<span><span class="va">phy</span><span class="op">&lt;-</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/multi2di.html" class="external-link">multi2di</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span></span>
<span></span>
<span><span class="va">l.tree</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/branching.times.html" class="external-link">branching.times</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span><span class="op">)</span> <span class="co">## rescale tree to height 1</span></span>
<span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">/</span><span class="va">l.tree</span> </span>
<span></span>
<span><span class="co">#Set regimes - manually - 2 regimes</span></span>
<span><span class="co">#Locate nodes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">phy</span>,no.margin<span class="op">=</span><span class="cn">TRUE</span>,edge.width<span class="op">=</span><span class="fl">2</span>,cex<span class="op">=</span><span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/nodelabels.html" class="external-link">nodelabels</a></span><span class="op">(</span>frame<span class="op">=</span><span class="st">"none"</span>,adj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.1</span>,<span class="op">-</span><span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/nodelabels.html" class="external-link">tiplabels</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-33-1.png" width="700"></p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Paint Regimes on Tree</span></span>
<span><span class="va">shifts</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">84</span><span class="op">)</span> <span class="co">#Location of nodes with regime shifts</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu">treeplyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/treeplyr/man/make.treedata.html" class="external-link">make.treedata</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">trdata</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/set.converge.regimes.html">set.converge.regimes</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="va">shifts</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; Levels: OU1 OU2</span></span>
<span><span class="co">#&gt; [1] "#E64B35FF" "#4DBBD5FF"</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-33-2.png" width="700"></p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Check if manual setting code worked</span></span>
<span><span class="va">shifts.total</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span>,<span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">node.label</span><span class="op">)</span></span>
<span><span class="va">edge.regimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">shifts.total</span><span class="op">[</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">edge</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">edge.regimes</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; Levels: OU1 OU2</span></span>
<span></span>
<span><span class="va">reg_tips</span><span class="op">&lt;-</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span></span>
<span><span class="va">reg_tips</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">reg_tips</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">reg.colors</span> <span class="op">&lt;-</span> <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/pal_aaas.html" class="external-link">pal_aaas</a></span><span class="op">(</span><span class="st">"default"</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">reg.colors</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "#3B4992B2" "#EE0000B2"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>,edge.color <span class="op">=</span> <span class="va">reg.colors</span><span class="op">[</span><span class="va">edge.regimes</span><span class="op">]</span>, edge.width <span class="op">=</span> <span class="fl">1</span>, cex <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-33-3.png" width="700"></p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Phylogeny info</span></span>
<span><span class="va">n</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span></span>
<span></span>
<span><span class="va">regimes_internal</span> <span class="op">&lt;-</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">node.label</span></span>
<span><span class="va">regimes_tip</span> <span class="op">&lt;-</span> <span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span></span>
<span><span class="va">regimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/concat.factor.html">concat.factor</a></span><span class="op">(</span><span class="va">regimes_tip</span>, <span class="va">regimes_internal</span><span class="op">)</span></span>
<span><span class="va">anc_maps</span><span class="op">&lt;-</span><span class="st">"regimes"</span></span>
<span><span class="va">lineages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="fu"><a href="../reference/lineage.constructor.html">lineage.constructor</a></span><span class="op">(</span><span class="va">phy</span>, <span class="va">e</span>, <span class="va">anc_maps</span>, <span class="va">regimes</span><span class="op">)</span><span class="op">)</span> <span class="co">#Trace lineage from tips (n) to root and determine regimes of each node or branch</span></span></code></pre></div>
<p>Simulate X and Y data using generative model</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">################################################################################################################</span></span>
<span><span class="va">hl</span><span class="op">&lt;-</span><span class="fl">0.1</span> <span class="co">#0.1, 0.25, 0.75 - testing options</span></span>
<span><span class="va">a</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span></span>
<span><span class="va">vy</span><span class="op">&lt;-</span><span class="fl">0.01</span> <span class="co">#0.25,0.5 - testing options</span></span>
<span><span class="va">sigma2_y</span><span class="op">&lt;-</span><span class="va">vy</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span><span class="op">)</span><span class="op">)</span>;</span>
<span></span>
<span><span class="va">vX0</span><span class="op">&lt;-</span><span class="fl">0</span></span>
<span><span class="va">vY0</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">sigma2_x</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span> <span class="co">#Variance of BM Process</span></span>
<span></span>
<span><span class="va">Xa</span><span class="op">&lt;-</span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/fastBM.html" class="external-link">fastBM</a></span><span class="op">(</span><span class="va">phy</span>,a<span class="op">=</span><span class="va">vX0</span>,sig2<span class="op">=</span><span class="va">sigma2_x</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>,internal<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="co">#Simulate X BM variable on tree, with scaling 10</span></span>
<span><span class="va">Xd</span><span class="op">&lt;-</span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/fastBM.html" class="external-link">fastBM</a></span><span class="op">(</span><span class="va">phy</span>,a<span class="op">=</span><span class="va">vX0</span>,sig2<span class="op">=</span><span class="va">sigma2_x</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>,internal<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="co">#Simulate X BM variable on tree, with scaling 10</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">Xa</span><span class="op">)</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">Xd</span><span class="op">)</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span></span>
<span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/phenogram.html" class="external-link">phenogram</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">Xd</span>,spread.labels<span class="op">=</span><span class="cn">TRUE</span>,spread.cost<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="co">#Plot X data</span></span>
<span><span class="co">#&gt; Optimizing the positions of the tip labels...</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-34-1.png" width="700"></p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/phenogram.html" class="external-link">phenogram</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">Xa</span>,spread.labels<span class="op">=</span><span class="cn">TRUE</span>,spread.cost<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="co">#Plot X data</span></span>
<span><span class="co">#&gt; Optimizing the positions of the tip labels...</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-34-2.png" width="700"></p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">Xs</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Xd</span>,<span class="va">Xa</span><span class="op">)</span></span>
<span><span class="va">sigma2_x</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span> <span class="co">#Variance of BM Process</span></span>
<span></span>
<span><span class="va">Z_adaptive</span><span class="op">&lt;-</span><span class="fl">1</span></span>
<span><span class="va">Z_direct</span><span class="op">&lt;-</span><span class="fl">1</span></span>
<span></span>
<span><span class="va">optima_matrix</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/weight.matrix.html">weight.matrix</a></span><span class="op">(</span><span class="va">phy</span>, <span class="va">a</span>, <span class="va">lineages</span><span class="op">)</span> <span class="co">#Slouch approach</span></span>
<span><span class="va">pred_X</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/calc_mixed_dmX.html">calc_mixed_dmX</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">a</span>,<span class="va">Xs</span>,<span class="va">Z_direct</span>,<span class="va">Z_adaptive</span><span class="op">)</span></span>
<span><span class="va">optima</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">beta</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>,<span class="fl">0.15</span>,<span class="fl">0.35</span>,<span class="fl">0.1</span><span class="op">)</span>,ncol<span class="op">=</span><span class="fl">2</span>,nrow<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="co">#Two traits on columns, two regimes on vertical</span></span>
<span></span>
<span><span class="va">mu</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="va">N</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">mu</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="va">optima_matrix</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">optima</span><span class="op">+</span><span class="va">pred_X</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">beta</span><span class="op">[</span><span class="va">reg_tips</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span><span class="va">n_reg</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">regimes</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">V</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/calc_adaptive_V.html">calc_adaptive_V</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">a</span>, <span class="va">sigma2_y</span>, <span class="va">beta</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,  <span class="va">sigma2_x</span>, <span class="va">Z_adaptive</span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">&lt;-</span><span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1</span>,<span class="va">mu</span>,<span class="va">V</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">###############################################################################################################</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">Xs</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = Y ~ Xs)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co">#&gt; -0.87644 -0.23115  0.07543  0.29025  0.48469 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  2.14016    0.08049  26.589  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; XsXd         0.61536    0.06761   9.101 6.11e-12 ***</span></span>
<span><span class="co">#&gt; XsXa         0.21118    0.05370   3.933 0.000275 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 0.3486 on 47 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.7532, Adjusted R-squared:  0.7427 </span></span>
<span><span class="co">#&gt; F-statistic: 71.73 on 2 and 47 DF,  p-value: 5.234e-15</span></span>
<span></span>
<span><span class="co">################################################################################################################</span></span></code></pre></div>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">###############################################################################################################</span></span>
<span><span class="co">#Simulate errors - original Hansen setup</span></span>
<span><span class="va">Z_X_error</span><span class="op">&lt;-</span><span class="fl">2</span> <span class="co">#Number of X traits with error</span></span>
<span><span class="va">X_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0.01</span>,nrow<span class="op">=</span><span class="va">N</span>,ncol<span class="op">=</span><span class="va">Z_X_error</span><span class="op">)</span></span>
<span><span class="va">X_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">X_error</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">X_error</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Xd_error"</span>,<span class="st">"Xa_error"</span><span class="op">)</span></span>
<span><span class="va">Y_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Y_with_error</span><span class="op">&lt;-</span><span class="va">Y</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">X_with_error</span><span class="op">&lt;-</span><span class="va">Xs</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">X_with_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">X_with_error</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">X_with_error</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Xd"</span>,<span class="st">"Xa"</span><span class="op">)</span></span>
<span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Make trdata file</span></span>
<span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span>,<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Y_with_error</span>,<span class="va">Y_error</span>,<span class="va">X_with_error</span>,<span class="va">X_error</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#names(trdata$dat)[6:7]&lt;-c("Xd_error","Xa_error")</span></span></code></pre></div>
<p>We will use the helper function blouch.reg.adapt.prep() to setup the
dat file for Stan. Here “Z_adaptive” is the number of predictors, and
“regimes” is the name of the regime column in trdata$dat.</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Test Blouch prep code - Regimes + Direct Effect model</span></span>
<span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/blouch.reg.direct.adapt.prep.html">blouch.reg.direct.adapt.prep</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="st">"Y_with_error"</span>,<span class="st">"Y_error"</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Xd"</span>,<span class="st">"Xa"</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Xd_error"</span>,<span class="st">"Xa_error"</span><span class="op">)</span>,Z_direct<span class="op">=</span><span class="fl">1</span>,Z_adaptive<span class="op">=</span><span class="fl">1</span>,<span class="st">"regimes"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">########################################################################################################</span></span>
<span><span class="co">#Plot of data</span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">dat</span><span class="op">$</span><span class="va">Y_obs</span>,X<span class="op">=</span><span class="va">dat</span><span class="op">$</span><span class="va">X_obs</span>,Regimes<span class="op">=</span><span class="va">regimes_tip</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">#slope.prior.plot&lt;-ggplot(data=reg.trdata$dat,aes(y=Sim1,x=X))+</span></span>
<span><span class="va">slope.plot.1</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">Y</span>,x<span class="op">=</span><span class="va">Xd</span>,color<span class="op">=</span><span class="va">Regimes</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#ggtitle("Prior vs. Posterior for Intercept and Slope")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Direct effect trait"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">slope.plot.1</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-37-1.png" width="700"></p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#slope.prior.plot&lt;-ggplot(data=reg.trdata$dat,aes(y=Sim1,x=X))+</span></span>
<span><span class="va">slope.plot.2</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">Y</span>,x<span class="op">=</span><span class="va">Xa</span>,color<span class="op">=</span><span class="va">Regimes</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#ggtitle("Prior vs. Posterior for Intercept and Slope")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Adaptive trait"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">slope.plot.2</span></span></code></pre></div>
<p><img src="Varying_Effects_Models-Examples_files/figure-html/unnamed-chunk-37-2.png" width="700"></p>
<p>Now we run the Multilevel Multi-optima Direct Effect Adaptive Model
with Varying Effects, look at the results, and rstan::extract the
posterior</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.direct.adapt.mlm.ve</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_direct_adapt_mlm_ve</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">1</span>,cores<span class="op">=</span><span class="fl">1</span>,iter<span class="op">=</span><span class="fl">400</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: There were 3 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span>
<span><span class="co">#&gt; Warning: The largest R-hat is NA, indicating chains have not mixed.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#r-hat</span></span>
<span><span class="co">#&gt; Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#bulk-ess</span></span>
<span><span class="co">#&gt; Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#tail-ess</span></span></code></pre></div>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.direct.adapt.mlm.ve</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_adapt_mlm_ve.</span></span>
<span><span class="co">#&gt; 1 chains, each with iter=400; warmup=200; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=200, total post-warmup draws=200.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd  2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.26    0.01 0.08  0.14 0.20 0.25 0.29  0.43    43 1.00</span></span>
<span><span class="co">#&gt; vy        0.01    0.00 0.01  0.00 0.00 0.00 0.01  0.02   143 1.00</span></span>
<span><span class="co">#&gt; optima[1] 2.04    0.02 0.08  1.88 2.00 2.04 2.10  2.22    25 1.10</span></span>
<span><span class="co">#&gt; optima[2] 1.10    0.03 0.21  0.62 0.98 1.09 1.22  1.48    36 1.00</span></span>
<span><span class="co">#&gt; beta[1,1] 0.28    0.01 0.04  0.21 0.26 0.28 0.31  0.37    36 1.08</span></span>
<span><span class="co">#&gt; beta[1,2] 0.48    0.01 0.09  0.37 0.42 0.47 0.51  0.72    37 1.00</span></span>
<span><span class="co">#&gt; beta[2,1] 0.27    0.02 0.09  0.10 0.21 0.26 0.33  0.49    33 1.00</span></span>
<span><span class="co">#&gt; beta[2,2] 0.19    0.02 0.14 -0.12 0.11 0.20 0.29  0.44    61 1.00</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Mon Sep 25 13:59:09 2023.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="co">#plot(rethinking::precis(fit.reg.direct.adapt.mlm.ve,depth=2,pars = c("hl","vy","optima","beta")))</span></span>
<span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.direct.adapt.mlm.ve</span><span class="op">)</span></span></code></pre></div>
<p>Now we run the non-centered version of the Multilevel Multi-optima
Direct Effect Adaptive Model with Varying Effects</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.direct.adapt.mlm.ve.nc</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_direct_adapt_mlm_ve_nc</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">1</span>,cores<span class="op">=</span><span class="fl">1</span>,iter<span class="op">=</span><span class="fl">400</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: There were 10 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span>
<span><span class="co">#&gt; Warning: The largest R-hat is NA, indicating chains have not mixed.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#r-hat</span></span>
<span><span class="co">#&gt; Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#bulk-ess</span></span>
<span><span class="co">#&gt; Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#tail-ess</span></span></code></pre></div>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.direct.adapt.mlm.ve.nc</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_adapt_mlm_ve_nc.</span></span>
<span><span class="co">#&gt; 1 chains, each with iter=400; warmup=200; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=200, total post-warmup draws=200.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd  2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.23    0.00 0.05  0.15 0.20 0.23 0.26  0.37   138 1.00</span></span>
<span><span class="co">#&gt; vy        0.01    0.00 0.01  0.00 0.00 0.01 0.01  0.02    83 1.00</span></span>
<span><span class="co">#&gt; optima[1] 2.05    0.01 0.08  1.88 2.00 2.05 2.10  2.17   171 1.00</span></span>
<span><span class="co">#&gt; optima[2] 1.20    0.02 0.15  0.92 1.12 1.20 1.28  1.48    78 1.00</span></span>
<span><span class="co">#&gt; beta[1,1] 0.28    0.00 0.04  0.21 0.26 0.28 0.30  0.37   147 1.00</span></span>
<span><span class="co">#&gt; beta[1,2] 0.46    0.01 0.07  0.36 0.42 0.46 0.51  0.59   116 1.01</span></span>
<span><span class="co">#&gt; beta[2,1] 0.31    0.01 0.06  0.19 0.28 0.32 0.35  0.43    67 1.00</span></span>
<span><span class="co">#&gt; beta[2,2] 0.15    0.02 0.14 -0.19 0.08 0.17 0.25  0.35    70 1.02</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Mon Sep 25 13:59:56 2023.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="co">#plot(rethinking::precis(fit.reg.direct.adapt.mlm.ve.nc,depth=2,pars = c("hl","vy","optima","beta")))</span></span>
<span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.direct.adapt.mlm.ve.nc</span><span class="op">)</span></span></code></pre></div>
<p>Finally we run the Multi-optima Direct Effect Adaptive Model with
Varying Effects</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.direct.adapt.ve</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_direct_adapt_ve</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">1</span>,cores<span class="op">=</span><span class="fl">1</span>,iter<span class="op">=</span><span class="fl">400</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: There were 3 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span>
<span><span class="co">#&gt; Warning: The largest R-hat is NA, indicating chains have not mixed.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#r-hat</span></span>
<span><span class="co">#&gt; Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#bulk-ess</span></span>
<span><span class="co">#&gt; Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#tail-ess</span></span></code></pre></div>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.direct.adapt.ve</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_adapt_ve.</span></span>
<span><span class="co">#&gt; 1 chains, each with iter=400; warmup=200; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=200, total post-warmup draws=200.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd  2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.24    0.03 0.16  0.08 0.13 0.19 0.29  0.58    25 1.00</span></span>
<span><span class="co">#&gt; vy        0.01    0.00 0.01  0.00 0.00 0.01 0.01  0.02    52 1.05</span></span>
<span><span class="co">#&gt; optima[1] 2.06    0.01 0.07  1.90 2.01 2.05 2.11  2.19   108 1.00</span></span>
<span><span class="co">#&gt; optima[2] 1.06    0.05 0.24  0.44 0.95 1.10 1.20  1.40    24 1.00</span></span>
<span><span class="co">#&gt; beta[1,1] 0.29    0.00 0.04  0.21 0.26 0.29 0.31  0.36   126 1.00</span></span>
<span><span class="co">#&gt; beta[1,2] 0.47    0.02 0.13  0.32 0.38 0.43 0.51  0.75    28 1.00</span></span>
<span><span class="co">#&gt; beta[2,1] 0.25    0.01 0.09  0.06 0.20 0.26 0.31  0.40    54 1.03</span></span>
<span><span class="co">#&gt; beta[2,2] 0.19    0.01 0.12 -0.08 0.12 0.20 0.28  0.39    68 1.04</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Mon Sep 25 14:00:20 2023.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="co">#plot(rethinking::precis(fit.reg.direct.adapt.ve,depth=2,pars = c("hl","vy","optima","beta")))</span></span>
<span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.direct.adapt.ve</span><span class="op">)</span></span></code></pre></div>
<p>From there the posteriors should be explored, compared to the priors,
etc. See the Simulation Example for one example of how to do this.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Mark Grabowski.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.9000.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
