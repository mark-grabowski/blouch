<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Mullti-Optima Models Walkthrough • blouch</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Mullti-Optima Models Walkthrough">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">blouch</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Empirical-Example.html">Empirical Example from Grabowski (2024)</a></li>
    <li><a class="dropdown-item" href="../articles/Simulation-Example.html">Simulation Example from Grabowski (2024)</a></li>
    <li><a class="dropdown-item" href="../articles/Basic_Models-Examples.html">Basic Models</a></li>
    <li><a class="dropdown-item" href="../articles/Multi-optima_Models-Examples.html">Multi-Optima Models</a></li>
    <li><a class="dropdown-item" href="../articles/Varying_Effects_Models-Examples.html">Varying Effects Models</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mark-grabowski/blouch"><span class="fa fa-brands fa-github"></span> Github</a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Mullti-Optima Models Walkthrough</h1>
                        <h4 data-toc-skip class="author">Mark
Grabowski</h4>
            
            <h4 data-toc-skip class="date">2025-10-11</h4>
      

      <div class="d-none name"><code>Multi-optima_Models-Examples.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mark-grabowski.github.io/blouch/">blouch</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">########################################################################################################</span></span>
<span><span class="co">#For execution on a local, multicore CPU with excess RAM we recommend calling</span></span>
<span><span class="co">#options(mc.cores = parallel::detectCores())</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>mc.cores <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="co">#2 For R package checks - use line above on your own machine</span></span>
<span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/rstan_options.html" class="external-link">rstan_options</a></span><span class="op">(</span>auto_write <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dotR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"HOME"</span><span class="op">)</span>, <span class="st">".R"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">dotR</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">dotR</span><span class="op">)</span></span>
<span><span class="va">M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">dotR</span>, <span class="st">"Makevars"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.create</a></span><span class="op">(</span><span class="va">M</span><span class="op">)</span></span>
<span><span class="va">arch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">R.version</span><span class="op">$</span><span class="va">arch</span> <span class="op">==</span> <span class="st">"aarch64"</span>, <span class="st">"arm64"</span>, <span class="st">"x86_64"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"\nCXX14FLAGS += -O3 -mtune=native -arch"</span>, <span class="va">arch</span>, <span class="st">"-ftemplate-depth-256"</span><span class="op">)</span>,</span>
<span>    file <span class="op">=</span> <span class="va">M</span>, sep <span class="op">=</span> <span class="st">"\n"</span>, append <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="multi-optima-model">Multi-optima Model<a class="anchor" aria-label="anchor" href="#multi-optima-model"></a>
</h2>
<p>Next we will run a series of models that include categorical
variables - regimes painted on a phylogeny following Hansen (1997) and
Hansen et al. (2008). This article is an abbreviated versions of the
Simulation Example article - most of the steps of analysis will be the
same and are not repeated here. Note that the Stan runs are also too few
iterations and use only 1 chain and 1 core.</p>
<p>First we will set up the regime painting</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">########################################################################################################</span></span>
<span><span class="co">#Create phylogeny</span></span>
<span><span class="co">########################################################################################################</span></span>
<span><span class="va">N</span><span class="op">&lt;-</span><span class="fl">50</span> <span class="co">#Number of species</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="co">#Set seed to get same random species each time</span></span>
<span></span>
<span><span class="va">phy</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/drop.tip.html" class="external-link">keep.tip</a></span><span class="op">(</span><span class="va">tree.10K</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">tree.10K</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">]</span><span class="op">)</span> </span>
<span><span class="va">phy</span><span class="op">&lt;-</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/multi2di.html" class="external-link">multi2di</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span></span>
<span></span>
<span><span class="va">l.tree</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/branching.times.html" class="external-link">branching.times</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span><span class="op">)</span> <span class="co">## rescale tree to height 1</span></span>
<span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">/</span><span class="va">l.tree</span> </span>
<span></span>
<span><span class="va">tip.label</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span></span>
<span></span>
<span></span>
<span><span class="co">#Set regimes - manually - 2 regimes</span></span>
<span><span class="co">#Locate nodes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">phy</span>,no.margin<span class="op">=</span><span class="cn">TRUE</span>,edge.width<span class="op">=</span><span class="fl">2</span>,cex<span class="op">=</span><span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/nodelabels.html" class="external-link">nodelabels</a></span><span class="op">(</span>frame<span class="op">=</span><span class="st">"none"</span>,adj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.1</span>,<span class="op">-</span><span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/nodelabels.html" class="external-link">tiplabels</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_model_setup-1.png" width="700"></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Paint Regimes on Tree</span></span>
<span><span class="co">#source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/blouch/Simulation Code/Functions/set.converge.regimes.R") #Macbook Pro</span></span>
<span></span>
<span><span class="va">shifts</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">84</span><span class="op">)</span> <span class="co">#Location of nodes with regime shifts</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu">treeplyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/treeplyr/man/make.treedata.html" class="external-link">make.treedata</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">trdata</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/set.converge.regimes.html">set.converge.regimes</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="va">shifts</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; Levels: OU1 OU2</span></span>
<span><span class="co">#&gt; [1] "#E64B35FF" "#4DBBD5FF"</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_model_setup-2.png" width="700"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Check if manual setting code worked</span></span>
<span><span class="va">shifts.total</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span>,<span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">node.label</span><span class="op">)</span></span>
<span><span class="va">edge.regimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">shifts.total</span><span class="op">[</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">edge</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">edge.regimes</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; Levels: OU1 OU2</span></span>
<span></span>
<span><span class="va">reg.colors</span> <span class="op">&lt;-</span> <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/pal_aaas.html" class="external-link">pal_aaas</a></span><span class="op">(</span><span class="st">"default"</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">reg.colors</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "#3B4992B2" "#EE0000B2"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>,edge.color <span class="op">=</span> <span class="va">reg.colors</span><span class="op">[</span><span class="va">edge.regimes</span><span class="op">]</span>, edge.width <span class="op">=</span> <span class="fl">1</span>, cex <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_model_setup-3.png" width="700"></p>
<p>Format tree</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Simulate data</span></span>
<span><span class="va">n</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span></span>
<span><span class="va">regimes_internal</span> <span class="op">&lt;-</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">node.label</span></span>
<span><span class="va">regimes_tip</span> <span class="op">&lt;-</span> <span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span></span>
<span><span class="va">regimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/concat.factor.html">concat.factor</a></span><span class="op">(</span><span class="va">regimes_tip</span>, <span class="va">regimes_internal</span><span class="op">)</span></span>
<span><span class="va">anc_maps</span><span class="op">&lt;-</span><span class="st">"regimes"</span></span>
<span><span class="va">lineages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="fu"><a href="../reference/lineage.constructor.html">lineage.constructor</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>, <span class="va">e</span>, <span class="va">anc_maps</span>, <span class="va">regimes</span><span class="op">)</span><span class="op">)</span> <span class="co">#Trace lineage from tips (n) to root and determine regimes of each node or branch</span></span></code></pre></div>
<p>Now we will simulate Y data based on our generative model</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Set true values for parameters</span></span>
<span><span class="va">hl</span><span class="op">&lt;-</span><span class="fl">0.1</span> <span class="co">#0.1, 0.25, 0.75 - testing options</span></span>
<span><span class="va">a</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span></span>
<span><span class="va">vy</span><span class="op">&lt;-</span><span class="fl">0.01</span> <span class="co">#0.25,0.5 - testing options</span></span>
<span><span class="va">sigma2_y</span><span class="op">&lt;-</span><span class="va">vy</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span><span class="op">)</span><span class="op">)</span>;</span>
<span><span class="va">optima</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">0.25</span><span class="op">)</span> <span class="co">#Optima for two regimes</span></span>
<span></span>
<span><span class="va">dmX</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/weight.matrix.html">weight.matrix</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>, <span class="va">a</span>, <span class="va">lineages</span><span class="op">)</span> <span class="co">#Slouch approach</span></span>
<span><span class="va">mu</span><span class="op">&lt;-</span><span class="va">dmX</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">optima</span> <span class="co">#Simulate mu for Y</span></span>
<span><span class="va">V</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/calc_direct_V.html">calc_direct_V</a></span><span class="op">(</span><span class="va">phy</span>, <span class="va">sigma2_y</span>, <span class="va">a</span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">&lt;-</span><span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1</span>,<span class="va">mu</span>,<span class="va">V</span><span class="op">)</span></span>
<span></span>
<span><span class="co">########################################################################################################</span></span>
<span><span class="co">#Simulate errors</span></span>
<span><span class="va">Y_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Y_with_error</span><span class="op">&lt;-</span><span class="va">Y</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/phenogram.html" class="external-link">phenogram</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">Y_with_error</span>,spread.labels<span class="op">=</span><span class="cn">TRUE</span>,spread.cost<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="co">#Plot X data</span></span>
<span><span class="co">#&gt; Optimizing the positions of the tip labels...</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Simulate_Y_data-1.png" width="700"></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Make trdata file</span></span>
<span><span class="va">trait.data</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Y_with_error</span>,<span class="va">Y_error</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span>,<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Y_with_error</span>,<span class="va">Y_error</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">############################################################################################################</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Set Priors</span></span>
<span><span class="va">hl.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span>,<span class="fl">0.75</span><span class="op">)</span></span>
<span><span class="va">vy.prior</span><span class="op">&lt;-</span><span class="fl">20</span></span>
<span><span class="va">optima.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="exploring-priors">Exploring Priors<a class="anchor" aria-label="anchor" href="#exploring-priors"></a>
</h2>
<p>At this point one would want to explore if the priors are appropriate
- do the prior distributions look consistent with what we know about our
system? See Grabowski (in press) for more on setting priors.</p>
<p>Half-life Prior plot</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hl.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1000</span>,meanlog<span class="op">=</span><span class="va">hl.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,sdlog<span class="op">=</span><span class="va">hl.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"prior.hl.sims"</span></span>
<span></span>
<span><span class="va">hl.prior.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.hl.sims</span>,fill<span class="op">=</span><span class="st">"prior.hl.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#labs(title="Prior vs. Posterior Distribution ",x="Half-life", y = "Density")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"Half-life"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#scale_fill_manual(labels=c("Posterior","Prior"))+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">hl</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hl.prior.plot</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>Vy Prior Plot</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vy.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1000</span>,rate<span class="op">=</span><span class="va">vy.prior</span><span class="op">)</span></span>
<span><span class="va">vy.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">vy.sims</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vy.sims</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"prior.vy.sims"</span></span>
<span></span>
<span><span class="va">vy.prior.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.vy.sims</span>,fill<span class="op">=</span><span class="st">"prior.vy.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">vy.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#labs(title="Prior vs. Posterior Distribution ",x="vy", y = "Density")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"vy"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">vy</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#scale_fill_manual(labels=c("Posterior","Prior"))+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">vy.prior.plot</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>Prior on how shared branch lengths correspond to covariance</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl.sims</span>;</span>
<span><span class="va">sigma2_y.sims</span><span class="op">&lt;-</span><span class="va">vy.sims</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">)</span>;</span>
<span><span class="co">#x&lt;-seq(from=0,to=1,by=0.001)</span></span>
<span><span class="co">#V.sim&lt;-calc_direct_V(phy,a.sims,sigma2_y.sims)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span> <span class="cn">NULL</span> , xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> , ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.3</span><span class="op">)</span> , xlab<span class="op">=</span><span class="st">"Time since MRCA"</span> , ylab<span class="op">=</span><span class="st">"Covariance"</span> ,cex.axis<span class="op">=</span><span class="fl">0.75</span>, mgp<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.25</span>,<span class="fl">0.25</span>,<span class="fl">0</span><span class="op">)</span>,tcl<span class="op">=</span><span class="op">-</span><span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="va">sigma2_y.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">/</span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">a.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span> <span class="op">*</span> <span class="va">a.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">a.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span> , add<span class="op">=</span><span class="cn">TRUE</span> , lwd<span class="op">=</span><span class="fl">4</span> , col<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/col.alpha.html" class="external-link">col.alpha</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0.15</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">0.25</span>,<span class="fl">0.25</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">covariance.prior.plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/recordplot.html" class="external-link">recordPlot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; null device </span></span>
<span><span class="co">#&gt;           1</span></span>
<span><span class="va">covariance.prior.plot</span></span></code></pre></div>
<p>Prior Plot</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://nanx.me/ggsci/" class="external-link">ggsci</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Direct Model</span></span>
<span><span class="co">#intercept_test&lt;-rnorm(100,stan_sim_data$ols_intercept,0.2)</span></span>
<span><span class="co">#slope_test&lt;-rnorm(100,stan_sim_data$ols_slope,0.1)</span></span>
<span></span>
<span><span class="va">optima.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">optima.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">optima.sims</span>,Prior<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">Y</span>,regimes<span class="op">=</span><span class="va">regimes_tip</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Y"</span>,<span class="st">"Regimes"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">optima.plot</span><span class="op">&lt;-</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>, Mapping <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Y</span>, y <span class="op">=</span> <span class="va">Regimes</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html" class="external-link">geom_jitter</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">optima.sims</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">optima.sims</span>,x<span class="op">=</span><span class="va">Prior</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.25</span>,width<span class="op">=</span><span class="fl">0.15</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html" class="external-link">geom_jitter</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">Y</span>,x<span class="op">=</span><span class="va">Regimes</span><span class="op">)</span>,width<span class="op">=</span><span class="fl">0.15</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Optima"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in fortify(data, ...): Arguments in `...` must be used.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> Problematic argument:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> Mapping = ggplot2::aes(x = Y, y = Regimes)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Did you misspell an argument name?</span></span>
<span></span>
<span><span class="va">optima.plot</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>We will use the helper function blouch.reg.prep() to setup the dat
file for Stan. Here “regimes” is the name of the regime column in
trdata$dat.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/blouch.reg.prep.html">blouch.reg.prep</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="st">"Y_with_error"</span>,<span class="st">"Y_error"</span>,<span class="st">"regimes"</span>,<span class="va">hl.prior</span>,<span class="va">vy.prior</span>,<span class="va">optima.prior</span><span class="op">)</span></span></code></pre></div>
<p>Here we run the basic Multi-optima Model, look at the results, and
rstan::extract the posterior</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,iter <span class="op">=</span><span class="fl">2000</span>,cores<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.10    0.01 0.06 0.03 0.06 0.09 0.11  0.23   144 1.01</span></span>
<span><span class="co">#&gt; vy        0.02    0.00 0.01 0.01 0.02 0.02 0.02  0.04   163 1.01</span></span>
<span><span class="co">#&gt; optima[1] 0.48    0.00 0.03 0.41 0.46 0.48 0.50  0.54  1316 1.00</span></span>
<span><span class="co">#&gt; optima[2] 0.26    0.00 0.07 0.14 0.23 0.27 0.31  0.37   263 1.01</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Sat Oct 11 15:29:57 2025.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg</span><span class="op">)</span> <span class="co">#rstan::extract posterior</span></span></code></pre></div>
<p>Now lets look at the prior vs. posterior plots for the parameters
Half-life plot</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hl.post</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">hl</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">hl.post</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"post.hl.sims"</span></span>
<span></span>
<span><span class="va">hl.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.hl.sims</span>,fill<span class="op">=</span><span class="st">"prior.hl.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">post.hl.sims</span>,fill<span class="op">=</span><span class="st">"post.hl.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">hl.post</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#labs(title="Prior vs. Posterior Distribution ",x="Half-life", y = "Density")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"Half-life"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#scale_fill_manual(labels=c("Posterior","Prior"))+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">hl</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Posterior"</span>,<span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hl.plot</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<p>Vy Prior vs. posterior plot</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vy.post</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">vy</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vy.post</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"post.vy.sims"</span></span>
<span></span>
<span></span>
<span><span class="va">vy.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.vy.sims</span>,fill<span class="op">=</span><span class="st">"prior.vy.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">vy.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">post.vy.sims</span>,fill<span class="op">=</span><span class="st">"post.vy.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">vy.post</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#labs(title="Prior vs. Posterior Distribution ",x="vy", y = "Density")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"vy"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">vy</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#scale_fill_manual(labels=c("Posterior","Prior"))+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Posterior"</span>,<span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vy.plot</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<p>Prior versus posterior on how shared branch lengths correspond to
covariance</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span> <span class="cn">NULL</span> , xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> , ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.3</span><span class="op">)</span> , xlab<span class="op">=</span><span class="st">"Time since MRCA"</span> , ylab<span class="op">=</span><span class="st">"Covariance"</span> ,cex.axis<span class="op">=</span><span class="fl">0.75</span>, mgp<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.25</span>,<span class="fl">0.25</span>,<span class="fl">0</span><span class="op">)</span>,tcl<span class="op">=</span><span class="op">-</span><span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="va">sigma2_y.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">/</span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">a.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span> <span class="op">*</span> <span class="va">a.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">a.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span> , add<span class="op">=</span><span class="cn">TRUE</span> , lwd<span class="op">=</span><span class="fl">4</span> , col<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/col.alpha.html" class="external-link">col.alpha</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0.15</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">sigma2_y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">/</span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">post</span><span class="op">$</span><span class="va">a</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span> <span class="op">*</span> <span class="va">post</span><span class="op">$</span><span class="va">a</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">post</span><span class="op">$</span><span class="va">a</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span> , add<span class="op">=</span><span class="cn">TRUE</span> , lwd<span class="op">=</span><span class="fl">4</span> , col<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/col.alpha.html" class="external-link">col.alpha</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">0.25</span>,<span class="fl">0.25</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#covariance.plot &lt;- recordPlot()</span></span>
<span><span class="co">#dev.off()</span></span></code></pre></div>
<p>Prior vs. Posterior Plot</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://nanx.me/ggsci/" class="external-link">ggsci</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">optima.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">optima.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">optima.sims</span>,Prior<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span></span>
<span><span class="va">optima.post</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">optima</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">optima.post</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"OU"</span>,<span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">optima.post</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,sep<span class="op">=</span><span class="st">""</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mu.mean</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span> <span class="va">optima.post</span>, <span class="fl">2</span>, <span class="va">mean</span> <span class="op">)</span></span>
<span><span class="va">mu.mean</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mu.mean</span><span class="op">)</span></span>
<span><span class="va">mu.mean</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mu.mean</span>,<span class="st">"Regimes"</span><span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">mu.mean</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">mu.mean</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mu.mean</span>,<span class="va">optima</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mu.CI</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span> <span class="va">optima.post</span> , <span class="fl">2</span>, <span class="fu">rethinking</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/rethinking/man/HPDI.html" class="external-link">PI</a></span> , prob<span class="op">=</span><span class="fl">0.89</span> <span class="op">)</span></span>
<span><span class="va">mu.CI</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mu.CI</span><span class="op">)</span><span class="op">)</span>,<span class="st">"Regimes"</span><span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">mu.CI</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.CI</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"min.5.5"</span>,<span class="st">"max.94.5"</span>,<span class="st">"Regimes"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">Y</span>,regimes<span class="op">=</span><span class="va">regimes_tip</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Y"</span>,<span class="st">"Regimes"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="va">optima.plot</span><span class="op">&lt;-</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>, Mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Y</span>, y <span class="op">=</span> <span class="va">Regimes</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html" class="external-link">geom_jitter</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">optima.sims</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">optima.sims</span>,x<span class="op">=</span><span class="va">Prior</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.25</span>,width<span class="op">=</span><span class="fl">0.15</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html" class="external-link">geom_segment</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mu.mean</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Regimes</span><span class="op">-</span><span class="fl">0.5</span>,xend<span class="op">=</span><span class="va">Regimes</span><span class="op">+</span><span class="fl">0.5</span>,y<span class="op">=</span><span class="va">mu.mean</span>,yend<span class="op">=</span><span class="va">mu.mean</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html" class="external-link">geom_segment</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mu.mean</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Regimes</span><span class="op">-</span><span class="fl">0.5</span>,xend<span class="op">=</span><span class="va">Regimes</span><span class="op">+</span><span class="fl">0.5</span>,y<span class="op">=</span><span class="va">optima</span>,yend<span class="op">=</span><span class="va">optima</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_linerange</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mu.CI</span>, mapping<span class="op">=</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Regimes</span>,ymin<span class="op">=</span><span class="va">min.5.5</span>,ymax<span class="op">=</span><span class="va">max.94.5</span><span class="op">)</span>,size<span class="op">=</span><span class="fl">35</span>,color<span class="op">=</span><span class="st">"darkgrey"</span>,alpha<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html" class="external-link">geom_jitter</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">Y</span>,x<span class="op">=</span><span class="va">Regimes</span><span class="op">)</span>,width<span class="op">=</span><span class="fl">0.15</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Optima"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in fortify(data, ...): Arguments in `...` must be used.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> Problematic argument:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> Mapping = aes(x = Y, y = Regimes)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Did you misspell an argument name?</span></span>
<span><span class="co">#&gt; Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Please use `linewidth` instead.</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">generated.</span></span></span>
<span></span>
<span><span class="va">optima.plot</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>Next is the code for the Multilevel Multi-optima Model - here we
include the additional prior sigma, which is a parameter for the
variance among regimes</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Set Priors</span></span>
<span><span class="va">hl.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span>,<span class="fl">0.75</span><span class="op">)</span></span>
<span><span class="va">vy.prior</span><span class="op">&lt;-</span><span class="fl">20</span></span>
<span><span class="va">optima.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span>
<span><span class="va">sigma.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Blouch Prep Code</span></span>
<span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/blouch.reg.mlm.prep.html">blouch.reg.mlm.prep</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="st">"Y_with_error"</span>,<span class="st">"Y_error"</span>,<span class="st">"regimes"</span>,<span class="va">hl.prior</span>,<span class="va">vy.prior</span>,<span class="va">optima.prior</span>,<span class="va">sigma.prior</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.mlm.vi.regimes</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_mlm_vi</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,iter<span class="op">=</span> <span class="fl">2000</span>,cores<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Warning: There were 50 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.mlm.vi.regimes</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"optima_bar"</span>,<span class="st">"sigma"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.mlm.vi.regimes</span><span class="op">)</span></span></code></pre></div>
<p>Finally we will run the non-centered version of the same model, which
can be used when the posterior is hard to explore and the centered
version of the model produces divergences.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.mlm.vi.regimes.nc</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_mlm_vi_nc</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,iter <span class="op">=</span><span class="fl">2000</span>,cores<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="co">#,control=list(adapt_delta=0.95))</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Warning: There were 68 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span>
<span><span class="co">#&gt; Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#tail-ess</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.mlm.vi.regimes.nc</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"optima_bar"</span>,<span class="st">"sigma"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">###plot(rethinking::precis(fit.mlm.vi.regimes.nc,depth=2,pars = c("hl","vy","optima","optima_bar","sigma")))</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.mlm.vi.regimes.nc</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="multi-optima-direct-effect-model">Multi-optima Direct Effect Model<a class="anchor" aria-label="anchor" href="#multi-optima-direct-effect-model"></a>
</h2>
<p>We will now include both regimes painted on the tree and a direct
effect predictor</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Regimes + Direct Effect Model</span></span>
<span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Create phylogeny</span></span>
<span><span class="co">########################################################################################################</span></span>
<span><span class="va">N</span><span class="op">&lt;-</span><span class="fl">50</span> <span class="co">#Number of species</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="co">#Set seed to get same random species each time</span></span>
<span></span>
<span><span class="va">phy</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/drop.tip.html" class="external-link">keep.tip</a></span><span class="op">(</span><span class="va">tree.10K</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">tree.10K</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">]</span><span class="op">)</span> </span>
<span><span class="va">phy</span><span class="op">&lt;-</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/multi2di.html" class="external-link">multi2di</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span></span>
<span></span>
<span><span class="va">l.tree</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/branching.times.html" class="external-link">branching.times</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span><span class="op">)</span> <span class="co">## rescale tree to height 1</span></span>
<span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">/</span><span class="va">l.tree</span> </span>
<span></span>
<span><span class="va">tip.label</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span></span>
<span></span>
<span><span class="co">#Set regimes - manually - 2 regimes</span></span>
<span><span class="co">#Locate nodes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">phy</span>,no.margin<span class="op">=</span><span class="cn">TRUE</span>,edge.width<span class="op">=</span><span class="fl">2</span>,cex<span class="op">=</span><span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/nodelabels.html" class="external-link">nodelabels</a></span><span class="op">(</span>frame<span class="op">=</span><span class="st">"none"</span>,adj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.1</span>,<span class="op">-</span><span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/nodelabels.html" class="external-link">tiplabels</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Paint Regimes on Tree</span></span>
<span><span class="co">#source("/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/blouch/Simulation Code/Functions/set.converge.regimes.R") #Macbook Pro</span></span>
<span><span class="va">shifts</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">84</span><span class="op">)</span> <span class="co">#Location of nodes with regime shifts</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu">treeplyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/treeplyr/man/make.treedata.html" class="external-link">make.treedata</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">trdata</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/set.converge.regimes.html">set.converge.regimes</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="va">shifts</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; Levels: OU1 OU2</span></span>
<span><span class="co">#&gt; [1] "#E64B35FF" "#4DBBD5FF"</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-19-2.png" width="700"></p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="co">#Check if manual setting code worked</span></span>
<span><span class="va">shifts.total</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span>,<span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">node.label</span><span class="op">)</span></span>
<span><span class="va">edge.regimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">shifts.total</span><span class="op">[</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">edge</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">edge.regimes</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; Levels: OU1 OU2</span></span>
<span></span>
<span><span class="va">reg.colors</span> <span class="op">&lt;-</span> <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/pal_aaas.html" class="external-link">pal_aaas</a></span><span class="op">(</span><span class="st">"default"</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">reg.colors</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "#3B4992B2" "#EE0000B2"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>,edge.color <span class="op">=</span> <span class="va">reg.colors</span><span class="op">[</span><span class="va">edge.regimes</span><span class="op">]</span>, edge.width <span class="op">=</span> <span class="fl">1</span>, cex <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-19-3.png" width="700"></p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Phylogeny info</span></span>
<span><span class="va">n</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span></span>
<span><span class="va">mrca1</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/mrca.html" class="external-link">mrca</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">)</span></span>
<span><span class="va">times</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/node.depth.html" class="external-link">node.depth.edgelength</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">)</span></span>
<span></span>
<span><span class="va">regimes_internal</span> <span class="op">&lt;-</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">node.label</span></span>
<span><span class="va">regimes_tip</span> <span class="op">&lt;-</span> <span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span></span>
<span><span class="va">regimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/concat.factor.html">concat.factor</a></span><span class="op">(</span><span class="va">regimes_tip</span>, <span class="va">regimes_internal</span><span class="op">)</span></span>
<span><span class="va">anc_maps</span><span class="op">&lt;-</span><span class="st">"regimes"</span></span>
<span><span class="va">lineages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="fu"><a href="../reference/lineage.constructor.html">lineage.constructor</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>, <span class="va">e</span>, <span class="va">anc_maps</span>, <span class="va">regimes</span><span class="op">)</span><span class="op">)</span> <span class="co">#Trace lineage from tips (n) to root and determine regimes of each node or branch</span></span></code></pre></div>
<p>Now simulate X and Y data</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#########################</span></span>
<span><span class="va">hl</span><span class="op">&lt;-</span><span class="fl">0.1</span> <span class="co">#0.1, 0.25, 0.75 - testing options</span></span>
<span><span class="va">a</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span></span>
<span><span class="va">vy</span><span class="op">&lt;-</span><span class="fl">0.01</span> <span class="co">#0.25,0.5 - testing options</span></span>
<span><span class="va">sigma2_y</span><span class="op">&lt;-</span><span class="va">vy</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span><span class="op">)</span><span class="op">)</span>;</span>
<span></span>
<span><span class="va">vX0</span><span class="op">&lt;-</span><span class="fl">0</span></span>
<span><span class="va">vY0</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">Sxx</span><span class="op">&lt;-</span><span class="fl">10</span> <span class="co">#Look at effects</span></span>
<span></span>
<span><span class="va">Z_direct</span><span class="op">&lt;-</span><span class="fl">1</span></span>
<span></span>
<span><span class="va">V</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/calc_direct_V.html">calc_direct_V</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">sigma2_y</span>,<span class="va">a</span><span class="op">)</span></span>
<span><span class="va">X</span><span class="op">&lt;-</span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/fastBM.html" class="external-link">fastBM</a></span><span class="op">(</span><span class="va">phy</span>,a<span class="op">=</span><span class="va">vX0</span>,sig2<span class="op">=</span><span class="va">Sxx</span>,internal<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="co">#Simulate X BM variable on tree, with scaling 10</span></span>
<span><span class="co">#X&lt;-rnorm(N,0,1)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span></span>
<span></span>
<span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/phenogram.html" class="external-link">phenogram</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">X</span>,spread.labels<span class="op">=</span><span class="cn">TRUE</span>,spread.cost<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="co">#Plot X data</span></span>
<span><span class="co">#&gt; Optimizing the positions of the tip labels...</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-20-1.png" width="700"></p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">dmX</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/weight.matrix.html">weight.matrix</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>, <span class="va">a</span>, <span class="va">lineages</span><span class="op">)</span> <span class="co">#Slouch approach</span></span>
<span><span class="va">dmX</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">dmX</span>,<span class="va">X</span><span class="op">)</span></span>
<span></span>
<span><span class="va">beta</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">0.25</span><span class="op">)</span> <span class="co">#Two Optima/One Slope</span></span>
<span><span class="va">mu</span><span class="op">&lt;-</span><span class="va">dmX</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">beta</span> <span class="co">#Simulate mu for Y</span></span>
<span></span>
<span><span class="va">V</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/calc_direct_V.html">calc_direct_V</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">sigma2_y</span>,<span class="va">a</span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">&lt;-</span><span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1</span>,<span class="va">mu</span>,<span class="va">V</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Plot data</span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">Y</span>,X<span class="op">=</span><span class="va">X</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">X</span>,y<span class="op">=</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-20-2.png" width="700"></p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">X</span>,<span class="va">df</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = Y ~ X, data = df)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co">#&gt; -1.00801  0.05843  0.18122  0.26742  0.44140 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  1.79802    0.07104   25.31   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; X            0.25223    0.02025   12.46   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 0.4464 on 48 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.7638, Adjusted R-squared:  0.7589 </span></span>
<span><span class="co">#&gt; F-statistic: 155.2 on 1 and 48 DF,  p-value: &lt; 2.2e-16</span></span>
<span></span>
<span><span class="co">#################################################################################################################Simulate errors</span></span>
<span><span class="va">Z_X_error</span><span class="op">&lt;-</span><span class="fl">1</span> <span class="co">#Number of X traits with error</span></span>
<span><span class="va">X_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Y_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Y_with_error</span><span class="op">&lt;-</span><span class="va">Y</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">X_with_error</span><span class="op">&lt;-</span><span class="va">X</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span></span>
<span></span>
<span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Make trdata file</span></span>
<span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span>,<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Y_with_error</span>,<span class="va">Y_error</span>,<span class="va">X_with_error</span>,<span class="va">X_error</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Next we will set the priors for the estimated parameters - for this
model this includes the half-life, Vy, optima, and beta. For the latter
two parameters we will use the results of the linear model to inform our
priors.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Set Priors</span></span>
<span><span class="va">hl.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span>,<span class="fl">0.75</span><span class="op">)</span></span>
<span><span class="va">vy.prior</span><span class="op">&lt;-</span><span class="fl">5</span></span>
<span><span class="va">optima.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">0.5</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span>
<span><span class="va">beta.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>,<span class="fl">0.25</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="exploring-priors-1">Exploring Priors<a class="anchor" aria-label="anchor" href="#exploring-priors-1"></a>
</h2>
<p>At this point one would want to explore if the priors are appropriate
- do the prior distributions look consistent with what we know about our
system? See Grabowski (in press) for more on setting priors.</p>
<p>Half-life Prior plot</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hl.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1000</span>,meanlog<span class="op">=</span><span class="va">hl.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,sdlog<span class="op">=</span><span class="va">hl.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"prior.hl.sims"</span></span>
<span></span>
<span><span class="va">hl.prior.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.hl.sims</span>,fill<span class="op">=</span><span class="st">"prior.hl.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#labs(title="Prior vs. Posterior Distribution ",x="Half-life", y = "Density")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"Half-life"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#scale_fill_manual(labels=c("Posterior","Prior"))+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">hl</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hl.prior.plot</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-22-1.png" width="700"></p>
<p>Vy Prior Plot</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vy.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1000</span>,rate<span class="op">=</span><span class="va">vy.prior</span><span class="op">)</span></span>
<span><span class="va">vy.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">vy.sims</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vy.sims</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"prior.vy.sims"</span></span>
<span></span>
<span><span class="va">vy.prior.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.vy.sims</span>,fill<span class="op">=</span><span class="st">"prior.vy.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">vy.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#labs(title="Prior vs. Posterior Distribution ",x="vy", y = "Density")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"vy"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">vy</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#scale_fill_manual(labels=c("Posterior","Prior"))+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">vy.prior.plot</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-23-1.png" width="700"></p>
<p>Prior on how shared branch lengths correspond to covariance</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl.sims</span>;</span>
<span><span class="va">sigma2_y.sims</span><span class="op">&lt;-</span><span class="va">vy.sims</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">)</span>;</span>
<span><span class="co">#x&lt;-seq(from=0,to=1,by=0.001)</span></span>
<span><span class="co">#V.sim&lt;-calc_direct_V(phy,a.sims,sigma2_y.sims)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span> <span class="cn">NULL</span> , xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> , ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> , xlab<span class="op">=</span><span class="st">"Time since MRCA"</span> , ylab<span class="op">=</span><span class="st">"Covariance"</span> ,cex.axis<span class="op">=</span><span class="fl">0.75</span>, mgp<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.25</span>,<span class="fl">0.25</span>,<span class="fl">0</span><span class="op">)</span>,tcl<span class="op">=</span><span class="op">-</span><span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="va">sigma2_y.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">/</span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">a.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span> <span class="op">*</span> <span class="va">a.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">a.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span> , add<span class="op">=</span><span class="cn">TRUE</span> , lwd<span class="op">=</span><span class="fl">4</span> , col<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/col.alpha.html" class="external-link">col.alpha</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0.15</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-24-1.png" width="700"></p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">0.25</span>,<span class="fl">0.25</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">covariance.prior.plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/recordplot.html" class="external-link">recordPlot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; null device </span></span>
<span><span class="co">#&gt;           1</span></span>
<span><span class="va">covariance.prior.plot</span></span></code></pre></div>
<p>Slope and intercept Prior Plot</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">optima.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">beta.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">100</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prior.slope.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>  </span>
<span> <span class="fu">ggplot2</span><span class="fu">::</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">Y</span>,x<span class="op">=</span><span class="va">X</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima.sims</span>,slope<span class="op">=</span><span class="va">beta.sims</span>,alpha<span class="op">=</span><span class="fl">0.15</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Direct Effect X"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prior.slope.plot</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-25-1.png" width="700"></p>
<p>We will use the helper function blouch.reg.direct.prep() to setup the
dat file for Stan. Here “Z_direct” is the number of predictors, and
“regimes” is the name of the regime column in trdata$dat.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Test Blouch prep code - Regimes + Direct Efffect model</span></span>
<span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/blouch.reg.direct.prep.html">blouch.reg.direct.prep</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="st">"Y_with_error"</span>,<span class="st">"Y_error"</span>,<span class="st">"X_with_error"</span>,<span class="st">"X_error"</span>,Z_direct<span class="op">=</span><span class="fl">1</span>,<span class="st">"regimes"</span>,<span class="va">hl.prior</span>,<span class="va">vy.prior</span>,<span class="va">optima.prior</span>,<span class="va">beta.prior</span><span class="op">)</span></span></code></pre></div>
<p>Now we run the basic Multi-optima Direct Effect Model, look at the
results, and rstan::extract the posterior</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.direct</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_direct</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores<span class="op">=</span><span class="fl">2</span>,iter<span class="op">=</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span></code></pre></div>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.direct</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.16       0 0.08 0.06 0.11 0.14 0.19  0.36  1046    1</span></span>
<span><span class="co">#&gt; vy        0.02       0 0.01 0.01 0.01 0.02 0.02  0.03  1063    1</span></span>
<span><span class="co">#&gt; optima[1] 2.01       0 0.04 1.93 1.99 2.01 2.03  2.09  2496    1</span></span>
<span><span class="co">#&gt; optima[2] 0.94       0 0.09 0.70 0.90 0.95 0.99  1.07  1167    1</span></span>
<span><span class="co">#&gt; beta[1]   0.25       0 0.01 0.24 0.25 0.25 0.26  0.27  3574    1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Sat Oct 11 15:31:35 2025.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.direct</span><span class="op">)</span> <span class="co">#rstan::extract posterior distribution</span></span></code></pre></div>
<p>Now lets look at the prior vs. posterior plots for the parameters
Half-life plot</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hl.post</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">hl</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">hl.post</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"post.hl.sims"</span></span>
<span></span>
<span><span class="va">hl.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.hl.sims</span>,fill<span class="op">=</span><span class="st">"prior.hl.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">post.hl.sims</span>,fill<span class="op">=</span><span class="st">"post.hl.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">hl.post</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#labs(title="Prior vs. Posterior Distribution ",x="Half-life", y = "Density")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"Half-life"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#scale_fill_manual(labels=c("Posterior","Prior"))+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">hl</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Posterior"</span>,<span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hl.plot</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-26-1.png" width="700"></p>
<p>Vy Prior vs. posterior plot</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vy.post</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">vy</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vy.post</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"post.vy.sims"</span></span>
<span></span>
<span></span>
<span><span class="va">vy.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.vy.sims</span>,fill<span class="op">=</span><span class="st">"prior.vy.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">vy.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">post.vy.sims</span>,fill<span class="op">=</span><span class="st">"post.vy.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">vy.post</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#labs(title="Prior vs. Posterior Distribution ",x="vy", y = "Density")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"vy"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">vy</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#scale_fill_manual(labels=c("Posterior","Prior"))+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Posterior"</span>,<span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vy.plot</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-27-1.png" width="700"></p>
<p>Prior versus posterior on how shared branch lengths correspond to
covariance</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span> <span class="cn">NULL</span> , xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> , ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> , xlab<span class="op">=</span><span class="st">"Time since MRCA"</span> , ylab<span class="op">=</span><span class="st">"Covariance"</span> ,cex.axis<span class="op">=</span><span class="fl">0.75</span>, mgp<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.25</span>,<span class="fl">0.25</span>,<span class="fl">0</span><span class="op">)</span>,tcl<span class="op">=</span><span class="op">-</span><span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="va">sigma2_y.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">/</span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">a.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span> <span class="op">*</span> <span class="va">a.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">a.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span> , add<span class="op">=</span><span class="cn">TRUE</span> , lwd<span class="op">=</span><span class="fl">4</span> , col<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/col.alpha.html" class="external-link">col.alpha</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0.15</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">sigma2_y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">/</span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">post</span><span class="op">$</span><span class="va">a</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span> <span class="op">*</span> <span class="va">post</span><span class="op">$</span><span class="va">a</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">post</span><span class="op">$</span><span class="va">a</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span> , add<span class="op">=</span><span class="cn">TRUE</span> , lwd<span class="op">=</span><span class="fl">4</span> , col<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/col.alpha.html" class="external-link">col.alpha</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-28-1.png" width="700"></p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">0.25</span>,<span class="fl">0.25</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">covariance.plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/recordplot.html" class="external-link">recordPlot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; null device </span></span>
<span><span class="co">#&gt;           1</span></span>
<span><span class="va">covariance.plot</span></span></code></pre></div>
<p>Prior vs. Posterior Plot for Regression</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">optima.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">beta.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">100</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">optima.post</span><span class="op">&lt;-</span><span class="va">post</span><span class="op">$</span><span class="va">optima</span></span>
<span><span class="va">beta.post</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">beta</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">beta.post</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"post.beta.1"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mu.link.11</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x.seq</span><span class="op">)</span><span class="op">{</span><span class="va">optima.post</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">+</span><span class="va">x.seq</span><span class="op">*</span><span class="va">beta.post</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">}</span></span>
<span><span class="va">mu.link.12</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x.seq</span><span class="op">)</span><span class="op">{</span><span class="va">optima.post</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">+</span><span class="va">x.seq</span><span class="op">*</span><span class="va">beta.post</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">}</span></span>
<span></span>
<span><span class="va">x.seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, to<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> , length.out<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">mu.11</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">x.seq</span> , <span class="va">mu.link.11</span> <span class="op">)</span></span>
<span><span class="va">mu.12</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">x.seq</span> , <span class="va">mu.link.12</span> <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">mu.mean.11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">mu.11</span><span class="op">)</span></span>
<span><span class="va">mu.mean.12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">mu.12</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mu.mean.11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mu.mean.11</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mu.mean.12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mu.mean.12</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.mean.11</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"mu.mean.11"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.mean.12</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"mu.mean.12"</span></span>
<span></span>
<span><span class="va">mu.CI.11</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span> <span class="va">mu.11</span> , MARGIN<span class="op">=</span><span class="fl">2</span>, FUN<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/rethinking/man/HPDI.html" class="external-link">PI</a></span> , prob<span class="op">=</span><span class="fl">0.89</span> <span class="op">)</span></span>
<span><span class="va">mu.CI.12</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span> <span class="va">mu.12</span> , MARGIN<span class="op">=</span><span class="fl">2</span>, FUN<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/rethinking/man/HPDI.html" class="external-link">PI</a></span> , prob<span class="op">=</span><span class="fl">0.89</span> <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">mu.CI.11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mu.CI.11</span><span class="op">)</span><span class="op">)</span>,<span class="va">x.seq</span><span class="op">)</span></span>
<span><span class="va">mu.CI.12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mu.CI.12</span><span class="op">)</span><span class="op">)</span>,<span class="va">x.seq</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.CI.11</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"min.5.5"</span>,<span class="st">"max.94.5"</span>,<span class="st">"x.seq"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.CI.12</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"min.5.5"</span>,<span class="st">"max.94.5"</span>,<span class="st">"x.seq"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#df&lt;-data.frame(Y=stan_sim_data$Y,X=stan_sim_data$direct_cov)</span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">dat</span><span class="op">$</span><span class="va">Y_obs</span>,X<span class="op">=</span><span class="va">dat</span><span class="op">$</span><span class="va">X_obs</span>,Regimes<span class="op">=</span><span class="va">regimes_tip</span><span class="op">)</span></span>
<span><span class="va">df11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x.seq</span>,<span class="va">mu.mean.11</span><span class="op">)</span></span>
<span><span class="va">df12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x.seq</span>,<span class="va">mu.mean.12</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#slope.prior.plot&lt;-ggplot(data=reg.trdata$dat,aes(y=Sim1,x=X))+</span></span>
<span><span class="va">slope.plot.1</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">Y</span>,x<span class="op">=</span><span class="va">X</span>,color<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">Regimes</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima.sims</span>,slope<span class="op">=</span><span class="va">beta.sims</span>,alpha<span class="op">=</span><span class="fl">0.05</span><span class="op">)</span><span class="op">+</span> <span class="co">#Prior</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mu.CI.11</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,ymin<span class="op">=</span><span class="va">min.5.5</span>,ymax<span class="op">=</span><span class="va">max.94.5</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span>,alpha<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df11</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,y<span class="op">=</span><span class="va">mu.mean.11</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">1</span>,linewidth<span class="op">=</span><span class="fl">1</span>,alpha<span class="op">=</span><span class="fl">0.3</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mu.CI.12</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,ymin<span class="op">=</span><span class="va">min.5.5</span>,ymax<span class="op">=</span><span class="va">max.94.5</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span>,alpha<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df12</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,y<span class="op">=</span><span class="va">mu.mean.12</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">1</span>,linewidth<span class="op">=</span><span class="fl">1</span>,alpha<span class="op">=</span><span class="fl">0.3</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#ggtitle("Prior vs. Posterior for Intercept and Slope")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Direct Effect X"</span><span class="op">)</span><span class="op">+</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>color<span class="op">=</span><span class="st">"Regimes"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">slope.plot.1</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-29-1.png" width="700"></p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Label points</span></span></code></pre></div>
<p>Here is the Multilevel version of the same model</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Set Priors</span></span>
<span><span class="va">hl.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span>,<span class="fl">0.75</span><span class="op">)</span></span>
<span><span class="va">vy.prior</span><span class="op">&lt;-</span><span class="fl">5</span></span>
<span><span class="va">optima.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">0.5</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span>
<span><span class="va">beta.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>,<span class="fl">0.25</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span>
<span><span class="va">sigma.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>We will use the helper function blouch.reg.direct.prep() to setup the
dat file for Stan. Here “Z_direct” is the number of predictors, and
“regimes” is the name of the regime column in trdata$dat.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Test Blouch prep code - Regimes + Direct Efffect model</span></span>
<span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/blouch.reg.direct.mlm.prep.html">blouch.reg.direct.mlm.prep</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="st">"Y_with_error"</span>,<span class="st">"Y_error"</span>,<span class="st">"X_with_error"</span>,<span class="st">"X_error"</span>,Z_direct<span class="op">=</span><span class="fl">1</span>,<span class="st">"regimes"</span>,<span class="va">hl.prior</span>,<span class="va">vy.prior</span>,<span class="va">optima.prior</span>,<span class="va">beta.prior</span>,<span class="va">sigma.prior</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.direct.mlm.vi</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_direct_mlm_vi</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores<span class="op">=</span><span class="fl">2</span>,iter <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span></code></pre></div>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.direct.mlm.vi</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"optima_bar"</span>,<span class="st">"beta"</span>,<span class="st">"sigma"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_mlm_vi.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;            mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl         0.18    0.00 0.10 0.06 0.11 0.15 0.22  0.42   767    1</span></span>
<span><span class="co">#&gt; vy         0.02    0.00 0.01 0.01 0.01 0.02 0.02  0.03   903    1</span></span>
<span><span class="co">#&gt; optima[1]  2.01    0.00 0.04 1.93 1.99 2.01 2.03  2.09  2744    1</span></span>
<span><span class="co">#&gt; optima[2]  0.91    0.00 0.12 0.61 0.88 0.94 0.98  1.06   870    1</span></span>
<span><span class="co">#&gt; optima_bar 1.76    0.01 0.39 1.06 1.49 1.74 2.00  2.59  3671    1</span></span>
<span><span class="co">#&gt; beta[1]    0.26    0.00 0.01 0.24 0.25 0.26 0.26  0.27  3455    1</span></span>
<span><span class="co">#&gt; sigma      0.91    0.01 0.44 0.34 0.59 0.81 1.15  2.04  2971    1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Sat Oct 11 15:32:04 2025.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.direct.mlm.vi</span><span class="op">)</span> <span class="co">#rstan::extract posterior distribution</span></span></code></pre></div>
<p>And finally the non-centered version of the Multilevel model</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.direct.mlm.vi</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_direct_mlm_vi_nc</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores<span class="op">=</span><span class="fl">2</span>,iter <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Warning: There were 14 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span></code></pre></div>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.direct.mlm.vi</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"optima_bar"</span>,<span class="st">"beta"</span>,<span class="st">"sigma"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_mlm_vi_nc.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;            mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl         0.18    0.00 0.10 0.06 0.11 0.15 0.22  0.43  1104    1</span></span>
<span><span class="co">#&gt; vy         0.02    0.00 0.01 0.01 0.01 0.02 0.02  0.03  1086    1</span></span>
<span><span class="co">#&gt; optima[1]  2.01    0.00 0.04 1.92 1.98 2.01 2.03  2.10  1947    1</span></span>
<span><span class="co">#&gt; optima[2]  0.92    0.00 0.12 0.61 0.88 0.94 0.99  1.06  1210    1</span></span>
<span><span class="co">#&gt; optima_bar 1.77    0.01 0.38 1.06 1.52 1.76 1.99  2.61  1408    1</span></span>
<span><span class="co">#&gt; beta[1]    0.25    0.00 0.01 0.24 0.25 0.26 0.26  0.27  4228    1</span></span>
<span><span class="co">#&gt; sigma      0.90    0.01 0.42 0.34 0.59 0.82 1.12  1.93  1359    1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Sat Oct 11 15:33:07 2025.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.direct.mlm.vi</span><span class="op">)</span> <span class="co">#rstan::extract posterior distribution</span></span></code></pre></div>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="multi-optima-adaptive-model">Multi-optima Adaptive Model<a class="anchor" aria-label="anchor" href="#multi-optima-adaptive-model"></a>
</h2>
<p>We will now include both regimes painted on the tree and an adaptive
predictor</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Create phylogeny</span></span>
<span><span class="co">########################################################################################################</span></span>
<span><span class="va">N</span><span class="op">&lt;-</span><span class="fl">50</span> <span class="co">#Number of species</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="co">#Set seed to get same random species each time</span></span>
<span></span>
<span><span class="va">phy</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/drop.tip.html" class="external-link">keep.tip</a></span><span class="op">(</span><span class="va">tree.10K</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">tree.10K</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">]</span><span class="op">)</span> </span>
<span><span class="va">phy</span><span class="op">&lt;-</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/multi2di.html" class="external-link">multi2di</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span></span>
<span></span>
<span><span class="va">l.tree</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/branching.times.html" class="external-link">branching.times</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span><span class="op">)</span> <span class="co">## rescale tree to height 1</span></span>
<span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">/</span><span class="va">l.tree</span> </span>
<span></span>
<span><span class="va">tip.label</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span></span>
<span></span>
<span><span class="co">#Set regimes - manually - 2 regimes</span></span>
<span><span class="co">#Locate nodes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">phy</span>,no.margin<span class="op">=</span><span class="cn">TRUE</span>,edge.width<span class="op">=</span><span class="fl">2</span>,cex<span class="op">=</span><span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/nodelabels.html" class="external-link">nodelabels</a></span><span class="op">(</span>frame<span class="op">=</span><span class="st">"none"</span>,adj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.1</span>,<span class="op">-</span><span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/nodelabels.html" class="external-link">tiplabels</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_adaptive_model_setup-1.png" width="700"></p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Paint Regimes on Tree</span></span>
<span><span class="va">shifts</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">84</span><span class="op">)</span> <span class="co">#Location of nodes with regime shifts</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu">treeplyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/treeplyr/man/make.treedata.html" class="external-link">make.treedata</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">trdata</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/set.converge.regimes.html">set.converge.regimes</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="va">shifts</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; Levels: OU1 OU2</span></span>
<span><span class="co">#&gt; [1] "#E64B35FF" "#4DBBD5FF"</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_adaptive_model_setup-2.png" width="700"></p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Check if manual setting code worked</span></span>
<span><span class="va">shifts.total</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span>,<span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">node.label</span><span class="op">)</span></span>
<span><span class="va">edge.regimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">shifts.total</span><span class="op">[</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">edge</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">edge.regimes</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; Levels: OU1 OU2</span></span>
<span></span>
<span><span class="va">reg.colors</span> <span class="op">&lt;-</span> <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/pal_aaas.html" class="external-link">pal_aaas</a></span><span class="op">(</span><span class="st">"default"</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">reg.colors</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "#3B4992B2" "#EE0000B2"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>,edge.color <span class="op">=</span> <span class="va">reg.colors</span><span class="op">[</span><span class="va">edge.regimes</span><span class="op">]</span>, edge.width <span class="op">=</span> <span class="fl">1</span>, cex <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_adaptive_model_setup-3.png" width="700"></p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Phylogeny info</span></span>
<span><span class="va">n</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span></span>
<span></span>
<span><span class="va">regimes_internal</span> <span class="op">&lt;-</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">node.label</span></span>
<span><span class="va">regimes_tip</span> <span class="op">&lt;-</span> <span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span></span>
<span><span class="va">regimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/concat.factor.html">concat.factor</a></span><span class="op">(</span><span class="va">regimes_tip</span>, <span class="va">regimes_internal</span><span class="op">)</span></span>
<span><span class="va">anc_maps</span><span class="op">&lt;-</span><span class="st">"regimes"</span></span>
<span><span class="va">lineages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="fu"><a href="../reference/lineage.constructor.html">lineage.constructor</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>, <span class="va">e</span>, <span class="va">anc_maps</span>, <span class="va">regimes</span><span class="op">)</span><span class="op">)</span> <span class="co">#Trace lineage from tips (n) to root and determine regimes of each node or branch</span></span></code></pre></div>
<p>Simulate X and Y data using generative model</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#########################</span></span>
<span><span class="va">hl</span><span class="op">&lt;-</span><span class="fl">0.1</span> <span class="co">#0.1, 0.25, 0.75 - testing options</span></span>
<span><span class="va">a</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span></span>
<span><span class="va">vy</span><span class="op">&lt;-</span><span class="fl">0.01</span> <span class="co">#0.25,0.5 - testing options</span></span>
<span><span class="va">sigma2_y</span><span class="op">&lt;-</span><span class="va">vy</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span><span class="op">)</span><span class="op">)</span>;</span>
<span></span>
<span><span class="va">vX0</span><span class="op">&lt;-</span><span class="fl">0</span></span>
<span><span class="va">vY0</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span><span class="va">Z_adaptive</span><span class="op">&lt;-</span><span class="fl">1</span></span>
<span><span class="va">sigma2_x</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span> <span class="co">#Variance of BM Process</span></span>
<span></span>
<span><span class="va">X</span><span class="op">&lt;-</span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/fastBM.html" class="external-link">fastBM</a></span><span class="op">(</span><span class="va">phy</span>,a<span class="op">=</span><span class="va">vX0</span>,sig2<span class="op">=</span><span class="va">sigma2_x</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>,internal<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="co">#Simulate X BM variable on tree, with scaling 10</span></span>
<span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/phenogram.html" class="external-link">phenogram</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">X</span>,spread.labels<span class="op">=</span><span class="cn">TRUE</span>,spread.cost<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="co">#Plot X data</span></span>
<span><span class="co">#&gt; Optimizing the positions of the tip labels...</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_adaptive_model_data-1.png" width="700"></p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#sigma2_x&lt;-ratematrix(phy,Xa) #Calculate evolutionary v/cv matrix</span></span>
<span></span>
<span><span class="va">dmX</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/weight.matrix.html">weight.matrix</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>, <span class="va">a</span>, <span class="va">lineages</span><span class="op">)</span> <span class="co">#Slouch approach</span></span>
<span><span class="va">dmX</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">dmX</span>,<span class="fu"><a href="../reference/calc_adaptive_dmX.html">calc_adaptive_dmX</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">a</span>,<span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">beta</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">0.25</span><span class="op">)</span> <span class="co">#Two Optima/Two Slopes</span></span>
<span><span class="va">mu</span><span class="op">&lt;-</span><span class="va">dmX</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">beta</span> <span class="co">#Simulate mu for Y</span></span>
<span></span>
<span><span class="va">V</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/calc_adaptive_V.html">calc_adaptive_V</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">a</span>, <span class="va">sigma2_y</span>, <span class="va">beta</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,  <span class="va">sigma2_x</span>,<span class="va">Z_adaptive</span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">&lt;-</span><span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1</span>,<span class="va">mu</span>,<span class="va">V</span><span class="op">)</span></span>
<span></span>
<span><span class="co">################################################################################################################</span></span>
<span><span class="co">#Plot data</span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">Y</span>,X<span class="op">=</span><span class="va">X</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">X</span>,y<span class="op">=</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_adaptive_model_data-2.png" width="700"></p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">X</span>,<span class="va">df</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = Y ~ X, data = df)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co">#&gt; -1.0206  0.0130  0.2201  0.2994  0.4077 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  1.75536    0.07480  23.467  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; X            0.19407    0.06742   2.879  0.00595 ** </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 0.47 on 48 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.1472, Adjusted R-squared:  0.1295 </span></span>
<span><span class="co">#&gt; F-statistic: 8.287 on 1 and 48 DF,  p-value: 0.005947</span></span>
<span><span class="co">################################################################################################################</span></span>
<span><span class="co">#Simulate errors</span></span>
<span><span class="va">Z_X_error</span><span class="op">&lt;-</span><span class="fl">1</span> <span class="co">#Number of X traits with error</span></span>
<span><span class="va">X_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Y_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Y_with_error</span><span class="op">&lt;-</span><span class="va">Y</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">X_with_error</span><span class="op">&lt;-</span><span class="va">X</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span></span>
<span></span>
<span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Make trdata file</span></span>
<span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span>,<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Y_with_error</span>,<span class="va">Y_error</span>,<span class="va">X_with_error</span>,<span class="va">X_error</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">############################################################################################################</span></span></code></pre></div>
<p>Next we will set the priors for the estimated parameters - for this
model this includes the half-life, Vy, optima, and beta. For the latter
two parameters we will use the results of the linear model to inform our
priors.</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Set Priors</span></span>
<span><span class="va">hl.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span>,<span class="fl">0.75</span><span class="op">)</span></span>
<span><span class="va">vy.prior</span><span class="op">&lt;-</span><span class="fl">5</span></span>
<span><span class="va">optima.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.75</span>,<span class="fl">0.55</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span>
<span><span class="va">beta.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>,<span class="fl">0.25</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="exploring-priors-2">Exploring Priors<a class="anchor" aria-label="anchor" href="#exploring-priors-2"></a>
</h2>
<p>At this point one would want to explore if the priors are appropriate
- do the prior distributions look consistent with what we know about our
system? See Grabowski (in press) for more on setting priors.</p>
<p>Half-life Prior plot</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hl.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1000</span>,meanlog<span class="op">=</span><span class="va">hl.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,sdlog<span class="op">=</span><span class="va">hl.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"prior.hl.sims"</span></span>
<span></span>
<span><span class="va">hl.prior.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.hl.sims</span>,fill<span class="op">=</span><span class="st">"prior.hl.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#labs(title="Prior vs. Posterior Distribution ",x="Half-life", y = "Density")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"Half-life"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#scale_fill_manual(labels=c("Posterior","Prior"))+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">hl</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hl.prior.plot</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-33-1.png" width="700"></p>
<p>Vy Prior Plot</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vy.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1000</span>,rate<span class="op">=</span><span class="va">vy.prior</span><span class="op">)</span></span>
<span><span class="va">vy.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">vy.sims</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vy.sims</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"prior.vy.sims"</span></span>
<span></span>
<span><span class="va">vy.prior.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.vy.sims</span>,fill<span class="op">=</span><span class="st">"prior.vy.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">vy.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#labs(title="Prior vs. Posterior Distribution ",x="vy", y = "Density")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"vy"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">vy</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#scale_fill_manual(labels=c("Posterior","Prior"))+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">vy.prior.plot</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-34-1.png" width="700"></p>
<p>Prior on how shared branch lengths correspond to covariance</p>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl.sims</span>;</span>
<span><span class="va">sigma2_y.sims</span><span class="op">&lt;-</span><span class="va">vy.sims</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">)</span>;</span>
<span><span class="co">#x&lt;-seq(from=0,to=1,by=0.001)</span></span>
<span><span class="co">#V.sim&lt;-calc_direct_V(phy,a.sims,sigma2_y.sims)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span> <span class="cn">NULL</span> , xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> , ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.4</span><span class="op">)</span> , xlab<span class="op">=</span><span class="st">"Time since MRCA"</span> , ylab<span class="op">=</span><span class="st">"Covariance"</span> ,cex.axis<span class="op">=</span><span class="fl">0.75</span>, mgp<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.25</span>,<span class="fl">0.25</span>,<span class="fl">0</span><span class="op">)</span>,tcl<span class="op">=</span><span class="op">-</span><span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="fu"><a href="../reference/calc_adaptive_cov_plot.html">calc_adaptive_cov_plot</a></span><span class="op">(</span><span class="va">a.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,<span class="va">sigma2_y.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,<span class="va">beta</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,<span class="va">x</span><span class="op">)</span> , add<span class="op">=</span><span class="cn">TRUE</span> , lwd<span class="op">=</span><span class="fl">4</span> , col<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/col.alpha.html" class="external-link">col.alpha</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0.15</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-35-1.png" width="700"></p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="co">#multiple traits</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">0.25</span>,<span class="fl">0.25</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Slope and intercept Prior Plot</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">optima.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">beta.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">100</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prior.slope.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>  </span>
<span> <span class="fu">ggplot2</span><span class="fu">::</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">Y</span>,x<span class="op">=</span><span class="va">X</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima.sims</span>,slope<span class="op">=</span><span class="va">beta.sims</span>,alpha<span class="op">=</span><span class="fl">0.15</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Adaptive X"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prior.slope.plot</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-36-1.png" width="700"></p>
<p>We will use the helper function blouch.reg.adapt.prep() to setup the
dat file for Stan. Here “Z_adapt” is the number of predictors, and
“regimes” is the name of the regime column in trdata$dat.</p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/blouch.reg.adapt.prep.html">blouch.reg.adapt.prep</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="st">"Y_with_error"</span>,<span class="st">"Y_error"</span>,<span class="st">"X_with_error"</span>,<span class="st">"X_error"</span>,Z_adaptive<span class="op">=</span><span class="fl">1</span>,<span class="st">"regimes"</span>,<span class="va">hl.prior</span>,<span class="va">vy.prior</span>,<span class="va">optima.prior</span>,<span class="va">beta.prior</span><span class="op">)</span></span></code></pre></div>
<p>Now we run the basic Multi-optima Adaptive Model, look at the
results, and rstan::extract the posterior</p>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.adapt</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_adapt</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores <span class="op">=</span> <span class="fl">2</span>, iter <span class="op">=</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span></code></pre></div>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.adapt</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span>,<span class="st">"beta_e"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_adapt.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.22       0 0.11 0.07 0.14 0.20 0.27  0.49   982 1.00</span></span>
<span><span class="co">#&gt; vy        0.02       0 0.01 0.01 0.01 0.02 0.02  0.04  1499 1.00</span></span>
<span><span class="co">#&gt; optima[1] 2.03       0 0.05 1.93 1.99 2.02 2.06  2.14  2250 1.00</span></span>
<span><span class="co">#&gt; optima[2] 0.86       0 0.13 0.54 0.81 0.88 0.94  1.04  1091 1.01</span></span>
<span><span class="co">#&gt; beta[1]   0.24       0 0.05 0.16 0.21 0.23 0.26  0.36  1261 1.01</span></span>
<span><span class="co">#&gt; beta_e[1] 0.17       0 0.03 0.10 0.15 0.17 0.19  0.23  2331 1.00</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Sat Oct 11 15:33:48 2025.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.adapt</span><span class="op">)</span> <span class="co">#rstan::extract Posterior Distribution</span></span></code></pre></div>
<p>Now lets look at the prior vs. posterior plots for the parameters
Half-life plot</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hl.post</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">hl</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">hl.post</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"post.hl.sims"</span></span>
<span></span>
<span><span class="va">hl.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.hl.sims</span>,fill<span class="op">=</span><span class="st">"prior.hl.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">post.hl.sims</span>,fill<span class="op">=</span><span class="st">"post.hl.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">hl.post</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#labs(title="Prior vs. Posterior Distribution ",x="Half-life", y = "Density")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"Half-life"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#scale_fill_manual(labels=c("Posterior","Prior"))+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">hl</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Posterior"</span>,<span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hl.plot</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-38-1.png" width="700"></p>
<p>Vy Prior vs. posterior plot</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vy.post</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">vy</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vy.post</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"post.vy.sims"</span></span>
<span></span>
<span></span>
<span><span class="va">vy.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.vy.sims</span>,fill<span class="op">=</span><span class="st">"prior.vy.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">vy.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">post.vy.sims</span>,fill<span class="op">=</span><span class="st">"post.vy.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">vy.post</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#labs(title="Prior vs. Posterior Distribution ",x="vy", y = "Density")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"vy"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">vy</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#scale_fill_manual(labels=c("Posterior","Prior"))+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Posterior"</span>,<span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vy.plot</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-39-1.png" width="700"></p>
<p>Prior versus posterior on how shared branch lengths correspond to
covariance</p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl.sims</span>;</span>
<span><span class="va">sigma2_y.sims</span><span class="op">&lt;-</span><span class="va">vy.sims</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">)</span>;</span>
<span><span class="co">#x&lt;-seq(from=0,to=1,by=0.001)</span></span>
<span><span class="co">#V.sim&lt;-calc_direct_V(phy,a.sims,sigma2_y.sims)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span> <span class="cn">NULL</span> , xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> , ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.4</span><span class="op">)</span> , xlab<span class="op">=</span><span class="st">"Time since MRCA"</span> , ylab<span class="op">=</span><span class="st">"Covariance"</span> ,cex.axis<span class="op">=</span><span class="fl">0.75</span>, mgp<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.25</span>,<span class="fl">0.25</span>,<span class="fl">0</span><span class="op">)</span>,tcl<span class="op">=</span><span class="op">-</span><span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="fu"><a href="../reference/calc_adaptive_cov_plot.html">calc_adaptive_cov_plot</a></span><span class="op">(</span><span class="va">a.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,<span class="va">sigma2_y.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,<span class="va">beta</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,<span class="va">x</span><span class="op">)</span> , add<span class="op">=</span><span class="cn">TRUE</span> , lwd<span class="op">=</span><span class="fl">4</span> , col<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/col.alpha.html" class="external-link">col.alpha</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0.15</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="fu"><a href="../reference/calc_adaptive_cov_plot.html">calc_adaptive_cov_plot</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">a</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="va">post</span><span class="op">$</span><span class="va">sigma2_y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="va">post</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="va">x</span><span class="op">)</span> , add<span class="op">=</span><span class="cn">TRUE</span> , lwd<span class="op">=</span><span class="fl">4</span> , col<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/col.alpha.html" class="external-link">col.alpha</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-40-1.png" width="700"></p>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#multiple traits</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">0.25</span>,<span class="fl">0.25</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Prior vs. Posterior Plot for Regression</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">optima.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">beta.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">100</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">optima.post</span><span class="op">&lt;-</span><span class="va">post</span><span class="op">$</span><span class="va">optima</span></span>
<span><span class="va">beta.post</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">beta</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">beta.post</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"post.beta.1"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mu.link.11</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x.seq</span><span class="op">)</span><span class="op">{</span><span class="va">optima.post</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">+</span><span class="va">x.seq</span><span class="op">*</span><span class="va">beta.post</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">}</span></span>
<span><span class="va">mu.link.12</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x.seq</span><span class="op">)</span><span class="op">{</span><span class="va">optima.post</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">+</span><span class="va">x.seq</span><span class="op">*</span><span class="va">beta.post</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">}</span></span>
<span></span>
<span><span class="va">x.seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, to<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span> , length.out<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">mu.11</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">x.seq</span> , <span class="va">mu.link.11</span> <span class="op">)</span></span>
<span><span class="va">mu.12</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">x.seq</span> , <span class="va">mu.link.12</span> <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">mu.mean.11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">mu.11</span><span class="op">)</span></span>
<span><span class="va">mu.mean.12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">mu.12</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mu.mean.11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mu.mean.11</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mu.mean.12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mu.mean.12</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.mean.11</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"mu.mean.11"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.mean.12</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"mu.mean.12"</span></span>
<span></span>
<span><span class="va">mu.CI.11</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span> <span class="va">mu.11</span> , MARGIN<span class="op">=</span><span class="fl">2</span>, FUN<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/rethinking/man/HPDI.html" class="external-link">PI</a></span> , prob<span class="op">=</span><span class="fl">0.89</span> <span class="op">)</span></span>
<span><span class="va">mu.CI.12</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span> <span class="va">mu.12</span> , MARGIN<span class="op">=</span><span class="fl">2</span>, FUN<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/rethinking/man/HPDI.html" class="external-link">PI</a></span> , prob<span class="op">=</span><span class="fl">0.89</span> <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">mu.CI.11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mu.CI.11</span><span class="op">)</span><span class="op">)</span>,<span class="va">x.seq</span><span class="op">)</span></span>
<span><span class="va">mu.CI.12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mu.CI.12</span><span class="op">)</span><span class="op">)</span>,<span class="va">x.seq</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.CI.11</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"min.5.5"</span>,<span class="st">"max.94.5"</span>,<span class="st">"x.seq"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.CI.12</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"min.5.5"</span>,<span class="st">"max.94.5"</span>,<span class="st">"x.seq"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#df&lt;-data.frame(Y=stan_sim_data$Y,X=stan_sim_data$direct_cov)</span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">dat</span><span class="op">$</span><span class="va">Y_obs</span>,X<span class="op">=</span><span class="va">dat</span><span class="op">$</span><span class="va">X_obs</span>,Regimes<span class="op">=</span><span class="va">regimes_tip</span><span class="op">)</span></span>
<span><span class="va">df11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x.seq</span>,<span class="va">mu.mean.11</span><span class="op">)</span></span>
<span><span class="va">df12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x.seq</span>,<span class="va">mu.mean.12</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#slope.prior.plot&lt;-ggplot(data=reg.trdata$dat,aes(y=Sim1,x=X))+</span></span>
<span><span class="va">slope.plot.1</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">Y</span>,x<span class="op">=</span><span class="va">X</span>,color<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">Regimes</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima.sims</span>,slope<span class="op">=</span><span class="va">beta.sims</span>,alpha<span class="op">=</span><span class="fl">0.05</span><span class="op">)</span><span class="op">+</span> <span class="co">#Prior</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mu.CI.11</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,ymin<span class="op">=</span><span class="va">min.5.5</span>,ymax<span class="op">=</span><span class="va">max.94.5</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span>,alpha<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df11</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,y<span class="op">=</span><span class="va">mu.mean.11</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">1</span>,linewidth<span class="op">=</span><span class="fl">1</span>,alpha<span class="op">=</span><span class="fl">0.3</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mu.CI.12</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,ymin<span class="op">=</span><span class="va">min.5.5</span>,ymax<span class="op">=</span><span class="va">max.94.5</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span>,alpha<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df12</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,y<span class="op">=</span><span class="va">mu.mean.12</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">1</span>,linewidth<span class="op">=</span><span class="fl">1</span>,alpha<span class="op">=</span><span class="fl">0.3</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#ggtitle("Prior vs. Posterior for Intercept and Slope")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Direct Effect X"</span><span class="op">)</span><span class="op">+</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>color<span class="op">=</span><span class="st">"Regimes"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">slope.plot.1</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-41-1.png" width="700"></p>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Label points</span></span></code></pre></div>
<p>Here is the Multilevel version of the same model Next we will set the
priors for the estimated parameters - for this model this includes the
half-life, Vy, optima, and beta. For the latter two parameters we will
use the results of the linear model to inform our priors.</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Set Priors</span></span>
<span><span class="va">hl.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span>,<span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="va">vy.prior</span><span class="op">&lt;-</span><span class="fl">5</span></span>
<span><span class="va">optima.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>,<span class="fl">0.5</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span>
<span><span class="va">beta.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.25</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span>
<span><span class="va">sigma.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Make trdata file</span></span>
<span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span>,<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Y_with_error</span>,<span class="va">Y_error</span>,<span class="va">X_with_error</span>,<span class="va">X_error</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">############################################################################################################</span></span>
<span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/blouch.reg.adapt.mlm.prep.html">blouch.reg.adapt.mlm.prep</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="st">"Y_with_error"</span>,<span class="st">"Y_error"</span>,<span class="st">"X_with_error"</span>,<span class="st">"X_error"</span>,Z_adaptive<span class="op">=</span><span class="fl">1</span>,<span class="st">"regimes"</span>,<span class="va">hl.prior</span>,<span class="va">vy.prior</span>,<span class="va">optima.prior</span>,<span class="va">beta.prior</span>,<span class="va">sigma.prior</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.adapt.mlm.vi</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_adapt_mlm_vi</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores<span class="op">=</span><span class="fl">2</span>,iter <span class="op">=</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span></code></pre></div>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.adapt.mlm.vi</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span>,<span class="st">"beta_e"</span>,<span class="st">"sigma"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_adapt_mlm_vi.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.25    0.00 0.06 0.15 0.21 0.24 0.28  0.38  1154    1</span></span>
<span><span class="co">#&gt; vy        0.02    0.00 0.01 0.01 0.02 0.02 0.02  0.03  1701    1</span></span>
<span><span class="co">#&gt; optima[1] 2.04    0.00 0.06 1.92 2.00 2.04 2.08  2.16  1791    1</span></span>
<span><span class="co">#&gt; optima[2] 0.83    0.00 0.12 0.56 0.77 0.84 0.91  1.03  1177    1</span></span>
<span><span class="co">#&gt; beta[1]   0.24    0.00 0.05 0.14 0.20 0.24 0.27  0.34  1423    1</span></span>
<span><span class="co">#&gt; beta_e[1] 0.16    0.00 0.03 0.09 0.13 0.16 0.18  0.22  1802    1</span></span>
<span><span class="co">#&gt; sigma     0.92    0.01 0.46 0.34 0.58 0.82 1.13  2.01  2198    1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Sat Oct 11 15:34:28 2025.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.adapt.mlm.vi</span><span class="op">)</span></span></code></pre></div>
<p>And the non-centered version</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.adapt.mlm.vi.nc</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_adapt_mlm_vi_nc</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores<span class="op">=</span><span class="fl">2</span>,iter <span class="op">=</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Warning: There were 28 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span></code></pre></div>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.adapt.mlm.vi.nc</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span>,<span class="st">"beta_e"</span>,<span class="st">"sigma"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_adapt_mlm_vi_nc.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.25    0.00 0.06 0.15 0.21 0.24 0.28  0.38  2550 1.00</span></span>
<span><span class="co">#&gt; vy        0.02    0.00 0.01 0.01 0.02 0.02 0.02  0.04  2572 1.00</span></span>
<span><span class="co">#&gt; optima[1] 2.03    0.00 0.06 1.92 1.99 2.03 2.07  2.16  1970 1.00</span></span>
<span><span class="co">#&gt; optima[2] 0.83    0.00 0.11 0.58 0.77 0.85 0.91  1.03  2063 1.00</span></span>
<span><span class="co">#&gt; beta[1]   0.23    0.00 0.05 0.14 0.20 0.23 0.26  0.34  2897 1.00</span></span>
<span><span class="co">#&gt; beta_e[1] 0.16    0.00 0.03 0.09 0.13 0.16 0.18  0.22  3233 1.00</span></span>
<span><span class="co">#&gt; sigma     0.89    0.01 0.39 0.36 0.60 0.81 1.10  1.83  1281 1.01</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Sat Oct 11 15:35:58 2025.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.adapt.mlm.vi.nc</span><span class="op">)</span></span></code></pre></div>
<p>From there the posteriors should be explored, compared to the priors,
etc. See the Simulation Example for one example of how to do this.</p>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="multi-optima-direct-effect-and-adaptive-model">Multi-optima Direct Effect and Adaptive Model<a class="anchor" aria-label="anchor" href="#multi-optima-direct-effect-and-adaptive-model"></a>
</h2>
<p>We will now include both regimes painted on the tree and a direct
effect and adaptive predictor</p>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Regimes + Adaptive + Direct Model</span></span>
<span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Create phylogeny</span></span>
<span><span class="co">########################################################################################################</span></span>
<span><span class="va">N</span><span class="op">&lt;-</span><span class="fl">50</span> <span class="co">#Number of species</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="co">#Set seed to get same random species each time</span></span>
<span></span>
<span><span class="va">phy</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/drop.tip.html" class="external-link">keep.tip</a></span><span class="op">(</span><span class="va">tree.10K</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">tree.10K</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">]</span><span class="op">)</span> </span>
<span><span class="va">phy</span><span class="op">&lt;-</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/multi2di.html" class="external-link">multi2di</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span></span>
<span></span>
<span><span class="va">l.tree</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/branching.times.html" class="external-link">branching.times</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span><span class="op">)</span> <span class="co">## rescale tree to height 1</span></span>
<span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">/</span><span class="va">l.tree</span> </span>
<span></span>
<span><span class="va">tip.label</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span></span>
<span></span>
<span><span class="co">#Set regimes - manually - 2 regimes</span></span>
<span><span class="co">#Locate nodes</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">phy</span>,no.margin<span class="op">=</span><span class="cn">TRUE</span>,edge.width<span class="op">=</span><span class="fl">2</span>,cex<span class="op">=</span><span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/nodelabels.html" class="external-link">nodelabels</a></span><span class="op">(</span>frame<span class="op">=</span><span class="st">"none"</span>,adj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.1</span>,<span class="op">-</span><span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/nodelabels.html" class="external-link">tiplabels</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_direct_adaptive_model_setup-1.png" width="700"></p>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Paint Regimes on Tree</span></span>
<span><span class="va">shifts</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">84</span><span class="op">)</span> <span class="co">#Location of nodes with regime shifts</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu">treeplyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/treeplyr/man/make.treedata.html" class="external-link">make.treedata</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">trdata</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/set.converge.regimes.html">set.converge.regimes</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="va">shifts</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; Levels: OU1 OU2</span></span>
<span><span class="co">#&gt; [1] "#E64B35FF" "#4DBBD5FF"</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_direct_adaptive_model_setup-2.png" width="700"></p>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Check if manual setting code worked</span></span>
<span><span class="va">shifts.total</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span>,<span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">node.label</span><span class="op">)</span></span>
<span><span class="va">edge.regimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">shifts.total</span><span class="op">[</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">edge</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">edge.regimes</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span><span class="co">#&gt; Levels: OU1 OU2</span></span>
<span></span>
<span><span class="va">reg.colors</span> <span class="op">&lt;-</span> <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/pal_aaas.html" class="external-link">pal_aaas</a></span><span class="op">(</span><span class="st">"default"</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">reg.colors</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "#3B4992B2" "#EE0000B2"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>,edge.color <span class="op">=</span> <span class="va">reg.colors</span><span class="op">[</span><span class="va">edge.regimes</span><span class="op">]</span>, edge.width <span class="op">=</span> <span class="fl">1</span>, cex <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_direct_adaptive_model_setup-3.png" width="700"></p>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#Phylogeny info</span></span>
<span><span class="va">n</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span></span>
<span></span>
<span><span class="va">regimes_internal</span> <span class="op">&lt;-</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span><span class="op">$</span><span class="va">node.label</span></span>
<span><span class="va">regimes_tip</span> <span class="op">&lt;-</span> <span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">$</span><span class="va">regimes</span></span>
<span><span class="va">regimes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/concat.factor.html">concat.factor</a></span><span class="op">(</span><span class="va">regimes_tip</span>, <span class="va">regimes_internal</span><span class="op">)</span></span>
<span><span class="va">anc_maps</span><span class="op">&lt;-</span><span class="st">"regimes"</span></span>
<span><span class="va">lineages</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="fu"><a href="../reference/lineage.constructor.html">lineage.constructor</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>, <span class="va">e</span>, <span class="va">anc_maps</span>, <span class="va">regimes</span><span class="op">)</span><span class="op">)</span> <span class="co">#Trace lineage from tips (n) to root and determine regimes of each node or branch</span></span></code></pre></div>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="va">hl</span><span class="op">&lt;-</span><span class="fl">0.1</span> <span class="co">#0.1, 0.25, 0.75 - testing options</span></span>
<span><span class="va">a</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span></span>
<span><span class="va">vy</span><span class="op">&lt;-</span><span class="fl">0.01</span> <span class="co">#0.25,0.5 - testing options</span></span>
<span><span class="va">sigma2_y</span><span class="op">&lt;-</span><span class="va">vy</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span><span class="op">)</span><span class="op">)</span>;</span>
<span></span>
<span><span class="va">vX0</span><span class="op">&lt;-</span><span class="fl">0</span></span>
<span><span class="va">vY0</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span><span class="va">Z_direct</span><span class="op">&lt;-</span><span class="fl">1</span></span>
<span><span class="va">Z_adaptive</span><span class="op">&lt;-</span><span class="fl">1</span></span>
<span><span class="va">Z</span><span class="op">&lt;-</span><span class="va">Z_direct</span><span class="op">+</span><span class="va">Z_adaptive</span></span>
<span><span class="va">sigma2_x</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span> <span class="co">#Variance of BM Process</span></span>
<span></span>
<span><span class="va">Xd</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">Xd</span><span class="op">)</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span></span>
<span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/phenogram.html" class="external-link">phenogram</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">Xd</span>,spread.labels<span class="op">=</span><span class="cn">TRUE</span>,spread.cost<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="co">#Plot X data</span></span>
<span><span class="co">#&gt; Optimizing the positions of the tip labels...</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_direct_adaptive_model_data-1.png" width="700"></p>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Xa</span><span class="op">&lt;-</span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/fastBM.html" class="external-link">fastBM</a></span><span class="op">(</span><span class="va">phy</span>,a<span class="op">=</span><span class="va">vX0</span>,sig2<span class="op">=</span><span class="va">sigma2_x</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>,internal<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="co">#Simulate X BM variable on tree, with scaling 10</span></span>
<span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/phenogram.html" class="external-link">phenogram</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">Xa</span>,spread.labels<span class="op">=</span><span class="cn">TRUE</span>,spread.cost<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="co">#Plot X data</span></span>
<span><span class="co">#&gt; Optimizing the positions of the tip labels...</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_direct_adaptive_model_data-2.png" width="700"></p>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#sigma2_x&lt;-ratematrix(phy,Xa) #Calculate evolutionary v/cv matrix</span></span>
<span><span class="va">Xs</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Xd</span>,<span class="va">Xa</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dmX</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/weight.matrix.html">weight.matrix</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">phy</span>, <span class="va">a</span>, <span class="va">lineages</span><span class="op">)</span> <span class="co">#Slouch approach</span></span>
<span><span class="va">dmX</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">dmX</span>,<span class="fu"><a href="../reference/calc_mixed_dmX.html">calc_mixed_dmX</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">a</span>,<span class="va">Xs</span>,<span class="va">Z_direct</span>,<span class="va">Z_adaptive</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">beta</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">0.35</span>,<span class="fl">0.25</span><span class="op">)</span> <span class="co">#Two Optima/Two Slopes</span></span>
<span><span class="va">mu</span><span class="op">&lt;-</span><span class="va">dmX</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">beta</span> <span class="co">#Simulate mu for Y</span></span>
<span></span>
<span><span class="va">V</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/calc_adaptive_V.html">calc_adaptive_V</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">a</span>, <span class="va">sigma2_y</span>,   <span class="va">beta</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span><span class="op">]</span>,  <span class="va">sigma2_x</span>,<span class="va">Z_adaptive</span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">&lt;-</span><span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1</span>,<span class="va">mu</span>,<span class="va">V</span><span class="op">)</span></span>
<span></span>
<span><span class="co">################################################################################################################</span></span>
<span><span class="co">#Plot data</span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">Y</span>,Xd<span class="op">=</span><span class="va">Xs</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,Xa<span class="op">=</span><span class="va">Xs</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Xd</span>,y<span class="op">=</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_direct_adaptive_model_data-3.png" width="700"></p>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Xa</span>,y<span class="op">=</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_direct_adaptive_model_data-4.png" width="700"></p>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">Xs</span>,<span class="va">df</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = Y ~ Xs, data = df)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co">#&gt; -0.84900 -0.16208  0.08845  0.25892  0.67924 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  1.78206    0.05601  31.818  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; XsXd         0.23270    0.04105   5.668 8.52e-07 ***</span></span>
<span><span class="co">#&gt; XsXa         0.14175    0.06396   2.216   0.0315 *  </span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 0.3935 on 47 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.4563, Adjusted R-squared:  0.4332 </span></span>
<span><span class="co">#&gt; F-statistic: 19.72 on 2 and 47 DF,  p-value: 6.034e-07</span></span>
<span></span>
<span><span class="co">########################################################################################################</span></span>
<span><span class="co">#Simulate errors - for use with blouchOU_reg_direct_adaptive_ME</span></span>
<span><span class="va">Z_X_error</span><span class="op">&lt;-</span><span class="fl">2</span> <span class="co">#Number of X traits with error</span></span>
<span><span class="va">X_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0.01</span>,nrow<span class="op">=</span><span class="va">N</span>,ncol<span class="op">=</span><span class="va">Z_X_error</span><span class="op">)</span></span>
<span><span class="va">X_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">X_error</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">X_error</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Xd_error"</span>,<span class="st">"Xa_error"</span><span class="op">)</span></span>
<span><span class="va">Y_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Y_with_error</span><span class="op">&lt;-</span><span class="va">Y</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">X_with_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">Xs</span>,<span class="fl">2</span>,<span class="kw">function</span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">{</span><span class="va">X</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Set Priors</span></span>
<span><span class="va">hl.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span>,<span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="va">vy.prior</span><span class="op">&lt;-</span><span class="fl">5</span></span>
<span><span class="va">optima.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>,<span class="fl">0.5</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span>
<span><span class="va">beta.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.25</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span></code></pre></div>
<p>Half-life Prior plot</p>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hl.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1000</span>,meanlog<span class="op">=</span><span class="va">hl.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,sdlog<span class="op">=</span><span class="va">hl.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"prior.hl.sims"</span></span>
<span></span>
<span><span class="va">hl.prior.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.hl.sims</span>,fill<span class="op">=</span><span class="st">"prior.hl.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#labs(title="Prior vs. Posterior Distribution ",x="Half-life", y = "Density")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"Half-life"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#scale_fill_manual(labels=c("Posterior","Prior"))+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">hl</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hl.prior.plot</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-45-1.png" width="700"></p>
<p>Vy Prior Plot</p>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vy.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1000</span>,rate<span class="op">=</span><span class="va">vy.prior</span><span class="op">)</span></span>
<span><span class="va">vy.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">vy.sims</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vy.sims</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"prior.vy.sims"</span></span>
<span></span>
<span><span class="va">vy.prior.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.vy.sims</span>,fill<span class="op">=</span><span class="st">"prior.vy.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">vy.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#labs(title="Prior vs. Posterior Distribution ",x="vy", y = "Density")+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"vy"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">vy</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="co">#scale_fill_manual(labels=c("Posterior","Prior"))+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">vy.prior.plot</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-46-1.png" width="700"></p>
<p>Adaptation model</p>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl.sims</span>;</span>
<span><span class="va">sigma2_y.sims</span><span class="op">&lt;-</span><span class="va">vy.sims</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">)</span>;</span>
<span><span class="co">#x&lt;-seq(from=0,to=1,by=0.001)</span></span>
<span><span class="co">#V.sim&lt;-calc_direct_V(phy,a.sims,sigma2_y.sims)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span> <span class="cn">NULL</span> , xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> , ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.4</span><span class="op">)</span> , xlab<span class="op">=</span><span class="st">"Time since MRCA"</span> , ylab<span class="op">=</span><span class="st">"Covariance"</span> ,cex.axis<span class="op">=</span><span class="fl">0.75</span>, mgp<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.25</span>,<span class="fl">0.25</span>,<span class="fl">0</span><span class="op">)</span>,tcl<span class="op">=</span><span class="op">-</span><span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="fu"><a href="../reference/calc_adaptive_cov_plot.html">calc_adaptive_cov_plot</a></span><span class="op">(</span><span class="va">a.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,<span class="va">sigma2_y.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,<span class="va">beta</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,<span class="va">x</span><span class="op">)</span> , add<span class="op">=</span><span class="cn">TRUE</span> , lwd<span class="op">=</span><span class="fl">4</span> , col<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/col.alpha.html" class="external-link">col.alpha</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0.15</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-47-1.png" width="700"></p>
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">0.25</span>,<span class="fl">0.25</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">covariance.plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/recordplot.html" class="external-link">recordPlot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; null device </span></span>
<span><span class="co">#&gt;           1</span></span>
<span></span>
<span><span class="va">covariance.plot</span></span></code></pre></div>
<p>Prior vs. Posterior Plot</p>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">optima.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">beta.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">100</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">Y_with_error</span>,X<span class="op">=</span><span class="va">X_with_error</span>,Regimes<span class="op">=</span><span class="va">regimes_tip</span><span class="op">)</span></span>
<span></span>
<span><span class="va">slope.plot.Xd</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">Y</span>,x<span class="op">=</span><span class="va">X.Xd</span>,color<span class="op">=</span><span class="va">Regimes</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima.sims</span>,slope<span class="op">=</span><span class="va">beta.sims</span>,alpha<span class="op">=</span><span class="fl">0.15</span><span class="op">)</span><span class="op">+</span> <span class="co">#Prior</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>  panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Direct effect trait"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">slope.plot.Xd</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-48-1.png" width="700"></p>
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">slope.plot.Xa</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">Y</span>,x<span class="op">=</span><span class="va">X.Xa</span>,color<span class="op">=</span><span class="va">Regimes</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima.sims</span>,slope<span class="op">=</span><span class="va">beta.sims</span>,alpha<span class="op">=</span><span class="fl">0.15</span><span class="op">)</span><span class="op">+</span> <span class="co">#Prior</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>  panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Adaptive trait"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">slope.plot.Xa</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-48-2.png" width="700"></p>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Make trdata file</span></span>
<span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span>,<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Y_with_error</span>,<span class="va">Y_error</span>,<span class="va">X_with_error</span>,<span class="va">X_error</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We will use the helper function blouch.reg.direct.adapt.prep() to
setup the dat file for Stan. Here the names of the direct effect and
adaptive columns are “Xd”, and “Xa” and their associated errors, with
Z_direct and Z_adaptive th number of direct and adaptive traits,
respectively, and “regimes” is the name of the regimes column data in
trdata$dat.</p>
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/blouch.reg.direct.adapt.prep.html">blouch.reg.direct.adapt.prep</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="st">"Y_with_error"</span>,<span class="st">"Y_error"</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Xd"</span>,<span class="st">"Xa"</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Xd_error"</span>,<span class="st">"Xa_error"</span><span class="op">)</span>,Z_direct<span class="op">=</span><span class="fl">1</span>,Z_adaptive<span class="op">=</span><span class="fl">1</span>,<span class="st">"regimes"</span>,<span class="va">hl.prior</span>,<span class="va">vy.prior</span>,<span class="va">optima.prior</span>,<span class="va">beta.prior</span><span class="op">)</span></span></code></pre></div>
<p>First we run the basic Multi-optima Direct Effect Adaptive Model.</p>
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.direct.adapt</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_direct_adapt</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores<span class="op">=</span><span class="fl">2</span>,iter <span class="op">=</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span></code></pre></div>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.direct.adapt</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span>,<span class="st">"beta_e"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_adapt.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.21       0 0.05 0.13 0.18 0.21 0.24  0.33  2000    1</span></span>
<span><span class="co">#&gt; vy        0.01       0 0.00 0.00 0.01 0.01 0.01  0.02  3105    1</span></span>
<span><span class="co">#&gt; optima[1] 1.98       0 0.05 1.89 1.95 1.98 2.01  2.08  3550    1</span></span>
<span><span class="co">#&gt; optima[2] 0.95       0 0.09 0.75 0.90 0.96 1.01  1.11  2364    1</span></span>
<span><span class="co">#&gt; beta[1]   0.35       0 0.01 0.33 0.34 0.35 0.35  0.36  4263    1</span></span>
<span><span class="co">#&gt; beta[2]   0.33       0 0.05 0.25 0.30 0.33 0.36  0.44  2331    1</span></span>
<span><span class="co">#&gt; beta_e[1] 0.23       0 0.03 0.18 0.22 0.23 0.25  0.29  3395    1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Sat Oct 11 15:36:46 2025.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.direct.adapt</span><span class="op">)</span> <span class="co">#rstan::extract posterior</span></span></code></pre></div>
<p>Prior vs. posterior</p>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hl.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1000</span>,meanlog<span class="op">=</span><span class="va">hl.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,sdlog<span class="op">=</span><span class="va">hl.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"prior.hl.sims"</span></span>
<span></span>
<span><span class="va">hl.post</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">hl</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">hl.post</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"post.hl.sims"</span></span>
<span></span>
<span><span class="va">hl.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.hl.sims</span>,fill<span class="op">=</span><span class="st">"prior.hl.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">post.hl.sims</span>,fill<span class="op">=</span><span class="st">"post.hl.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">hl.post</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>  panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"Half-life"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">hl</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Posterior"</span>,<span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hl.plot</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-51-1.png" width="700"></p>
<p>Prior vs. posterior plot</p>
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vy.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1000</span>,rate<span class="op">=</span><span class="va">vy.prior</span><span class="op">)</span></span>
<span><span class="va">vy.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">vy.sims</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vy.sims</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"prior.vy.sims"</span></span>
<span></span>
<span><span class="va">vy.post</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">vy</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vy.post</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"post.vy.sims"</span></span>
<span></span>
<span></span>
<span><span class="va">vy.plot</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">prior.vy.sims</span>,fill<span class="op">=</span><span class="st">"prior.vy.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">vy.sims</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">post.vy.sims</span>,fill<span class="op">=</span><span class="st">"post.vy.sims"</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.2</span>,data<span class="op">=</span><span class="va">vy.post</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>  panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"vy"</span>, y <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">vy</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_fill_npg</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">""</span>,labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Posterior"</span>,<span class="st">"Prior"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vy.plot</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-52-1.png" width="700"></p>
<p>Adaptation model</p>
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl.sims</span>;</span>
<span><span class="va">sigma2_y.sims</span><span class="op">&lt;-</span><span class="va">vy.sims</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl.sims</span><span class="op">)</span><span class="op">)</span>;</span>
<span><span class="co">#x&lt;-seq(from=0,to=1,by=0.001)</span></span>
<span><span class="co">#V.sim&lt;-calc_direct_V(phy,a.sims,sigma2_y.sims)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span> <span class="cn">NULL</span> , xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> , ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.4</span><span class="op">)</span> , xlab<span class="op">=</span><span class="st">"Time since MRCA"</span> , ylab<span class="op">=</span><span class="st">"Covariance"</span> ,cex.axis<span class="op">=</span><span class="fl">0.75</span>, mgp<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.25</span>,<span class="fl">0.25</span>,<span class="fl">0</span><span class="op">)</span>,tcl<span class="op">=</span><span class="op">-</span><span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="fu"><a href="../reference/calc_adaptive_cov_plot.html">calc_adaptive_cov_plot</a></span><span class="op">(</span><span class="va">a.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,<span class="va">sigma2_y.sims</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,<span class="va">beta</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>,<span class="va">x</span><span class="op">)</span> , add<span class="op">=</span><span class="cn">TRUE</span> , lwd<span class="op">=</span><span class="fl">4</span> , col<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/col.alpha.html" class="external-link">col.alpha</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0.15</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/curve.html" class="external-link">curve</a></span><span class="op">(</span><span class="fu"><a href="../reference/calc_adaptive_cov_plot.html">calc_adaptive_cov_plot</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">a</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="va">post</span><span class="op">$</span><span class="va">sigma2_y</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="va">post</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span>,<span class="va">x</span><span class="op">)</span> , add<span class="op">=</span><span class="cn">TRUE</span> , lwd<span class="op">=</span><span class="fl">4</span> , col<span class="op">=</span><span class="fu">rethinking</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rethinking/man/col.alpha.html" class="external-link">col.alpha</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-53-1.png" width="700"></p>
<div class="sourceCode" id="cb109"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co">#multiple traits</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">0.25</span>,<span class="fl">0.25</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">covariance.plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/recordplot.html" class="external-link">recordPlot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; null device </span></span>
<span><span class="co">#&gt;           1</span></span>
<span></span>
<span><span class="co">#Vt = sigma2_y /( 2 * a) * ((1 - exp(-2 * a * ta)) .* exp(-a * tij)); //From Hansen (1997)</span></span>
<span></span>
<span><span class="va">covariance.plot</span></span></code></pre></div>
<p>Slope plots for direct and adaptive models with Measurement Error</p>
<div class="sourceCode" id="cb110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://nanx.me/ggsci/" class="external-link">ggsci</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">optima.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">beta.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">100</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">beta.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">optima.post</span><span class="op">&lt;-</span><span class="va">post</span><span class="op">$</span><span class="va">optima</span></span>
<span></span>
<span><span class="va">beta.post.1</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">beta.post.1</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"post.beta.1"</span></span>
<span></span>
<span><span class="va">beta.post.2</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">beta</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">beta.post.2</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"post.beta.2"</span></span>
<span></span>
<span><span class="va">mu.link.11</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x.seq</span><span class="op">)</span><span class="op">{</span><span class="va">optima.post</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">+</span><span class="va">x.seq</span><span class="op">*</span><span class="va">beta.post.1</span><span class="op">}</span></span>
<span><span class="va">mu.link.12</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x.seq</span><span class="op">)</span><span class="op">{</span><span class="va">optima.post</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">+</span><span class="va">x.seq</span><span class="op">*</span><span class="va">beta.post.1</span><span class="op">}</span></span>
<span><span class="va">mu.link.21</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x.seq</span><span class="op">)</span><span class="op">{</span><span class="va">optima.post</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">+</span><span class="va">x.seq</span><span class="op">*</span><span class="va">beta.post.2</span><span class="op">}</span></span>
<span><span class="va">mu.link.22</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">x.seq</span><span class="op">)</span><span class="op">{</span><span class="va">optima.post</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">+</span><span class="va">x.seq</span><span class="op">*</span><span class="va">beta.post.2</span><span class="op">}</span></span>
<span><span class="va">x.seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">Xs</span><span class="op">)</span>, to<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">Xs</span><span class="op">)</span> , length.out<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">mu.11</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">x.seq</span> , <span class="va">mu.link.11</span> <span class="op">)</span></span>
<span><span class="va">mu.12</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">x.seq</span> , <span class="va">mu.link.12</span> <span class="op">)</span></span>
<span><span class="va">mu.21</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">x.seq</span> , <span class="va">mu.link.21</span> <span class="op">)</span></span>
<span><span class="va">mu.22</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">x.seq</span> , <span class="va">mu.link.22</span> <span class="op">)</span></span>
<span><span class="va">mu.mean.11</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span> <span class="va">mu.11</span> , <span class="va">mean</span> <span class="op">)</span></span>
<span><span class="va">mu.mean.12</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span> <span class="va">mu.12</span> , <span class="va">mean</span> <span class="op">)</span></span>
<span><span class="va">mu.mean.21</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span> <span class="va">mu.21</span> , <span class="va">mean</span> <span class="op">)</span></span>
<span><span class="va">mu.mean.22</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span> <span class="va">mu.22</span> , <span class="va">mean</span> <span class="op">)</span></span>
<span></span>
<span><span class="va">mu.mean.11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mu.mean.11</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mu.mean.12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mu.mean.12</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.mean.11</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"mu.mean.11"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.mean.12</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"mu.mean.12"</span></span>
<span><span class="va">mu.mean.21</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mu.mean.21</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mu.mean.22</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mu.mean.22</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.mean.21</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"mu.mean.21"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.mean.22</span><span class="op">)</span><span class="op">&lt;-</span><span class="st">"mu.mean.22"</span></span>
<span></span>
<span><span class="va">mu.CI.11</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span> <span class="va">mu.11</span> , <span class="fu">rethinking</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/rethinking/man/HPDI.html" class="external-link">PI</a></span> , prob<span class="op">=</span><span class="fl">0.89</span> <span class="op">)</span></span>
<span><span class="va">mu.CI.12</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span> <span class="va">mu.12</span> , <span class="fu">rethinking</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/rethinking/man/HPDI.html" class="external-link">PI</a></span> , prob<span class="op">=</span><span class="fl">0.89</span> <span class="op">)</span></span>
<span><span class="va">mu.CI.11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mu.CI.11</span><span class="op">)</span><span class="op">)</span>,<span class="va">x.seq</span><span class="op">)</span></span>
<span><span class="va">mu.CI.12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mu.CI.12</span><span class="op">)</span><span class="op">)</span>,<span class="va">x.seq</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mu.CI.21</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span> <span class="va">mu.21</span> , <span class="fu">rethinking</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/rethinking/man/HPDI.html" class="external-link">PI</a></span> , prob<span class="op">=</span><span class="fl">0.89</span> <span class="op">)</span></span>
<span><span class="va">mu.CI.22</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span> <span class="va">mu.22</span> , <span class="fu">rethinking</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/rethinking/man/HPDI.html" class="external-link">PI</a></span> , prob<span class="op">=</span><span class="fl">0.89</span> <span class="op">)</span></span>
<span><span class="va">mu.CI.21</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mu.CI.21</span><span class="op">)</span><span class="op">)</span>,<span class="va">x.seq</span><span class="op">)</span></span>
<span><span class="va">mu.CI.22</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mu.CI.22</span><span class="op">)</span><span class="op">)</span>,<span class="va">x.seq</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.CI.11</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"min.5.5"</span>,<span class="st">"max.94.5"</span>,<span class="st">"x.seq"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.CI.12</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"min.5.5"</span>,<span class="st">"max.94.5"</span>,<span class="st">"x.seq"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.CI.21</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"min.5.5"</span>,<span class="st">"max.94.5"</span>,<span class="st">"x.seq"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.CI.22</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"min.5.5"</span>,<span class="st">"max.94.5"</span>,<span class="st">"x.seq"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">dat</span><span class="op">$</span><span class="va">Y_obs</span>,X<span class="op">=</span><span class="va">dat</span><span class="op">$</span><span class="va">X_obs</span>,Regimes<span class="op">=</span><span class="va">regimes_tip</span><span class="op">)</span></span>
<span><span class="va">df11</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x.seq</span>,<span class="va">mu.mean.11</span><span class="op">)</span></span>
<span><span class="va">df12</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x.seq</span>,<span class="va">mu.mean.12</span><span class="op">)</span></span>
<span><span class="va">df21</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x.seq</span>,<span class="va">mu.mean.21</span><span class="op">)</span></span>
<span><span class="va">df22</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x.seq</span>,<span class="va">mu.mean.22</span><span class="op">)</span></span>
<span></span>
<span><span class="va">slope.plot.Xd</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">Y</span>,x<span class="op">=</span><span class="va">X.Xd</span>,color<span class="op">=</span><span class="va">Regimes</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima.sims</span>,slope<span class="op">=</span><span class="va">beta.sims</span>,alpha<span class="op">=</span><span class="fl">0.15</span><span class="op">)</span><span class="op">+</span> <span class="co">#Prior</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df11</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,y<span class="op">=</span><span class="va">mu.mean.11</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mu.CI.11</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,ymin<span class="op">=</span><span class="va">min.5.5</span>,ymax<span class="op">=</span><span class="va">max.94.5</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span>,alpha<span class="op">=</span><span class="fl">0.25</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df12</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,y<span class="op">=</span><span class="va">mu.mean.12</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mu.CI.12</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,ymin<span class="op">=</span><span class="va">min.5.5</span>,ymax<span class="op">=</span><span class="va">max.94.5</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span>,alpha<span class="op">=</span><span class="fl">0.25</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>  panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Direct effect trait"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">slope.plot.Xd</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-54-1.png" width="700"></p>
<div class="sourceCode" id="cb111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">slope.plot.Xa</span><span class="op">&lt;-</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">Y</span>,x<span class="op">=</span><span class="va">X.Xa</span>,color<span class="op">=</span><span class="va">Regimes</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">optima.sims</span>,slope<span class="op">=</span><span class="va">beta.sims</span>,alpha<span class="op">=</span><span class="fl">0.15</span><span class="op">)</span><span class="op">+</span> <span class="co">#Prior</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,slope<span class="op">=</span><span class="va">beta</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>,alpha<span class="op">=</span><span class="fl">0.5</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df21</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,y<span class="op">=</span><span class="va">mu.mean.21</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mu.CI.21</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,ymin<span class="op">=</span><span class="va">min.5.5</span>,ymax<span class="op">=</span><span class="va">max.94.5</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span>,alpha<span class="op">=</span><span class="fl">0.25</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df22</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,y<span class="op">=</span><span class="va">mu.mean.22</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mu.CI.22</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x.seq</span>,ymin<span class="op">=</span><span class="va">min.5.5</span>,ymax<span class="op">=</span><span class="va">max.94.5</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span>,alpha<span class="op">=</span><span class="fl">0.25</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>  panel.grid.major <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  panel.grid.minor <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Adaptive trait"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">slope.plot.Xa</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-54-2.png" width="700"></p>
<div class="sourceCode" id="cb112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Next we run the Multilevel version of the same model</span></span>
<span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Set Priors</span></span>
<span><span class="va">hl.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span>,<span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="va">vy.prior</span><span class="op">&lt;-</span><span class="fl">5</span></span>
<span><span class="va">optima.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>,<span class="fl">0.5</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span>
<span><span class="va">beta.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.25</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span>
<span><span class="va">sigma.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb113"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Make trdata file</span></span>
<span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span>,<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Y_with_error</span>,<span class="va">Y_error</span>,<span class="va">X_with_error</span>,<span class="va">X_error</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/blouch.reg.direct.adapt.mlm.prep.html">blouch.reg.direct.adapt.mlm.prep</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="st">"Y_with_error"</span>,<span class="st">"Y_error"</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Xd"</span>,<span class="st">"Xa"</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Xd_error"</span>,<span class="st">"Xa_error"</span><span class="op">)</span>,Z_direct<span class="op">=</span><span class="fl">1</span>,Z_adaptive<span class="op">=</span><span class="fl">1</span>,<span class="st">"regimes"</span>,<span class="va">hl.prior</span>,<span class="va">vy.prior</span>,<span class="va">optima.prior</span>,<span class="va">beta.prior</span>,<span class="va">sigma.prior</span><span class="op">)</span></span></code></pre></div>
<p>Next we run the Multilevel version of the same model</p>
<div class="sourceCode" id="cb115"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.direct.adapt.mlm.vi</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_direct_adapt_mlm_vi</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores<span class="op">=</span><span class="fl">2</span>,iter <span class="op">=</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span></code></pre></div>
<div class="sourceCode" id="cb116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.direct.adapt.mlm.vi</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span>,<span class="st">"beta_e"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_adapt_mlm_vi.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.22       0 0.05 0.13 0.18 0.21 0.25  0.33  1971    1</span></span>
<span><span class="co">#&gt; vy        0.01       0 0.00 0.00 0.01 0.01 0.01  0.02  2190    1</span></span>
<span><span class="co">#&gt; optima[1] 1.98       0 0.05 1.89 1.95 1.99 2.02  2.08  3294    1</span></span>
<span><span class="co">#&gt; optima[2] 0.94       0 0.09 0.74 0.88 0.95 1.01  1.11  2435    1</span></span>
<span><span class="co">#&gt; beta[1]   0.35       0 0.01 0.33 0.34 0.35 0.35  0.36  4130    1</span></span>
<span><span class="co">#&gt; beta[2]   0.33       0 0.05 0.24 0.30 0.33 0.36  0.44  2101    1</span></span>
<span><span class="co">#&gt; beta_e[1] 0.23       0 0.03 0.17 0.22 0.23 0.25  0.29  2702    1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Sat Oct 11 15:37:33 2025.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.direct.adapt.mlm.vi</span><span class="op">)</span></span></code></pre></div>
<p>Finally we run the non-centered version of that model</p>
<div class="sourceCode" id="cb117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.direct.adapt.mlm.vi.nc</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_direct_adapt_mlm_vi_nc</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">1</span>,cores<span class="op">=</span><span class="fl">1</span>,iter <span class="op">=</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: There were 12 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span></code></pre></div>
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.direct.adapt.mlm.vi.nc</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span>,<span class="st">"beta_e"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_adapt_mlm_vi_nc.</span></span>
<span><span class="co">#&gt; 1 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=1000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.22       0 0.05 0.13 0.18 0.21 0.25  0.34   893    1</span></span>
<span><span class="co">#&gt; vy        0.01       0 0.00 0.00 0.01 0.01 0.01  0.02   776    1</span></span>
<span><span class="co">#&gt; optima[1] 1.98       0 0.05 1.89 1.95 1.98 2.02  2.08   966    1</span></span>
<span><span class="co">#&gt; optima[2] 0.94       0 0.09 0.74 0.88 0.94 1.00  1.10   905    1</span></span>
<span><span class="co">#&gt; beta[1]   0.35       0 0.01 0.33 0.34 0.35 0.35  0.36  1532    1</span></span>
<span><span class="co">#&gt; beta[2]   0.33       0 0.05 0.24 0.30 0.33 0.36  0.43   787    1</span></span>
<span><span class="co">#&gt; beta_e[1] 0.23       0 0.03 0.17 0.21 0.23 0.25  0.28   892    1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Sat Oct 11 15:39:05 2025.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.direct.adapt.mlm.vi.nc</span><span class="op">)</span></span></code></pre></div>
<p>From there the posteriors should be explored, compared to the priors,
etc. See the Simulation Example for one example of how to do this.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Hansen T.F. 1997. Stabilizing Selection and the Comparative Analysis
of Adaptation. Evolution. 51:1341–1351.</p>
<p>Hansen T.F., Pienaar J., Orzack S.H. 2008. A comparative method for
studying adaptation to a randomly evolving environment. Evolution.
62:1965–1977.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Mark Grabowski.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
