<!DOCTYPE html>
<<<<<<< HEAD
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Mullti-Optima Models Walkthrough • blouch</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Mullti-Optima Models Walkthrough"></head><body>
=======
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Mullti-Optima Models Walkthrough • blouch</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Mullti-Optima Models Walkthrough">
</head>
<body>
>>>>>>> dev-fixes-blouch1.0
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">blouch</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
<<<<<<< HEAD
      <ul class="navbar-nav me-auto"><li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/Empirical-Example.html">Empirical Example from Grabowski (2024)</a></li>
=======
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Empirical-Example.html">Empirical Example from Grabowski (2024)</a></li>
>>>>>>> dev-fixes-blouch1.0
    <li><a class="dropdown-item" href="../articles/Simulation-Example.html">Simulation Example from Grabowski (2024)</a></li>
    <li><a class="dropdown-item" href="../articles/Basic_Models-Examples.html">Basic Models</a></li>
    <li><a class="dropdown-item" href="../articles/Multi-optima_Models-Examples.html">Multi-Optima Models</a></li>
    <li><a class="dropdown-item" href="../articles/Varying_Effects_Models-Examples.html">Varying Effects Models</a></li>
<<<<<<< HEAD
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mark-grabowski/blouch"><span class="fa fa-brands fa-github"></span> Github</a></li>
      </ul></div>


=======
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mark-grabowski/blouch"><span class="fa fa-brands fa-github"></span> Github</a></li>
      </ul>
</div>


>>>>>>> dev-fixes-blouch1.0
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Mullti-Optima Models Walkthrough</h1>
                        <h4 data-toc-skip class="author">Mark
Grabowski</h4>
            
<<<<<<< HEAD
            <h4 data-toc-skip class="date">2025-10-10</h4>
=======
            <h4 data-toc-skip class="date">2025-10-11</h4>
>>>>>>> dev-fixes-blouch1.0
      

      <div class="d-none name"><code>Multi-optima_Models-Examples.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">library</span>(blouch)</span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="do">########################################################################################################</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="co">#For execution on a local, multicore CPU with excess RAM we recommend calling</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="co">#options(mc.cores = parallel::detectCores())</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mc.cores =</span> <span class="dv">2</span>) <span class="co">#2 For R package checks - use line above on your own machine</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">rstan_options</span>(<span class="at">auto_write =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>dotR <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">Sys.getenv</span>(<span class="st">&quot;HOME&quot;</span>), <span class="st">&quot;.R&quot;</span>)</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(dotR)) <span class="fu">dir.create</span>(dotR)</span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>M <span class="ot">&lt;-</span> <span class="fu">file.path</span>(dotR, <span class="st">&quot;Makevars&quot;</span>)</span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(M)) <span class="fu">file.create</span>(M)</span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>arch <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(R.version<span class="sc">$</span>arch <span class="sc">==</span> <span class="st">&quot;aarch64&quot;</span>, <span class="st">&quot;arm64&quot;</span>, <span class="st">&quot;x86_64&quot;</span>)</span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">CXX14FLAGS += -O3 -mtune=native -arch&quot;</span>, arch, <span class="st">&quot;-ftemplate-depth-256&quot;</span>),</span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a>    <span class="at">file =</span> M, <span class="at">sep =</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="at">append =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<div id="multi-optima-model" class="section level2">
<h2>Multi-optima Model</h2>
<p>Next we will run a series of models that include categorical
variables - regimes painted on a phylogeny following Hansen (1997) and
Hansen et al. (2008). This article is an abbreviated versions of the
Simulation Example article - most of the steps of analysis will be the
same and are not repeated here. Note that the Stan runs are also too few
iterations and use only 1 chain and 1 core.</p>
<p>First we will set up the regime painting</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="do">########################################################################################################</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="co">#Create phylogeny</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="do">########################################################################################################</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>N<span class="ot">&lt;-</span><span class="dv">50</span> <span class="co">#Number of species</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">10</span>) <span class="co">#Set seed to get same random species each time</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>phy <span class="ot">&lt;-</span> ape<span class="sc">::</span><span class="fu">keep.tip</span>(tree<span class="fl">.10</span>K,<span class="fu">sample</span>(tree<span class="fl">.10</span>K<span class="sc">$</span>tip.label)[<span class="dv">1</span><span class="sc">:</span>N]) </span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>phy<span class="ot">&lt;-</span>ape<span class="sc">::</span><span class="fu">multi2di</span>(phy)</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>l.tree<span class="ot">&lt;-</span><span class="fu">max</span>(ape<span class="sc">::</span><span class="fu">branching.times</span>(phy)) <span class="do">## rescale tree to height 1</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>phy<span class="sc">$</span>edge.length<span class="ot">&lt;-</span>phy<span class="sc">$</span>edge.length<span class="sc">/</span>l.tree </span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>tip.label<span class="ot">&lt;-</span>phy<span class="sc">$</span>tip.label</span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a><span class="co">#Set regimes - manually - 2 regimes</span></span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a><span class="co">#Locate nodes</span></span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a><span class="fu">plot</span>(phy,<span class="at">no.margin=</span><span class="cn">TRUE</span>,<span class="at">edge.width=</span><span class="dv">2</span>,<span class="at">cex=</span><span class="fl">0.7</span>)</span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>ape<span class="sc">::</span><span class="fu">nodelabels</span>(<span class="at">frame=</span><span class="st">&quot;none&quot;</span>,<span class="at">adj=</span><span class="fu">c</span>(<span class="fl">1.1</span>,<span class="sc">-</span><span class="fl">0.4</span>))</span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a>ape<span class="sc">::</span><span class="fu">tiplabels</span>()</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_model_setup-1.png" width="700" /></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="co">#Paint Regimes on Tree</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="co">#source(&quot;/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/blouch/Simulation Code/Functions/set.converge.regimes.R&quot;) #Macbook Pro</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>shifts<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">84</span>) <span class="co">#Location of nodes with regime shifts</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>trdata<span class="ot">&lt;-</span><span class="fu">data.frame</span>(phy<span class="sc">$</span>tip.label)</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>trdata<span class="ot">&lt;-</span>treeplyr<span class="sc">::</span><span class="fu">make.treedata</span>(phy,trdata)</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>trdata<span class="ot">&lt;-</span><span class="fu">set.converge.regimes</span>(trdata,shifts)</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a><span class="co">#&gt; [1] 1</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a><span class="co">#&gt; Levels: OU1 OU2</span></span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a><span class="co">#&gt; [1] &quot;#E64B35FF&quot; &quot;#4DBBD5FF&quot;</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_model_setup-2.png" width="700" /></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="co">#Check if manual setting code worked</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>shifts.total<span class="ot">&lt;-</span><span class="fu">c</span>(trdata<span class="sc">$</span>dat<span class="sc">$</span>regimes,trdata<span class="sc">$</span>phy<span class="sc">$</span>node.label)</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>edge.regimes <span class="ot">&lt;-</span> <span class="fu">factor</span>(shifts.total[trdata<span class="sc">$</span>phy<span class="sc">$</span>edge[,<span class="dv">2</span>]])</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="fu">print</span>(edge.regimes)</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a><span class="co">#&gt; Levels: OU1 OU2</span></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>reg.colors <span class="ot">&lt;-</span> ggsci<span class="sc">::</span><span class="fu">pal_aaas</span>(<span class="st">&quot;default&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>)(<span class="dv">2</span>)</span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a><span class="fu">print</span>(reg.colors)</span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a><span class="co">#&gt; [1] &quot;#3B4992B2&quot; &quot;#EE0000B2&quot;</span></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a><span class="fu">plot</span>(trdata<span class="sc">$</span>phy,<span class="at">edge.color =</span> reg.colors[edge.regimes], <span class="at">edge.width =</span> <span class="dv">1</span>, <span class="at">cex =</span> <span class="fl">0.2</span>)</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_model_setup-3.png" width="700" /></p>
<p>Format tree</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="do">############################################################################################################</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="co">#Simulate data</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>n<span class="ot">&lt;-</span><span class="fu">length</span>(trdata<span class="sc">$</span>phy<span class="sc">$</span>tip.label)</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>regimes_internal <span class="ot">&lt;-</span>trdata<span class="sc">$</span>phy<span class="sc">$</span>node.label</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>regimes_tip <span class="ot">&lt;-</span> trdata<span class="sc">$</span>dat<span class="sc">$</span>regimes</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>regimes <span class="ot">&lt;-</span> <span class="fu">concat.factor</span>(regimes_tip, regimes_internal)</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>anc_maps<span class="ot">&lt;-</span><span class="st">&quot;regimes&quot;</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>lineages <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="cf">function</span>(e) <span class="fu">lineage.constructor</span>(trdata<span class="sc">$</span>phy, e, anc_maps, regimes)) <span class="co">#Trace lineage from tips (n) to root and determine regimes of each node or branch</span></span></code></pre></div>
<p>Now we will simulate Y data based on our generative model</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="do">############################################################################################################</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="co">#Set true values for parameters</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>hl<span class="ot">&lt;-</span><span class="fl">0.1</span> <span class="co">#0.1, 0.25, 0.75 - testing options</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>a<span class="ot">&lt;-</span><span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">/</span>hl</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>vy<span class="ot">&lt;-</span><span class="fl">0.01</span> <span class="co">#0.25,0.5 - testing options</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>sigma2_y<span class="ot">&lt;-</span>vy<span class="sc">*</span>(<span class="dv">2</span><span class="sc">*</span>(<span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">/</span>hl));</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>optima<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fl">0.5</span>,<span class="fl">0.25</span>) <span class="co">#Optima for two regimes</span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>dmX<span class="ot">&lt;-</span><span class="fu">weight.matrix</span>(trdata<span class="sc">$</span>phy, a, lineages) <span class="co">#Slouch approach</span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>mu<span class="ot">&lt;-</span>dmX<span class="sc">%*%</span>optima <span class="co">#Simulate mu for Y</span></span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>V<span class="ot">&lt;-</span><span class="fu">calc_direct_V</span>(phy, sigma2_y, a)</span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>Y<span class="ot">&lt;-</span>MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(<span class="at">n=</span><span class="dv">1</span>,mu,V)</span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a><span class="do">########################################################################################################</span></span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a><span class="co">#Simulate errors</span></span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a>Y_error<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="fl">0.01</span>,N)</span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a>Y_with_error<span class="ot">&lt;-</span>Y<span class="sc">+</span><span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fl">0.01</span>)</span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a>phytools<span class="sc">::</span><span class="fu">phenogram</span>(phy,Y_with_error,<span class="at">spread.labels=</span><span class="cn">TRUE</span>,<span class="at">spread.cost=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>)) <span class="co">#Plot X data</span></span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a><span class="co">#&gt; Optimizing the positions of the tip labels...</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Simulate_Y_data-1.png" width="700" /></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="do">############################################################################################################</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="co">#Make trdata file</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>trait.data<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">cbind</span>(Y_with_error,Y_error))</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>trdata<span class="sc">$</span>dat<span class="ot">&lt;-</span><span class="fu">cbind</span>(trdata<span class="sc">$</span>dat,<span class="fu">data.frame</span>(<span class="fu">cbind</span>(Y_with_error,Y_error)))</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a><span class="do">############################################################################################################</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="do">############################################################################################################</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="co">#Set Priors</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>hl.prior<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fu">log</span>(<span class="fl">0.25</span>),<span class="fl">0.75</span>)</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>vy.prior<span class="ot">&lt;-</span><span class="dv">20</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>optima.prior<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="co">#Informed by linear model</span></span></code></pre></div>
</div>
<div id="exploring-priors" class="section level2">
<h2>Exploring Priors</h2>
<p>At this point one would want to explore if the priors are appropriate
- do the prior distributions look consistent with what we know about our
system? See Grabowski (in press) for more on setting priors.</p>
<p>Half-life Prior plot</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>hl.sims<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">rlnorm</span>(<span class="at">n=</span><span class="dv">1000</span>,<span class="at">meanlog=</span>hl.prior[<span class="dv">1</span>],<span class="at">sdlog=</span>hl.prior[<span class="dv">2</span>]))</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="fu">names</span>(hl.sims)<span class="ot">&lt;-</span><span class="st">&quot;prior.hl.sims&quot;</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>hl.prior.plot<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(prior.hl.sims,<span class="at">fill=</span><span class="st">&quot;prior.hl.sims&quot;</span>),<span class="at">alpha=</span><span class="fl">0.2</span>,<span class="at">data=</span>hl.sims)<span class="sc">+</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(),</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>  </span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>  <span class="co">#labs(title=&quot;Prior vs. Posterior Distribution &quot;,x=&quot;Half-life&quot;, y = &quot;Density&quot;)+</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title=</span><span class="st">&quot;&quot;</span>,<span class="at">x=</span><span class="st">&quot;Half-life&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Density&quot;</span>)<span class="sc">+</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>  </span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>  <span class="co">#scale_fill_manual(labels=c(&quot;Posterior&quot;,&quot;Prior&quot;))+</span></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept=</span><span class="fu">c</span>(hl),<span class="at">linetype=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>  ggsci<span class="sc">::</span><span class="fu">scale_fill_npg</span>(<span class="at">name=</span><span class="st">&quot;&quot;</span>,<span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;Prior&quot;</span>))</span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>hl.prior.plot</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-5-1.png" width="700" /></p>
<p>Vy Prior Plot</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>vy.sims<span class="ot">&lt;-</span><span class="fu">rexp</span>(<span class="at">n=</span><span class="dv">1000</span>,<span class="at">rate=</span>vy.prior)</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>vy.sims<span class="ot">&lt;-</span><span class="fu">data.frame</span>(vy.sims)</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="fu">names</span>(vy.sims)<span class="ot">&lt;-</span><span class="st">&quot;prior.vy.sims&quot;</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>vy.prior.plot<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(prior.vy.sims,<span class="at">fill=</span><span class="st">&quot;prior.vy.sims&quot;</span>),<span class="at">alpha=</span><span class="fl">0.2</span>,<span class="at">data=</span>vy.sims)<span class="sc">+</span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(),</span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>  </span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>  <span class="co">#labs(title=&quot;Prior vs. Posterior Distribution &quot;,x=&quot;vy&quot;, y = &quot;Density&quot;)+</span></span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title=</span><span class="st">&quot;&quot;</span>,<span class="at">x=</span><span class="st">&quot;vy&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Density&quot;</span>)<span class="sc">+</span></span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept=</span><span class="fu">c</span>(vy),<span class="at">linetype=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a>  </span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a>  <span class="co">#scale_fill_manual(labels=c(&quot;Posterior&quot;,&quot;Prior&quot;))+</span></span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a>  ggsci<span class="sc">::</span><span class="fu">scale_fill_npg</span>(<span class="at">name=</span><span class="st">&quot;&quot;</span>,<span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;Prior&quot;</span>))</span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" tabindex="-1"></a>vy.prior.plot</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-6-1.png" width="700" /></p>
<p>Prior on how shared branch lengths correspond to covariance</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>a.sims<span class="ot">&lt;-</span><span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">/</span>hl.sims;</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>sigma2_y.sims<span class="ot">&lt;-</span>vy.sims<span class="sc">*</span>(<span class="dv">2</span><span class="sc">*</span>(<span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">/</span>hl.sims));</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="co">#x&lt;-seq(from=0,to=1,by=0.001)</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="co">#V.sim&lt;-calc_direct_V(phy,a.sims,sigma2_y.sims)</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="fu">plot</span>( <span class="cn">NULL</span> , <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>) , <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.3</span>) , <span class="at">xlab=</span><span class="st">&quot;Time since MRCA&quot;</span> , <span class="at">ylab=</span><span class="st">&quot;Covariance&quot;</span> ,<span class="at">cex.axis=</span><span class="fl">0.75</span>, <span class="at">mgp=</span><span class="fu">c</span>(<span class="fl">1.25</span>,<span class="fl">0.25</span>,<span class="dv">0</span>),<span class="at">tcl=</span><span class="sc">-</span><span class="fl">0.25</span>)</span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>){</span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>  <span class="fu">curve</span>(sigma2_y.sims[i,] <span class="sc">/</span>(<span class="dv">2</span> <span class="sc">*</span> a.sims[i,]) <span class="sc">*</span> ((<span class="dv">1</span> <span class="sc">-</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> a.sims[i,] <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>(x<span class="sc">/</span><span class="dv">2</span>)))) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>a.sims[i,] <span class="sc">*</span> x)) , <span class="at">add=</span><span class="cn">TRUE</span> , <span class="at">lwd=</span><span class="dv">4</span> , <span class="at">col=</span>rethinking<span class="sc">::</span><span class="fu">col.alpha</span>(<span class="dv">1</span>,<span class="fl">0.15</span>))</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-7-1.png" width="700" /></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="fl">0.25</span>,<span class="fl">0.25</span>))</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>covariance.prior.plot <span class="ot">&lt;-</span> <span class="fu">recordPlot</span>()</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a><span class="co">#&gt; null device </span></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a><span class="co">#&gt;           1</span></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>covariance.prior.plot</span></code></pre></div>
<p>Prior Plot</p>
<<<<<<< HEAD
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="fu">library</span>(ggsci)</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="co">#Direct Model</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="co">#intercept_test&lt;-rnorm(100,stan_sim_data$ols_intercept,0.2)</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="co">#slope_test&lt;-rnorm(100,stan_sim_data$ols_slope,0.1)</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>optima.sims<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="dv">100</span>,optima.prior[<span class="dv">1</span>],optima.prior[<span class="dv">2</span>])</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>optima.sims<span class="ot">&lt;-</span><span class="fu">data.frame</span>(optima.sims,<span class="at">Prior=</span><span class="st">&quot;Prior&quot;</span>)</span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>df<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">Y=</span>Y,<span class="at">regimes=</span>regimes_tip)</span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a><span class="fu">names</span>(df)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">&quot;Y&quot;</span>,<span class="st">&quot;Regimes&quot;</span>)</span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>optima.plot<span class="ot">&lt;-</span></span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">data=</span>df, <span class="at">Mapping =</span> ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x =</span> Y, <span class="at">y =</span> Regimes))<span class="sc">+</span></span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a>  </span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>(<span class="at">data=</span>optima.sims,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y=</span>optima.sims,<span class="at">x=</span>Prior),<span class="at">alpha=</span><span class="fl">0.25</span>,<span class="at">width=</span><span class="fl">0.15</span>)<span class="sc">+</span></span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>(<span class="at">data=</span>df,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y=</span>Y,<span class="at">x=</span>Regimes),<span class="at">width=</span><span class="fl">0.15</span>)<span class="sc">+</span></span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ylab</span>(<span class="st">&quot;Optima&quot;</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">xlab</span>(<span class="st">&quot;&quot;</span>)<span class="sc">+</span></span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a>  ggsci<span class="sc">::</span><span class="fu">scale_color_npg</span>()</span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a></span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a>optima.plot</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-8-1.png" width="700" /></p>
=======
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://nanx.me/ggsci/" class="external-link">ggsci</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Direct Model</span></span>
<span><span class="co">#intercept_test&lt;-rnorm(100,stan_sim_data$ols_intercept,0.2)</span></span>
<span><span class="co">#slope_test&lt;-rnorm(100,stan_sim_data$ols_slope,0.1)</span></span>
<span></span>
<span><span class="va">optima.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">optima.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">optima.sims</span>,Prior<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">Y</span>,regimes<span class="op">=</span><span class="va">regimes_tip</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Y"</span>,<span class="st">"Regimes"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">optima.plot</span><span class="op">&lt;-</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>, Mapping <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Y</span>, y <span class="op">=</span> <span class="va">Regimes</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html" class="external-link">geom_jitter</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">optima.sims</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">optima.sims</span>,x<span class="op">=</span><span class="va">Prior</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.25</span>,width<span class="op">=</span><span class="fl">0.15</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html" class="external-link">geom_jitter</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">Y</span>,x<span class="op">=</span><span class="va">Regimes</span><span class="op">)</span>,width<span class="op">=</span><span class="fl">0.15</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Optima"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in fortify(data, ...): Arguments in `...` must be used.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> Problematic argument:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> Mapping = ggplot2::aes(x = Y, y = Regimes)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Did you misspell an argument name?</span></span>
<span></span>
<span><span class="va">optima.plot</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
>>>>>>> dev-fixes-blouch1.0
<p>We will use the helper function blouch.reg.prep() to setup the dat
file for Stan. Here “regimes” is the name of the regime column in
trdata$dat.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>dat<span class="ot">&lt;-</span><span class="fu">blouch.reg.prep</span>(trdata,<span class="st">&quot;Y_with_error&quot;</span>,<span class="st">&quot;Y_error&quot;</span>,<span class="st">&quot;regimes&quot;</span>,hl.prior,vy.prior,optima.prior)</span></code></pre></div>
<p>Here we run the basic Multi-optima Model, look at the results, and
rstan::extract the posterior</p>
<<<<<<< HEAD
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>fit.reg<span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">sampling</span>(<span class="at">object =</span> blouch<span class="sc">:::</span>stanmodels<span class="sc">$</span>blouchOU_reg,<span class="at">data =</span> dat,<span class="at">chains =</span> <span class="dv">2</span>,<span class="at">iter =</span><span class="dv">2000</span>,<span class="at">cores=</span><span class="dv">2</span>)</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="co">#&gt; Found more than one class &quot;stanfit&quot; in cache; using the first, from namespace &#39;rstan&#39;</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="co">#&gt; Also defined by &#39;rethinking&#39;</span></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="co">#&gt; Found more than one class &quot;stanfit&quot; in cache; using the first, from namespace &#39;rstan&#39;</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="co">#&gt; Also defined by &#39;rethinking&#39;</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="fu">print</span>(fit.reg,<span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;hl&quot;</span>,<span class="st">&quot;vy&quot;</span>,<span class="st">&quot;optima&quot;</span>))</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="co">#&gt; Inference for Stan model: blouchOU_reg.</span></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a><span class="co">#&gt;           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a><span class="co">#&gt; hl        0.10    0.01 0.06 0.03 0.06 0.09 0.11  0.23   144 1.01</span></span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a><span class="co">#&gt; vy        0.02    0.00 0.01 0.01 0.02 0.02 0.02  0.04   163 1.01</span></span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a><span class="co">#&gt; optima[1] 0.48    0.00 0.03 0.41 0.46 0.48 0.50  0.54  1316 1.00</span></span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a><span class="co">#&gt; optima[2] 0.26    0.00 0.07 0.14 0.23 0.27 0.31  0.37   263 1.01</span></span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Fri Oct 10 16:18:19 2025.</span></span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span id="cb18-15"><a href="#cb18-15" tabindex="-1"></a><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span id="cb18-16"><a href="#cb18-16" tabindex="-1"></a>post<span class="ot">&lt;-</span>rstan<span class="sc">::</span><span class="fu">extract</span>(fit.reg) <span class="co">#rstan::extract posterior</span></span></code></pre></div>
=======
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,iter <span class="op">=</span><span class="fl">2000</span>,cores<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.10    0.01 0.06 0.03 0.06 0.09 0.11  0.23   144 1.01</span></span>
<span><span class="co">#&gt; vy        0.02    0.00 0.01 0.01 0.02 0.02 0.02  0.04   163 1.01</span></span>
<span><span class="co">#&gt; optima[1] 0.48    0.00 0.03 0.41 0.46 0.48 0.50  0.54  1316 1.00</span></span>
<span><span class="co">#&gt; optima[2] 0.26    0.00 0.07 0.14 0.23 0.27 0.31  0.37   263 1.01</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Sat Oct 11 15:29:57 2025.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg</span><span class="op">)</span> <span class="co">#rstan::extract posterior</span></span></code></pre></div>
>>>>>>> dev-fixes-blouch1.0
<p>Now lets look at the prior vs. posterior plots for the parameters
Half-life plot</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>hl.post<span class="ot">&lt;-</span><span class="fu">data.frame</span>(post<span class="sc">$</span>hl)</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a><span class="fu">names</span>(hl.post)<span class="ot">&lt;-</span><span class="st">&quot;post.hl.sims&quot;</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>hl.plot<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(prior.hl.sims,<span class="at">fill=</span><span class="st">&quot;prior.hl.sims&quot;</span>),<span class="at">alpha=</span><span class="fl">0.2</span>,<span class="at">data=</span>hl.sims)<span class="sc">+</span></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(post.hl.sims,<span class="at">fill=</span><span class="st">&quot;post.hl.sims&quot;</span>),<span class="at">alpha=</span><span class="fl">0.2</span>,<span class="at">data=</span>hl.post)<span class="sc">+</span></span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(),</span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a>  </span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a>  <span class="co">#labs(title=&quot;Prior vs. Posterior Distribution &quot;,x=&quot;Half-life&quot;, y = &quot;Density&quot;)+</span></span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title=</span><span class="st">&quot;&quot;</span>,<span class="at">x=</span><span class="st">&quot;Half-life&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Density&quot;</span>)<span class="sc">+</span></span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a>  </span>
<span id="cb19-15"><a href="#cb19-15" tabindex="-1"></a>  <span class="co">#scale_fill_manual(labels=c(&quot;Posterior&quot;,&quot;Prior&quot;))+</span></span>
<span id="cb19-16"><a href="#cb19-16" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept=</span><span class="fu">c</span>(hl),<span class="at">linetype=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb19-17"><a href="#cb19-17" tabindex="-1"></a>  ggsci<span class="sc">::</span><span class="fu">scale_fill_npg</span>(<span class="at">name=</span><span class="st">&quot;&quot;</span>,<span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;Posterior&quot;</span>,<span class="st">&quot;Prior&quot;</span>))</span>
<span id="cb19-18"><a href="#cb19-18" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" tabindex="-1"></a>hl.plot</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-10-1.png" width="700" /></p>
<p>Vy Prior vs. posterior plot</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>vy.post<span class="ot">&lt;-</span><span class="fu">data.frame</span>(post<span class="sc">$</span>vy)</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="fu">names</span>(vy.post)<span class="ot">&lt;-</span><span class="st">&quot;post.vy.sims&quot;</span></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>vy.plot<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(prior.vy.sims,<span class="at">fill=</span><span class="st">&quot;prior.vy.sims&quot;</span>),<span class="at">alpha=</span><span class="fl">0.2</span>,<span class="at">data=</span>vy.sims)<span class="sc">+</span></span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(post.vy.sims,<span class="at">fill=</span><span class="st">&quot;post.vy.sims&quot;</span>),<span class="at">alpha=</span><span class="fl">0.2</span>,<span class="at">data=</span>vy.post)<span class="sc">+</span></span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(),</span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a>  </span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a>  <span class="co">#labs(title=&quot;Prior vs. Posterior Distribution &quot;,x=&quot;vy&quot;, y = &quot;Density&quot;)+</span></span>
<span id="cb20-14"><a href="#cb20-14" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title=</span><span class="st">&quot;&quot;</span>,<span class="at">x=</span><span class="st">&quot;vy&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Density&quot;</span>)<span class="sc">+</span></span>
<span id="cb20-15"><a href="#cb20-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept=</span><span class="fu">c</span>(vy),<span class="at">linetype=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb20-16"><a href="#cb20-16" tabindex="-1"></a>  </span>
<span id="cb20-17"><a href="#cb20-17" tabindex="-1"></a>  <span class="co">#scale_fill_manual(labels=c(&quot;Posterior&quot;,&quot;Prior&quot;))+</span></span>
<span id="cb20-18"><a href="#cb20-18" tabindex="-1"></a>  ggsci<span class="sc">::</span><span class="fu">scale_fill_npg</span>(<span class="at">name=</span><span class="st">&quot;&quot;</span>,<span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;Posterior&quot;</span>,<span class="st">&quot;Prior&quot;</span>))</span>
<span id="cb20-19"><a href="#cb20-19" tabindex="-1"></a></span>
<span id="cb20-20"><a href="#cb20-20" tabindex="-1"></a>vy.plot</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-11-1.png" width="700" /></p>
<p>Prior versus posterior on how shared branch lengths correspond to
covariance</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="fu">plot</span>( <span class="cn">NULL</span> , <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>) , <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.3</span>) , <span class="at">xlab=</span><span class="st">&quot;Time since MRCA&quot;</span> , <span class="at">ylab=</span><span class="st">&quot;Covariance&quot;</span> ,<span class="at">cex.axis=</span><span class="fl">0.75</span>, <span class="at">mgp=</span><span class="fu">c</span>(<span class="fl">1.25</span>,<span class="fl">0.25</span>,<span class="dv">0</span>),<span class="at">tcl=</span><span class="sc">-</span><span class="fl">0.25</span>)</span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>){</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>  <span class="fu">curve</span>(sigma2_y.sims[i,] <span class="sc">/</span>(<span class="dv">2</span> <span class="sc">*</span> a.sims[i,]) <span class="sc">*</span> ((<span class="dv">1</span> <span class="sc">-</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> a.sims[i,] <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>(x<span class="sc">/</span><span class="dv">2</span>)))) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>a.sims[i,] <span class="sc">*</span> x)) , <span class="at">add=</span><span class="cn">TRUE</span> , <span class="at">lwd=</span><span class="dv">4</span> , <span class="at">col=</span>rethinking<span class="sc">::</span><span class="fu">col.alpha</span>(<span class="dv">1</span>,<span class="fl">0.15</span>))</span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a>}</span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>){</span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a>  <span class="fu">curve</span>(post<span class="sc">$</span>sigma2_y[i] <span class="sc">/</span>(<span class="dv">2</span> <span class="sc">*</span> post<span class="sc">$</span>a[i]) <span class="sc">*</span> ((<span class="dv">1</span> <span class="sc">-</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> post<span class="sc">$</span>a[i] <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>(x<span class="sc">/</span><span class="dv">2</span>)))) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>post<span class="sc">$</span>a[i] <span class="sc">*</span> x)) , <span class="at">add=</span><span class="cn">TRUE</span> , <span class="at">lwd=</span><span class="dv">4</span> , <span class="at">col=</span>rethinking<span class="sc">::</span><span class="fu">col.alpha</span>(<span class="dv">2</span>,<span class="fl">0.5</span>))</span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-12-1.png" width="700" /></p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="fl">0.25</span>,<span class="fl">0.25</span>))</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a><span class="co">#covariance.plot &lt;- recordPlot()</span></span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a><span class="co">#dev.off()</span></span></code></pre></div>
<p>Prior vs. Posterior Plot</p>
<<<<<<< HEAD
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="fu">library</span>(ggsci)</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>optima.sims<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="dv">100</span>,optima.prior[<span class="dv">1</span>],optima.prior[<span class="dv">2</span>])</span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a>optima.sims<span class="ot">&lt;-</span><span class="fu">data.frame</span>(optima.sims,<span class="at">Prior=</span><span class="st">&quot;Prior&quot;</span>)</span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>optima.post<span class="ot">&lt;-</span><span class="fu">data.frame</span>(post<span class="sc">$</span>optima)</span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a><span class="fu">names</span>(optima.post)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">&quot;OU&quot;</span>,<span class="dv">1</span><span class="sc">:</span><span class="fu">dim</span>(optima.post)[<span class="dv">2</span>],<span class="at">sep=</span><span class="st">&quot;&quot;</span>))</span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a>mu.mean <span class="ot">&lt;-</span><span class="fu">apply</span>( optima.post, <span class="dv">2</span>, mean )</span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a>mu.mean<span class="ot">&lt;-</span><span class="fu">data.frame</span>(mu.mean)</span>
<span id="cb23-10"><a href="#cb23-10" tabindex="-1"></a>mu.mean<span class="ot">&lt;-</span><span class="fu">data.frame</span>(mu.mean,<span class="st">&quot;Regimes&quot;</span><span class="ot">=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">dim</span>(mu.mean)[<span class="dv">1</span>])</span>
<span id="cb23-11"><a href="#cb23-11" tabindex="-1"></a>mu.mean<span class="ot">&lt;-</span><span class="fu">data.frame</span>(mu.mean,optima)</span>
<span id="cb23-12"><a href="#cb23-12" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" tabindex="-1"></a>mu.CI <span class="ot">&lt;-</span> <span class="fu">apply</span>( optima.post , <span class="dv">2</span>, rethinking<span class="sc">::</span>PI , <span class="at">prob=</span><span class="fl">0.89</span> )</span>
<span id="cb23-14"><a href="#cb23-14" tabindex="-1"></a>mu.CI<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">t</span>(<span class="fu">data.frame</span>(mu.CI)),<span class="st">&quot;Regimes&quot;</span><span class="ot">=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">dim</span>(mu.CI)[<span class="dv">2</span>])</span>
<span id="cb23-15"><a href="#cb23-15" tabindex="-1"></a><span class="fu">names</span>(mu.CI)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">&quot;min.5.5&quot;</span>,<span class="st">&quot;max.94.5&quot;</span>,<span class="st">&quot;Regimes&quot;</span>)</span>
<span id="cb23-16"><a href="#cb23-16" tabindex="-1"></a></span>
<span id="cb23-17"><a href="#cb23-17" tabindex="-1"></a>df<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">Y=</span>Y,<span class="at">regimes=</span>regimes_tip)</span>
<span id="cb23-18"><a href="#cb23-18" tabindex="-1"></a><span class="fu">names</span>(df)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">&quot;Y&quot;</span>,<span class="st">&quot;Regimes&quot;</span>)</span>
<span id="cb23-19"><a href="#cb23-19" tabindex="-1"></a></span>
<span id="cb23-20"><a href="#cb23-20" tabindex="-1"></a></span>
<span id="cb23-21"><a href="#cb23-21" tabindex="-1"></a></span>
<span id="cb23-22"><a href="#cb23-22" tabindex="-1"></a>optima.plot<span class="ot">&lt;-</span></span>
<span id="cb23-23"><a href="#cb23-23" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">data=</span>df, <span class="at">Mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> Y, <span class="at">y =</span> Regimes))<span class="sc">+</span></span>
<span id="cb23-24"><a href="#cb23-24" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>(<span class="at">data=</span>optima.sims,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y=</span>optima.sims,<span class="at">x=</span>Prior),<span class="at">alpha=</span><span class="fl">0.25</span>,<span class="at">width=</span><span class="fl">0.15</span>)<span class="sc">+</span></span>
<span id="cb23-25"><a href="#cb23-25" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_segment</span>(<span class="at">data=</span>mu.mean,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>Regimes<span class="fl">-0.5</span>,<span class="at">xend=</span>Regimes<span class="fl">+0.5</span>,<span class="at">y=</span>mu.mean,<span class="at">yend=</span>mu.mean),<span class="at">linetype=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb23-26"><a href="#cb23-26" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_segment</span>(<span class="at">data=</span>mu.mean,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>Regimes<span class="fl">-0.5</span>,<span class="at">xend=</span>Regimes<span class="fl">+0.5</span>,<span class="at">y=</span>optima,<span class="at">yend=</span>optima),<span class="at">linetype=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb23-27"><a href="#cb23-27" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_linerange</span>(<span class="at">data=</span>mu.CI, <span class="at">mapping=</span>ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>Regimes,<span class="at">ymin=</span>min.<span class="fl">5.5</span>,<span class="at">ymax=</span>max.<span class="fl">94.5</span>),<span class="at">size=</span><span class="dv">35</span>,<span class="at">color=</span><span class="st">&quot;darkgrey&quot;</span>,<span class="at">alpha=</span><span class="fl">0.5</span>)<span class="sc">+</span></span>
<span id="cb23-28"><a href="#cb23-28" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_jitter</span>(<span class="at">data=</span>df,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y=</span>Y,<span class="at">x=</span>Regimes),<span class="at">width=</span><span class="fl">0.15</span>)<span class="sc">+</span></span>
<span id="cb23-29"><a href="#cb23-29" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb23-30"><a href="#cb23-30" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ylab</span>(<span class="st">&quot;Optima&quot;</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">xlab</span>(<span class="st">&quot;&quot;</span>)<span class="sc">+</span></span>
<span id="cb23-31"><a href="#cb23-31" tabindex="-1"></a>  ggsci<span class="sc">::</span><span class="fu">scale_color_npg</span>()</span>
<span id="cb23-32"><a href="#cb23-32" tabindex="-1"></a><span class="co">#&gt; Warning: [1m[22mUsing `size` aesthetic for lines was deprecated in ggplot2 3.4.0.</span></span>
<span id="cb23-33"><a href="#cb23-33" tabindex="-1"></a><span class="co">#&gt; [36mℹ[39m Please use `linewidth` instead.</span></span>
<span id="cb23-34"><a href="#cb23-34" tabindex="-1"></a><span class="co">#&gt; [90mThis warning is displayed once every 8 hours.[39m</span></span>
<span id="cb23-35"><a href="#cb23-35" tabindex="-1"></a><span class="co">#&gt; [90mCall `lifecycle::last_lifecycle_warnings()` to see where this warning was[39m</span></span>
<span id="cb23-36"><a href="#cb23-36" tabindex="-1"></a><span class="co">#&gt; [90mgenerated.[39m</span></span>
<span id="cb23-37"><a href="#cb23-37" tabindex="-1"></a></span>
<span id="cb23-38"><a href="#cb23-38" tabindex="-1"></a>optima.plot</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-13-1.png" width="700" /></p>
<p>Next is the code for the Multilevel Multi-optima Model - here we
include the additional prior sigma, which is a parameter for the
variance among regimes</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="do">############################################################################################################</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a><span class="co">#Set Priors</span></span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>hl.prior<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fu">log</span>(<span class="fl">0.25</span>),<span class="fl">0.75</span>)</span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a>vy.prior<span class="ot">&lt;-</span><span class="dv">20</span></span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a>optima.prior<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="co">#Informed by linear model</span></span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a>sigma.prior<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="do">############################################################################################################</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a><span class="co">#Blouch Prep Code</span></span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a>dat<span class="ot">&lt;-</span><span class="fu">blouch.reg.mlm.prep</span>(trdata,<span class="st">&quot;Y_with_error&quot;</span>,<span class="st">&quot;Y_error&quot;</span>,<span class="st">&quot;regimes&quot;</span>,hl.prior,vy.prior,optima.prior,sigma.prior)</span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>fit.mlm.vi.regimes<span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">sampling</span>(<span class="at">object =</span> blouch<span class="sc">:::</span>stanmodels<span class="sc">$</span>blouchOU_reg_mlm_vi,<span class="at">data =</span> dat,<span class="at">chains =</span> <span class="dv">2</span>,<span class="at">iter=</span> <span class="dv">2000</span>,<span class="at">cores=</span><span class="dv">2</span>)</span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a><span class="co">#&gt; Found more than one class &quot;stanfit&quot; in cache; using the first, from namespace &#39;rstan&#39;</span></span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a><span class="co">#&gt; Also defined by &#39;rethinking&#39;</span></span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a><span class="co">#&gt; Found more than one class &quot;stanfit&quot; in cache; using the first, from namespace &#39;rstan&#39;</span></span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a><span class="co">#&gt; Also defined by &#39;rethinking&#39;</span></span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a><span class="co">#&gt; Warning: There were 50 divergent transitions after warmup. See</span></span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span id="cb26-9"><a href="#cb26-9" tabindex="-1"></a><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span>
<span id="cb26-10"><a href="#cb26-10" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" tabindex="-1"></a><span class="fu">print</span>(fit.mlm.vi.regimes,<span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;hl&quot;</span>,<span class="st">&quot;vy&quot;</span>,<span class="st">&quot;optima&quot;</span>,<span class="st">&quot;optima_bar&quot;</span>,<span class="st">&quot;sigma&quot;</span>))</span>
<span id="cb26-12"><a href="#cb26-12" tabindex="-1"></a>post<span class="ot">&lt;-</span>rstan<span class="sc">::</span><span class="fu">extract</span>(fit.mlm.vi.regimes)</span></code></pre></div>
<p>Finally we will run the non-centered version of the same model, which
can be used when the posterior is hard to explore and the centered
version of the model produces divergences.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a>fit.mlm.vi.regimes.nc<span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">sampling</span>(<span class="at">object =</span> blouch<span class="sc">:::</span>stanmodels<span class="sc">$</span>blouchOU_reg_mlm_vi_nc,<span class="at">data =</span> dat,<span class="at">chains =</span> <span class="dv">2</span>,<span class="at">iter =</span><span class="dv">2000</span>,<span class="at">cores=</span><span class="dv">2</span>) <span class="co">#,control=list(adapt_delta=0.95))</span></span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a><span class="co">#&gt; Found more than one class &quot;stanfit&quot; in cache; using the first, from namespace &#39;rstan&#39;</span></span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a><span class="co">#&gt; Also defined by &#39;rethinking&#39;</span></span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a><span class="co">#&gt; Found more than one class &quot;stanfit&quot; in cache; using the first, from namespace &#39;rstan&#39;</span></span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a><span class="co">#&gt; Also defined by &#39;rethinking&#39;</span></span>
<span id="cb27-6"><a href="#cb27-6" tabindex="-1"></a><span class="co">#&gt; Warning: There were 68 divergent transitions after warmup. See</span></span>
<span id="cb27-7"><a href="#cb27-7" tabindex="-1"></a><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span id="cb27-8"><a href="#cb27-8" tabindex="-1"></a><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span id="cb27-9"><a href="#cb27-9" tabindex="-1"></a><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span>
<span id="cb27-10"><a href="#cb27-10" tabindex="-1"></a><span class="co">#&gt; Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.</span></span>
<span id="cb27-11"><a href="#cb27-11" tabindex="-1"></a><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span id="cb27-12"><a href="#cb27-12" tabindex="-1"></a><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#tail-ess</span></span>
<span id="cb27-13"><a href="#cb27-13" tabindex="-1"></a><span class="fu">print</span>(fit.mlm.vi.regimes.nc,<span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;hl&quot;</span>,<span class="st">&quot;vy&quot;</span>,<span class="st">&quot;optima&quot;</span>,<span class="st">&quot;optima_bar&quot;</span>,<span class="st">&quot;sigma&quot;</span>))</span>
<span id="cb27-14"><a href="#cb27-14" tabindex="-1"></a><span class="do">###plot(rethinking::precis(fit.mlm.vi.regimes.nc,depth=2,pars = c(&quot;hl&quot;,&quot;vy&quot;,&quot;optima&quot;,&quot;optima_bar&quot;,&quot;sigma&quot;)))</span></span>
<span id="cb27-15"><a href="#cb27-15" tabindex="-1"></a>post<span class="ot">&lt;-</span>rstan<span class="sc">::</span><span class="fu">extract</span>(fit.mlm.vi.regimes.nc)</span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span></code></pre></div>
=======
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://nanx.me/ggsci/" class="external-link">ggsci</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">optima.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,<span class="va">optima.prior</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">optima.sims</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">optima.sims</span>,Prior<span class="op">=</span><span class="st">"Prior"</span><span class="op">)</span></span>
<span><span class="va">optima.post</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">post</span><span class="op">$</span><span class="va">optima</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">optima.post</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"OU"</span>,<span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">optima.post</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,sep<span class="op">=</span><span class="st">""</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mu.mean</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span> <span class="va">optima.post</span>, <span class="fl">2</span>, <span class="va">mean</span> <span class="op">)</span></span>
<span><span class="va">mu.mean</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mu.mean</span><span class="op">)</span></span>
<span><span class="va">mu.mean</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mu.mean</span>,<span class="st">"Regimes"</span><span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">mu.mean</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">mu.mean</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mu.mean</span>,<span class="va">optima</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mu.CI</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span> <span class="va">optima.post</span> , <span class="fl">2</span>, <span class="fu">rethinking</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/rethinking/man/HPDI.html" class="external-link">PI</a></span> , prob<span class="op">=</span><span class="fl">0.89</span> <span class="op">)</span></span>
<span><span class="va">mu.CI</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">mu.CI</span><span class="op">)</span><span class="op">)</span>,<span class="st">"Regimes"</span><span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">mu.CI</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mu.CI</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"min.5.5"</span>,<span class="st">"max.94.5"</span>,<span class="st">"Regimes"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">Y</span>,regimes<span class="op">=</span><span class="va">regimes_tip</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Y"</span>,<span class="st">"Regimes"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span></span>
<span><span class="va">optima.plot</span><span class="op">&lt;-</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>, Mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Y</span>, y <span class="op">=</span> <span class="va">Regimes</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html" class="external-link">geom_jitter</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">optima.sims</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">optima.sims</span>,x<span class="op">=</span><span class="va">Prior</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">0.25</span>,width<span class="op">=</span><span class="fl">0.15</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html" class="external-link">geom_segment</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mu.mean</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Regimes</span><span class="op">-</span><span class="fl">0.5</span>,xend<span class="op">=</span><span class="va">Regimes</span><span class="op">+</span><span class="fl">0.5</span>,y<span class="op">=</span><span class="va">mu.mean</span>,yend<span class="op">=</span><span class="va">mu.mean</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html" class="external-link">geom_segment</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mu.mean</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Regimes</span><span class="op">-</span><span class="fl">0.5</span>,xend<span class="op">=</span><span class="va">Regimes</span><span class="op">+</span><span class="fl">0.5</span>,y<span class="op">=</span><span class="va">optima</span>,yend<span class="op">=</span><span class="va">optima</span><span class="op">)</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_linerange</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mu.CI</span>, mapping<span class="op">=</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">Regimes</span>,ymin<span class="op">=</span><span class="va">min.5.5</span>,ymax<span class="op">=</span><span class="va">max.94.5</span><span class="op">)</span>,size<span class="op">=</span><span class="fl">35</span>,color<span class="op">=</span><span class="st">"darkgrey"</span>,alpha<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html" class="external-link">geom_jitter</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">Y</span>,x<span class="op">=</span><span class="va">Regimes</span><span class="op">)</span>,width<span class="op">=</span><span class="fl">0.15</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Optima"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/scale_npg.html" class="external-link">scale_color_npg</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in fortify(data, ...): Arguments in `...` must be used.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> Problematic argument:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> Mapping = aes(x = Y, y = Regimes)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Did you misspell an argument name?</span></span>
<span><span class="co">#&gt; Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Please use `linewidth` instead.</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">generated.</span></span></span>
<span></span>
<span><span class="va">optima.plot</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>Next is the code for the Multilevel Multi-optima Model - here we
include the additional prior sigma, which is a parameter for the
variance among regimes</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Set Priors</span></span>
<span><span class="va">hl.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span>,<span class="fl">0.75</span><span class="op">)</span></span>
<span><span class="va">vy.prior</span><span class="op">&lt;-</span><span class="fl">20</span></span>
<span><span class="va">optima.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span>
<span><span class="va">sigma.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Blouch Prep Code</span></span>
<span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/blouch.reg.mlm.prep.html">blouch.reg.mlm.prep</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="st">"Y_with_error"</span>,<span class="st">"Y_error"</span>,<span class="st">"regimes"</span>,<span class="va">hl.prior</span>,<span class="va">vy.prior</span>,<span class="va">optima.prior</span>,<span class="va">sigma.prior</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.mlm.vi.regimes</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_mlm_vi</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,iter<span class="op">=</span> <span class="fl">2000</span>,cores<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Warning: There were 50 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.mlm.vi.regimes</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"optima_bar"</span>,<span class="st">"sigma"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.mlm.vi.regimes</span><span class="op">)</span></span></code></pre></div>
<p>Finally we will run the non-centered version of the same model, which
can be used when the posterior is hard to explore and the centered
version of the model produces divergences.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.mlm.vi.regimes.nc</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_mlm_vi_nc</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,iter <span class="op">=</span><span class="fl">2000</span>,cores<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="co">#,control=list(adapt_delta=0.95))</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Warning: There were 68 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span>
<span><span class="co">#&gt; Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#tail-ess</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.mlm.vi.regimes.nc</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"optima_bar"</span>,<span class="st">"sigma"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">###plot(rethinking::precis(fit.mlm.vi.regimes.nc,depth=2,pars = c("hl","vy","optima","optima_bar","sigma")))</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.mlm.vi.regimes.nc</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
>>>>>>> dev-fixes-blouch1.0
</div>
<div id="multi-optima-direct-effect-model" class="section level2">
<h2>Multi-optima Direct Effect Model</h2>
<p>We will now include both regimes painted on the tree and a direct
effect predictor</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="do">############################################################################################################</span></span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a><span class="co">#Regimes + Direct Effect Model</span></span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a><span class="do">############################################################################################################</span></span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a><span class="co">#Create phylogeny</span></span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a><span class="do">########################################################################################################</span></span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a>N<span class="ot">&lt;-</span><span class="dv">50</span> <span class="co">#Number of species</span></span>
<span id="cb29-7"><a href="#cb29-7" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">10</span>) <span class="co">#Set seed to get same random species each time</span></span>
<span id="cb29-8"><a href="#cb29-8" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" tabindex="-1"></a>phy <span class="ot">&lt;-</span> ape<span class="sc">::</span><span class="fu">keep.tip</span>(tree<span class="fl">.10</span>K,<span class="fu">sample</span>(tree<span class="fl">.10</span>K<span class="sc">$</span>tip.label)[<span class="dv">1</span><span class="sc">:</span>N]) </span>
<span id="cb29-10"><a href="#cb29-10" tabindex="-1"></a>phy<span class="ot">&lt;-</span>ape<span class="sc">::</span><span class="fu">multi2di</span>(phy)</span>
<span id="cb29-11"><a href="#cb29-11" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" tabindex="-1"></a>l.tree<span class="ot">&lt;-</span><span class="fu">max</span>(ape<span class="sc">::</span><span class="fu">branching.times</span>(phy)) <span class="do">## rescale tree to height 1</span></span>
<span id="cb29-13"><a href="#cb29-13" tabindex="-1"></a>phy<span class="sc">$</span>edge.length<span class="ot">&lt;-</span>phy<span class="sc">$</span>edge.length<span class="sc">/</span>l.tree </span>
<span id="cb29-14"><a href="#cb29-14" tabindex="-1"></a></span>
<span id="cb29-15"><a href="#cb29-15" tabindex="-1"></a>tip.label<span class="ot">&lt;-</span>phy<span class="sc">$</span>tip.label</span>
<span id="cb29-16"><a href="#cb29-16" tabindex="-1"></a></span>
<span id="cb29-17"><a href="#cb29-17" tabindex="-1"></a><span class="co">#Set regimes - manually - 2 regimes</span></span>
<span id="cb29-18"><a href="#cb29-18" tabindex="-1"></a><span class="co">#Locate nodes</span></span>
<span id="cb29-19"><a href="#cb29-19" tabindex="-1"></a><span class="fu">plot</span>(phy,<span class="at">no.margin=</span><span class="cn">TRUE</span>,<span class="at">edge.width=</span><span class="dv">2</span>,<span class="at">cex=</span><span class="fl">0.7</span>)</span>
<span id="cb29-20"><a href="#cb29-20" tabindex="-1"></a>ape<span class="sc">::</span><span class="fu">nodelabels</span>(<span class="at">frame=</span><span class="st">&quot;none&quot;</span>,<span class="at">adj=</span><span class="fu">c</span>(<span class="fl">1.1</span>,<span class="sc">-</span><span class="fl">0.4</span>))</span>
<span id="cb29-21"><a href="#cb29-21" tabindex="-1"></a>ape<span class="sc">::</span><span class="fu">tiplabels</span>()</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-19-1.png" width="700" /></p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a></span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a><span class="co">#Paint Regimes on Tree</span></span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a><span class="co">#source(&quot;/Users/markgrabowski/Documents/Academic/Research/Current Projects/Blouch project/blouch/Simulation Code/Functions/set.converge.regimes.R&quot;) #Macbook Pro</span></span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a>shifts<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">84</span>) <span class="co">#Location of nodes with regime shifts</span></span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a>trdata<span class="ot">&lt;-</span><span class="fu">data.frame</span>(phy<span class="sc">$</span>tip.label)</span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a>trdata<span class="ot">&lt;-</span>treeplyr<span class="sc">::</span><span class="fu">make.treedata</span>(phy,trdata)</span>
<span id="cb30-7"><a href="#cb30-7" tabindex="-1"></a>trdata<span class="ot">&lt;-</span><span class="fu">set.converge.regimes</span>(trdata,shifts)</span>
<span id="cb30-8"><a href="#cb30-8" tabindex="-1"></a><span class="co">#&gt; [1] 1</span></span>
<span id="cb30-9"><a href="#cb30-9" tabindex="-1"></a><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb30-10"><a href="#cb30-10" tabindex="-1"></a><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb30-11"><a href="#cb30-11" tabindex="-1"></a><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb30-12"><a href="#cb30-12" tabindex="-1"></a><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span id="cb30-13"><a href="#cb30-13" tabindex="-1"></a><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb30-14"><a href="#cb30-14" tabindex="-1"></a><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span id="cb30-15"><a href="#cb30-15" tabindex="-1"></a><span class="co">#&gt; Levels: OU1 OU2</span></span>
<span id="cb30-16"><a href="#cb30-16" tabindex="-1"></a><span class="co">#&gt; [1] &quot;#E64B35FF&quot; &quot;#4DBBD5FF&quot;</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-19-2.png" width="700" /></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a></span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a><span class="co">#Check if manual setting code worked</span></span>
<span id="cb31-4"><a href="#cb31-4" tabindex="-1"></a>shifts.total<span class="ot">&lt;-</span><span class="fu">c</span>(trdata<span class="sc">$</span>dat<span class="sc">$</span>regimes,trdata<span class="sc">$</span>phy<span class="sc">$</span>node.label)</span>
<span id="cb31-5"><a href="#cb31-5" tabindex="-1"></a>edge.regimes <span class="ot">&lt;-</span> <span class="fu">factor</span>(shifts.total[trdata<span class="sc">$</span>phy<span class="sc">$</span>edge[,<span class="dv">2</span>]])</span>
<span id="cb31-6"><a href="#cb31-6" tabindex="-1"></a><span class="fu">print</span>(edge.regimes)</span>
<span id="cb31-7"><a href="#cb31-7" tabindex="-1"></a><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb31-8"><a href="#cb31-8" tabindex="-1"></a><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb31-9"><a href="#cb31-9" tabindex="-1"></a><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb31-10"><a href="#cb31-10" tabindex="-1"></a><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span id="cb31-11"><a href="#cb31-11" tabindex="-1"></a><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb31-12"><a href="#cb31-12" tabindex="-1"></a><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span id="cb31-13"><a href="#cb31-13" tabindex="-1"></a><span class="co">#&gt; Levels: OU1 OU2</span></span>
<span id="cb31-14"><a href="#cb31-14" tabindex="-1"></a></span>
<span id="cb31-15"><a href="#cb31-15" tabindex="-1"></a>reg.colors <span class="ot">&lt;-</span> ggsci<span class="sc">::</span><span class="fu">pal_aaas</span>(<span class="st">&quot;default&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>)(<span class="dv">2</span>)</span>
<span id="cb31-16"><a href="#cb31-16" tabindex="-1"></a><span class="fu">print</span>(reg.colors)</span>
<span id="cb31-17"><a href="#cb31-17" tabindex="-1"></a><span class="co">#&gt; [1] &quot;#3B4992B2&quot; &quot;#EE0000B2&quot;</span></span>
<span id="cb31-18"><a href="#cb31-18" tabindex="-1"></a><span class="fu">plot</span>(trdata<span class="sc">$</span>phy,<span class="at">edge.color =</span> reg.colors[edge.regimes], <span class="at">edge.width =</span> <span class="dv">1</span>, <span class="at">cex =</span> <span class="fl">0.2</span>)</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-19-3.png" width="700" /></p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a></span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a><span class="co">#Phylogeny info</span></span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a>n<span class="ot">&lt;-</span><span class="fu">length</span>(trdata<span class="sc">$</span>phy<span class="sc">$</span>tip.label)</span>
<span id="cb32-4"><a href="#cb32-4" tabindex="-1"></a>mrca1 <span class="ot">&lt;-</span> ape<span class="sc">::</span><span class="fu">mrca</span>(trdata<span class="sc">$</span>phy)</span>
<span id="cb32-5"><a href="#cb32-5" tabindex="-1"></a>times <span class="ot">&lt;-</span> ape<span class="sc">::</span><span class="fu">node.depth.edgelength</span>(trdata<span class="sc">$</span>phy)</span>
<span id="cb32-6"><a href="#cb32-6" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" tabindex="-1"></a>regimes_internal <span class="ot">&lt;-</span>trdata<span class="sc">$</span>phy<span class="sc">$</span>node.label</span>
<span id="cb32-8"><a href="#cb32-8" tabindex="-1"></a>regimes_tip <span class="ot">&lt;-</span> trdata<span class="sc">$</span>dat<span class="sc">$</span>regimes</span>
<span id="cb32-9"><a href="#cb32-9" tabindex="-1"></a>regimes <span class="ot">&lt;-</span> <span class="fu">concat.factor</span>(regimes_tip, regimes_internal)</span>
<span id="cb32-10"><a href="#cb32-10" tabindex="-1"></a>anc_maps<span class="ot">&lt;-</span><span class="st">&quot;regimes&quot;</span></span>
<span id="cb32-11"><a href="#cb32-11" tabindex="-1"></a>lineages <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="cf">function</span>(e) <span class="fu">lineage.constructor</span>(trdata<span class="sc">$</span>phy, e, anc_maps, regimes)) <span class="co">#Trace lineage from tips (n) to root and determine regimes of each node or branch</span></span></code></pre></div>
<p>Now simulate X and Y data</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a><span class="do">#########################</span></span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a>hl<span class="ot">&lt;-</span><span class="fl">0.1</span> <span class="co">#0.1, 0.25, 0.75 - testing options</span></span>
<span id="cb33-3"><a href="#cb33-3" tabindex="-1"></a>a<span class="ot">&lt;-</span><span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">/</span>hl</span>
<span id="cb33-4"><a href="#cb33-4" tabindex="-1"></a>vy<span class="ot">&lt;-</span><span class="fl">0.01</span> <span class="co">#0.25,0.5 - testing options</span></span>
<span id="cb33-5"><a href="#cb33-5" tabindex="-1"></a>sigma2_y<span class="ot">&lt;-</span>vy<span class="sc">*</span>(<span class="dv">2</span><span class="sc">*</span>(<span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">/</span>hl));</span>
<span id="cb33-6"><a href="#cb33-6" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" tabindex="-1"></a>vX0<span class="ot">&lt;-</span><span class="dv">0</span></span>
<span id="cb33-8"><a href="#cb33-8" tabindex="-1"></a>vY0 <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb33-9"><a href="#cb33-9" tabindex="-1"></a>Sxx<span class="ot">&lt;-</span><span class="dv">10</span> <span class="co">#Look at effects</span></span>
<span id="cb33-10"><a href="#cb33-10" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" tabindex="-1"></a>Z_direct<span class="ot">&lt;-</span><span class="dv">1</span></span>
<span id="cb33-12"><a href="#cb33-12" tabindex="-1"></a></span>
<span id="cb33-13"><a href="#cb33-13" tabindex="-1"></a>V<span class="ot">&lt;-</span><span class="fu">calc_direct_V</span>(phy,sigma2_y,a)</span>
<span id="cb33-14"><a href="#cb33-14" tabindex="-1"></a>X<span class="ot">&lt;-</span>phytools<span class="sc">::</span><span class="fu">fastBM</span>(phy,<span class="at">a=</span>vX0,<span class="at">sig2=</span>Sxx,<span class="at">internal=</span><span class="cn">FALSE</span>) <span class="co">#Simulate X BM variable on tree, with scaling 10</span></span>
<span id="cb33-15"><a href="#cb33-15" tabindex="-1"></a><span class="co">#X&lt;-rnorm(N,0,1)</span></span>
<span id="cb33-16"><a href="#cb33-16" tabindex="-1"></a><span class="fu">names</span>(X)<span class="ot">&lt;-</span>phy<span class="sc">$</span>tip.label</span>
<span id="cb33-17"><a href="#cb33-17" tabindex="-1"></a></span>
<span id="cb33-18"><a href="#cb33-18" tabindex="-1"></a>phytools<span class="sc">::</span><span class="fu">phenogram</span>(phy,X,<span class="at">spread.labels=</span><span class="cn">TRUE</span>,<span class="at">spread.cost=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>)) <span class="co">#Plot X data</span></span>
<span id="cb33-19"><a href="#cb33-19" tabindex="-1"></a><span class="co">#&gt; Optimizing the positions of the tip labels...</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-20-1.png" width="700" /></p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a></span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a>dmX<span class="ot">&lt;-</span><span class="fu">weight.matrix</span>(trdata<span class="sc">$</span>phy, a, lineages) <span class="co">#Slouch approach</span></span>
<span id="cb34-3"><a href="#cb34-3" tabindex="-1"></a>dmX<span class="ot">&lt;-</span><span class="fu">cbind</span>(dmX,X)</span>
<span id="cb34-4"><a href="#cb34-4" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" tabindex="-1"></a>beta<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="fl">0.25</span>) <span class="co">#Two Optima/One Slope</span></span>
<span id="cb34-6"><a href="#cb34-6" tabindex="-1"></a>mu<span class="ot">&lt;-</span>dmX<span class="sc">%*%</span>beta <span class="co">#Simulate mu for Y</span></span>
<span id="cb34-7"><a href="#cb34-7" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" tabindex="-1"></a>V<span class="ot">&lt;-</span><span class="fu">calc_direct_V</span>(phy,sigma2_y,a)</span>
<span id="cb34-9"><a href="#cb34-9" tabindex="-1"></a>Y<span class="ot">&lt;-</span>MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(<span class="at">n=</span><span class="dv">1</span>,mu,V)</span>
<span id="cb34-10"><a href="#cb34-10" tabindex="-1"></a></span>
<span id="cb34-11"><a href="#cb34-11" tabindex="-1"></a><span class="co">#Plot data</span></span>
<span id="cb34-12"><a href="#cb34-12" tabindex="-1"></a>df<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">Y=</span>Y,<span class="at">X=</span>X)</span>
<span id="cb34-13"><a href="#cb34-13" tabindex="-1"></a></span>
<span id="cb34-14"><a href="#cb34-14" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">data=</span>df,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>X,<span class="at">y=</span>Y))<span class="sc">+</span></span>
<span id="cb34-15"><a href="#cb34-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>()</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-20-2.png" width="700" /></p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">lm</span>(Y<span class="sc">~</span>X,df))</span>
<span id="cb35-2"><a href="#cb35-2" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb35-3"><a href="#cb35-3" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb35-4"><a href="#cb35-4" tabindex="-1"></a><span class="co">#&gt; lm(formula = Y ~ X, data = df)</span></span>
<span id="cb35-5"><a href="#cb35-5" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb35-6"><a href="#cb35-6" tabindex="-1"></a><span class="co">#&gt; Residuals:</span></span>
<span id="cb35-7"><a href="#cb35-7" tabindex="-1"></a><span class="co">#&gt;      Min       1Q   Median       3Q      Max </span></span>
<span id="cb35-8"><a href="#cb35-8" tabindex="-1"></a><span class="co">#&gt; -1.00801  0.05843  0.18122  0.26742  0.44140 </span></span>
<span id="cb35-9"><a href="#cb35-9" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb35-10"><a href="#cb35-10" tabindex="-1"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb35-11"><a href="#cb35-11" tabindex="-1"></a><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span id="cb35-12"><a href="#cb35-12" tabindex="-1"></a><span class="co">#&gt; (Intercept)  1.79802    0.07104   25.31   &lt;2e-16 ***</span></span>
<span id="cb35-13"><a href="#cb35-13" tabindex="-1"></a><span class="co">#&gt; X            0.25223    0.02025   12.46   &lt;2e-16 ***</span></span>
<span id="cb35-14"><a href="#cb35-14" tabindex="-1"></a><span class="co">#&gt; ---</span></span>
<span id="cb35-15"><a href="#cb35-15" tabindex="-1"></a><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></span>
<span id="cb35-16"><a href="#cb35-16" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb35-17"><a href="#cb35-17" tabindex="-1"></a><span class="co">#&gt; Residual standard error: 0.4464 on 48 degrees of freedom</span></span>
<span id="cb35-18"><a href="#cb35-18" tabindex="-1"></a><span class="co">#&gt; Multiple R-squared:  0.7638, Adjusted R-squared:  0.7589 </span></span>
<span id="cb35-19"><a href="#cb35-19" tabindex="-1"></a><span class="co">#&gt; F-statistic: 155.2 on 1 and 48 DF,  p-value: &lt; 2.2e-16</span></span>
<span id="cb35-20"><a href="#cb35-20" tabindex="-1"></a></span>
<span id="cb35-21"><a href="#cb35-21" tabindex="-1"></a><span class="do">#################################################################################################################Simulate errors</span></span>
<span id="cb35-22"><a href="#cb35-22" tabindex="-1"></a>Z_X_error<span class="ot">&lt;-</span><span class="dv">1</span> <span class="co">#Number of X traits with error</span></span>
<span id="cb35-23"><a href="#cb35-23" tabindex="-1"></a>X_error<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="fl">0.01</span>,N)</span>
<span id="cb35-24"><a href="#cb35-24" tabindex="-1"></a>Y_error<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="fl">0.01</span>,N)</span>
<span id="cb35-25"><a href="#cb35-25" tabindex="-1"></a>Y_with_error<span class="ot">&lt;-</span>Y<span class="sc">+</span><span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fl">0.01</span>)</span>
<span id="cb35-26"><a href="#cb35-26" tabindex="-1"></a>X_with_error<span class="ot">&lt;-</span>X<span class="sc">+</span><span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fl">0.01</span>)</span>
<span id="cb35-27"><a href="#cb35-27" tabindex="-1"></a></span>
<span id="cb35-28"><a href="#cb35-28" tabindex="-1"></a><span class="do">############################################################################################################</span></span>
<span id="cb35-29"><a href="#cb35-29" tabindex="-1"></a><span class="co">#Make trdata file</span></span>
<span id="cb35-30"><a href="#cb35-30" tabindex="-1"></a>trdata<span class="sc">$</span>dat<span class="ot">&lt;-</span><span class="fu">cbind</span>(trdata<span class="sc">$</span>dat,<span class="fu">data.frame</span>(<span class="fu">cbind</span>(Y_with_error,Y_error,X_with_error,X_error)))</span></code></pre></div>
<p>Next we will set the priors for the estimated parameters - for this
model this includes the half-life, Vy, optima, and beta. For the latter
two parameters we will use the results of the linear model to inform our
priors.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a><span class="do">############################################################################################################</span></span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a><span class="co">#Set Priors</span></span>
<span id="cb36-3"><a href="#cb36-3" tabindex="-1"></a>hl.prior<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fu">log</span>(<span class="fl">0.25</span>),<span class="fl">0.75</span>)</span>
<span id="cb36-4"><a href="#cb36-4" tabindex="-1"></a>vy.prior<span class="ot">&lt;-</span><span class="dv">5</span></span>
<span id="cb36-5"><a href="#cb36-5" tabindex="-1"></a>optima.prior<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="fl">0.5</span>) <span class="co">#Informed by linear model</span></span>
<span id="cb36-6"><a href="#cb36-6" tabindex="-1"></a>beta.prior<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fl">0.25</span>,<span class="fl">0.25</span>) <span class="co">#Informed by linear model</span></span></code></pre></div>
</div>
<div id="exploring-priors-1" class="section level2">
<h2>Exploring Priors</h2>
<p>At this point one would want to explore if the priors are appropriate
- do the prior distributions look consistent with what we know about our
system? See Grabowski (in press) for more on setting priors.</p>
<p>Half-life Prior plot</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a>hl.sims<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">rlnorm</span>(<span class="at">n=</span><span class="dv">1000</span>,<span class="at">meanlog=</span>hl.prior[<span class="dv">1</span>],<span class="at">sdlog=</span>hl.prior[<span class="dv">2</span>]))</span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a><span class="fu">names</span>(hl.sims)<span class="ot">&lt;-</span><span class="st">&quot;prior.hl.sims&quot;</span></span>
<span id="cb37-3"><a href="#cb37-3" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" tabindex="-1"></a>hl.prior.plot<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb37-5"><a href="#cb37-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(prior.hl.sims,<span class="at">fill=</span><span class="st">&quot;prior.hl.sims&quot;</span>),<span class="at">alpha=</span><span class="fl">0.2</span>,<span class="at">data=</span>hl.sims)<span class="sc">+</span></span>
<span id="cb37-6"><a href="#cb37-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb37-7"><a href="#cb37-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb37-8"><a href="#cb37-8" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(),</span>
<span id="cb37-9"><a href="#cb37-9" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb37-10"><a href="#cb37-10" tabindex="-1"></a>  </span>
<span id="cb37-11"><a href="#cb37-11" tabindex="-1"></a>  <span class="co">#labs(title=&quot;Prior vs. Posterior Distribution &quot;,x=&quot;Half-life&quot;, y = &quot;Density&quot;)+</span></span>
<span id="cb37-12"><a href="#cb37-12" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title=</span><span class="st">&quot;&quot;</span>,<span class="at">x=</span><span class="st">&quot;Half-life&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Density&quot;</span>)<span class="sc">+</span></span>
<span id="cb37-13"><a href="#cb37-13" tabindex="-1"></a>  </span>
<span id="cb37-14"><a href="#cb37-14" tabindex="-1"></a>  <span class="co">#scale_fill_manual(labels=c(&quot;Posterior&quot;,&quot;Prior&quot;))+</span></span>
<span id="cb37-15"><a href="#cb37-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept=</span><span class="fu">c</span>(hl),<span class="at">linetype=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb37-16"><a href="#cb37-16" tabindex="-1"></a>  ggsci<span class="sc">::</span><span class="fu">scale_fill_npg</span>(<span class="at">name=</span><span class="st">&quot;&quot;</span>,<span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;Prior&quot;</span>))</span>
<span id="cb37-17"><a href="#cb37-17" tabindex="-1"></a></span>
<span id="cb37-18"><a href="#cb37-18" tabindex="-1"></a>hl.prior.plot</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-22-1.png" width="700" /></p>
<p>Vy Prior Plot</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a>vy.sims<span class="ot">&lt;-</span><span class="fu">rexp</span>(<span class="at">n=</span><span class="dv">1000</span>,<span class="at">rate=</span>vy.prior)</span>
<span id="cb38-2"><a href="#cb38-2" tabindex="-1"></a>vy.sims<span class="ot">&lt;-</span><span class="fu">data.frame</span>(vy.sims)</span>
<span id="cb38-3"><a href="#cb38-3" tabindex="-1"></a><span class="fu">names</span>(vy.sims)<span class="ot">&lt;-</span><span class="st">&quot;prior.vy.sims&quot;</span></span>
<span id="cb38-4"><a href="#cb38-4" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" tabindex="-1"></a>vy.prior.plot<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb38-6"><a href="#cb38-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(prior.vy.sims,<span class="at">fill=</span><span class="st">&quot;prior.vy.sims&quot;</span>),<span class="at">alpha=</span><span class="fl">0.2</span>,<span class="at">data=</span>vy.sims)<span class="sc">+</span></span>
<span id="cb38-7"><a href="#cb38-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb38-8"><a href="#cb38-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb38-9"><a href="#cb38-9" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(),</span>
<span id="cb38-10"><a href="#cb38-10" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb38-11"><a href="#cb38-11" tabindex="-1"></a>  </span>
<span id="cb38-12"><a href="#cb38-12" tabindex="-1"></a>  <span class="co">#labs(title=&quot;Prior vs. Posterior Distribution &quot;,x=&quot;vy&quot;, y = &quot;Density&quot;)+</span></span>
<span id="cb38-13"><a href="#cb38-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title=</span><span class="st">&quot;&quot;</span>,<span class="at">x=</span><span class="st">&quot;vy&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Density&quot;</span>)<span class="sc">+</span></span>
<span id="cb38-14"><a href="#cb38-14" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept=</span><span class="fu">c</span>(vy),<span class="at">linetype=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb38-15"><a href="#cb38-15" tabindex="-1"></a>  </span>
<span id="cb38-16"><a href="#cb38-16" tabindex="-1"></a>  <span class="co">#scale_fill_manual(labels=c(&quot;Posterior&quot;,&quot;Prior&quot;))+</span></span>
<span id="cb38-17"><a href="#cb38-17" tabindex="-1"></a>  ggsci<span class="sc">::</span><span class="fu">scale_fill_npg</span>(<span class="at">name=</span><span class="st">&quot;&quot;</span>,<span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;Prior&quot;</span>))</span>
<span id="cb38-18"><a href="#cb38-18" tabindex="-1"></a></span>
<span id="cb38-19"><a href="#cb38-19" tabindex="-1"></a></span>
<span id="cb38-20"><a href="#cb38-20" tabindex="-1"></a>vy.prior.plot</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-23-1.png" width="700" /></p>
<p>Prior on how shared branch lengths correspond to covariance</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a>a.sims<span class="ot">&lt;-</span><span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">/</span>hl.sims;</span>
<span id="cb39-2"><a href="#cb39-2" tabindex="-1"></a>sigma2_y.sims<span class="ot">&lt;-</span>vy.sims<span class="sc">*</span>(<span class="dv">2</span><span class="sc">*</span>(<span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">/</span>hl.sims));</span>
<span id="cb39-3"><a href="#cb39-3" tabindex="-1"></a><span class="co">#x&lt;-seq(from=0,to=1,by=0.001)</span></span>
<span id="cb39-4"><a href="#cb39-4" tabindex="-1"></a><span class="co">#V.sim&lt;-calc_direct_V(phy,a.sims,sigma2_y.sims)</span></span>
<span id="cb39-5"><a href="#cb39-5" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" tabindex="-1"></a><span class="fu">plot</span>( <span class="cn">NULL</span> , <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>) , <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>) , <span class="at">xlab=</span><span class="st">&quot;Time since MRCA&quot;</span> , <span class="at">ylab=</span><span class="st">&quot;Covariance&quot;</span> ,<span class="at">cex.axis=</span><span class="fl">0.75</span>, <span class="at">mgp=</span><span class="fu">c</span>(<span class="fl">1.25</span>,<span class="fl">0.25</span>,<span class="dv">0</span>),<span class="at">tcl=</span><span class="sc">-</span><span class="fl">0.25</span>)</span>
<span id="cb39-7"><a href="#cb39-7" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>){</span>
<span id="cb39-8"><a href="#cb39-8" tabindex="-1"></a>  <span class="fu">curve</span>(sigma2_y.sims[i,] <span class="sc">/</span>(<span class="dv">2</span> <span class="sc">*</span> a.sims[i,]) <span class="sc">*</span> ((<span class="dv">1</span> <span class="sc">-</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> a.sims[i,] <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>(x<span class="sc">/</span><span class="dv">2</span>)))) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>a.sims[i,] <span class="sc">*</span> x)) , <span class="at">add=</span><span class="cn">TRUE</span> , <span class="at">lwd=</span><span class="dv">4</span> , <span class="at">col=</span>rethinking<span class="sc">::</span><span class="fu">col.alpha</span>(<span class="dv">1</span>,<span class="fl">0.15</span>))</span>
<span id="cb39-9"><a href="#cb39-9" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-24-1.png" width="700" /></p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" tabindex="-1"></a></span>
<span id="cb40-2"><a href="#cb40-2" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="fl">0.25</span>,<span class="fl">0.25</span>))</span>
<span id="cb40-5"><a href="#cb40-5" tabindex="-1"></a>covariance.prior.plot <span class="ot">&lt;-</span> <span class="fu">recordPlot</span>()</span>
<span id="cb40-6"><a href="#cb40-6" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb40-7"><a href="#cb40-7" tabindex="-1"></a><span class="co">#&gt; null device </span></span>
<span id="cb40-8"><a href="#cb40-8" tabindex="-1"></a><span class="co">#&gt;           1</span></span>
<span id="cb40-9"><a href="#cb40-9" tabindex="-1"></a>covariance.prior.plot</span></code></pre></div>
<p>Slope and intercept Prior Plot</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a></span>
<span id="cb41-2"><a href="#cb41-2" tabindex="-1"></a>optima.sims<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="dv">100</span>,optima.prior[<span class="dv">1</span>],optima.prior[<span class="dv">2</span>])</span>
<span id="cb41-3"><a href="#cb41-3" tabindex="-1"></a>beta.sims<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="at">n=</span><span class="dv">100</span>,beta.prior[<span class="dv">1</span>],beta.prior[<span class="dv">2</span>])</span>
<span id="cb41-4"><a href="#cb41-4" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" tabindex="-1"></a>prior.slope.plot<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>()<span class="sc">+</span>  </span>
<span id="cb41-6"><a href="#cb41-6" tabindex="-1"></a> ggplot2<span class="sc">::</span> <span class="fu">geom_point</span>(<span class="at">data=</span>df,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y=</span>Y,<span class="at">x=</span>X))<span class="sc">+</span></span>
<span id="cb41-7"><a href="#cb41-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_abline</span>(<span class="at">intercept=</span>optima.sims,<span class="at">slope=</span>beta.sims,<span class="at">alpha=</span><span class="fl">0.15</span>)<span class="sc">+</span></span>
<span id="cb41-8"><a href="#cb41-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb41-9"><a href="#cb41-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb41-10"><a href="#cb41-10" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(),</span>
<span id="cb41-11"><a href="#cb41-11" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb41-12"><a href="#cb41-12" tabindex="-1"></a>  </span>
<span id="cb41-13"><a href="#cb41-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ylab</span>(<span class="st">&quot;Y&quot;</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">xlab</span>(<span class="st">&quot;Direct Effect X&quot;</span>)<span class="sc">+</span></span>
<span id="cb41-14"><a href="#cb41-14" tabindex="-1"></a>  ggsci<span class="sc">::</span><span class="fu">scale_color_npg</span>()</span>
<span id="cb41-15"><a href="#cb41-15" tabindex="-1"></a></span>
<span id="cb41-16"><a href="#cb41-16" tabindex="-1"></a>prior.slope.plot</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-25-1.png" width="700" /></p>
<p>We will use the helper function blouch.reg.direct.prep() to setup the
dat file for Stan. Here “Z_direct” is the number of predictors, and
“regimes” is the name of the regime column in trdata$dat.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" tabindex="-1"></a><span class="do">############################################################################################################</span></span>
<span id="cb42-2"><a href="#cb42-2" tabindex="-1"></a><span class="co">#Test Blouch prep code - Regimes + Direct Efffect model</span></span>
<span id="cb42-3"><a href="#cb42-3" tabindex="-1"></a>dat<span class="ot">&lt;-</span><span class="fu">blouch.reg.direct.prep</span>(trdata,<span class="st">&quot;Y_with_error&quot;</span>,<span class="st">&quot;Y_error&quot;</span>,<span class="st">&quot;X_with_error&quot;</span>,<span class="st">&quot;X_error&quot;</span>,<span class="at">Z_direct=</span><span class="dv">1</span>,<span class="st">&quot;regimes&quot;</span>,hl.prior,vy.prior,optima.prior,beta.prior)</span></code></pre></div>
<p>Now we run the basic Multi-optima Direct Effect Model, look at the
results, and rstan::extract the posterior</p>
<<<<<<< HEAD
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a>fit.reg.direct<span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">sampling</span>(<span class="at">object =</span> blouch<span class="sc">:::</span>stanmodels<span class="sc">$</span>blouchOU_reg_direct,<span class="at">data =</span> dat,<span class="at">chains =</span> <span class="dv">2</span>,<span class="at">cores=</span><span class="dv">2</span>,<span class="at">iter=</span><span class="dv">2000</span>)</span>
<span id="cb43-2"><a href="#cb43-2" tabindex="-1"></a><span class="co">#&gt; Found more than one class &quot;stanfit&quot; in cache; using the first, from namespace &#39;rstan&#39;</span></span>
<span id="cb43-3"><a href="#cb43-3" tabindex="-1"></a><span class="co">#&gt; Also defined by &#39;rethinking&#39;</span></span>
<span id="cb43-4"><a href="#cb43-4" tabindex="-1"></a><span class="co">#&gt; Found more than one class &quot;stanfit&quot; in cache; using the first, from namespace &#39;rstan&#39;</span></span>
<span id="cb43-5"><a href="#cb43-5" tabindex="-1"></a><span class="co">#&gt; Also defined by &#39;rethinking&#39;</span></span></code></pre></div>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" tabindex="-1"></a><span class="fu">print</span>(fit.reg.direct,<span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;hl&quot;</span>,<span class="st">&quot;vy&quot;</span>,<span class="st">&quot;optima&quot;</span>,<span class="st">&quot;beta&quot;</span>))</span>
<span id="cb44-2"><a href="#cb44-2" tabindex="-1"></a><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct.</span></span>
<span id="cb44-3"><a href="#cb44-3" tabindex="-1"></a><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span id="cb44-4"><a href="#cb44-4" tabindex="-1"></a><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span id="cb44-5"><a href="#cb44-5" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb44-6"><a href="#cb44-6" tabindex="-1"></a><span class="co">#&gt;           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span id="cb44-7"><a href="#cb44-7" tabindex="-1"></a><span class="co">#&gt; hl        0.16       0 0.08 0.06 0.11 0.14 0.19  0.36  1046    1</span></span>
<span id="cb44-8"><a href="#cb44-8" tabindex="-1"></a><span class="co">#&gt; vy        0.02       0 0.01 0.01 0.01 0.02 0.02  0.03  1063    1</span></span>
<span id="cb44-9"><a href="#cb44-9" tabindex="-1"></a><span class="co">#&gt; optima[1] 2.01       0 0.04 1.93 1.99 2.01 2.03  2.09  2496    1</span></span>
<span id="cb44-10"><a href="#cb44-10" tabindex="-1"></a><span class="co">#&gt; optima[2] 0.94       0 0.09 0.70 0.90 0.95 0.99  1.07  1167    1</span></span>
<span id="cb44-11"><a href="#cb44-11" tabindex="-1"></a><span class="co">#&gt; beta[1]   0.25       0 0.01 0.24 0.25 0.25 0.26  0.27  3574    1</span></span>
<span id="cb44-12"><a href="#cb44-12" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb44-13"><a href="#cb44-13" tabindex="-1"></a><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Fri Oct 10 16:20:21 2025.</span></span>
<span id="cb44-14"><a href="#cb44-14" tabindex="-1"></a><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span id="cb44-15"><a href="#cb44-15" tabindex="-1"></a><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span id="cb44-16"><a href="#cb44-16" tabindex="-1"></a><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span id="cb44-17"><a href="#cb44-17" tabindex="-1"></a>post<span class="ot">&lt;-</span>rstan<span class="sc">::</span><span class="fu">extract</span>(fit.reg.direct) <span class="co">#rstan::extract posterior distribution</span></span></code></pre></div>
=======
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.direct</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_direct</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores<span class="op">=</span><span class="fl">2</span>,iter<span class="op">=</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span></code></pre></div>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.direct</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.16       0 0.08 0.06 0.11 0.14 0.19  0.36  1046    1</span></span>
<span><span class="co">#&gt; vy        0.02       0 0.01 0.01 0.01 0.02 0.02  0.03  1063    1</span></span>
<span><span class="co">#&gt; optima[1] 2.01       0 0.04 1.93 1.99 2.01 2.03  2.09  2496    1</span></span>
<span><span class="co">#&gt; optima[2] 0.94       0 0.09 0.70 0.90 0.95 0.99  1.07  1167    1</span></span>
<span><span class="co">#&gt; beta[1]   0.25       0 0.01 0.24 0.25 0.25 0.26  0.27  3574    1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Sat Oct 11 15:31:35 2025.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.direct</span><span class="op">)</span> <span class="co">#rstan::extract posterior distribution</span></span></code></pre></div>
>>>>>>> dev-fixes-blouch1.0
<p>Now lets look at the prior vs. posterior plots for the parameters
Half-life plot</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a>hl.post<span class="ot">&lt;-</span><span class="fu">data.frame</span>(post<span class="sc">$</span>hl)</span>
<span id="cb45-2"><a href="#cb45-2" tabindex="-1"></a><span class="fu">names</span>(hl.post)<span class="ot">&lt;-</span><span class="st">&quot;post.hl.sims&quot;</span></span>
<span id="cb45-3"><a href="#cb45-3" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" tabindex="-1"></a>hl.plot<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb45-5"><a href="#cb45-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(prior.hl.sims,<span class="at">fill=</span><span class="st">&quot;prior.hl.sims&quot;</span>),<span class="at">alpha=</span><span class="fl">0.2</span>,<span class="at">data=</span>hl.sims)<span class="sc">+</span></span>
<span id="cb45-6"><a href="#cb45-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(post.hl.sims,<span class="at">fill=</span><span class="st">&quot;post.hl.sims&quot;</span>),<span class="at">alpha=</span><span class="fl">0.2</span>,<span class="at">data=</span>hl.post)<span class="sc">+</span></span>
<span id="cb45-7"><a href="#cb45-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb45-8"><a href="#cb45-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb45-9"><a href="#cb45-9" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(),</span>
<span id="cb45-10"><a href="#cb45-10" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb45-11"><a href="#cb45-11" tabindex="-1"></a>  </span>
<span id="cb45-12"><a href="#cb45-12" tabindex="-1"></a>  <span class="co">#labs(title=&quot;Prior vs. Posterior Distribution &quot;,x=&quot;Half-life&quot;, y = &quot;Density&quot;)+</span></span>
<span id="cb45-13"><a href="#cb45-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title=</span><span class="st">&quot;&quot;</span>,<span class="at">x=</span><span class="st">&quot;Half-life&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Density&quot;</span>)<span class="sc">+</span></span>
<span id="cb45-14"><a href="#cb45-14" tabindex="-1"></a>  </span>
<span id="cb45-15"><a href="#cb45-15" tabindex="-1"></a>  <span class="co">#scale_fill_manual(labels=c(&quot;Posterior&quot;,&quot;Prior&quot;))+</span></span>
<span id="cb45-16"><a href="#cb45-16" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept=</span><span class="fu">c</span>(hl),<span class="at">linetype=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb45-17"><a href="#cb45-17" tabindex="-1"></a>  ggsci<span class="sc">::</span><span class="fu">scale_fill_npg</span>(<span class="at">name=</span><span class="st">&quot;&quot;</span>,<span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;Posterior&quot;</span>,<span class="st">&quot;Prior&quot;</span>))</span>
<span id="cb45-18"><a href="#cb45-18" tabindex="-1"></a></span>
<span id="cb45-19"><a href="#cb45-19" tabindex="-1"></a>hl.plot</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-26-1.png" width="700" /></p>
<p>Vy Prior vs. posterior plot</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" tabindex="-1"></a>vy.post<span class="ot">&lt;-</span><span class="fu">data.frame</span>(post<span class="sc">$</span>vy)</span>
<span id="cb46-2"><a href="#cb46-2" tabindex="-1"></a><span class="fu">names</span>(vy.post)<span class="ot">&lt;-</span><span class="st">&quot;post.vy.sims&quot;</span></span>
<span id="cb46-3"><a href="#cb46-3" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" tabindex="-1"></a>vy.plot<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb46-6"><a href="#cb46-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(prior.vy.sims,<span class="at">fill=</span><span class="st">&quot;prior.vy.sims&quot;</span>),<span class="at">alpha=</span><span class="fl">0.2</span>,<span class="at">data=</span>vy.sims)<span class="sc">+</span></span>
<span id="cb46-7"><a href="#cb46-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(post.vy.sims,<span class="at">fill=</span><span class="st">&quot;post.vy.sims&quot;</span>),<span class="at">alpha=</span><span class="fl">0.2</span>,<span class="at">data=</span>vy.post)<span class="sc">+</span></span>
<span id="cb46-8"><a href="#cb46-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb46-9"><a href="#cb46-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb46-10"><a href="#cb46-10" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(),</span>
<span id="cb46-11"><a href="#cb46-11" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb46-12"><a href="#cb46-12" tabindex="-1"></a>  </span>
<span id="cb46-13"><a href="#cb46-13" tabindex="-1"></a>  <span class="co">#labs(title=&quot;Prior vs. Posterior Distribution &quot;,x=&quot;vy&quot;, y = &quot;Density&quot;)+</span></span>
<span id="cb46-14"><a href="#cb46-14" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title=</span><span class="st">&quot;&quot;</span>,<span class="at">x=</span><span class="st">&quot;vy&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Density&quot;</span>)<span class="sc">+</span></span>
<span id="cb46-15"><a href="#cb46-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept=</span><span class="fu">c</span>(vy),<span class="at">linetype=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb46-16"><a href="#cb46-16" tabindex="-1"></a>  </span>
<span id="cb46-17"><a href="#cb46-17" tabindex="-1"></a>  <span class="co">#scale_fill_manual(labels=c(&quot;Posterior&quot;,&quot;Prior&quot;))+</span></span>
<span id="cb46-18"><a href="#cb46-18" tabindex="-1"></a>  ggsci<span class="sc">::</span><span class="fu">scale_fill_npg</span>(<span class="at">name=</span><span class="st">&quot;&quot;</span>,<span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;Posterior&quot;</span>,<span class="st">&quot;Prior&quot;</span>))</span>
<span id="cb46-19"><a href="#cb46-19" tabindex="-1"></a></span>
<span id="cb46-20"><a href="#cb46-20" tabindex="-1"></a>vy.plot</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-27-1.png" width="700" /></p>
<p>Prior versus posterior on how shared branch lengths correspond to
covariance</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" tabindex="-1"></a><span class="fu">plot</span>( <span class="cn">NULL</span> , <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>) , <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>) , <span class="at">xlab=</span><span class="st">&quot;Time since MRCA&quot;</span> , <span class="at">ylab=</span><span class="st">&quot;Covariance&quot;</span> ,<span class="at">cex.axis=</span><span class="fl">0.75</span>, <span class="at">mgp=</span><span class="fu">c</span>(<span class="fl">1.25</span>,<span class="fl">0.25</span>,<span class="dv">0</span>),<span class="at">tcl=</span><span class="sc">-</span><span class="fl">0.25</span>)</span>
<span id="cb47-2"><a href="#cb47-2" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>){</span>
<span id="cb47-3"><a href="#cb47-3" tabindex="-1"></a>  <span class="fu">curve</span>(sigma2_y.sims[i,] <span class="sc">/</span>(<span class="dv">2</span> <span class="sc">*</span> a.sims[i,]) <span class="sc">*</span> ((<span class="dv">1</span> <span class="sc">-</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> a.sims[i,] <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>(x<span class="sc">/</span><span class="dv">2</span>)))) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>a.sims[i,] <span class="sc">*</span> x)) , <span class="at">add=</span><span class="cn">TRUE</span> , <span class="at">lwd=</span><span class="dv">4</span> , <span class="at">col=</span>rethinking<span class="sc">::</span><span class="fu">col.alpha</span>(<span class="dv">1</span>,<span class="fl">0.15</span>))</span>
<span id="cb47-4"><a href="#cb47-4" tabindex="-1"></a>}</span>
<span id="cb47-5"><a href="#cb47-5" tabindex="-1"></a></span>
<span id="cb47-6"><a href="#cb47-6" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>){</span>
<span id="cb47-7"><a href="#cb47-7" tabindex="-1"></a>  <span class="fu">curve</span>(post<span class="sc">$</span>sigma2_y[i] <span class="sc">/</span>(<span class="dv">2</span> <span class="sc">*</span> post<span class="sc">$</span>a[i]) <span class="sc">*</span> ((<span class="dv">1</span> <span class="sc">-</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> post<span class="sc">$</span>a[i] <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>(x<span class="sc">/</span><span class="dv">2</span>)))) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>post<span class="sc">$</span>a[i] <span class="sc">*</span> x)) , <span class="at">add=</span><span class="cn">TRUE</span> , <span class="at">lwd=</span><span class="dv">4</span> , <span class="at">col=</span>rethinking<span class="sc">::</span><span class="fu">col.alpha</span>(<span class="dv">2</span>,<span class="fl">0.5</span>))</span>
<span id="cb47-8"><a href="#cb47-8" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-28-1.png" width="700" /></p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" tabindex="-1"></a></span>
<span id="cb48-2"><a href="#cb48-2" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="fl">0.25</span>,<span class="fl">0.25</span>))</span>
<span id="cb48-3"><a href="#cb48-3" tabindex="-1"></a>covariance.plot <span class="ot">&lt;-</span> <span class="fu">recordPlot</span>()</span>
<span id="cb48-4"><a href="#cb48-4" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb48-5"><a href="#cb48-5" tabindex="-1"></a><span class="co">#&gt; null device </span></span>
<span id="cb48-6"><a href="#cb48-6" tabindex="-1"></a><span class="co">#&gt;           1</span></span>
<span id="cb48-7"><a href="#cb48-7" tabindex="-1"></a>covariance.plot</span></code></pre></div>
<p>Prior vs. Posterior Plot for Regression</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" tabindex="-1"></a>optima.sims<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="dv">100</span>,optima.prior[<span class="dv">1</span>],optima.prior[<span class="dv">2</span>])</span>
<span id="cb49-2"><a href="#cb49-2" tabindex="-1"></a>beta.sims<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="at">n=</span><span class="dv">100</span>,beta.prior[<span class="dv">1</span>],beta.prior[<span class="dv">2</span>])</span>
<span id="cb49-3"><a href="#cb49-3" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" tabindex="-1"></a>optima.post<span class="ot">&lt;-</span>post<span class="sc">$</span>optima</span>
<span id="cb49-5"><a href="#cb49-5" tabindex="-1"></a>beta.post<span class="ot">&lt;-</span><span class="fu">data.frame</span>(post<span class="sc">$</span>beta)</span>
<span id="cb49-6"><a href="#cb49-6" tabindex="-1"></a><span class="fu">names</span>(beta.post)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">&quot;post.beta.1&quot;</span>)</span>
<span id="cb49-7"><a href="#cb49-7" tabindex="-1"></a></span>
<span id="cb49-8"><a href="#cb49-8" tabindex="-1"></a>mu.link<span class="fl">.11</span><span class="ot">&lt;-</span><span class="cf">function</span>(x.seq){optima.post[,<span class="dv">1</span>]<span class="sc">+</span>x.seq<span class="sc">*</span>beta.post[,<span class="dv">1</span>]}</span>
<span id="cb49-9"><a href="#cb49-9" tabindex="-1"></a>mu.link<span class="fl">.12</span><span class="ot">&lt;-</span><span class="cf">function</span>(x.seq){optima.post[,<span class="dv">2</span>]<span class="sc">+</span>x.seq<span class="sc">*</span>beta.post[,<span class="dv">1</span>]}</span>
<span id="cb49-10"><a href="#cb49-10" tabindex="-1"></a></span>
<span id="cb49-11"><a href="#cb49-11" tabindex="-1"></a>x.seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from=</span><span class="fu">min</span>(X), <span class="at">to=</span><span class="fu">max</span>(X) , <span class="at">length.out=</span><span class="dv">100</span>)</span>
<span id="cb49-12"><a href="#cb49-12" tabindex="-1"></a>mu<span class="fl">.11</span> <span class="ot">&lt;-</span> <span class="fu">sapply</span>(x.seq , mu.link<span class="fl">.11</span> )</span>
<span id="cb49-13"><a href="#cb49-13" tabindex="-1"></a>mu<span class="fl">.12</span> <span class="ot">&lt;-</span> <span class="fu">sapply</span>(x.seq , mu.link<span class="fl">.12</span> )</span>
<span id="cb49-14"><a href="#cb49-14" tabindex="-1"></a></span>
<span id="cb49-15"><a href="#cb49-15" tabindex="-1"></a></span>
<span id="cb49-16"><a href="#cb49-16" tabindex="-1"></a>mu.mean<span class="fl">.11</span><span class="ot">&lt;-</span><span class="fu">colMeans</span>(mu<span class="fl">.11</span>)</span>
<span id="cb49-17"><a href="#cb49-17" tabindex="-1"></a>mu.mean<span class="fl">.12</span><span class="ot">&lt;-</span><span class="fu">colMeans</span>(mu<span class="fl">.12</span>)</span>
<span id="cb49-18"><a href="#cb49-18" tabindex="-1"></a></span>
<span id="cb49-19"><a href="#cb49-19" tabindex="-1"></a>mu.mean<span class="fl">.11</span><span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">as.numeric</span>(mu.mean<span class="fl">.11</span>))</span>
<span id="cb49-20"><a href="#cb49-20" tabindex="-1"></a>mu.mean<span class="fl">.12</span><span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">as.numeric</span>(mu.mean<span class="fl">.12</span>))</span>
<span id="cb49-21"><a href="#cb49-21" tabindex="-1"></a></span>
<span id="cb49-22"><a href="#cb49-22" tabindex="-1"></a><span class="fu">names</span>(mu.mean<span class="fl">.11</span>)<span class="ot">&lt;-</span><span class="st">&quot;mu.mean.11&quot;</span></span>
<span id="cb49-23"><a href="#cb49-23" tabindex="-1"></a><span class="fu">names</span>(mu.mean<span class="fl">.12</span>)<span class="ot">&lt;-</span><span class="st">&quot;mu.mean.12&quot;</span></span>
<span id="cb49-24"><a href="#cb49-24" tabindex="-1"></a></span>
<span id="cb49-25"><a href="#cb49-25" tabindex="-1"></a>mu.CI<span class="fl">.11</span> <span class="ot">&lt;-</span> <span class="fu">apply</span>( mu<span class="fl">.11</span> , <span class="at">MARGIN=</span><span class="dv">2</span>, <span class="at">FUN=</span>rethinking<span class="sc">::</span>PI , <span class="at">prob=</span><span class="fl">0.89</span> )</span>
<span id="cb49-26"><a href="#cb49-26" tabindex="-1"></a>mu.CI<span class="fl">.12</span> <span class="ot">&lt;-</span> <span class="fu">apply</span>( mu<span class="fl">.12</span> , <span class="at">MARGIN=</span><span class="dv">2</span>, <span class="at">FUN=</span>rethinking<span class="sc">::</span>PI , <span class="at">prob=</span><span class="fl">0.89</span> )</span>
<span id="cb49-27"><a href="#cb49-27" tabindex="-1"></a></span>
<span id="cb49-28"><a href="#cb49-28" tabindex="-1"></a></span>
<span id="cb49-29"><a href="#cb49-29" tabindex="-1"></a>mu.CI<span class="fl">.11</span><span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">t</span>(<span class="fu">data.frame</span>(mu.CI<span class="fl">.11</span>)),x.seq)</span>
<span id="cb49-30"><a href="#cb49-30" tabindex="-1"></a>mu.CI<span class="fl">.12</span><span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">t</span>(<span class="fu">data.frame</span>(mu.CI<span class="fl">.12</span>)),x.seq)</span>
<span id="cb49-31"><a href="#cb49-31" tabindex="-1"></a></span>
<span id="cb49-32"><a href="#cb49-32" tabindex="-1"></a><span class="fu">names</span>(mu.CI<span class="fl">.11</span>)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">&quot;min.5.5&quot;</span>,<span class="st">&quot;max.94.5&quot;</span>,<span class="st">&quot;x.seq&quot;</span>)</span>
<span id="cb49-33"><a href="#cb49-33" tabindex="-1"></a><span class="fu">names</span>(mu.CI<span class="fl">.12</span>)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">&quot;min.5.5&quot;</span>,<span class="st">&quot;max.94.5&quot;</span>,<span class="st">&quot;x.seq&quot;</span>)</span>
<span id="cb49-34"><a href="#cb49-34" tabindex="-1"></a></span>
<span id="cb49-35"><a href="#cb49-35" tabindex="-1"></a><span class="co">#df&lt;-data.frame(Y=stan_sim_data$Y,X=stan_sim_data$direct_cov)</span></span>
<span id="cb49-36"><a href="#cb49-36" tabindex="-1"></a>df<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">Y=</span>dat<span class="sc">$</span>Y_obs,<span class="at">X=</span>dat<span class="sc">$</span>X_obs,<span class="at">Regimes=</span>regimes_tip)</span>
<span id="cb49-37"><a href="#cb49-37" tabindex="-1"></a>df11<span class="ot">&lt;-</span><span class="fu">data.frame</span>(x.seq,mu.mean<span class="fl">.11</span>)</span>
<span id="cb49-38"><a href="#cb49-38" tabindex="-1"></a>df12<span class="ot">&lt;-</span><span class="fu">data.frame</span>(x.seq,mu.mean<span class="fl">.12</span>)</span>
<span id="cb49-39"><a href="#cb49-39" tabindex="-1"></a></span>
<span id="cb49-40"><a href="#cb49-40" tabindex="-1"></a><span class="co">#slope.prior.plot&lt;-ggplot(data=reg.trdata$dat,aes(y=Sim1,x=X))+</span></span>
<span id="cb49-41"><a href="#cb49-41" tabindex="-1"></a>slope.plot<span class="fl">.1</span><span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>()<span class="sc">+</span>  </span>
<span id="cb49-42"><a href="#cb49-42" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">data=</span>df,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y=</span>Y,<span class="at">x=</span>X,<span class="at">color=</span><span class="fu">as.factor</span>(Regimes)))<span class="sc">+</span></span>
<span id="cb49-43"><a href="#cb49-43" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_abline</span>(<span class="at">intercept=</span>optima.sims,<span class="at">slope=</span>beta.sims,<span class="at">alpha=</span><span class="fl">0.05</span>)<span class="sc">+</span> <span class="co">#Prior</span></span>
<span id="cb49-44"><a href="#cb49-44" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_abline</span>(<span class="at">intercept=</span>beta[<span class="dv">1</span>],<span class="at">slope=</span>beta[<span class="dv">3</span>],<span class="at">alpha=</span><span class="fl">0.5</span>,<span class="at">linetype=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb49-45"><a href="#cb49-45" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_abline</span>(<span class="at">intercept=</span>beta[<span class="dv">2</span>],<span class="at">slope=</span>beta[<span class="dv">3</span>],<span class="at">alpha=</span><span class="fl">0.5</span>,<span class="at">linetype=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb49-46"><a href="#cb49-46" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_ribbon</span>(<span class="at">data=</span>mu.CI<span class="fl">.11</span>,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>x.seq,<span class="at">ymin=</span>min.<span class="fl">5.5</span>,<span class="at">ymax=</span>max.<span class="fl">94.5</span>),<span class="at">linetype=</span><span class="dv">2</span>,<span class="at">alpha=</span><span class="fl">0.1</span>)<span class="sc">+</span></span>
<span id="cb49-47"><a href="#cb49-47" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">data=</span>df11,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>x.seq,<span class="at">y=</span>mu.mean<span class="fl">.11</span>),<span class="at">linetype=</span><span class="dv">1</span>,<span class="at">linewidth=</span><span class="dv">1</span>,<span class="at">alpha=</span><span class="fl">0.3</span>)<span class="sc">+</span></span>
<span id="cb49-48"><a href="#cb49-48" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_ribbon</span>(<span class="at">data=</span>mu.CI<span class="fl">.12</span>,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>x.seq,<span class="at">ymin=</span>min.<span class="fl">5.5</span>,<span class="at">ymax=</span>max.<span class="fl">94.5</span>),<span class="at">linetype=</span><span class="dv">2</span>,<span class="at">alpha=</span><span class="fl">0.1</span>)<span class="sc">+</span></span>
<span id="cb49-49"><a href="#cb49-49" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">data=</span>df12,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>x.seq,<span class="at">y=</span>mu.mean<span class="fl">.12</span>),<span class="at">linetype=</span><span class="dv">1</span>,<span class="at">linewidth=</span><span class="dv">1</span>,<span class="at">alpha=</span><span class="fl">0.3</span>)<span class="sc">+</span></span>
<span id="cb49-50"><a href="#cb49-50" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb49-51"><a href="#cb49-51" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb49-52"><a href="#cb49-52" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(),</span>
<span id="cb49-53"><a href="#cb49-53" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb49-54"><a href="#cb49-54" tabindex="-1"></a>  </span>
<span id="cb49-55"><a href="#cb49-55" tabindex="-1"></a>  <span class="co">#ggtitle(&quot;Prior vs. Posterior for Intercept and Slope&quot;)+</span></span>
<span id="cb49-56"><a href="#cb49-56" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ylab</span>(<span class="st">&quot;Y&quot;</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">xlab</span>(<span class="st">&quot;Direct Effect X&quot;</span>)<span class="sc">+</span>ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">color=</span><span class="st">&quot;Regimes&quot;</span>)<span class="sc">+</span></span>
<span id="cb49-57"><a href="#cb49-57" tabindex="-1"></a>  ggsci<span class="sc">::</span><span class="fu">scale_color_npg</span>()</span>
<span id="cb49-58"><a href="#cb49-58" tabindex="-1"></a></span>
<span id="cb49-59"><a href="#cb49-59" tabindex="-1"></a>slope.plot<span class="fl">.1</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-29-1.png" width="700" /></p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" tabindex="-1"></a><span class="co">#Label points</span></span></code></pre></div>
<p>Here is the Multilevel version of the same model</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" tabindex="-1"></a><span class="do">############################################################################################################</span></span>
<span id="cb51-2"><a href="#cb51-2" tabindex="-1"></a><span class="co">#Set Priors</span></span>
<span id="cb51-3"><a href="#cb51-3" tabindex="-1"></a>hl.prior<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fu">log</span>(<span class="fl">0.25</span>),<span class="fl">0.75</span>)</span>
<span id="cb51-4"><a href="#cb51-4" tabindex="-1"></a>vy.prior<span class="ot">&lt;-</span><span class="dv">5</span></span>
<span id="cb51-5"><a href="#cb51-5" tabindex="-1"></a>optima.prior<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="fl">0.5</span>) <span class="co">#Informed by linear model</span></span>
<span id="cb51-6"><a href="#cb51-6" tabindex="-1"></a>beta.prior<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fl">0.25</span>,<span class="fl">0.25</span>) <span class="co">#Informed by linear model</span></span>
<span id="cb51-7"><a href="#cb51-7" tabindex="-1"></a>sigma.prior<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span></code></pre></div>
<p>We will use the helper function blouch.reg.direct.prep() to setup the
dat file for Stan. Here “Z_direct” is the number of predictors, and
“regimes” is the name of the regime column in trdata$dat.</p>
<<<<<<< HEAD
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" tabindex="-1"></a><span class="do">############################################################################################################</span></span>
<span id="cb52-2"><a href="#cb52-2" tabindex="-1"></a><span class="co">#Test Blouch prep code - Regimes + Direct Efffect model</span></span>
<span id="cb52-3"><a href="#cb52-3" tabindex="-1"></a>dat<span class="ot">&lt;-</span><span class="fu">blouch.reg.direct.mlm.prep</span>(trdata,<span class="st">&quot;Y_with_error&quot;</span>,<span class="st">&quot;Y_error&quot;</span>,<span class="st">&quot;X_with_error&quot;</span>,<span class="st">&quot;X_error&quot;</span>,<span class="at">Z_direct=</span><span class="dv">1</span>,<span class="st">&quot;regimes&quot;</span>,hl.prior,vy.prior,optima.prior,beta.prior,sigma.prior)</span></code></pre></div>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" tabindex="-1"></a>fit.reg.direct.mlm.vi<span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">sampling</span>(<span class="at">object =</span> blouch<span class="sc">:::</span>stanmodels<span class="sc">$</span>blouchOU_reg_direct_mlm_vi,<span class="at">data =</span> dat,<span class="at">chains =</span> <span class="dv">2</span>,<span class="at">cores=</span><span class="dv">2</span>,<span class="at">iter =</span> <span class="dv">2000</span>)</span>
<span id="cb53-2"><a href="#cb53-2" tabindex="-1"></a><span class="co">#&gt; Found more than one class &quot;stanfit&quot; in cache; using the first, from namespace &#39;rstan&#39;</span></span>
<span id="cb53-3"><a href="#cb53-3" tabindex="-1"></a><span class="co">#&gt; Also defined by &#39;rethinking&#39;</span></span>
<span id="cb53-4"><a href="#cb53-4" tabindex="-1"></a><span class="co">#&gt; Found more than one class &quot;stanfit&quot; in cache; using the first, from namespace &#39;rstan&#39;</span></span>
<span id="cb53-5"><a href="#cb53-5" tabindex="-1"></a><span class="co">#&gt; Also defined by &#39;rethinking&#39;</span></span></code></pre></div>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" tabindex="-1"></a><span class="fu">print</span>(fit.reg.direct.mlm.vi,<span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;hl&quot;</span>,<span class="st">&quot;vy&quot;</span>,<span class="st">&quot;optima&quot;</span>,<span class="st">&quot;optima_bar&quot;</span>,<span class="st">&quot;beta&quot;</span>,<span class="st">&quot;sigma&quot;</span>))</span>
<span id="cb54-2"><a href="#cb54-2" tabindex="-1"></a><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_mlm_vi.</span></span>
<span id="cb54-3"><a href="#cb54-3" tabindex="-1"></a><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span id="cb54-4"><a href="#cb54-4" tabindex="-1"></a><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span id="cb54-5"><a href="#cb54-5" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb54-6"><a href="#cb54-6" tabindex="-1"></a><span class="co">#&gt;            mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span id="cb54-7"><a href="#cb54-7" tabindex="-1"></a><span class="co">#&gt; hl         0.18    0.00 0.10 0.06 0.11 0.15 0.22  0.42   767    1</span></span>
<span id="cb54-8"><a href="#cb54-8" tabindex="-1"></a><span class="co">#&gt; vy         0.02    0.00 0.01 0.01 0.01 0.02 0.02  0.03   903    1</span></span>
<span id="cb54-9"><a href="#cb54-9" tabindex="-1"></a><span class="co">#&gt; optima[1]  2.01    0.00 0.04 1.93 1.99 2.01 2.03  2.09  2744    1</span></span>
<span id="cb54-10"><a href="#cb54-10" tabindex="-1"></a><span class="co">#&gt; optima[2]  0.91    0.00 0.12 0.61 0.88 0.94 0.98  1.06   870    1</span></span>
<span id="cb54-11"><a href="#cb54-11" tabindex="-1"></a><span class="co">#&gt; optima_bar 1.76    0.01 0.39 1.06 1.49 1.74 2.00  2.59  3671    1</span></span>
<span id="cb54-12"><a href="#cb54-12" tabindex="-1"></a><span class="co">#&gt; beta[1]    0.26    0.00 0.01 0.24 0.25 0.26 0.26  0.27  3455    1</span></span>
<span id="cb54-13"><a href="#cb54-13" tabindex="-1"></a><span class="co">#&gt; sigma      0.91    0.01 0.44 0.34 0.59 0.81 1.15  2.04  2971    1</span></span>
<span id="cb54-14"><a href="#cb54-14" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb54-15"><a href="#cb54-15" tabindex="-1"></a><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Fri Oct 10 16:20:55 2025.</span></span>
<span id="cb54-16"><a href="#cb54-16" tabindex="-1"></a><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span id="cb54-17"><a href="#cb54-17" tabindex="-1"></a><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span id="cb54-18"><a href="#cb54-18" tabindex="-1"></a><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span id="cb54-19"><a href="#cb54-19" tabindex="-1"></a>post<span class="ot">&lt;-</span>rstan<span class="sc">::</span><span class="fu">extract</span>(fit.reg.direct.mlm.vi) <span class="co">#rstan::extract posterior distribution</span></span></code></pre></div>
<p>And finally the non-centered version of the Multilevel model</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" tabindex="-1"></a>fit.reg.direct.mlm.vi<span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">sampling</span>(<span class="at">object =</span> blouch<span class="sc">:::</span>stanmodels<span class="sc">$</span>blouchOU_reg_direct_mlm_vi_nc,<span class="at">data =</span> dat,<span class="at">chains =</span> <span class="dv">2</span>,<span class="at">cores=</span><span class="dv">2</span>,<span class="at">iter =</span> <span class="dv">2000</span>)</span>
<span id="cb55-2"><a href="#cb55-2" tabindex="-1"></a><span class="co">#&gt; Found more than one class &quot;stanfit&quot; in cache; using the first, from namespace &#39;rstan&#39;</span></span>
<span id="cb55-3"><a href="#cb55-3" tabindex="-1"></a><span class="co">#&gt; Also defined by &#39;rethinking&#39;</span></span>
<span id="cb55-4"><a href="#cb55-4" tabindex="-1"></a><span class="co">#&gt; Found more than one class &quot;stanfit&quot; in cache; using the first, from namespace &#39;rstan&#39;</span></span>
<span id="cb55-5"><a href="#cb55-5" tabindex="-1"></a><span class="co">#&gt; Also defined by &#39;rethinking&#39;</span></span>
<span id="cb55-6"><a href="#cb55-6" tabindex="-1"></a><span class="co">#&gt; Warning: There were 14 divergent transitions after warmup. See</span></span>
<span id="cb55-7"><a href="#cb55-7" tabindex="-1"></a><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span id="cb55-8"><a href="#cb55-8" tabindex="-1"></a><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span id="cb55-9"><a href="#cb55-9" tabindex="-1"></a><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span></code></pre></div>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" tabindex="-1"></a><span class="fu">print</span>(fit.reg.direct.mlm.vi,<span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;hl&quot;</span>,<span class="st">&quot;vy&quot;</span>,<span class="st">&quot;optima&quot;</span>,<span class="st">&quot;optima_bar&quot;</span>,<span class="st">&quot;beta&quot;</span>,<span class="st">&quot;sigma&quot;</span>))</span>
<span id="cb56-2"><a href="#cb56-2" tabindex="-1"></a><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_mlm_vi_nc.</span></span>
<span id="cb56-3"><a href="#cb56-3" tabindex="-1"></a><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span id="cb56-4"><a href="#cb56-4" tabindex="-1"></a><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span id="cb56-5"><a href="#cb56-5" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb56-6"><a href="#cb56-6" tabindex="-1"></a><span class="co">#&gt;            mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span id="cb56-7"><a href="#cb56-7" tabindex="-1"></a><span class="co">#&gt; hl         0.18    0.00 0.10 0.06 0.11 0.15 0.22  0.43  1104    1</span></span>
<span id="cb56-8"><a href="#cb56-8" tabindex="-1"></a><span class="co">#&gt; vy         0.02    0.00 0.01 0.01 0.01 0.02 0.02  0.03  1086    1</span></span>
<span id="cb56-9"><a href="#cb56-9" tabindex="-1"></a><span class="co">#&gt; optima[1]  2.01    0.00 0.04 1.92 1.98 2.01 2.03  2.10  1947    1</span></span>
<span id="cb56-10"><a href="#cb56-10" tabindex="-1"></a><span class="co">#&gt; optima[2]  0.92    0.00 0.12 0.61 0.88 0.94 0.99  1.06  1210    1</span></span>
<span id="cb56-11"><a href="#cb56-11" tabindex="-1"></a><span class="co">#&gt; optima_bar 1.77    0.01 0.38 1.06 1.52 1.76 1.99  2.61  1408    1</span></span>
<span id="cb56-12"><a href="#cb56-12" tabindex="-1"></a><span class="co">#&gt; beta[1]    0.25    0.00 0.01 0.24 0.25 0.26 0.26  0.27  4228    1</span></span>
<span id="cb56-13"><a href="#cb56-13" tabindex="-1"></a><span class="co">#&gt; sigma      0.90    0.01 0.42 0.34 0.59 0.82 1.12  1.93  1359    1</span></span>
<span id="cb56-14"><a href="#cb56-14" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb56-15"><a href="#cb56-15" tabindex="-1"></a><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Fri Oct 10 16:22:24 2025.</span></span>
<span id="cb56-16"><a href="#cb56-16" tabindex="-1"></a><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span id="cb56-17"><a href="#cb56-17" tabindex="-1"></a><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span id="cb56-18"><a href="#cb56-18" tabindex="-1"></a><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span id="cb56-19"><a href="#cb56-19" tabindex="-1"></a>post<span class="ot">&lt;-</span>rstan<span class="sc">::</span><span class="fu">extract</span>(fit.reg.direct.mlm.vi) <span class="co">#rstan::extract posterior distribution</span></span></code></pre></div>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span></code></pre></div>
=======
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Test Blouch prep code - Regimes + Direct Efffect model</span></span>
<span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/blouch.reg.direct.mlm.prep.html">blouch.reg.direct.mlm.prep</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="st">"Y_with_error"</span>,<span class="st">"Y_error"</span>,<span class="st">"X_with_error"</span>,<span class="st">"X_error"</span>,Z_direct<span class="op">=</span><span class="fl">1</span>,<span class="st">"regimes"</span>,<span class="va">hl.prior</span>,<span class="va">vy.prior</span>,<span class="va">optima.prior</span>,<span class="va">beta.prior</span>,<span class="va">sigma.prior</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.direct.mlm.vi</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_direct_mlm_vi</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores<span class="op">=</span><span class="fl">2</span>,iter <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span></code></pre></div>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.direct.mlm.vi</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"optima_bar"</span>,<span class="st">"beta"</span>,<span class="st">"sigma"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_mlm_vi.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;            mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl         0.18    0.00 0.10 0.06 0.11 0.15 0.22  0.42   767    1</span></span>
<span><span class="co">#&gt; vy         0.02    0.00 0.01 0.01 0.01 0.02 0.02  0.03   903    1</span></span>
<span><span class="co">#&gt; optima[1]  2.01    0.00 0.04 1.93 1.99 2.01 2.03  2.09  2744    1</span></span>
<span><span class="co">#&gt; optima[2]  0.91    0.00 0.12 0.61 0.88 0.94 0.98  1.06   870    1</span></span>
<span><span class="co">#&gt; optima_bar 1.76    0.01 0.39 1.06 1.49 1.74 2.00  2.59  3671    1</span></span>
<span><span class="co">#&gt; beta[1]    0.26    0.00 0.01 0.24 0.25 0.26 0.26  0.27  3455    1</span></span>
<span><span class="co">#&gt; sigma      0.91    0.01 0.44 0.34 0.59 0.81 1.15  2.04  2971    1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Sat Oct 11 15:32:04 2025.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.direct.mlm.vi</span><span class="op">)</span> <span class="co">#rstan::extract posterior distribution</span></span></code></pre></div>
<p>And finally the non-centered version of the Multilevel model</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.direct.mlm.vi</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_direct_mlm_vi_nc</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores<span class="op">=</span><span class="fl">2</span>,iter <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Warning: There were 14 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span></code></pre></div>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.direct.mlm.vi</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"optima_bar"</span>,<span class="st">"beta"</span>,<span class="st">"sigma"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_mlm_vi_nc.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;            mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl         0.18    0.00 0.10 0.06 0.11 0.15 0.22  0.43  1104    1</span></span>
<span><span class="co">#&gt; vy         0.02    0.00 0.01 0.01 0.01 0.02 0.02  0.03  1086    1</span></span>
<span><span class="co">#&gt; optima[1]  2.01    0.00 0.04 1.92 1.98 2.01 2.03  2.10  1947    1</span></span>
<span><span class="co">#&gt; optima[2]  0.92    0.00 0.12 0.61 0.88 0.94 0.99  1.06  1210    1</span></span>
<span><span class="co">#&gt; optima_bar 1.77    0.01 0.38 1.06 1.52 1.76 1.99  2.61  1408    1</span></span>
<span><span class="co">#&gt; beta[1]    0.25    0.00 0.01 0.24 0.25 0.26 0.26  0.27  4228    1</span></span>
<span><span class="co">#&gt; sigma      0.90    0.01 0.42 0.34 0.59 0.82 1.12  1.93  1359    1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Sat Oct 11 15:33:07 2025.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.direct.mlm.vi</span><span class="op">)</span> <span class="co">#rstan::extract posterior distribution</span></span></code></pre></div>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
>>>>>>> dev-fixes-blouch1.0
</div>
<div id="multi-optima-adaptive-model" class="section level2">
<h2>Multi-optima Adaptive Model</h2>
<p>We will now include both regimes painted on the tree and an adaptive
predictor</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" tabindex="-1"></a><span class="co">#Create phylogeny</span></span>
<span id="cb58-2"><a href="#cb58-2" tabindex="-1"></a><span class="do">########################################################################################################</span></span>
<span id="cb58-3"><a href="#cb58-3" tabindex="-1"></a>N<span class="ot">&lt;-</span><span class="dv">50</span> <span class="co">#Number of species</span></span>
<span id="cb58-4"><a href="#cb58-4" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">10</span>) <span class="co">#Set seed to get same random species each time</span></span>
<span id="cb58-5"><a href="#cb58-5" tabindex="-1"></a></span>
<span id="cb58-6"><a href="#cb58-6" tabindex="-1"></a>phy <span class="ot">&lt;-</span> ape<span class="sc">::</span><span class="fu">keep.tip</span>(tree<span class="fl">.10</span>K,<span class="fu">sample</span>(tree<span class="fl">.10</span>K<span class="sc">$</span>tip.label)[<span class="dv">1</span><span class="sc">:</span>N]) </span>
<span id="cb58-7"><a href="#cb58-7" tabindex="-1"></a>phy<span class="ot">&lt;-</span>ape<span class="sc">::</span><span class="fu">multi2di</span>(phy)</span>
<span id="cb58-8"><a href="#cb58-8" tabindex="-1"></a></span>
<span id="cb58-9"><a href="#cb58-9" tabindex="-1"></a>l.tree<span class="ot">&lt;-</span><span class="fu">max</span>(ape<span class="sc">::</span><span class="fu">branching.times</span>(phy)) <span class="do">## rescale tree to height 1</span></span>
<span id="cb58-10"><a href="#cb58-10" tabindex="-1"></a>phy<span class="sc">$</span>edge.length<span class="ot">&lt;-</span>phy<span class="sc">$</span>edge.length<span class="sc">/</span>l.tree </span>
<span id="cb58-11"><a href="#cb58-11" tabindex="-1"></a></span>
<span id="cb58-12"><a href="#cb58-12" tabindex="-1"></a>tip.label<span class="ot">&lt;-</span>phy<span class="sc">$</span>tip.label</span>
<span id="cb58-13"><a href="#cb58-13" tabindex="-1"></a></span>
<span id="cb58-14"><a href="#cb58-14" tabindex="-1"></a><span class="co">#Set regimes - manually - 2 regimes</span></span>
<span id="cb58-15"><a href="#cb58-15" tabindex="-1"></a><span class="co">#Locate nodes</span></span>
<span id="cb58-16"><a href="#cb58-16" tabindex="-1"></a><span class="fu">plot</span>(phy,<span class="at">no.margin=</span><span class="cn">TRUE</span>,<span class="at">edge.width=</span><span class="dv">2</span>,<span class="at">cex=</span><span class="fl">0.7</span>)</span>
<span id="cb58-17"><a href="#cb58-17" tabindex="-1"></a>ape<span class="sc">::</span><span class="fu">nodelabels</span>(<span class="at">frame=</span><span class="st">&quot;none&quot;</span>,<span class="at">adj=</span><span class="fu">c</span>(<span class="fl">1.1</span>,<span class="sc">-</span><span class="fl">0.4</span>))</span>
<span id="cb58-18"><a href="#cb58-18" tabindex="-1"></a>ape<span class="sc">::</span><span class="fu">tiplabels</span>()</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_adaptive_model_setup-1.png" width="700" /></p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" tabindex="-1"></a></span>
<span id="cb59-2"><a href="#cb59-2" tabindex="-1"></a><span class="co">#Paint Regimes on Tree</span></span>
<span id="cb59-3"><a href="#cb59-3" tabindex="-1"></a>shifts<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">84</span>) <span class="co">#Location of nodes with regime shifts</span></span>
<span id="cb59-4"><a href="#cb59-4" tabindex="-1"></a>trdata<span class="ot">&lt;-</span><span class="fu">data.frame</span>(phy<span class="sc">$</span>tip.label)</span>
<span id="cb59-5"><a href="#cb59-5" tabindex="-1"></a>trdata<span class="ot">&lt;-</span>treeplyr<span class="sc">::</span><span class="fu">make.treedata</span>(phy,trdata)</span>
<span id="cb59-6"><a href="#cb59-6" tabindex="-1"></a>trdata<span class="ot">&lt;-</span><span class="fu">set.converge.regimes</span>(trdata,shifts)</span>
<span id="cb59-7"><a href="#cb59-7" tabindex="-1"></a><span class="co">#&gt; [1] 1</span></span>
<span id="cb59-8"><a href="#cb59-8" tabindex="-1"></a><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb59-9"><a href="#cb59-9" tabindex="-1"></a><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb59-10"><a href="#cb59-10" tabindex="-1"></a><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb59-11"><a href="#cb59-11" tabindex="-1"></a><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span id="cb59-12"><a href="#cb59-12" tabindex="-1"></a><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb59-13"><a href="#cb59-13" tabindex="-1"></a><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span id="cb59-14"><a href="#cb59-14" tabindex="-1"></a><span class="co">#&gt; Levels: OU1 OU2</span></span>
<span id="cb59-15"><a href="#cb59-15" tabindex="-1"></a><span class="co">#&gt; [1] &quot;#E64B35FF&quot; &quot;#4DBBD5FF&quot;</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_adaptive_model_setup-2.png" width="700" /></p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" tabindex="-1"></a></span>
<span id="cb60-2"><a href="#cb60-2" tabindex="-1"></a><span class="co">#Check if manual setting code worked</span></span>
<span id="cb60-3"><a href="#cb60-3" tabindex="-1"></a>shifts.total<span class="ot">&lt;-</span><span class="fu">c</span>(trdata<span class="sc">$</span>dat<span class="sc">$</span>regimes,trdata<span class="sc">$</span>phy<span class="sc">$</span>node.label)</span>
<span id="cb60-4"><a href="#cb60-4" tabindex="-1"></a>edge.regimes <span class="ot">&lt;-</span> <span class="fu">factor</span>(shifts.total[trdata<span class="sc">$</span>phy<span class="sc">$</span>edge[,<span class="dv">2</span>]])</span>
<span id="cb60-5"><a href="#cb60-5" tabindex="-1"></a><span class="fu">print</span>(edge.regimes)</span>
<span id="cb60-6"><a href="#cb60-6" tabindex="-1"></a><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb60-7"><a href="#cb60-7" tabindex="-1"></a><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb60-8"><a href="#cb60-8" tabindex="-1"></a><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb60-9"><a href="#cb60-9" tabindex="-1"></a><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span id="cb60-10"><a href="#cb60-10" tabindex="-1"></a><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb60-11"><a href="#cb60-11" tabindex="-1"></a><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span id="cb60-12"><a href="#cb60-12" tabindex="-1"></a><span class="co">#&gt; Levels: OU1 OU2</span></span>
<span id="cb60-13"><a href="#cb60-13" tabindex="-1"></a></span>
<span id="cb60-14"><a href="#cb60-14" tabindex="-1"></a>reg.colors <span class="ot">&lt;-</span> ggsci<span class="sc">::</span><span class="fu">pal_aaas</span>(<span class="st">&quot;default&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>)(<span class="dv">2</span>)</span>
<span id="cb60-15"><a href="#cb60-15" tabindex="-1"></a><span class="fu">print</span>(reg.colors)</span>
<span id="cb60-16"><a href="#cb60-16" tabindex="-1"></a><span class="co">#&gt; [1] &quot;#3B4992B2&quot; &quot;#EE0000B2&quot;</span></span>
<span id="cb60-17"><a href="#cb60-17" tabindex="-1"></a><span class="fu">plot</span>(trdata<span class="sc">$</span>phy,<span class="at">edge.color =</span> reg.colors[edge.regimes], <span class="at">edge.width =</span> <span class="dv">1</span>, <span class="at">cex =</span> <span class="fl">0.2</span>)</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_adaptive_model_setup-3.png" width="700" /></p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" tabindex="-1"></a></span>
<span id="cb61-2"><a href="#cb61-2" tabindex="-1"></a><span class="co">#Phylogeny info</span></span>
<span id="cb61-3"><a href="#cb61-3" tabindex="-1"></a>n<span class="ot">&lt;-</span><span class="fu">length</span>(trdata<span class="sc">$</span>phy<span class="sc">$</span>tip.label)</span>
<span id="cb61-4"><a href="#cb61-4" tabindex="-1"></a></span>
<span id="cb61-5"><a href="#cb61-5" tabindex="-1"></a>regimes_internal <span class="ot">&lt;-</span>trdata<span class="sc">$</span>phy<span class="sc">$</span>node.label</span>
<span id="cb61-6"><a href="#cb61-6" tabindex="-1"></a>regimes_tip <span class="ot">&lt;-</span> trdata<span class="sc">$</span>dat<span class="sc">$</span>regimes</span>
<span id="cb61-7"><a href="#cb61-7" tabindex="-1"></a>regimes <span class="ot">&lt;-</span> <span class="fu">concat.factor</span>(regimes_tip, regimes_internal)</span>
<span id="cb61-8"><a href="#cb61-8" tabindex="-1"></a>anc_maps<span class="ot">&lt;-</span><span class="st">&quot;regimes&quot;</span></span>
<span id="cb61-9"><a href="#cb61-9" tabindex="-1"></a>lineages <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="cf">function</span>(e) <span class="fu">lineage.constructor</span>(trdata<span class="sc">$</span>phy, e, anc_maps, regimes)) <span class="co">#Trace lineage from tips (n) to root and determine regimes of each node or branch</span></span></code></pre></div>
<p>Simulate X and Y data using generative model</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" tabindex="-1"></a><span class="do">############################################################################################################</span></span>
<span id="cb62-2"><a href="#cb62-2" tabindex="-1"></a><span class="do">#########################</span></span>
<span id="cb62-3"><a href="#cb62-3" tabindex="-1"></a>hl<span class="ot">&lt;-</span><span class="fl">0.1</span> <span class="co">#0.1, 0.25, 0.75 - testing options</span></span>
<span id="cb62-4"><a href="#cb62-4" tabindex="-1"></a>a<span class="ot">&lt;-</span><span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">/</span>hl</span>
<span id="cb62-5"><a href="#cb62-5" tabindex="-1"></a>vy<span class="ot">&lt;-</span><span class="fl">0.01</span> <span class="co">#0.25,0.5 - testing options</span></span>
<span id="cb62-6"><a href="#cb62-6" tabindex="-1"></a>sigma2_y<span class="ot">&lt;-</span>vy<span class="sc">*</span>(<span class="dv">2</span><span class="sc">*</span>(<span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">/</span>hl));</span>
<span id="cb62-7"><a href="#cb62-7" tabindex="-1"></a></span>
<span id="cb62-8"><a href="#cb62-8" tabindex="-1"></a>vX0<span class="ot">&lt;-</span><span class="dv">0</span></span>
<span id="cb62-9"><a href="#cb62-9" tabindex="-1"></a>vY0 <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb62-10"><a href="#cb62-10" tabindex="-1"></a></span>
<span id="cb62-11"><a href="#cb62-11" tabindex="-1"></a>Z_adaptive<span class="ot">&lt;-</span><span class="dv">1</span></span>
<span id="cb62-12"><a href="#cb62-12" tabindex="-1"></a>sigma2_x<span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>) <span class="co">#Variance of BM Process</span></span>
<span id="cb62-13"><a href="#cb62-13" tabindex="-1"></a></span>
<span id="cb62-14"><a href="#cb62-14" tabindex="-1"></a>X<span class="ot">&lt;-</span>phytools<span class="sc">::</span><span class="fu">fastBM</span>(phy,<span class="at">a=</span>vX0,<span class="at">sig2=</span>sigma2_x[<span class="dv">1</span>,<span class="dv">1</span>],<span class="at">internal=</span><span class="cn">FALSE</span>) <span class="co">#Simulate X BM variable on tree, with scaling 10</span></span>
<span id="cb62-15"><a href="#cb62-15" tabindex="-1"></a>phytools<span class="sc">::</span><span class="fu">phenogram</span>(phy,X,<span class="at">spread.labels=</span><span class="cn">TRUE</span>,<span class="at">spread.cost=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>)) <span class="co">#Plot X data</span></span>
<span id="cb62-16"><a href="#cb62-16" tabindex="-1"></a><span class="co">#&gt; Optimizing the positions of the tip labels...</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_adaptive_model_data-1.png" width="700" /></p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" tabindex="-1"></a><span class="co">#sigma2_x&lt;-ratematrix(phy,Xa) #Calculate evolutionary v/cv matrix</span></span>
<span id="cb63-2"><a href="#cb63-2" tabindex="-1"></a></span>
<span id="cb63-3"><a href="#cb63-3" tabindex="-1"></a>dmX<span class="ot">&lt;-</span><span class="fu">weight.matrix</span>(trdata<span class="sc">$</span>phy, a, lineages) <span class="co">#Slouch approach</span></span>
<span id="cb63-4"><a href="#cb63-4" tabindex="-1"></a>dmX<span class="ot">&lt;-</span><span class="fu">cbind</span>(dmX,<span class="fu">calc_adaptive_dmX</span>(phy,a,X))</span>
<span id="cb63-5"><a href="#cb63-5" tabindex="-1"></a></span>
<span id="cb63-6"><a href="#cb63-6" tabindex="-1"></a>beta<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="fl">0.25</span>) <span class="co">#Two Optima/Two Slopes</span></span>
<span id="cb63-7"><a href="#cb63-7" tabindex="-1"></a>mu<span class="ot">&lt;-</span>dmX<span class="sc">%*%</span>beta <span class="co">#Simulate mu for Y</span></span>
<span id="cb63-8"><a href="#cb63-8" tabindex="-1"></a></span>
<span id="cb63-9"><a href="#cb63-9" tabindex="-1"></a>V<span class="ot">&lt;-</span><span class="fu">calc_adaptive_V</span>(phy,a, sigma2_y, beta[<span class="dv">3</span>],  sigma2_x,Z_adaptive)</span>
<span id="cb63-10"><a href="#cb63-10" tabindex="-1"></a>Y<span class="ot">&lt;-</span>MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(<span class="at">n=</span><span class="dv">1</span>,mu,V)</span>
<span id="cb63-11"><a href="#cb63-11" tabindex="-1"></a></span>
<span id="cb63-12"><a href="#cb63-12" tabindex="-1"></a><span class="do">################################################################################################################</span></span>
<span id="cb63-13"><a href="#cb63-13" tabindex="-1"></a><span class="co">#Plot data</span></span>
<span id="cb63-14"><a href="#cb63-14" tabindex="-1"></a>df<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">Y=</span>Y,<span class="at">X=</span>X)</span>
<span id="cb63-15"><a href="#cb63-15" tabindex="-1"></a></span>
<span id="cb63-16"><a href="#cb63-16" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">data=</span>df,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>X,<span class="at">y=</span>Y))<span class="sc">+</span></span>
<span id="cb63-17"><a href="#cb63-17" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>()</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_adaptive_model_data-2.png" width="700" /></p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">lm</span>(Y<span class="sc">~</span>X,df))</span>
<span id="cb64-2"><a href="#cb64-2" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb64-3"><a href="#cb64-3" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb64-4"><a href="#cb64-4" tabindex="-1"></a><span class="co">#&gt; lm(formula = Y ~ X, data = df)</span></span>
<span id="cb64-5"><a href="#cb64-5" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb64-6"><a href="#cb64-6" tabindex="-1"></a><span class="co">#&gt; Residuals:</span></span>
<span id="cb64-7"><a href="#cb64-7" tabindex="-1"></a><span class="co">#&gt;     Min      1Q  Median      3Q     Max </span></span>
<span id="cb64-8"><a href="#cb64-8" tabindex="-1"></a><span class="co">#&gt; -1.0206  0.0130  0.2201  0.2994  0.4077 </span></span>
<span id="cb64-9"><a href="#cb64-9" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb64-10"><a href="#cb64-10" tabindex="-1"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb64-11"><a href="#cb64-11" tabindex="-1"></a><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span id="cb64-12"><a href="#cb64-12" tabindex="-1"></a><span class="co">#&gt; (Intercept)  1.75536    0.07480  23.467  &lt; 2e-16 ***</span></span>
<span id="cb64-13"><a href="#cb64-13" tabindex="-1"></a><span class="co">#&gt; X            0.19407    0.06742   2.879  0.00595 ** </span></span>
<span id="cb64-14"><a href="#cb64-14" tabindex="-1"></a><span class="co">#&gt; ---</span></span>
<span id="cb64-15"><a href="#cb64-15" tabindex="-1"></a><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></span>
<span id="cb64-16"><a href="#cb64-16" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb64-17"><a href="#cb64-17" tabindex="-1"></a><span class="co">#&gt; Residual standard error: 0.47 on 48 degrees of freedom</span></span>
<span id="cb64-18"><a href="#cb64-18" tabindex="-1"></a><span class="co">#&gt; Multiple R-squared:  0.1472, Adjusted R-squared:  0.1295 </span></span>
<span id="cb64-19"><a href="#cb64-19" tabindex="-1"></a><span class="co">#&gt; F-statistic: 8.287 on 1 and 48 DF,  p-value: 0.005947</span></span>
<span id="cb64-20"><a href="#cb64-20" tabindex="-1"></a><span class="do">################################################################################################################</span></span>
<span id="cb64-21"><a href="#cb64-21" tabindex="-1"></a><span class="co">#Simulate errors</span></span>
<span id="cb64-22"><a href="#cb64-22" tabindex="-1"></a>Z_X_error<span class="ot">&lt;-</span><span class="dv">1</span> <span class="co">#Number of X traits with error</span></span>
<span id="cb64-23"><a href="#cb64-23" tabindex="-1"></a>X_error<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="fl">0.01</span>,N)</span>
<span id="cb64-24"><a href="#cb64-24" tabindex="-1"></a>Y_error<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="fl">0.01</span>,N)</span>
<span id="cb64-25"><a href="#cb64-25" tabindex="-1"></a>Y_with_error<span class="ot">&lt;-</span>Y<span class="sc">+</span><span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fl">0.01</span>)</span>
<span id="cb64-26"><a href="#cb64-26" tabindex="-1"></a>X_with_error<span class="ot">&lt;-</span>X<span class="sc">+</span><span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fl">0.01</span>)</span>
<span id="cb64-27"><a href="#cb64-27" tabindex="-1"></a></span>
<span id="cb64-28"><a href="#cb64-28" tabindex="-1"></a><span class="do">############################################################################################################</span></span>
<span id="cb64-29"><a href="#cb64-29" tabindex="-1"></a><span class="co">#Make trdata file</span></span>
<span id="cb64-30"><a href="#cb64-30" tabindex="-1"></a>trdata<span class="sc">$</span>dat<span class="ot">&lt;-</span><span class="fu">cbind</span>(trdata<span class="sc">$</span>dat,<span class="fu">data.frame</span>(<span class="fu">cbind</span>(Y_with_error,Y_error,X_with_error,X_error)))</span>
<span id="cb64-31"><a href="#cb64-31" tabindex="-1"></a><span class="do">############################################################################################################</span></span></code></pre></div>
<p>Next we will set the priors for the estimated parameters - for this
model this includes the half-life, Vy, optima, and beta. For the latter
two parameters we will use the results of the linear model to inform our
priors.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" tabindex="-1"></a><span class="do">############################################################################################################</span></span>
<span id="cb65-2"><a href="#cb65-2" tabindex="-1"></a><span class="co">#Set Priors</span></span>
<span id="cb65-3"><a href="#cb65-3" tabindex="-1"></a>hl.prior<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fu">log</span>(<span class="fl">0.25</span>),<span class="fl">0.75</span>)</span>
<span id="cb65-4"><a href="#cb65-4" tabindex="-1"></a>vy.prior<span class="ot">&lt;-</span><span class="dv">5</span></span>
<span id="cb65-5"><a href="#cb65-5" tabindex="-1"></a>optima.prior<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fl">1.75</span>,<span class="fl">0.55</span>) <span class="co">#Informed by linear model</span></span>
<span id="cb65-6"><a href="#cb65-6" tabindex="-1"></a>beta.prior<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fl">0.25</span>,<span class="fl">0.25</span>) <span class="co">#Informed by linear model</span></span></code></pre></div>
</div>
<div id="exploring-priors-2" class="section level2">
<h2>Exploring Priors</h2>
<p>At this point one would want to explore if the priors are appropriate
- do the prior distributions look consistent with what we know about our
system? See Grabowski (in press) for more on setting priors.</p>
<p>Half-life Prior plot</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" tabindex="-1"></a>hl.sims<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">rlnorm</span>(<span class="at">n=</span><span class="dv">1000</span>,<span class="at">meanlog=</span>hl.prior[<span class="dv">1</span>],<span class="at">sdlog=</span>hl.prior[<span class="dv">2</span>]))</span>
<span id="cb66-2"><a href="#cb66-2" tabindex="-1"></a><span class="fu">names</span>(hl.sims)<span class="ot">&lt;-</span><span class="st">&quot;prior.hl.sims&quot;</span></span>
<span id="cb66-3"><a href="#cb66-3" tabindex="-1"></a></span>
<span id="cb66-4"><a href="#cb66-4" tabindex="-1"></a>hl.prior.plot<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb66-5"><a href="#cb66-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(prior.hl.sims,<span class="at">fill=</span><span class="st">&quot;prior.hl.sims&quot;</span>),<span class="at">alpha=</span><span class="fl">0.2</span>,<span class="at">data=</span>hl.sims)<span class="sc">+</span></span>
<span id="cb66-6"><a href="#cb66-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb66-7"><a href="#cb66-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb66-8"><a href="#cb66-8" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(),</span>
<span id="cb66-9"><a href="#cb66-9" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb66-10"><a href="#cb66-10" tabindex="-1"></a>  </span>
<span id="cb66-11"><a href="#cb66-11" tabindex="-1"></a>  <span class="co">#labs(title=&quot;Prior vs. Posterior Distribution &quot;,x=&quot;Half-life&quot;, y = &quot;Density&quot;)+</span></span>
<span id="cb66-12"><a href="#cb66-12" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title=</span><span class="st">&quot;&quot;</span>,<span class="at">x=</span><span class="st">&quot;Half-life&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Density&quot;</span>)<span class="sc">+</span></span>
<span id="cb66-13"><a href="#cb66-13" tabindex="-1"></a>  </span>
<span id="cb66-14"><a href="#cb66-14" tabindex="-1"></a>  <span class="co">#scale_fill_manual(labels=c(&quot;Posterior&quot;,&quot;Prior&quot;))+</span></span>
<span id="cb66-15"><a href="#cb66-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept=</span><span class="fu">c</span>(hl),<span class="at">linetype=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb66-16"><a href="#cb66-16" tabindex="-1"></a>  ggsci<span class="sc">::</span><span class="fu">scale_fill_npg</span>(<span class="at">name=</span><span class="st">&quot;&quot;</span>,<span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;Prior&quot;</span>))</span>
<span id="cb66-17"><a href="#cb66-17" tabindex="-1"></a></span>
<span id="cb66-18"><a href="#cb66-18" tabindex="-1"></a>hl.prior.plot</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-33-1.png" width="700" /></p>
<p>Vy Prior Plot</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" tabindex="-1"></a>vy.sims<span class="ot">&lt;-</span><span class="fu">rexp</span>(<span class="at">n=</span><span class="dv">1000</span>,<span class="at">rate=</span>vy.prior)</span>
<span id="cb67-2"><a href="#cb67-2" tabindex="-1"></a>vy.sims<span class="ot">&lt;-</span><span class="fu">data.frame</span>(vy.sims)</span>
<span id="cb67-3"><a href="#cb67-3" tabindex="-1"></a><span class="fu">names</span>(vy.sims)<span class="ot">&lt;-</span><span class="st">&quot;prior.vy.sims&quot;</span></span>
<span id="cb67-4"><a href="#cb67-4" tabindex="-1"></a></span>
<span id="cb67-5"><a href="#cb67-5" tabindex="-1"></a>vy.prior.plot<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb67-6"><a href="#cb67-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(prior.vy.sims,<span class="at">fill=</span><span class="st">&quot;prior.vy.sims&quot;</span>),<span class="at">alpha=</span><span class="fl">0.2</span>,<span class="at">data=</span>vy.sims)<span class="sc">+</span></span>
<span id="cb67-7"><a href="#cb67-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb67-8"><a href="#cb67-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb67-9"><a href="#cb67-9" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(),</span>
<span id="cb67-10"><a href="#cb67-10" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb67-11"><a href="#cb67-11" tabindex="-1"></a>  </span>
<span id="cb67-12"><a href="#cb67-12" tabindex="-1"></a>  <span class="co">#labs(title=&quot;Prior vs. Posterior Distribution &quot;,x=&quot;vy&quot;, y = &quot;Density&quot;)+</span></span>
<span id="cb67-13"><a href="#cb67-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title=</span><span class="st">&quot;&quot;</span>,<span class="at">x=</span><span class="st">&quot;vy&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Density&quot;</span>)<span class="sc">+</span></span>
<span id="cb67-14"><a href="#cb67-14" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept=</span><span class="fu">c</span>(vy),<span class="at">linetype=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb67-15"><a href="#cb67-15" tabindex="-1"></a>  </span>
<span id="cb67-16"><a href="#cb67-16" tabindex="-1"></a>  <span class="co">#scale_fill_manual(labels=c(&quot;Posterior&quot;,&quot;Prior&quot;))+</span></span>
<span id="cb67-17"><a href="#cb67-17" tabindex="-1"></a>  ggsci<span class="sc">::</span><span class="fu">scale_fill_npg</span>(<span class="at">name=</span><span class="st">&quot;&quot;</span>,<span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;Prior&quot;</span>))</span>
<span id="cb67-18"><a href="#cb67-18" tabindex="-1"></a></span>
<span id="cb67-19"><a href="#cb67-19" tabindex="-1"></a></span>
<span id="cb67-20"><a href="#cb67-20" tabindex="-1"></a>vy.prior.plot</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-34-1.png" width="700" /></p>
<p>Prior on how shared branch lengths correspond to covariance</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" tabindex="-1"></a>a.sims<span class="ot">&lt;-</span><span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">/</span>hl.sims;</span>
<span id="cb68-2"><a href="#cb68-2" tabindex="-1"></a>sigma2_y.sims<span class="ot">&lt;-</span>vy.sims<span class="sc">*</span>(<span class="dv">2</span><span class="sc">*</span>(<span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">/</span>hl.sims));</span>
<span id="cb68-3"><a href="#cb68-3" tabindex="-1"></a><span class="co">#x&lt;-seq(from=0,to=1,by=0.001)</span></span>
<span id="cb68-4"><a href="#cb68-4" tabindex="-1"></a><span class="co">#V.sim&lt;-calc_direct_V(phy,a.sims,sigma2_y.sims)</span></span>
<span id="cb68-5"><a href="#cb68-5" tabindex="-1"></a></span>
<span id="cb68-6"><a href="#cb68-6" tabindex="-1"></a></span>
<span id="cb68-7"><a href="#cb68-7" tabindex="-1"></a><span class="fu">plot</span>( <span class="cn">NULL</span> , <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>) , <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.4</span>) , <span class="at">xlab=</span><span class="st">&quot;Time since MRCA&quot;</span> , <span class="at">ylab=</span><span class="st">&quot;Covariance&quot;</span> ,<span class="at">cex.axis=</span><span class="fl">0.75</span>, <span class="at">mgp=</span><span class="fu">c</span>(<span class="fl">1.25</span>,<span class="fl">0.25</span>,<span class="dv">0</span>),<span class="at">tcl=</span><span class="sc">-</span><span class="fl">0.25</span>)</span>
<span id="cb68-8"><a href="#cb68-8" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>){</span>
<span id="cb68-9"><a href="#cb68-9" tabindex="-1"></a>  <span class="fu">curve</span>(<span class="fu">calc_adaptive_cov_plot</span>(a.sims[i,],sigma2_y.sims[i,],beta[<span class="dv">3</span>],x) , <span class="at">add=</span><span class="cn">TRUE</span> , <span class="at">lwd=</span><span class="dv">4</span> , <span class="at">col=</span>rethinking<span class="sc">::</span><span class="fu">col.alpha</span>(<span class="dv">1</span>,<span class="fl">0.15</span>))</span>
<span id="cb68-10"><a href="#cb68-10" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-35-1.png" width="700" /></p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" tabindex="-1"></a></span>
<span id="cb69-2"><a href="#cb69-2" tabindex="-1"></a></span>
<span id="cb69-3"><a href="#cb69-3" tabindex="-1"></a><span class="co">#multiple traits</span></span>
<span id="cb69-4"><a href="#cb69-4" tabindex="-1"></a></span>
<span id="cb69-5"><a href="#cb69-5" tabindex="-1"></a></span>
<span id="cb69-6"><a href="#cb69-6" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="fl">0.25</span>,<span class="fl">0.25</span>))</span></code></pre></div>
<p>Slope and intercept Prior Plot</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" tabindex="-1"></a></span>
<span id="cb70-2"><a href="#cb70-2" tabindex="-1"></a>optima.sims<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="dv">100</span>,optima.prior[<span class="dv">1</span>],optima.prior[<span class="dv">2</span>])</span>
<span id="cb70-3"><a href="#cb70-3" tabindex="-1"></a>beta.sims<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="at">n=</span><span class="dv">100</span>,beta.prior[<span class="dv">1</span>],beta.prior[<span class="dv">2</span>])</span>
<span id="cb70-4"><a href="#cb70-4" tabindex="-1"></a></span>
<span id="cb70-5"><a href="#cb70-5" tabindex="-1"></a>prior.slope.plot<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>()<span class="sc">+</span>  </span>
<span id="cb70-6"><a href="#cb70-6" tabindex="-1"></a> ggplot2<span class="sc">::</span> <span class="fu">geom_point</span>(<span class="at">data=</span>df,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y=</span>Y,<span class="at">x=</span>X))<span class="sc">+</span></span>
<span id="cb70-7"><a href="#cb70-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_abline</span>(<span class="at">intercept=</span>optima.sims,<span class="at">slope=</span>beta.sims,<span class="at">alpha=</span><span class="fl">0.15</span>)<span class="sc">+</span></span>
<span id="cb70-8"><a href="#cb70-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb70-9"><a href="#cb70-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb70-10"><a href="#cb70-10" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(),</span>
<span id="cb70-11"><a href="#cb70-11" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb70-12"><a href="#cb70-12" tabindex="-1"></a>  </span>
<span id="cb70-13"><a href="#cb70-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ylab</span>(<span class="st">&quot;Y&quot;</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">xlab</span>(<span class="st">&quot;Adaptive X&quot;</span>)<span class="sc">+</span></span>
<span id="cb70-14"><a href="#cb70-14" tabindex="-1"></a>  ggsci<span class="sc">::</span><span class="fu">scale_color_npg</span>()</span>
<span id="cb70-15"><a href="#cb70-15" tabindex="-1"></a></span>
<span id="cb70-16"><a href="#cb70-16" tabindex="-1"></a>prior.slope.plot</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-36-1.png" width="700" /></p>
<p>We will use the helper function blouch.reg.adapt.prep() to setup the
dat file for Stan. Here “Z_adapt” is the number of predictors, and
“regimes” is the name of the regime column in trdata$dat.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" tabindex="-1"></a>dat<span class="ot">&lt;-</span><span class="fu">blouch.reg.adapt.prep</span>(trdata,<span class="st">&quot;Y_with_error&quot;</span>,<span class="st">&quot;Y_error&quot;</span>,<span class="st">&quot;X_with_error&quot;</span>,<span class="st">&quot;X_error&quot;</span>,<span class="at">Z_adaptive=</span><span class="dv">1</span>,<span class="st">&quot;regimes&quot;</span>,hl.prior,vy.prior,optima.prior,beta.prior)</span></code></pre></div>
<p>Now we run the basic Multi-optima Adaptive Model, look at the
results, and rstan::extract the posterior</p>
<<<<<<< HEAD
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" tabindex="-1"></a>fit.reg.adapt<span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">sampling</span>(<span class="at">object =</span> blouch<span class="sc">:::</span>stanmodels<span class="sc">$</span>blouchOU_reg_adapt,<span class="at">data =</span> dat,<span class="at">chains =</span> <span class="dv">2</span>,<span class="at">cores =</span> <span class="dv">2</span>, <span class="at">iter =</span><span class="dv">2000</span>)</span>
<span id="cb72-2"><a href="#cb72-2" tabindex="-1"></a><span class="co">#&gt; Found more than one class &quot;stanfit&quot; in cache; using the first, from namespace &#39;rstan&#39;</span></span>
<span id="cb72-3"><a href="#cb72-3" tabindex="-1"></a><span class="co">#&gt; Also defined by &#39;rethinking&#39;</span></span>
<span id="cb72-4"><a href="#cb72-4" tabindex="-1"></a><span class="co">#&gt; Found more than one class &quot;stanfit&quot; in cache; using the first, from namespace &#39;rstan&#39;</span></span>
<span id="cb72-5"><a href="#cb72-5" tabindex="-1"></a><span class="co">#&gt; Also defined by &#39;rethinking&#39;</span></span></code></pre></div>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" tabindex="-1"></a><span class="fu">print</span>(fit.reg.adapt,<span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;hl&quot;</span>,<span class="st">&quot;vy&quot;</span>,<span class="st">&quot;optima&quot;</span>,<span class="st">&quot;beta&quot;</span>,<span class="st">&quot;beta_e&quot;</span>))</span>
<span id="cb73-2"><a href="#cb73-2" tabindex="-1"></a><span class="co">#&gt; Inference for Stan model: blouchOU_reg_adapt.</span></span>
<span id="cb73-3"><a href="#cb73-3" tabindex="-1"></a><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span id="cb73-4"><a href="#cb73-4" tabindex="-1"></a><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span id="cb73-5"><a href="#cb73-5" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb73-6"><a href="#cb73-6" tabindex="-1"></a><span class="co">#&gt;           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span id="cb73-7"><a href="#cb73-7" tabindex="-1"></a><span class="co">#&gt; hl        0.22       0 0.11 0.07 0.14 0.20 0.27  0.49   982 1.00</span></span>
<span id="cb73-8"><a href="#cb73-8" tabindex="-1"></a><span class="co">#&gt; vy        0.02       0 0.01 0.01 0.01 0.02 0.02  0.04  1499 1.00</span></span>
<span id="cb73-9"><a href="#cb73-9" tabindex="-1"></a><span class="co">#&gt; optima[1] 2.03       0 0.05 1.93 1.99 2.02 2.06  2.14  2250 1.00</span></span>
<span id="cb73-10"><a href="#cb73-10" tabindex="-1"></a><span class="co">#&gt; optima[2] 0.86       0 0.13 0.54 0.81 0.88 0.94  1.04  1091 1.01</span></span>
<span id="cb73-11"><a href="#cb73-11" tabindex="-1"></a><span class="co">#&gt; beta[1]   0.24       0 0.05 0.16 0.21 0.23 0.26  0.36  1261 1.01</span></span>
<span id="cb73-12"><a href="#cb73-12" tabindex="-1"></a><span class="co">#&gt; beta_e[1] 0.17       0 0.03 0.10 0.15 0.17 0.19  0.23  2331 1.00</span></span>
<span id="cb73-13"><a href="#cb73-13" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb73-14"><a href="#cb73-14" tabindex="-1"></a><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Fri Oct 10 16:23:10 2025.</span></span>
<span id="cb73-15"><a href="#cb73-15" tabindex="-1"></a><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span id="cb73-16"><a href="#cb73-16" tabindex="-1"></a><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span id="cb73-17"><a href="#cb73-17" tabindex="-1"></a><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span id="cb73-18"><a href="#cb73-18" tabindex="-1"></a>post<span class="ot">&lt;-</span>rstan<span class="sc">::</span><span class="fu">extract</span>(fit.reg.adapt) <span class="co">#rstan::extract Posterior Distribution</span></span></code></pre></div>
=======
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.adapt</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_adapt</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores <span class="op">=</span> <span class="fl">2</span>, iter <span class="op">=</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span></code></pre></div>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.adapt</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span>,<span class="st">"beta_e"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_adapt.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.22       0 0.11 0.07 0.14 0.20 0.27  0.49   982 1.00</span></span>
<span><span class="co">#&gt; vy        0.02       0 0.01 0.01 0.01 0.02 0.02  0.04  1499 1.00</span></span>
<span><span class="co">#&gt; optima[1] 2.03       0 0.05 1.93 1.99 2.02 2.06  2.14  2250 1.00</span></span>
<span><span class="co">#&gt; optima[2] 0.86       0 0.13 0.54 0.81 0.88 0.94  1.04  1091 1.01</span></span>
<span><span class="co">#&gt; beta[1]   0.24       0 0.05 0.16 0.21 0.23 0.26  0.36  1261 1.01</span></span>
<span><span class="co">#&gt; beta_e[1] 0.17       0 0.03 0.10 0.15 0.17 0.19  0.23  2331 1.00</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Sat Oct 11 15:33:48 2025.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.adapt</span><span class="op">)</span> <span class="co">#rstan::extract Posterior Distribution</span></span></code></pre></div>
>>>>>>> dev-fixes-blouch1.0
<p>Now lets look at the prior vs. posterior plots for the parameters
Half-life plot</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" tabindex="-1"></a>hl.post<span class="ot">&lt;-</span><span class="fu">data.frame</span>(post<span class="sc">$</span>hl)</span>
<span id="cb74-2"><a href="#cb74-2" tabindex="-1"></a><span class="fu">names</span>(hl.post)<span class="ot">&lt;-</span><span class="st">&quot;post.hl.sims&quot;</span></span>
<span id="cb74-3"><a href="#cb74-3" tabindex="-1"></a></span>
<span id="cb74-4"><a href="#cb74-4" tabindex="-1"></a>hl.plot<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb74-5"><a href="#cb74-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(prior.hl.sims,<span class="at">fill=</span><span class="st">&quot;prior.hl.sims&quot;</span>),<span class="at">alpha=</span><span class="fl">0.2</span>,<span class="at">data=</span>hl.sims)<span class="sc">+</span></span>
<span id="cb74-6"><a href="#cb74-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(post.hl.sims,<span class="at">fill=</span><span class="st">&quot;post.hl.sims&quot;</span>),<span class="at">alpha=</span><span class="fl">0.2</span>,<span class="at">data=</span>hl.post)<span class="sc">+</span></span>
<span id="cb74-7"><a href="#cb74-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb74-8"><a href="#cb74-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb74-9"><a href="#cb74-9" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(),</span>
<span id="cb74-10"><a href="#cb74-10" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb74-11"><a href="#cb74-11" tabindex="-1"></a>  </span>
<span id="cb74-12"><a href="#cb74-12" tabindex="-1"></a>  <span class="co">#labs(title=&quot;Prior vs. Posterior Distribution &quot;,x=&quot;Half-life&quot;, y = &quot;Density&quot;)+</span></span>
<span id="cb74-13"><a href="#cb74-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title=</span><span class="st">&quot;&quot;</span>,<span class="at">x=</span><span class="st">&quot;Half-life&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Density&quot;</span>)<span class="sc">+</span></span>
<span id="cb74-14"><a href="#cb74-14" tabindex="-1"></a>  </span>
<span id="cb74-15"><a href="#cb74-15" tabindex="-1"></a>  <span class="co">#scale_fill_manual(labels=c(&quot;Posterior&quot;,&quot;Prior&quot;))+</span></span>
<span id="cb74-16"><a href="#cb74-16" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept=</span><span class="fu">c</span>(hl),<span class="at">linetype=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb74-17"><a href="#cb74-17" tabindex="-1"></a>  ggsci<span class="sc">::</span><span class="fu">scale_fill_npg</span>(<span class="at">name=</span><span class="st">&quot;&quot;</span>,<span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;Posterior&quot;</span>,<span class="st">&quot;Prior&quot;</span>))</span>
<span id="cb74-18"><a href="#cb74-18" tabindex="-1"></a></span>
<span id="cb74-19"><a href="#cb74-19" tabindex="-1"></a>hl.plot</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-38-1.png" width="700" /></p>
<p>Vy Prior vs. posterior plot</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" tabindex="-1"></a>vy.post<span class="ot">&lt;-</span><span class="fu">data.frame</span>(post<span class="sc">$</span>vy)</span>
<span id="cb75-2"><a href="#cb75-2" tabindex="-1"></a><span class="fu">names</span>(vy.post)<span class="ot">&lt;-</span><span class="st">&quot;post.vy.sims&quot;</span></span>
<span id="cb75-3"><a href="#cb75-3" tabindex="-1"></a></span>
<span id="cb75-4"><a href="#cb75-4" tabindex="-1"></a></span>
<span id="cb75-5"><a href="#cb75-5" tabindex="-1"></a>vy.plot<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb75-6"><a href="#cb75-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(prior.vy.sims,<span class="at">fill=</span><span class="st">&quot;prior.vy.sims&quot;</span>),<span class="at">alpha=</span><span class="fl">0.2</span>,<span class="at">data=</span>vy.sims)<span class="sc">+</span></span>
<span id="cb75-7"><a href="#cb75-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(post.vy.sims,<span class="at">fill=</span><span class="st">&quot;post.vy.sims&quot;</span>),<span class="at">alpha=</span><span class="fl">0.2</span>,<span class="at">data=</span>vy.post)<span class="sc">+</span></span>
<span id="cb75-8"><a href="#cb75-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb75-9"><a href="#cb75-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb75-10"><a href="#cb75-10" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(),</span>
<span id="cb75-11"><a href="#cb75-11" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb75-12"><a href="#cb75-12" tabindex="-1"></a>  </span>
<span id="cb75-13"><a href="#cb75-13" tabindex="-1"></a>  <span class="co">#labs(title=&quot;Prior vs. Posterior Distribution &quot;,x=&quot;vy&quot;, y = &quot;Density&quot;)+</span></span>
<span id="cb75-14"><a href="#cb75-14" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title=</span><span class="st">&quot;&quot;</span>,<span class="at">x=</span><span class="st">&quot;vy&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Density&quot;</span>)<span class="sc">+</span></span>
<span id="cb75-15"><a href="#cb75-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept=</span><span class="fu">c</span>(vy),<span class="at">linetype=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb75-16"><a href="#cb75-16" tabindex="-1"></a>  </span>
<span id="cb75-17"><a href="#cb75-17" tabindex="-1"></a>  <span class="co">#scale_fill_manual(labels=c(&quot;Posterior&quot;,&quot;Prior&quot;))+</span></span>
<span id="cb75-18"><a href="#cb75-18" tabindex="-1"></a>  ggsci<span class="sc">::</span><span class="fu">scale_fill_npg</span>(<span class="at">name=</span><span class="st">&quot;&quot;</span>,<span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;Posterior&quot;</span>,<span class="st">&quot;Prior&quot;</span>))</span>
<span id="cb75-19"><a href="#cb75-19" tabindex="-1"></a></span>
<span id="cb75-20"><a href="#cb75-20" tabindex="-1"></a>vy.plot</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-39-1.png" width="700" /></p>
<p>Prior versus posterior on how shared branch lengths correspond to
covariance</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" tabindex="-1"></a>a.sims<span class="ot">&lt;-</span><span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">/</span>hl.sims;</span>
<span id="cb76-2"><a href="#cb76-2" tabindex="-1"></a>sigma2_y.sims<span class="ot">&lt;-</span>vy.sims<span class="sc">*</span>(<span class="dv">2</span><span class="sc">*</span>(<span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">/</span>hl.sims));</span>
<span id="cb76-3"><a href="#cb76-3" tabindex="-1"></a><span class="co">#x&lt;-seq(from=0,to=1,by=0.001)</span></span>
<span id="cb76-4"><a href="#cb76-4" tabindex="-1"></a><span class="co">#V.sim&lt;-calc_direct_V(phy,a.sims,sigma2_y.sims)</span></span>
<span id="cb76-5"><a href="#cb76-5" tabindex="-1"></a></span>
<span id="cb76-6"><a href="#cb76-6" tabindex="-1"></a></span>
<span id="cb76-7"><a href="#cb76-7" tabindex="-1"></a><span class="fu">plot</span>( <span class="cn">NULL</span> , <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>) , <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.4</span>) , <span class="at">xlab=</span><span class="st">&quot;Time since MRCA&quot;</span> , <span class="at">ylab=</span><span class="st">&quot;Covariance&quot;</span> ,<span class="at">cex.axis=</span><span class="fl">0.75</span>, <span class="at">mgp=</span><span class="fu">c</span>(<span class="fl">1.25</span>,<span class="fl">0.25</span>,<span class="dv">0</span>),<span class="at">tcl=</span><span class="sc">-</span><span class="fl">0.25</span>)</span>
<span id="cb76-8"><a href="#cb76-8" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>){</span>
<span id="cb76-9"><a href="#cb76-9" tabindex="-1"></a>  <span class="fu">curve</span>(<span class="fu">calc_adaptive_cov_plot</span>(a.sims[i,],sigma2_y.sims[i,],beta[<span class="dv">3</span>],x) , <span class="at">add=</span><span class="cn">TRUE</span> , <span class="at">lwd=</span><span class="dv">4</span> , <span class="at">col=</span>rethinking<span class="sc">::</span><span class="fu">col.alpha</span>(<span class="dv">1</span>,<span class="fl">0.15</span>))</span>
<span id="cb76-10"><a href="#cb76-10" tabindex="-1"></a>}</span>
<span id="cb76-11"><a href="#cb76-11" tabindex="-1"></a></span>
<span id="cb76-12"><a href="#cb76-12" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>){</span>
<span id="cb76-13"><a href="#cb76-13" tabindex="-1"></a>  <span class="fu">curve</span>(<span class="fu">calc_adaptive_cov_plot</span>(post<span class="sc">$</span>a[i],post<span class="sc">$</span>sigma2_y[i],post<span class="sc">$</span>beta[i],x) , <span class="at">add=</span><span class="cn">TRUE</span> , <span class="at">lwd=</span><span class="dv">4</span> , <span class="at">col=</span>rethinking<span class="sc">::</span><span class="fu">col.alpha</span>(<span class="dv">2</span>,<span class="fl">0.5</span>))</span>
<span id="cb76-14"><a href="#cb76-14" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-40-1.png" width="700" /></p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" tabindex="-1"></a></span>
<span id="cb77-2"><a href="#cb77-2" tabindex="-1"></a><span class="co">#multiple traits</span></span>
<span id="cb77-3"><a href="#cb77-3" tabindex="-1"></a></span>
<span id="cb77-4"><a href="#cb77-4" tabindex="-1"></a></span>
<span id="cb77-5"><a href="#cb77-5" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="fl">0.25</span>,<span class="fl">0.25</span>))</span></code></pre></div>
<p>Prior vs. Posterior Plot for Regression</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" tabindex="-1"></a>optima.sims<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="dv">100</span>,optima.prior[<span class="dv">1</span>],optima.prior[<span class="dv">2</span>])</span>
<span id="cb78-2"><a href="#cb78-2" tabindex="-1"></a>beta.sims<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="at">n=</span><span class="dv">100</span>,beta.prior[<span class="dv">1</span>],beta.prior[<span class="dv">2</span>])</span>
<span id="cb78-3"><a href="#cb78-3" tabindex="-1"></a></span>
<span id="cb78-4"><a href="#cb78-4" tabindex="-1"></a>optima.post<span class="ot">&lt;-</span>post<span class="sc">$</span>optima</span>
<span id="cb78-5"><a href="#cb78-5" tabindex="-1"></a>beta.post<span class="ot">&lt;-</span><span class="fu">data.frame</span>(post<span class="sc">$</span>beta)</span>
<span id="cb78-6"><a href="#cb78-6" tabindex="-1"></a><span class="fu">names</span>(beta.post)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">&quot;post.beta.1&quot;</span>)</span>
<span id="cb78-7"><a href="#cb78-7" tabindex="-1"></a></span>
<span id="cb78-8"><a href="#cb78-8" tabindex="-1"></a>mu.link<span class="fl">.11</span><span class="ot">&lt;-</span><span class="cf">function</span>(x.seq){optima.post[,<span class="dv">1</span>]<span class="sc">+</span>x.seq<span class="sc">*</span>beta.post[,<span class="dv">1</span>]}</span>
<span id="cb78-9"><a href="#cb78-9" tabindex="-1"></a>mu.link<span class="fl">.12</span><span class="ot">&lt;-</span><span class="cf">function</span>(x.seq){optima.post[,<span class="dv">2</span>]<span class="sc">+</span>x.seq<span class="sc">*</span>beta.post[,<span class="dv">1</span>]}</span>
<span id="cb78-10"><a href="#cb78-10" tabindex="-1"></a></span>
<span id="cb78-11"><a href="#cb78-11" tabindex="-1"></a>x.seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from=</span><span class="fu">min</span>(X), <span class="at">to=</span><span class="fu">max</span>(X) , <span class="at">length.out=</span><span class="dv">100</span>)</span>
<span id="cb78-12"><a href="#cb78-12" tabindex="-1"></a>mu<span class="fl">.11</span> <span class="ot">&lt;-</span> <span class="fu">sapply</span>(x.seq , mu.link<span class="fl">.11</span> )</span>
<span id="cb78-13"><a href="#cb78-13" tabindex="-1"></a>mu<span class="fl">.12</span> <span class="ot">&lt;-</span> <span class="fu">sapply</span>(x.seq , mu.link<span class="fl">.12</span> )</span>
<span id="cb78-14"><a href="#cb78-14" tabindex="-1"></a></span>
<span id="cb78-15"><a href="#cb78-15" tabindex="-1"></a></span>
<span id="cb78-16"><a href="#cb78-16" tabindex="-1"></a>mu.mean<span class="fl">.11</span><span class="ot">&lt;-</span><span class="fu">colMeans</span>(mu<span class="fl">.11</span>)</span>
<span id="cb78-17"><a href="#cb78-17" tabindex="-1"></a>mu.mean<span class="fl">.12</span><span class="ot">&lt;-</span><span class="fu">colMeans</span>(mu<span class="fl">.12</span>)</span>
<span id="cb78-18"><a href="#cb78-18" tabindex="-1"></a></span>
<span id="cb78-19"><a href="#cb78-19" tabindex="-1"></a>mu.mean<span class="fl">.11</span><span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">as.numeric</span>(mu.mean<span class="fl">.11</span>))</span>
<span id="cb78-20"><a href="#cb78-20" tabindex="-1"></a>mu.mean<span class="fl">.12</span><span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">as.numeric</span>(mu.mean<span class="fl">.12</span>))</span>
<span id="cb78-21"><a href="#cb78-21" tabindex="-1"></a></span>
<span id="cb78-22"><a href="#cb78-22" tabindex="-1"></a><span class="fu">names</span>(mu.mean<span class="fl">.11</span>)<span class="ot">&lt;-</span><span class="st">&quot;mu.mean.11&quot;</span></span>
<span id="cb78-23"><a href="#cb78-23" tabindex="-1"></a><span class="fu">names</span>(mu.mean<span class="fl">.12</span>)<span class="ot">&lt;-</span><span class="st">&quot;mu.mean.12&quot;</span></span>
<span id="cb78-24"><a href="#cb78-24" tabindex="-1"></a></span>
<span id="cb78-25"><a href="#cb78-25" tabindex="-1"></a>mu.CI<span class="fl">.11</span> <span class="ot">&lt;-</span> <span class="fu">apply</span>( mu<span class="fl">.11</span> , <span class="at">MARGIN=</span><span class="dv">2</span>, <span class="at">FUN=</span>rethinking<span class="sc">::</span>PI , <span class="at">prob=</span><span class="fl">0.89</span> )</span>
<span id="cb78-26"><a href="#cb78-26" tabindex="-1"></a>mu.CI<span class="fl">.12</span> <span class="ot">&lt;-</span> <span class="fu">apply</span>( mu<span class="fl">.12</span> , <span class="at">MARGIN=</span><span class="dv">2</span>, <span class="at">FUN=</span>rethinking<span class="sc">::</span>PI , <span class="at">prob=</span><span class="fl">0.89</span> )</span>
<span id="cb78-27"><a href="#cb78-27" tabindex="-1"></a></span>
<span id="cb78-28"><a href="#cb78-28" tabindex="-1"></a></span>
<span id="cb78-29"><a href="#cb78-29" tabindex="-1"></a>mu.CI<span class="fl">.11</span><span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">t</span>(<span class="fu">data.frame</span>(mu.CI<span class="fl">.11</span>)),x.seq)</span>
<span id="cb78-30"><a href="#cb78-30" tabindex="-1"></a>mu.CI<span class="fl">.12</span><span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">t</span>(<span class="fu">data.frame</span>(mu.CI<span class="fl">.12</span>)),x.seq)</span>
<span id="cb78-31"><a href="#cb78-31" tabindex="-1"></a></span>
<span id="cb78-32"><a href="#cb78-32" tabindex="-1"></a><span class="fu">names</span>(mu.CI<span class="fl">.11</span>)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">&quot;min.5.5&quot;</span>,<span class="st">&quot;max.94.5&quot;</span>,<span class="st">&quot;x.seq&quot;</span>)</span>
<span id="cb78-33"><a href="#cb78-33" tabindex="-1"></a><span class="fu">names</span>(mu.CI<span class="fl">.12</span>)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">&quot;min.5.5&quot;</span>,<span class="st">&quot;max.94.5&quot;</span>,<span class="st">&quot;x.seq&quot;</span>)</span>
<span id="cb78-34"><a href="#cb78-34" tabindex="-1"></a></span>
<span id="cb78-35"><a href="#cb78-35" tabindex="-1"></a><span class="co">#df&lt;-data.frame(Y=stan_sim_data$Y,X=stan_sim_data$direct_cov)</span></span>
<span id="cb78-36"><a href="#cb78-36" tabindex="-1"></a>df<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">Y=</span>dat<span class="sc">$</span>Y_obs,<span class="at">X=</span>dat<span class="sc">$</span>X_obs,<span class="at">Regimes=</span>regimes_tip)</span>
<span id="cb78-37"><a href="#cb78-37" tabindex="-1"></a>df11<span class="ot">&lt;-</span><span class="fu">data.frame</span>(x.seq,mu.mean<span class="fl">.11</span>)</span>
<span id="cb78-38"><a href="#cb78-38" tabindex="-1"></a>df12<span class="ot">&lt;-</span><span class="fu">data.frame</span>(x.seq,mu.mean<span class="fl">.12</span>)</span>
<span id="cb78-39"><a href="#cb78-39" tabindex="-1"></a></span>
<span id="cb78-40"><a href="#cb78-40" tabindex="-1"></a><span class="co">#slope.prior.plot&lt;-ggplot(data=reg.trdata$dat,aes(y=Sim1,x=X))+</span></span>
<span id="cb78-41"><a href="#cb78-41" tabindex="-1"></a>slope.plot<span class="fl">.1</span><span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>()<span class="sc">+</span>  </span>
<span id="cb78-42"><a href="#cb78-42" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">data=</span>df,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y=</span>Y,<span class="at">x=</span>X,<span class="at">color=</span><span class="fu">as.factor</span>(Regimes)))<span class="sc">+</span></span>
<span id="cb78-43"><a href="#cb78-43" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_abline</span>(<span class="at">intercept=</span>optima.sims,<span class="at">slope=</span>beta.sims,<span class="at">alpha=</span><span class="fl">0.05</span>)<span class="sc">+</span> <span class="co">#Prior</span></span>
<span id="cb78-44"><a href="#cb78-44" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_abline</span>(<span class="at">intercept=</span>beta[<span class="dv">1</span>],<span class="at">slope=</span>beta[<span class="dv">3</span>],<span class="at">alpha=</span><span class="fl">0.5</span>,<span class="at">linetype=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb78-45"><a href="#cb78-45" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_abline</span>(<span class="at">intercept=</span>beta[<span class="dv">2</span>],<span class="at">slope=</span>beta[<span class="dv">3</span>],<span class="at">alpha=</span><span class="fl">0.5</span>,<span class="at">linetype=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb78-46"><a href="#cb78-46" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_ribbon</span>(<span class="at">data=</span>mu.CI<span class="fl">.11</span>,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>x.seq,<span class="at">ymin=</span>min.<span class="fl">5.5</span>,<span class="at">ymax=</span>max.<span class="fl">94.5</span>),<span class="at">linetype=</span><span class="dv">2</span>,<span class="at">alpha=</span><span class="fl">0.1</span>)<span class="sc">+</span></span>
<span id="cb78-47"><a href="#cb78-47" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">data=</span>df11,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>x.seq,<span class="at">y=</span>mu.mean<span class="fl">.11</span>),<span class="at">linetype=</span><span class="dv">1</span>,<span class="at">linewidth=</span><span class="dv">1</span>,<span class="at">alpha=</span><span class="fl">0.3</span>)<span class="sc">+</span></span>
<span id="cb78-48"><a href="#cb78-48" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_ribbon</span>(<span class="at">data=</span>mu.CI<span class="fl">.12</span>,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>x.seq,<span class="at">ymin=</span>min.<span class="fl">5.5</span>,<span class="at">ymax=</span>max.<span class="fl">94.5</span>),<span class="at">linetype=</span><span class="dv">2</span>,<span class="at">alpha=</span><span class="fl">0.1</span>)<span class="sc">+</span></span>
<span id="cb78-49"><a href="#cb78-49" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">data=</span>df12,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>x.seq,<span class="at">y=</span>mu.mean<span class="fl">.12</span>),<span class="at">linetype=</span><span class="dv">1</span>,<span class="at">linewidth=</span><span class="dv">1</span>,<span class="at">alpha=</span><span class="fl">0.3</span>)<span class="sc">+</span></span>
<span id="cb78-50"><a href="#cb78-50" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb78-51"><a href="#cb78-51" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb78-52"><a href="#cb78-52" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(),</span>
<span id="cb78-53"><a href="#cb78-53" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb78-54"><a href="#cb78-54" tabindex="-1"></a>  </span>
<span id="cb78-55"><a href="#cb78-55" tabindex="-1"></a>  <span class="co">#ggtitle(&quot;Prior vs. Posterior for Intercept and Slope&quot;)+</span></span>
<span id="cb78-56"><a href="#cb78-56" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ylab</span>(<span class="st">&quot;Y&quot;</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">xlab</span>(<span class="st">&quot;Direct Effect X&quot;</span>)<span class="sc">+</span>ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">color=</span><span class="st">&quot;Regimes&quot;</span>)<span class="sc">+</span></span>
<span id="cb78-57"><a href="#cb78-57" tabindex="-1"></a>  ggsci<span class="sc">::</span><span class="fu">scale_color_npg</span>()</span>
<span id="cb78-58"><a href="#cb78-58" tabindex="-1"></a></span>
<span id="cb78-59"><a href="#cb78-59" tabindex="-1"></a>slope.plot<span class="fl">.1</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-41-1.png" width="700" /></p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" tabindex="-1"></a><span class="co">#Label points</span></span></code></pre></div>
<p>Here is the Multilevel version of the same model Next we will set the
priors for the estimated parameters - for this model this includes the
half-life, Vy, optima, and beta. For the latter two parameters we will
use the results of the linear model to inform our priors.</p>
<<<<<<< HEAD
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" tabindex="-1"></a><span class="do">############################################################################################################</span></span>
<span id="cb80-2"><a href="#cb80-2" tabindex="-1"></a><span class="co">#Set Priors</span></span>
<span id="cb80-3"><a href="#cb80-3" tabindex="-1"></a>hl.prior<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fu">log</span>(<span class="fl">0.25</span>),<span class="fl">0.25</span>)</span>
<span id="cb80-4"><a href="#cb80-4" tabindex="-1"></a>vy.prior<span class="ot">&lt;-</span><span class="dv">5</span></span>
<span id="cb80-5"><a href="#cb80-5" tabindex="-1"></a>optima.prior<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fl">1.5</span>,<span class="fl">0.5</span>) <span class="co">#Informed by linear model</span></span>
<span id="cb80-6"><a href="#cb80-6" tabindex="-1"></a>beta.prior<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.25</span>) <span class="co">#Informed by linear model</span></span>
<span id="cb80-7"><a href="#cb80-7" tabindex="-1"></a>sigma.prior<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb80-8"><a href="#cb80-8" tabindex="-1"></a></span>
<span id="cb80-9"><a href="#cb80-9" tabindex="-1"></a><span class="do">############################################################################################################</span></span>
<span id="cb80-10"><a href="#cb80-10" tabindex="-1"></a><span class="co">#Make trdata file</span></span>
<span id="cb80-11"><a href="#cb80-11" tabindex="-1"></a>trdata<span class="sc">$</span>dat<span class="ot">&lt;-</span><span class="fu">cbind</span>(trdata<span class="sc">$</span>dat,<span class="fu">data.frame</span>(<span class="fu">cbind</span>(Y_with_error,Y_error,X_with_error,X_error)))</span>
<span id="cb80-12"><a href="#cb80-12" tabindex="-1"></a><span class="do">############################################################################################################</span></span>
<span id="cb80-13"><a href="#cb80-13" tabindex="-1"></a>dat<span class="ot">&lt;-</span><span class="fu">blouch.reg.adapt.mlm.prep</span>(trdata,<span class="st">&quot;Y_with_error&quot;</span>,<span class="st">&quot;Y_error&quot;</span>,<span class="st">&quot;X_with_error&quot;</span>,<span class="st">&quot;X_error&quot;</span>,<span class="at">Z_adaptive=</span><span class="dv">1</span>,<span class="st">&quot;regimes&quot;</span>,hl.prior,vy.prior,optima.prior,beta.prior,sigma.prior)</span></code></pre></div>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" tabindex="-1"></a>fit.reg.adapt.mlm.vi<span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">sampling</span>(<span class="at">object =</span> blouch<span class="sc">:::</span>stanmodels<span class="sc">$</span>blouchOU_reg_adapt_mlm_vi,<span class="at">data =</span> dat,<span class="at">chains =</span> <span class="dv">2</span>,<span class="at">cores=</span><span class="dv">2</span>,<span class="at">iter =</span><span class="dv">2000</span>)</span>
<span id="cb81-2"><a href="#cb81-2" tabindex="-1"></a><span class="co">#&gt; Found more than one class &quot;stanfit&quot; in cache; using the first, from namespace &#39;rstan&#39;</span></span>
<span id="cb81-3"><a href="#cb81-3" tabindex="-1"></a><span class="co">#&gt; Also defined by &#39;rethinking&#39;</span></span>
<span id="cb81-4"><a href="#cb81-4" tabindex="-1"></a><span class="co">#&gt; Found more than one class &quot;stanfit&quot; in cache; using the first, from namespace &#39;rstan&#39;</span></span>
<span id="cb81-5"><a href="#cb81-5" tabindex="-1"></a><span class="co">#&gt; Also defined by &#39;rethinking&#39;</span></span></code></pre></div>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" tabindex="-1"></a><span class="fu">print</span>(fit.reg.adapt.mlm.vi,<span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;hl&quot;</span>,<span class="st">&quot;vy&quot;</span>,<span class="st">&quot;optima&quot;</span>,<span class="st">&quot;beta&quot;</span>,<span class="st">&quot;beta_e&quot;</span>,<span class="st">&quot;sigma&quot;</span>))</span>
<span id="cb82-2"><a href="#cb82-2" tabindex="-1"></a><span class="co">#&gt; Inference for Stan model: blouchOU_reg_adapt_mlm_vi.</span></span>
<span id="cb82-3"><a href="#cb82-3" tabindex="-1"></a><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span id="cb82-4"><a href="#cb82-4" tabindex="-1"></a><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span id="cb82-5"><a href="#cb82-5" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb82-6"><a href="#cb82-6" tabindex="-1"></a><span class="co">#&gt;           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span id="cb82-7"><a href="#cb82-7" tabindex="-1"></a><span class="co">#&gt; hl        0.25    0.00 0.06 0.15 0.21 0.24 0.28  0.38  1154    1</span></span>
<span id="cb82-8"><a href="#cb82-8" tabindex="-1"></a><span class="co">#&gt; vy        0.02    0.00 0.01 0.01 0.02 0.02 0.02  0.03  1701    1</span></span>
<span id="cb82-9"><a href="#cb82-9" tabindex="-1"></a><span class="co">#&gt; optima[1] 2.04    0.00 0.06 1.92 2.00 2.04 2.08  2.16  1791    1</span></span>
<span id="cb82-10"><a href="#cb82-10" tabindex="-1"></a><span class="co">#&gt; optima[2] 0.83    0.00 0.12 0.56 0.77 0.84 0.91  1.03  1177    1</span></span>
<span id="cb82-11"><a href="#cb82-11" tabindex="-1"></a><span class="co">#&gt; beta[1]   0.24    0.00 0.05 0.14 0.20 0.24 0.27  0.34  1423    1</span></span>
<span id="cb82-12"><a href="#cb82-12" tabindex="-1"></a><span class="co">#&gt; beta_e[1] 0.16    0.00 0.03 0.09 0.13 0.16 0.18  0.22  1802    1</span></span>
<span id="cb82-13"><a href="#cb82-13" tabindex="-1"></a><span class="co">#&gt; sigma     0.92    0.01 0.46 0.34 0.58 0.82 1.13  2.01  2198    1</span></span>
<span id="cb82-14"><a href="#cb82-14" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb82-15"><a href="#cb82-15" tabindex="-1"></a><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Fri Oct 10 16:23:52 2025.</span></span>
<span id="cb82-16"><a href="#cb82-16" tabindex="-1"></a><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span id="cb82-17"><a href="#cb82-17" tabindex="-1"></a><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span id="cb82-18"><a href="#cb82-18" tabindex="-1"></a><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span id="cb82-19"><a href="#cb82-19" tabindex="-1"></a>post<span class="ot">&lt;-</span>rstan<span class="sc">::</span><span class="fu">extract</span>(fit.reg.adapt.mlm.vi)</span></code></pre></div>
<p>And the non-centered version</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" tabindex="-1"></a>fit.reg.adapt.mlm.vi.nc<span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">sampling</span>(<span class="at">object =</span> blouch<span class="sc">:::</span>stanmodels<span class="sc">$</span>blouchOU_reg_adapt_mlm_vi_nc,<span class="at">data =</span> dat,<span class="at">chains =</span> <span class="dv">2</span>,<span class="at">cores=</span><span class="dv">2</span>,<span class="at">iter =</span><span class="dv">2000</span>)</span>
<span id="cb83-2"><a href="#cb83-2" tabindex="-1"></a><span class="co">#&gt; Found more than one class &quot;stanfit&quot; in cache; using the first, from namespace &#39;rstan&#39;</span></span>
<span id="cb83-3"><a href="#cb83-3" tabindex="-1"></a><span class="co">#&gt; Also defined by &#39;rethinking&#39;</span></span>
<span id="cb83-4"><a href="#cb83-4" tabindex="-1"></a><span class="co">#&gt; Found more than one class &quot;stanfit&quot; in cache; using the first, from namespace &#39;rstan&#39;</span></span>
<span id="cb83-5"><a href="#cb83-5" tabindex="-1"></a><span class="co">#&gt; Also defined by &#39;rethinking&#39;</span></span>
<span id="cb83-6"><a href="#cb83-6" tabindex="-1"></a><span class="co">#&gt; Warning: There were 28 divergent transitions after warmup. See</span></span>
<span id="cb83-7"><a href="#cb83-7" tabindex="-1"></a><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span id="cb83-8"><a href="#cb83-8" tabindex="-1"></a><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span id="cb83-9"><a href="#cb83-9" tabindex="-1"></a><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span></code></pre></div>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" tabindex="-1"></a><span class="fu">print</span>(fit.reg.adapt.mlm.vi.nc,<span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;hl&quot;</span>,<span class="st">&quot;vy&quot;</span>,<span class="st">&quot;optima&quot;</span>,<span class="st">&quot;beta&quot;</span>,<span class="st">&quot;beta_e&quot;</span>,<span class="st">&quot;sigma&quot;</span>))</span>
<span id="cb84-2"><a href="#cb84-2" tabindex="-1"></a><span class="co">#&gt; Inference for Stan model: blouchOU_reg_adapt_mlm_vi_nc.</span></span>
<span id="cb84-3"><a href="#cb84-3" tabindex="-1"></a><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span id="cb84-4"><a href="#cb84-4" tabindex="-1"></a><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span id="cb84-5"><a href="#cb84-5" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb84-6"><a href="#cb84-6" tabindex="-1"></a><span class="co">#&gt;           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span id="cb84-7"><a href="#cb84-7" tabindex="-1"></a><span class="co">#&gt; hl        0.25    0.00 0.06 0.15 0.21 0.24 0.28  0.38  2550 1.00</span></span>
<span id="cb84-8"><a href="#cb84-8" tabindex="-1"></a><span class="co">#&gt; vy        0.02    0.00 0.01 0.01 0.02 0.02 0.02  0.04  2572 1.00</span></span>
<span id="cb84-9"><a href="#cb84-9" tabindex="-1"></a><span class="co">#&gt; optima[1] 2.03    0.00 0.06 1.92 1.99 2.03 2.07  2.16  1970 1.00</span></span>
<span id="cb84-10"><a href="#cb84-10" tabindex="-1"></a><span class="co">#&gt; optima[2] 0.83    0.00 0.11 0.58 0.77 0.85 0.91  1.03  2063 1.00</span></span>
<span id="cb84-11"><a href="#cb84-11" tabindex="-1"></a><span class="co">#&gt; beta[1]   0.23    0.00 0.05 0.14 0.20 0.23 0.26  0.34  2897 1.00</span></span>
<span id="cb84-12"><a href="#cb84-12" tabindex="-1"></a><span class="co">#&gt; beta_e[1] 0.16    0.00 0.03 0.09 0.13 0.16 0.18  0.22  3233 1.00</span></span>
<span id="cb84-13"><a href="#cb84-13" tabindex="-1"></a><span class="co">#&gt; sigma     0.89    0.01 0.39 0.36 0.60 0.81 1.10  1.83  1281 1.01</span></span>
<span id="cb84-14"><a href="#cb84-14" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb84-15"><a href="#cb84-15" tabindex="-1"></a><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Fri Oct 10 16:25:32 2025.</span></span>
<span id="cb84-16"><a href="#cb84-16" tabindex="-1"></a><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span id="cb84-17"><a href="#cb84-17" tabindex="-1"></a><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span id="cb84-18"><a href="#cb84-18" tabindex="-1"></a><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span id="cb84-19"><a href="#cb84-19" tabindex="-1"></a>post<span class="ot">&lt;-</span>rstan<span class="sc">::</span><span class="fu">extract</span>(fit.reg.adapt.mlm.vi.nc)</span></code></pre></div>
=======
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Set Priors</span></span>
<span><span class="va">hl.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.25</span><span class="op">)</span>,<span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="va">vy.prior</span><span class="op">&lt;-</span><span class="fl">5</span></span>
<span><span class="va">optima.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>,<span class="fl">0.5</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span>
<span><span class="va">beta.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.25</span><span class="op">)</span> <span class="co">#Informed by linear model</span></span>
<span><span class="va">sigma.prior</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Make trdata file</span></span>
<span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">trdata</span><span class="op">$</span><span class="va">dat</span>,<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Y_with_error</span>,<span class="va">Y_error</span>,<span class="va">X_with_error</span>,<span class="va">X_error</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">############################################################################################################</span></span>
<span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/blouch.reg.adapt.mlm.prep.html">blouch.reg.adapt.mlm.prep</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="st">"Y_with_error"</span>,<span class="st">"Y_error"</span>,<span class="st">"X_with_error"</span>,<span class="st">"X_error"</span>,Z_adaptive<span class="op">=</span><span class="fl">1</span>,<span class="st">"regimes"</span>,<span class="va">hl.prior</span>,<span class="va">vy.prior</span>,<span class="va">optima.prior</span>,<span class="va">beta.prior</span>,<span class="va">sigma.prior</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.adapt.mlm.vi</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_adapt_mlm_vi</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores<span class="op">=</span><span class="fl">2</span>,iter <span class="op">=</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span></code></pre></div>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.adapt.mlm.vi</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span>,<span class="st">"beta_e"</span>,<span class="st">"sigma"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_adapt_mlm_vi.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.25    0.00 0.06 0.15 0.21 0.24 0.28  0.38  1154    1</span></span>
<span><span class="co">#&gt; vy        0.02    0.00 0.01 0.01 0.02 0.02 0.02  0.03  1701    1</span></span>
<span><span class="co">#&gt; optima[1] 2.04    0.00 0.06 1.92 2.00 2.04 2.08  2.16  1791    1</span></span>
<span><span class="co">#&gt; optima[2] 0.83    0.00 0.12 0.56 0.77 0.84 0.91  1.03  1177    1</span></span>
<span><span class="co">#&gt; beta[1]   0.24    0.00 0.05 0.14 0.20 0.24 0.27  0.34  1423    1</span></span>
<span><span class="co">#&gt; beta_e[1] 0.16    0.00 0.03 0.09 0.13 0.16 0.18  0.22  1802    1</span></span>
<span><span class="co">#&gt; sigma     0.92    0.01 0.46 0.34 0.58 0.82 1.13  2.01  2198    1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Sat Oct 11 15:34:28 2025.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.adapt.mlm.vi</span><span class="op">)</span></span></code></pre></div>
<p>And the non-centered version</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.adapt.mlm.vi.nc</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_adapt_mlm_vi_nc</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores<span class="op">=</span><span class="fl">2</span>,iter <span class="op">=</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Warning: There were 28 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span></code></pre></div>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.adapt.mlm.vi.nc</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span>,<span class="st">"beta_e"</span>,<span class="st">"sigma"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_adapt_mlm_vi_nc.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.25    0.00 0.06 0.15 0.21 0.24 0.28  0.38  2550 1.00</span></span>
<span><span class="co">#&gt; vy        0.02    0.00 0.01 0.01 0.02 0.02 0.02  0.04  2572 1.00</span></span>
<span><span class="co">#&gt; optima[1] 2.03    0.00 0.06 1.92 1.99 2.03 2.07  2.16  1970 1.00</span></span>
<span><span class="co">#&gt; optima[2] 0.83    0.00 0.11 0.58 0.77 0.85 0.91  1.03  2063 1.00</span></span>
<span><span class="co">#&gt; beta[1]   0.23    0.00 0.05 0.14 0.20 0.23 0.26  0.34  2897 1.00</span></span>
<span><span class="co">#&gt; beta_e[1] 0.16    0.00 0.03 0.09 0.13 0.16 0.18  0.22  3233 1.00</span></span>
<span><span class="co">#&gt; sigma     0.89    0.01 0.39 0.36 0.60 0.81 1.10  1.83  1281 1.01</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Sat Oct 11 15:35:58 2025.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.adapt.mlm.vi.nc</span><span class="op">)</span></span></code></pre></div>
>>>>>>> dev-fixes-blouch1.0
<p>From there the posteriors should be explored, compared to the priors,
etc. See the Simulation Example for one example of how to do this.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span></code></pre></div>
</div>
<div id="multi-optima-direct-effect-and-adaptive-model"
class="section level2">
<h2>Multi-optima Direct Effect and Adaptive Model</h2>
<p>We will now include both regimes painted on the tree and a direct
effect and adaptive predictor</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" tabindex="-1"></a><span class="do">############################################################################################################</span></span>
<span id="cb86-2"><a href="#cb86-2" tabindex="-1"></a><span class="co">#Regimes + Adaptive + Direct Model</span></span>
<span id="cb86-3"><a href="#cb86-3" tabindex="-1"></a><span class="do">############################################################################################################</span></span>
<span id="cb86-4"><a href="#cb86-4" tabindex="-1"></a><span class="co">#Create phylogeny</span></span>
<span id="cb86-5"><a href="#cb86-5" tabindex="-1"></a><span class="do">########################################################################################################</span></span>
<span id="cb86-6"><a href="#cb86-6" tabindex="-1"></a>N<span class="ot">&lt;-</span><span class="dv">50</span> <span class="co">#Number of species</span></span>
<span id="cb86-7"><a href="#cb86-7" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">10</span>) <span class="co">#Set seed to get same random species each time</span></span>
<span id="cb86-8"><a href="#cb86-8" tabindex="-1"></a></span>
<span id="cb86-9"><a href="#cb86-9" tabindex="-1"></a>phy <span class="ot">&lt;-</span> ape<span class="sc">::</span><span class="fu">keep.tip</span>(tree<span class="fl">.10</span>K,<span class="fu">sample</span>(tree<span class="fl">.10</span>K<span class="sc">$</span>tip.label)[<span class="dv">1</span><span class="sc">:</span>N]) </span>
<span id="cb86-10"><a href="#cb86-10" tabindex="-1"></a>phy<span class="ot">&lt;-</span>ape<span class="sc">::</span><span class="fu">multi2di</span>(phy)</span>
<span id="cb86-11"><a href="#cb86-11" tabindex="-1"></a></span>
<span id="cb86-12"><a href="#cb86-12" tabindex="-1"></a>l.tree<span class="ot">&lt;-</span><span class="fu">max</span>(ape<span class="sc">::</span><span class="fu">branching.times</span>(phy)) <span class="do">## rescale tree to height 1</span></span>
<span id="cb86-13"><a href="#cb86-13" tabindex="-1"></a>phy<span class="sc">$</span>edge.length<span class="ot">&lt;-</span>phy<span class="sc">$</span>edge.length<span class="sc">/</span>l.tree </span>
<span id="cb86-14"><a href="#cb86-14" tabindex="-1"></a></span>
<span id="cb86-15"><a href="#cb86-15" tabindex="-1"></a>tip.label<span class="ot">&lt;-</span>phy<span class="sc">$</span>tip.label</span>
<span id="cb86-16"><a href="#cb86-16" tabindex="-1"></a></span>
<span id="cb86-17"><a href="#cb86-17" tabindex="-1"></a><span class="co">#Set regimes - manually - 2 regimes</span></span>
<span id="cb86-18"><a href="#cb86-18" tabindex="-1"></a><span class="co">#Locate nodes</span></span>
<span id="cb86-19"><a href="#cb86-19" tabindex="-1"></a><span class="fu">plot</span>(phy,<span class="at">no.margin=</span><span class="cn">TRUE</span>,<span class="at">edge.width=</span><span class="dv">2</span>,<span class="at">cex=</span><span class="fl">0.7</span>)</span>
<span id="cb86-20"><a href="#cb86-20" tabindex="-1"></a>ape<span class="sc">::</span><span class="fu">nodelabels</span>(<span class="at">frame=</span><span class="st">&quot;none&quot;</span>,<span class="at">adj=</span><span class="fu">c</span>(<span class="fl">1.1</span>,<span class="sc">-</span><span class="fl">0.4</span>))</span>
<span id="cb86-21"><a href="#cb86-21" tabindex="-1"></a>ape<span class="sc">::</span><span class="fu">tiplabels</span>()</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_direct_adaptive_model_setup-1.png" width="700" /></p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" tabindex="-1"></a></span>
<span id="cb87-2"><a href="#cb87-2" tabindex="-1"></a><span class="co">#Paint Regimes on Tree</span></span>
<span id="cb87-3"><a href="#cb87-3" tabindex="-1"></a>shifts<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">84</span>) <span class="co">#Location of nodes with regime shifts</span></span>
<span id="cb87-4"><a href="#cb87-4" tabindex="-1"></a>trdata<span class="ot">&lt;-</span><span class="fu">data.frame</span>(phy<span class="sc">$</span>tip.label)</span>
<span id="cb87-5"><a href="#cb87-5" tabindex="-1"></a>trdata<span class="ot">&lt;-</span>treeplyr<span class="sc">::</span><span class="fu">make.treedata</span>(phy,trdata)</span>
<span id="cb87-6"><a href="#cb87-6" tabindex="-1"></a>trdata<span class="ot">&lt;-</span><span class="fu">set.converge.regimes</span>(trdata,shifts)</span>
<span id="cb87-7"><a href="#cb87-7" tabindex="-1"></a><span class="co">#&gt; [1] 1</span></span>
<span id="cb87-8"><a href="#cb87-8" tabindex="-1"></a><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb87-9"><a href="#cb87-9" tabindex="-1"></a><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb87-10"><a href="#cb87-10" tabindex="-1"></a><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb87-11"><a href="#cb87-11" tabindex="-1"></a><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span id="cb87-12"><a href="#cb87-12" tabindex="-1"></a><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb87-13"><a href="#cb87-13" tabindex="-1"></a><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span id="cb87-14"><a href="#cb87-14" tabindex="-1"></a><span class="co">#&gt; Levels: OU1 OU2</span></span>
<span id="cb87-15"><a href="#cb87-15" tabindex="-1"></a><span class="co">#&gt; [1] &quot;#E64B35FF&quot; &quot;#4DBBD5FF&quot;</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_direct_adaptive_model_setup-2.png" width="700" /></p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" tabindex="-1"></a></span>
<span id="cb88-2"><a href="#cb88-2" tabindex="-1"></a><span class="co">#Check if manual setting code worked</span></span>
<span id="cb88-3"><a href="#cb88-3" tabindex="-1"></a>shifts.total<span class="ot">&lt;-</span><span class="fu">c</span>(trdata<span class="sc">$</span>dat<span class="sc">$</span>regimes,trdata<span class="sc">$</span>phy<span class="sc">$</span>node.label)</span>
<span id="cb88-4"><a href="#cb88-4" tabindex="-1"></a>edge.regimes <span class="ot">&lt;-</span> <span class="fu">factor</span>(shifts.total[trdata<span class="sc">$</span>phy<span class="sc">$</span>edge[,<span class="dv">2</span>]])</span>
<span id="cb88-5"><a href="#cb88-5" tabindex="-1"></a><span class="fu">print</span>(edge.regimes)</span>
<span id="cb88-6"><a href="#cb88-6" tabindex="-1"></a><span class="co">#&gt;  [1] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb88-7"><a href="#cb88-7" tabindex="-1"></a><span class="co">#&gt; [20] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb88-8"><a href="#cb88-8" tabindex="-1"></a><span class="co">#&gt; [39] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb88-9"><a href="#cb88-9" tabindex="-1"></a><span class="co">#&gt; [58] OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2</span></span>
<span id="cb88-10"><a href="#cb88-10" tabindex="-1"></a><span class="co">#&gt; [77] OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU2 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1 OU1</span></span>
<span id="cb88-11"><a href="#cb88-11" tabindex="-1"></a><span class="co">#&gt; [96] OU1 OU1 OU1</span></span>
<span id="cb88-12"><a href="#cb88-12" tabindex="-1"></a><span class="co">#&gt; Levels: OU1 OU2</span></span>
<span id="cb88-13"><a href="#cb88-13" tabindex="-1"></a></span>
<span id="cb88-14"><a href="#cb88-14" tabindex="-1"></a>reg.colors <span class="ot">&lt;-</span> ggsci<span class="sc">::</span><span class="fu">pal_aaas</span>(<span class="st">&quot;default&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>)(<span class="dv">2</span>)</span>
<span id="cb88-15"><a href="#cb88-15" tabindex="-1"></a><span class="fu">print</span>(reg.colors)</span>
<span id="cb88-16"><a href="#cb88-16" tabindex="-1"></a><span class="co">#&gt; [1] &quot;#3B4992B2&quot; &quot;#EE0000B2&quot;</span></span>
<span id="cb88-17"><a href="#cb88-17" tabindex="-1"></a><span class="fu">plot</span>(trdata<span class="sc">$</span>phy,<span class="at">edge.color =</span> reg.colors[edge.regimes], <span class="at">edge.width =</span> <span class="dv">1</span>, <span class="at">cex =</span> <span class="fl">0.2</span>)</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_direct_adaptive_model_setup-3.png" width="700" /></p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" tabindex="-1"></a></span>
<span id="cb89-2"><a href="#cb89-2" tabindex="-1"></a><span class="co">#Phylogeny info</span></span>
<span id="cb89-3"><a href="#cb89-3" tabindex="-1"></a>n<span class="ot">&lt;-</span><span class="fu">length</span>(trdata<span class="sc">$</span>phy<span class="sc">$</span>tip.label)</span>
<span id="cb89-4"><a href="#cb89-4" tabindex="-1"></a></span>
<span id="cb89-5"><a href="#cb89-5" tabindex="-1"></a>regimes_internal <span class="ot">&lt;-</span>trdata<span class="sc">$</span>phy<span class="sc">$</span>node.label</span>
<span id="cb89-6"><a href="#cb89-6" tabindex="-1"></a>regimes_tip <span class="ot">&lt;-</span> trdata<span class="sc">$</span>dat<span class="sc">$</span>regimes</span>
<span id="cb89-7"><a href="#cb89-7" tabindex="-1"></a>regimes <span class="ot">&lt;-</span> <span class="fu">concat.factor</span>(regimes_tip, regimes_internal)</span>
<span id="cb89-8"><a href="#cb89-8" tabindex="-1"></a>anc_maps<span class="ot">&lt;-</span><span class="st">&quot;regimes&quot;</span></span>
<span id="cb89-9"><a href="#cb89-9" tabindex="-1"></a>lineages <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="cf">function</span>(e) <span class="fu">lineage.constructor</span>(trdata<span class="sc">$</span>phy, e, anc_maps, regimes)) <span class="co">#Trace lineage from tips (n) to root and determine regimes of each node or branch</span></span></code></pre></div>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" tabindex="-1"></a><span class="do">############################################################################################################</span></span>
<span id="cb90-2"><a href="#cb90-2" tabindex="-1"></a>hl<span class="ot">&lt;-</span><span class="fl">0.1</span> <span class="co">#0.1, 0.25, 0.75 - testing options</span></span>
<span id="cb90-3"><a href="#cb90-3" tabindex="-1"></a>a<span class="ot">&lt;-</span><span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">/</span>hl</span>
<span id="cb90-4"><a href="#cb90-4" tabindex="-1"></a>vy<span class="ot">&lt;-</span><span class="fl">0.01</span> <span class="co">#0.25,0.5 - testing options</span></span>
<span id="cb90-5"><a href="#cb90-5" tabindex="-1"></a>sigma2_y<span class="ot">&lt;-</span>vy<span class="sc">*</span>(<span class="dv">2</span><span class="sc">*</span>(<span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">/</span>hl));</span>
<span id="cb90-6"><a href="#cb90-6" tabindex="-1"></a></span>
<span id="cb90-7"><a href="#cb90-7" tabindex="-1"></a>vX0<span class="ot">&lt;-</span><span class="dv">0</span></span>
<span id="cb90-8"><a href="#cb90-8" tabindex="-1"></a>vY0 <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb90-9"><a href="#cb90-9" tabindex="-1"></a></span>
<span id="cb90-10"><a href="#cb90-10" tabindex="-1"></a>Z_direct<span class="ot">&lt;-</span><span class="dv">1</span></span>
<span id="cb90-11"><a href="#cb90-11" tabindex="-1"></a>Z_adaptive<span class="ot">&lt;-</span><span class="dv">1</span></span>
<span id="cb90-12"><a href="#cb90-12" tabindex="-1"></a>Z<span class="ot">&lt;-</span>Z_direct<span class="sc">+</span>Z_adaptive</span>
<span id="cb90-13"><a href="#cb90-13" tabindex="-1"></a>sigma2_x<span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>) <span class="co">#Variance of BM Process</span></span>
<span id="cb90-14"><a href="#cb90-14" tabindex="-1"></a></span>
<span id="cb90-15"><a href="#cb90-15" tabindex="-1"></a>Xd<span class="ot">&lt;-</span><span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb90-16"><a href="#cb90-16" tabindex="-1"></a><span class="fu">names</span>(Xd)<span class="ot">&lt;-</span>phy<span class="sc">$</span>tip.label</span>
<span id="cb90-17"><a href="#cb90-17" tabindex="-1"></a>phytools<span class="sc">::</span><span class="fu">phenogram</span>(phy,Xd,<span class="at">spread.labels=</span><span class="cn">TRUE</span>,<span class="at">spread.cost=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>)) <span class="co">#Plot X data</span></span>
<span id="cb90-18"><a href="#cb90-18" tabindex="-1"></a><span class="co">#&gt; Optimizing the positions of the tip labels...</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_direct_adaptive_model_data-1.png" width="700" /></p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" tabindex="-1"></a>Xa<span class="ot">&lt;-</span>phytools<span class="sc">::</span><span class="fu">fastBM</span>(phy,<span class="at">a=</span>vX0,<span class="at">sig2=</span>sigma2_x[<span class="dv">1</span>,<span class="dv">1</span>],<span class="at">internal=</span><span class="cn">FALSE</span>) <span class="co">#Simulate X BM variable on tree, with scaling 10</span></span>
<span id="cb91-2"><a href="#cb91-2" tabindex="-1"></a>phytools<span class="sc">::</span><span class="fu">phenogram</span>(phy,Xa,<span class="at">spread.labels=</span><span class="cn">TRUE</span>,<span class="at">spread.cost=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">0</span>)) <span class="co">#Plot X data</span></span>
<span id="cb91-3"><a href="#cb91-3" tabindex="-1"></a><span class="co">#&gt; Optimizing the positions of the tip labels...</span></span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_direct_adaptive_model_data-2.png" width="700" /></p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" tabindex="-1"></a><span class="co">#sigma2_x&lt;-ratematrix(phy,Xa) #Calculate evolutionary v/cv matrix</span></span>
<span id="cb92-2"><a href="#cb92-2" tabindex="-1"></a>Xs<span class="ot">&lt;-</span><span class="fu">cbind</span>(Xd,Xa)</span>
<span id="cb92-3"><a href="#cb92-3" tabindex="-1"></a></span>
<span id="cb92-4"><a href="#cb92-4" tabindex="-1"></a>dmX<span class="ot">&lt;-</span><span class="fu">weight.matrix</span>(trdata<span class="sc">$</span>phy, a, lineages) <span class="co">#Slouch approach</span></span>
<span id="cb92-5"><a href="#cb92-5" tabindex="-1"></a>dmX<span class="ot">&lt;-</span><span class="fu">cbind</span>(dmX,<span class="fu">calc_mixed_dmX</span>(phy,a,Xs,Z_direct,Z_adaptive))</span>
<span id="cb92-6"><a href="#cb92-6" tabindex="-1"></a></span>
<span id="cb92-7"><a href="#cb92-7" tabindex="-1"></a>beta<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">1</span>,<span class="fl">0.35</span>,<span class="fl">0.25</span>) <span class="co">#Two Optima/Two Slopes</span></span>
<span id="cb92-8"><a href="#cb92-8" tabindex="-1"></a>mu<span class="ot">&lt;-</span>dmX<span class="sc">%*%</span>beta <span class="co">#Simulate mu for Y</span></span>
<span id="cb92-9"><a href="#cb92-9" tabindex="-1"></a></span>
<span id="cb92-10"><a href="#cb92-10" tabindex="-1"></a>V<span class="ot">&lt;-</span><span class="fu">calc_adaptive_V</span>(phy,a, sigma2_y,   beta[<span class="fu">length</span>(beta)],  sigma2_x,Z_adaptive)</span>
<span id="cb92-11"><a href="#cb92-11" tabindex="-1"></a>Y<span class="ot">&lt;-</span>MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(<span class="at">n=</span><span class="dv">1</span>,mu,V)</span>
<span id="cb92-12"><a href="#cb92-12" tabindex="-1"></a></span>
<span id="cb92-13"><a href="#cb92-13" tabindex="-1"></a><span class="do">################################################################################################################</span></span>
<span id="cb92-14"><a href="#cb92-14" tabindex="-1"></a><span class="co">#Plot data</span></span>
<span id="cb92-15"><a href="#cb92-15" tabindex="-1"></a>df<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">Y=</span>Y,<span class="at">Xd=</span>Xs[,<span class="dv">1</span>],<span class="at">Xa=</span>Xs[,<span class="dv">2</span>])</span>
<span id="cb92-16"><a href="#cb92-16" tabindex="-1"></a></span>
<span id="cb92-17"><a href="#cb92-17" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">data=</span>df,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>Xd,<span class="at">y=</span>Y))<span class="sc">+</span></span>
<span id="cb92-18"><a href="#cb92-18" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>()</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_direct_adaptive_model_data-3.png" width="700" /></p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" tabindex="-1"></a></span>
<span id="cb93-2"><a href="#cb93-2" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>(<span class="at">data=</span>df,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>Xa,<span class="at">y=</span>Y))<span class="sc">+</span></span>
<span id="cb93-3"><a href="#cb93-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>()</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/Multi_optima_direct_adaptive_model_data-4.png" width="700" /></p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">lm</span>(Y<span class="sc">~</span>Xs,df))</span>
<span id="cb94-2"><a href="#cb94-2" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb94-3"><a href="#cb94-3" tabindex="-1"></a><span class="co">#&gt; Call:</span></span>
<span id="cb94-4"><a href="#cb94-4" tabindex="-1"></a><span class="co">#&gt; lm(formula = Y ~ Xs, data = df)</span></span>
<span id="cb94-5"><a href="#cb94-5" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb94-6"><a href="#cb94-6" tabindex="-1"></a><span class="co">#&gt; Residuals:</span></span>
<span id="cb94-7"><a href="#cb94-7" tabindex="-1"></a><span class="co">#&gt;      Min       1Q   Median       3Q      Max </span></span>
<span id="cb94-8"><a href="#cb94-8" tabindex="-1"></a><span class="co">#&gt; -0.84900 -0.16208  0.08845  0.25892  0.67924 </span></span>
<span id="cb94-9"><a href="#cb94-9" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb94-10"><a href="#cb94-10" tabindex="-1"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb94-11"><a href="#cb94-11" tabindex="-1"></a><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span id="cb94-12"><a href="#cb94-12" tabindex="-1"></a><span class="co">#&gt; (Intercept)  1.78206    0.05601  31.818  &lt; 2e-16 ***</span></span>
<span id="cb94-13"><a href="#cb94-13" tabindex="-1"></a><span class="co">#&gt; XsXd         0.23270    0.04105   5.668 8.52e-07 ***</span></span>
<span id="cb94-14"><a href="#cb94-14" tabindex="-1"></a><span class="co">#&gt; XsXa         0.14175    0.06396   2.216   0.0315 *  </span></span>
<span id="cb94-15"><a href="#cb94-15" tabindex="-1"></a><span class="co">#&gt; ---</span></span>
<span id="cb94-16"><a href="#cb94-16" tabindex="-1"></a><span class="co">#&gt; Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</span></span>
<span id="cb94-17"><a href="#cb94-17" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb94-18"><a href="#cb94-18" tabindex="-1"></a><span class="co">#&gt; Residual standard error: 0.3935 on 47 degrees of freedom</span></span>
<span id="cb94-19"><a href="#cb94-19" tabindex="-1"></a><span class="co">#&gt; Multiple R-squared:  0.4563, Adjusted R-squared:  0.4332 </span></span>
<span id="cb94-20"><a href="#cb94-20" tabindex="-1"></a><span class="co">#&gt; F-statistic: 19.72 on 2 and 47 DF,  p-value: 6.034e-07</span></span>
<span id="cb94-21"><a href="#cb94-21" tabindex="-1"></a></span>
<span id="cb94-22"><a href="#cb94-22" tabindex="-1"></a><span class="do">########################################################################################################</span></span>
<span id="cb94-23"><a href="#cb94-23" tabindex="-1"></a><span class="co">#Simulate errors - for use with blouchOU_reg_direct_adaptive_ME</span></span>
<span id="cb94-24"><a href="#cb94-24" tabindex="-1"></a>Z_X_error<span class="ot">&lt;-</span><span class="dv">2</span> <span class="co">#Number of X traits with error</span></span>
<span id="cb94-25"><a href="#cb94-25" tabindex="-1"></a>X_error<span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="fl">0.01</span>,<span class="at">nrow=</span>N,<span class="at">ncol=</span>Z_X_error)</span>
<span id="cb94-26"><a href="#cb94-26" tabindex="-1"></a>X_error<span class="ot">&lt;-</span><span class="fu">data.frame</span>(X_error)</span>
<span id="cb94-27"><a href="#cb94-27" tabindex="-1"></a><span class="fu">names</span>(X_error)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">&quot;Xd_error&quot;</span>,<span class="st">&quot;Xa_error&quot;</span>)</span>
<span id="cb94-28"><a href="#cb94-28" tabindex="-1"></a>Y_error<span class="ot">&lt;-</span><span class="fu">rep</span>(<span class="fl">0.01</span>,N)</span>
<span id="cb94-29"><a href="#cb94-29" tabindex="-1"></a>Y_with_error<span class="ot">&lt;-</span>Y<span class="sc">+</span><span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fl">0.01</span>)</span>
<span id="cb94-30"><a href="#cb94-30" tabindex="-1"></a>X_with_error<span class="ot">&lt;-</span><span class="fu">apply</span>(Xs,<span class="dv">2</span>,<span class="cf">function</span>(X){X<span class="sc">+</span><span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="fl">0.01</span>)})</span></code></pre></div>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" tabindex="-1"></a><span class="do">############################################################################################################</span></span>
<span id="cb95-2"><a href="#cb95-2" tabindex="-1"></a><span class="co">#Set Priors</span></span>
<span id="cb95-3"><a href="#cb95-3" tabindex="-1"></a>hl.prior<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fu">log</span>(<span class="fl">0.25</span>),<span class="fl">0.25</span>)</span>
<span id="cb95-4"><a href="#cb95-4" tabindex="-1"></a>vy.prior<span class="ot">&lt;-</span><span class="dv">5</span></span>
<span id="cb95-5"><a href="#cb95-5" tabindex="-1"></a>optima.prior<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fl">1.5</span>,<span class="fl">0.5</span>) <span class="co">#Informed by linear model</span></span>
<span id="cb95-6"><a href="#cb95-6" tabindex="-1"></a>beta.prior<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.25</span>) <span class="co">#Informed by linear model</span></span></code></pre></div>
<p>Half-life Prior plot</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" tabindex="-1"></a>hl.sims<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">rlnorm</span>(<span class="at">n=</span><span class="dv">1000</span>,<span class="at">meanlog=</span>hl.prior[<span class="dv">1</span>],<span class="at">sdlog=</span>hl.prior[<span class="dv">2</span>]))</span>
<span id="cb96-2"><a href="#cb96-2" tabindex="-1"></a><span class="fu">names</span>(hl.sims)<span class="ot">&lt;-</span><span class="st">&quot;prior.hl.sims&quot;</span></span>
<span id="cb96-3"><a href="#cb96-3" tabindex="-1"></a></span>
<span id="cb96-4"><a href="#cb96-4" tabindex="-1"></a>hl.prior.plot<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb96-5"><a href="#cb96-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(prior.hl.sims,<span class="at">fill=</span><span class="st">&quot;prior.hl.sims&quot;</span>),<span class="at">alpha=</span><span class="fl">0.2</span>,<span class="at">data=</span>hl.sims)<span class="sc">+</span></span>
<span id="cb96-6"><a href="#cb96-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb96-7"><a href="#cb96-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb96-8"><a href="#cb96-8" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(),</span>
<span id="cb96-9"><a href="#cb96-9" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb96-10"><a href="#cb96-10" tabindex="-1"></a>  </span>
<span id="cb96-11"><a href="#cb96-11" tabindex="-1"></a>  <span class="co">#labs(title=&quot;Prior vs. Posterior Distribution &quot;,x=&quot;Half-life&quot;, y = &quot;Density&quot;)+</span></span>
<span id="cb96-12"><a href="#cb96-12" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title=</span><span class="st">&quot;&quot;</span>,<span class="at">x=</span><span class="st">&quot;Half-life&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Density&quot;</span>)<span class="sc">+</span></span>
<span id="cb96-13"><a href="#cb96-13" tabindex="-1"></a>  </span>
<span id="cb96-14"><a href="#cb96-14" tabindex="-1"></a>  <span class="co">#scale_fill_manual(labels=c(&quot;Posterior&quot;,&quot;Prior&quot;))+</span></span>
<span id="cb96-15"><a href="#cb96-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept=</span><span class="fu">c</span>(hl),<span class="at">linetype=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb96-16"><a href="#cb96-16" tabindex="-1"></a>  ggsci<span class="sc">::</span><span class="fu">scale_fill_npg</span>(<span class="at">name=</span><span class="st">&quot;&quot;</span>,<span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;Prior&quot;</span>))</span>
<span id="cb96-17"><a href="#cb96-17" tabindex="-1"></a></span>
<span id="cb96-18"><a href="#cb96-18" tabindex="-1"></a>hl.prior.plot</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-45-1.png" width="700" /></p>
<p>Vy Prior Plot</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" tabindex="-1"></a>vy.sims<span class="ot">&lt;-</span><span class="fu">rexp</span>(<span class="at">n=</span><span class="dv">1000</span>,<span class="at">rate=</span>vy.prior)</span>
<span id="cb97-2"><a href="#cb97-2" tabindex="-1"></a>vy.sims<span class="ot">&lt;-</span><span class="fu">data.frame</span>(vy.sims)</span>
<span id="cb97-3"><a href="#cb97-3" tabindex="-1"></a><span class="fu">names</span>(vy.sims)<span class="ot">&lt;-</span><span class="st">&quot;prior.vy.sims&quot;</span></span>
<span id="cb97-4"><a href="#cb97-4" tabindex="-1"></a></span>
<span id="cb97-5"><a href="#cb97-5" tabindex="-1"></a>vy.prior.plot<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb97-6"><a href="#cb97-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(prior.vy.sims,<span class="at">fill=</span><span class="st">&quot;prior.vy.sims&quot;</span>),<span class="at">alpha=</span><span class="fl">0.2</span>,<span class="at">data=</span>vy.sims)<span class="sc">+</span></span>
<span id="cb97-7"><a href="#cb97-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb97-8"><a href="#cb97-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb97-9"><a href="#cb97-9" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(),</span>
<span id="cb97-10"><a href="#cb97-10" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb97-11"><a href="#cb97-11" tabindex="-1"></a>  </span>
<span id="cb97-12"><a href="#cb97-12" tabindex="-1"></a>  <span class="co">#labs(title=&quot;Prior vs. Posterior Distribution &quot;,x=&quot;vy&quot;, y = &quot;Density&quot;)+</span></span>
<span id="cb97-13"><a href="#cb97-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title=</span><span class="st">&quot;&quot;</span>,<span class="at">x=</span><span class="st">&quot;vy&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Density&quot;</span>)<span class="sc">+</span></span>
<span id="cb97-14"><a href="#cb97-14" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept=</span><span class="fu">c</span>(vy),<span class="at">linetype=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb97-15"><a href="#cb97-15" tabindex="-1"></a>  </span>
<span id="cb97-16"><a href="#cb97-16" tabindex="-1"></a>  <span class="co">#scale_fill_manual(labels=c(&quot;Posterior&quot;,&quot;Prior&quot;))+</span></span>
<span id="cb97-17"><a href="#cb97-17" tabindex="-1"></a>  ggsci<span class="sc">::</span><span class="fu">scale_fill_npg</span>(<span class="at">name=</span><span class="st">&quot;&quot;</span>,<span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;Prior&quot;</span>))</span>
<span id="cb97-18"><a href="#cb97-18" tabindex="-1"></a></span>
<span id="cb97-19"><a href="#cb97-19" tabindex="-1"></a></span>
<span id="cb97-20"><a href="#cb97-20" tabindex="-1"></a>vy.prior.plot</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-46-1.png" width="700" /></p>
<p>Adaptation model</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" tabindex="-1"></a>a.sims<span class="ot">&lt;-</span><span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">/</span>hl.sims;</span>
<span id="cb98-2"><a href="#cb98-2" tabindex="-1"></a>sigma2_y.sims<span class="ot">&lt;-</span>vy.sims<span class="sc">*</span>(<span class="dv">2</span><span class="sc">*</span>(<span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">/</span>hl.sims));</span>
<span id="cb98-3"><a href="#cb98-3" tabindex="-1"></a><span class="co">#x&lt;-seq(from=0,to=1,by=0.001)</span></span>
<span id="cb98-4"><a href="#cb98-4" tabindex="-1"></a><span class="co">#V.sim&lt;-calc_direct_V(phy,a.sims,sigma2_y.sims)</span></span>
<span id="cb98-5"><a href="#cb98-5" tabindex="-1"></a></span>
<span id="cb98-6"><a href="#cb98-6" tabindex="-1"></a></span>
<span id="cb98-7"><a href="#cb98-7" tabindex="-1"></a><span class="fu">plot</span>( <span class="cn">NULL</span> , <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>) , <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.4</span>) , <span class="at">xlab=</span><span class="st">&quot;Time since MRCA&quot;</span> , <span class="at">ylab=</span><span class="st">&quot;Covariance&quot;</span> ,<span class="at">cex.axis=</span><span class="fl">0.75</span>, <span class="at">mgp=</span><span class="fu">c</span>(<span class="fl">1.25</span>,<span class="fl">0.25</span>,<span class="dv">0</span>),<span class="at">tcl=</span><span class="sc">-</span><span class="fl">0.25</span>)</span>
<span id="cb98-8"><a href="#cb98-8" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>){</span>
<span id="cb98-9"><a href="#cb98-9" tabindex="-1"></a>  <span class="fu">curve</span>(<span class="fu">calc_adaptive_cov_plot</span>(a.sims[i,],sigma2_y.sims[i,],beta[<span class="dv">3</span>],x) , <span class="at">add=</span><span class="cn">TRUE</span> , <span class="at">lwd=</span><span class="dv">4</span> , <span class="at">col=</span>rethinking<span class="sc">::</span><span class="fu">col.alpha</span>(<span class="dv">1</span>,<span class="fl">0.15</span>))</span>
<span id="cb98-10"><a href="#cb98-10" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-47-1.png" width="700" /></p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="fl">0.25</span>,<span class="fl">0.25</span>))</span>
<span id="cb99-2"><a href="#cb99-2" tabindex="-1"></a>covariance.plot <span class="ot">&lt;-</span> <span class="fu">recordPlot</span>()</span>
<span id="cb99-3"><a href="#cb99-3" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb99-4"><a href="#cb99-4" tabindex="-1"></a><span class="co">#&gt; null device </span></span>
<span id="cb99-5"><a href="#cb99-5" tabindex="-1"></a><span class="co">#&gt;           1</span></span>
<span id="cb99-6"><a href="#cb99-6" tabindex="-1"></a></span>
<span id="cb99-7"><a href="#cb99-7" tabindex="-1"></a>covariance.plot</span></code></pre></div>
<p>Prior vs. Posterior Plot</p>
<div class="sourceCode" id="cb100"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" tabindex="-1"></a>optima.sims<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="dv">100</span>,optima.prior[<span class="dv">1</span>],optima.prior[<span class="dv">2</span>])</span>
<span id="cb100-2"><a href="#cb100-2" tabindex="-1"></a>beta.sims<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="at">n=</span><span class="dv">100</span>,beta.prior[<span class="dv">1</span>],beta.prior[<span class="dv">2</span>])</span>
<span id="cb100-3"><a href="#cb100-3" tabindex="-1"></a></span>
<span id="cb100-4"><a href="#cb100-4" tabindex="-1"></a>df<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">Y=</span>Y_with_error,<span class="at">X=</span>X_with_error,<span class="at">Regimes=</span>regimes_tip)</span>
<span id="cb100-5"><a href="#cb100-5" tabindex="-1"></a></span>
<span id="cb100-6"><a href="#cb100-6" tabindex="-1"></a>slope.plot.Xd<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>()<span class="sc">+</span>  </span>
<span id="cb100-7"><a href="#cb100-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">data=</span>df,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y=</span>Y,<span class="at">x=</span>X.Xd,<span class="at">color=</span>Regimes))<span class="sc">+</span></span>
<span id="cb100-8"><a href="#cb100-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_abline</span>(<span class="at">intercept=</span>optima.sims,<span class="at">slope=</span>beta.sims,<span class="at">alpha=</span><span class="fl">0.15</span>)<span class="sc">+</span> <span class="co">#Prior</span></span>
<span id="cb100-9"><a href="#cb100-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb100-10"><a href="#cb100-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb100-11"><a href="#cb100-11" tabindex="-1"></a>  <span class="at">panel.grid.major =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(),</span>
<span id="cb100-12"><a href="#cb100-12" tabindex="-1"></a>  <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb100-13"><a href="#cb100-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ylab</span>(<span class="st">&quot;Y&quot;</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">xlab</span>(<span class="st">&quot;Direct effect trait&quot;</span>)<span class="sc">+</span></span>
<span id="cb100-14"><a href="#cb100-14" tabindex="-1"></a>  ggsci<span class="sc">::</span><span class="fu">scale_color_npg</span>()</span>
<span id="cb100-15"><a href="#cb100-15" tabindex="-1"></a></span>
<span id="cb100-16"><a href="#cb100-16" tabindex="-1"></a>slope.plot.Xd</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-48-1.png" width="700" /></p>
<div class="sourceCode" id="cb101"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" tabindex="-1"></a></span>
<span id="cb101-2"><a href="#cb101-2" tabindex="-1"></a>slope.plot.Xa<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>()<span class="sc">+</span>  </span>
<span id="cb101-3"><a href="#cb101-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">data=</span>df,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y=</span>Y,<span class="at">x=</span>X.Xa,<span class="at">color=</span>Regimes))<span class="sc">+</span></span>
<span id="cb101-4"><a href="#cb101-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_abline</span>(<span class="at">intercept=</span>optima.sims,<span class="at">slope=</span>beta.sims,<span class="at">alpha=</span><span class="fl">0.15</span>)<span class="sc">+</span> <span class="co">#Prior</span></span>
<span id="cb101-5"><a href="#cb101-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb101-6"><a href="#cb101-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb101-7"><a href="#cb101-7" tabindex="-1"></a>  <span class="at">panel.grid.major =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(),</span>
<span id="cb101-8"><a href="#cb101-8" tabindex="-1"></a>  <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb101-9"><a href="#cb101-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ylab</span>(<span class="st">&quot;Y&quot;</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">xlab</span>(<span class="st">&quot;Adaptive trait&quot;</span>)<span class="sc">+</span></span>
<span id="cb101-10"><a href="#cb101-10" tabindex="-1"></a>  ggsci<span class="sc">::</span><span class="fu">scale_color_npg</span>()</span>
<span id="cb101-11"><a href="#cb101-11" tabindex="-1"></a></span>
<span id="cb101-12"><a href="#cb101-12" tabindex="-1"></a>slope.plot.Xa</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-48-2.png" width="700" /></p>
<div class="sourceCode" id="cb102"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" tabindex="-1"></a><span class="do">############################################################################################################</span></span>
<span id="cb102-2"><a href="#cb102-2" tabindex="-1"></a><span class="co">#Make trdata file</span></span>
<span id="cb102-3"><a href="#cb102-3" tabindex="-1"></a>trdata<span class="sc">$</span>dat<span class="ot">&lt;-</span><span class="fu">cbind</span>(trdata<span class="sc">$</span>dat,<span class="fu">data.frame</span>(<span class="fu">cbind</span>(Y_with_error,Y_error,X_with_error,X_error)))</span></code></pre></div>
<p>We will use the helper function blouch.reg.direct.adapt.prep() to
setup the dat file for Stan. Here the names of the direct effect and
adaptive columns are “Xd”, and “Xa” and their associated errors, with
Z_direct and Z_adaptive th number of direct and adaptive traits,
respectively, and “regimes” is the name of the regimes column data in
trdata$dat.</p>
<div class="sourceCode" id="cb103"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" tabindex="-1"></a><span class="do">############################################################################################################</span></span>
<span id="cb103-2"><a href="#cb103-2" tabindex="-1"></a>dat<span class="ot">&lt;-</span><span class="fu">blouch.reg.direct.adapt.prep</span>(trdata,<span class="st">&quot;Y_with_error&quot;</span>,<span class="st">&quot;Y_error&quot;</span>,<span class="fu">c</span>(<span class="st">&quot;Xd&quot;</span>,<span class="st">&quot;Xa&quot;</span>),<span class="fu">c</span>(<span class="st">&quot;Xd_error&quot;</span>,<span class="st">&quot;Xa_error&quot;</span>),<span class="at">Z_direct=</span><span class="dv">1</span>,<span class="at">Z_adaptive=</span><span class="dv">1</span>,<span class="st">&quot;regimes&quot;</span>,hl.prior,vy.prior,optima.prior,beta.prior)</span></code></pre></div>
<p>First we run the basic Multi-optima Direct Effect Adaptive Model.</p>
<<<<<<< HEAD
<div class="sourceCode" id="cb104"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" tabindex="-1"></a>fit.reg.direct.adapt<span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">sampling</span>(<span class="at">object =</span> blouch<span class="sc">:::</span>stanmodels<span class="sc">$</span>blouchOU_reg_direct_adapt,<span class="at">data =</span> dat,<span class="at">chains =</span> <span class="dv">2</span>,<span class="at">cores=</span><span class="dv">2</span>,<span class="at">iter =</span><span class="dv">2000</span>)</span>
<span id="cb104-2"><a href="#cb104-2" tabindex="-1"></a><span class="co">#&gt; Found more than one class &quot;stanfit&quot; in cache; using the first, from namespace &#39;rstan&#39;</span></span>
<span id="cb104-3"><a href="#cb104-3" tabindex="-1"></a><span class="co">#&gt; Also defined by &#39;rethinking&#39;</span></span>
<span id="cb104-4"><a href="#cb104-4" tabindex="-1"></a><span class="co">#&gt; Found more than one class &quot;stanfit&quot; in cache; using the first, from namespace &#39;rstan&#39;</span></span>
<span id="cb104-5"><a href="#cb104-5" tabindex="-1"></a><span class="co">#&gt; Also defined by &#39;rethinking&#39;</span></span></code></pre></div>
<div class="sourceCode" id="cb105"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" tabindex="-1"></a><span class="fu">print</span>(fit.reg.direct.adapt,<span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;hl&quot;</span>,<span class="st">&quot;vy&quot;</span>,<span class="st">&quot;optima&quot;</span>,<span class="st">&quot;beta&quot;</span>,<span class="st">&quot;beta_e&quot;</span>))</span>
<span id="cb105-2"><a href="#cb105-2" tabindex="-1"></a><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_adapt.</span></span>
<span id="cb105-3"><a href="#cb105-3" tabindex="-1"></a><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span id="cb105-4"><a href="#cb105-4" tabindex="-1"></a><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span id="cb105-5"><a href="#cb105-5" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb105-6"><a href="#cb105-6" tabindex="-1"></a><span class="co">#&gt;           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span id="cb105-7"><a href="#cb105-7" tabindex="-1"></a><span class="co">#&gt; hl        0.21       0 0.05 0.13 0.18 0.21 0.24  0.33  2000    1</span></span>
<span id="cb105-8"><a href="#cb105-8" tabindex="-1"></a><span class="co">#&gt; vy        0.01       0 0.00 0.00 0.01 0.01 0.01  0.02  3105    1</span></span>
<span id="cb105-9"><a href="#cb105-9" tabindex="-1"></a><span class="co">#&gt; optima[1] 1.98       0 0.05 1.89 1.95 1.98 2.01  2.08  3550    1</span></span>
<span id="cb105-10"><a href="#cb105-10" tabindex="-1"></a><span class="co">#&gt; optima[2] 0.95       0 0.09 0.75 0.90 0.96 1.01  1.11  2364    1</span></span>
<span id="cb105-11"><a href="#cb105-11" tabindex="-1"></a><span class="co">#&gt; beta[1]   0.35       0 0.01 0.33 0.34 0.35 0.35  0.36  4263    1</span></span>
<span id="cb105-12"><a href="#cb105-12" tabindex="-1"></a><span class="co">#&gt; beta[2]   0.33       0 0.05 0.25 0.30 0.33 0.36  0.44  2331    1</span></span>
<span id="cb105-13"><a href="#cb105-13" tabindex="-1"></a><span class="co">#&gt; beta_e[1] 0.23       0 0.03 0.18 0.22 0.23 0.25  0.29  3395    1</span></span>
<span id="cb105-14"><a href="#cb105-14" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb105-15"><a href="#cb105-15" tabindex="-1"></a><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Fri Oct 10 16:26:16 2025.</span></span>
<span id="cb105-16"><a href="#cb105-16" tabindex="-1"></a><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span id="cb105-17"><a href="#cb105-17" tabindex="-1"></a><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span id="cb105-18"><a href="#cb105-18" tabindex="-1"></a><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span id="cb105-19"><a href="#cb105-19" tabindex="-1"></a>post<span class="ot">&lt;-</span>rstan<span class="sc">::</span><span class="fu">extract</span>(fit.reg.direct.adapt) <span class="co">#rstan::extract posterior</span></span></code></pre></div>
=======
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.direct.adapt</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_direct_adapt</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores<span class="op">=</span><span class="fl">2</span>,iter <span class="op">=</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span></code></pre></div>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.direct.adapt</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span>,<span class="st">"beta_e"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_adapt.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.21       0 0.05 0.13 0.18 0.21 0.24  0.33  2000    1</span></span>
<span><span class="co">#&gt; vy        0.01       0 0.00 0.00 0.01 0.01 0.01  0.02  3105    1</span></span>
<span><span class="co">#&gt; optima[1] 1.98       0 0.05 1.89 1.95 1.98 2.01  2.08  3550    1</span></span>
<span><span class="co">#&gt; optima[2] 0.95       0 0.09 0.75 0.90 0.96 1.01  1.11  2364    1</span></span>
<span><span class="co">#&gt; beta[1]   0.35       0 0.01 0.33 0.34 0.35 0.35  0.36  4263    1</span></span>
<span><span class="co">#&gt; beta[2]   0.33       0 0.05 0.25 0.30 0.33 0.36  0.44  2331    1</span></span>
<span><span class="co">#&gt; beta_e[1] 0.23       0 0.03 0.18 0.22 0.23 0.25  0.29  3395    1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Sat Oct 11 15:36:46 2025.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.direct.adapt</span><span class="op">)</span> <span class="co">#rstan::extract posterior</span></span></code></pre></div>
>>>>>>> dev-fixes-blouch1.0
<p>Prior vs. posterior</p>
<div class="sourceCode" id="cb106"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" tabindex="-1"></a>hl.sims<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">rlnorm</span>(<span class="at">n=</span><span class="dv">1000</span>,<span class="at">meanlog=</span>hl.prior[<span class="dv">1</span>],<span class="at">sdlog=</span>hl.prior[<span class="dv">2</span>]))</span>
<span id="cb106-2"><a href="#cb106-2" tabindex="-1"></a><span class="fu">names</span>(hl.sims)<span class="ot">&lt;-</span><span class="st">&quot;prior.hl.sims&quot;</span></span>
<span id="cb106-3"><a href="#cb106-3" tabindex="-1"></a></span>
<span id="cb106-4"><a href="#cb106-4" tabindex="-1"></a>hl.post<span class="ot">&lt;-</span><span class="fu">data.frame</span>(post<span class="sc">$</span>hl)</span>
<span id="cb106-5"><a href="#cb106-5" tabindex="-1"></a><span class="fu">names</span>(hl.post)<span class="ot">&lt;-</span><span class="st">&quot;post.hl.sims&quot;</span></span>
<span id="cb106-6"><a href="#cb106-6" tabindex="-1"></a></span>
<span id="cb106-7"><a href="#cb106-7" tabindex="-1"></a>hl.plot<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb106-8"><a href="#cb106-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(prior.hl.sims,<span class="at">fill=</span><span class="st">&quot;prior.hl.sims&quot;</span>),<span class="at">alpha=</span><span class="fl">0.2</span>,<span class="at">data=</span>hl.sims)<span class="sc">+</span></span>
<span id="cb106-9"><a href="#cb106-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(post.hl.sims,<span class="at">fill=</span><span class="st">&quot;post.hl.sims&quot;</span>),<span class="at">alpha=</span><span class="fl">0.2</span>,<span class="at">data=</span>hl.post)<span class="sc">+</span></span>
<span id="cb106-10"><a href="#cb106-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb106-11"><a href="#cb106-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb106-12"><a href="#cb106-12" tabindex="-1"></a>  <span class="at">panel.grid.major =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(),</span>
<span id="cb106-13"><a href="#cb106-13" tabindex="-1"></a>  <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb106-14"><a href="#cb106-14" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title=</span><span class="st">&quot;&quot;</span>,<span class="at">x=</span><span class="st">&quot;Half-life&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Density&quot;</span>)<span class="sc">+</span></span>
<span id="cb106-15"><a href="#cb106-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept=</span><span class="fu">c</span>(hl),<span class="at">linetype=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb106-16"><a href="#cb106-16" tabindex="-1"></a>  ggsci<span class="sc">::</span><span class="fu">scale_fill_npg</span>(<span class="at">name=</span><span class="st">&quot;&quot;</span>,<span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;Posterior&quot;</span>,<span class="st">&quot;Prior&quot;</span>))</span>
<span id="cb106-17"><a href="#cb106-17" tabindex="-1"></a></span>
<span id="cb106-18"><a href="#cb106-18" tabindex="-1"></a>hl.plot</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-51-1.png" width="700" /></p>
<p>Prior vs. posterior plot</p>
<div class="sourceCode" id="cb107"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" tabindex="-1"></a>vy.sims<span class="ot">&lt;-</span><span class="fu">rexp</span>(<span class="at">n=</span><span class="dv">1000</span>,<span class="at">rate=</span>vy.prior)</span>
<span id="cb107-2"><a href="#cb107-2" tabindex="-1"></a>vy.sims<span class="ot">&lt;-</span><span class="fu">data.frame</span>(vy.sims)</span>
<span id="cb107-3"><a href="#cb107-3" tabindex="-1"></a><span class="fu">names</span>(vy.sims)<span class="ot">&lt;-</span><span class="st">&quot;prior.vy.sims&quot;</span></span>
<span id="cb107-4"><a href="#cb107-4" tabindex="-1"></a></span>
<span id="cb107-5"><a href="#cb107-5" tabindex="-1"></a>vy.post<span class="ot">&lt;-</span><span class="fu">data.frame</span>(post<span class="sc">$</span>vy)</span>
<span id="cb107-6"><a href="#cb107-6" tabindex="-1"></a><span class="fu">names</span>(vy.post)<span class="ot">&lt;-</span><span class="st">&quot;post.vy.sims&quot;</span></span>
<span id="cb107-7"><a href="#cb107-7" tabindex="-1"></a></span>
<span id="cb107-8"><a href="#cb107-8" tabindex="-1"></a></span>
<span id="cb107-9"><a href="#cb107-9" tabindex="-1"></a>vy.plot<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb107-10"><a href="#cb107-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(prior.vy.sims,<span class="at">fill=</span><span class="st">&quot;prior.vy.sims&quot;</span>),<span class="at">alpha=</span><span class="fl">0.2</span>,<span class="at">data=</span>vy.sims)<span class="sc">+</span></span>
<span id="cb107-11"><a href="#cb107-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_density</span>(ggplot2<span class="sc">::</span><span class="fu">aes</span>(post.vy.sims,<span class="at">fill=</span><span class="st">&quot;post.vy.sims&quot;</span>),<span class="at">alpha=</span><span class="fl">0.2</span>,<span class="at">data=</span>vy.post)<span class="sc">+</span></span>
<span id="cb107-12"><a href="#cb107-12" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb107-13"><a href="#cb107-13" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb107-14"><a href="#cb107-14" tabindex="-1"></a>  <span class="at">panel.grid.major =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(),</span>
<span id="cb107-15"><a href="#cb107-15" tabindex="-1"></a>  <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb107-16"><a href="#cb107-16" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">labs</span>(<span class="at">title=</span><span class="st">&quot;&quot;</span>,<span class="at">x=</span><span class="st">&quot;vy&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Density&quot;</span>)<span class="sc">+</span></span>
<span id="cb107-17"><a href="#cb107-17" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_vline</span>(<span class="at">xintercept=</span><span class="fu">c</span>(vy),<span class="at">linetype=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb107-18"><a href="#cb107-18" tabindex="-1"></a>  ggsci<span class="sc">::</span><span class="fu">scale_fill_npg</span>(<span class="at">name=</span><span class="st">&quot;&quot;</span>,<span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;Posterior&quot;</span>,<span class="st">&quot;Prior&quot;</span>))</span>
<span id="cb107-19"><a href="#cb107-19" tabindex="-1"></a></span>
<span id="cb107-20"><a href="#cb107-20" tabindex="-1"></a>vy.plot</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-52-1.png" width="700" /></p>
<p>Adaptation model</p>
<div class="sourceCode" id="cb108"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" tabindex="-1"></a>a.sims<span class="ot">&lt;-</span><span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">/</span>hl.sims;</span>
<span id="cb108-2"><a href="#cb108-2" tabindex="-1"></a>sigma2_y.sims<span class="ot">&lt;-</span>vy.sims<span class="sc">*</span>(<span class="dv">2</span><span class="sc">*</span>(<span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">/</span>hl.sims));</span>
<span id="cb108-3"><a href="#cb108-3" tabindex="-1"></a><span class="co">#x&lt;-seq(from=0,to=1,by=0.001)</span></span>
<span id="cb108-4"><a href="#cb108-4" tabindex="-1"></a><span class="co">#V.sim&lt;-calc_direct_V(phy,a.sims,sigma2_y.sims)</span></span>
<span id="cb108-5"><a href="#cb108-5" tabindex="-1"></a></span>
<span id="cb108-6"><a href="#cb108-6" tabindex="-1"></a></span>
<span id="cb108-7"><a href="#cb108-7" tabindex="-1"></a><span class="fu">plot</span>( <span class="cn">NULL</span> , <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>) , <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.4</span>) , <span class="at">xlab=</span><span class="st">&quot;Time since MRCA&quot;</span> , <span class="at">ylab=</span><span class="st">&quot;Covariance&quot;</span> ,<span class="at">cex.axis=</span><span class="fl">0.75</span>, <span class="at">mgp=</span><span class="fu">c</span>(<span class="fl">1.25</span>,<span class="fl">0.25</span>,<span class="dv">0</span>),<span class="at">tcl=</span><span class="sc">-</span><span class="fl">0.25</span>)</span>
<span id="cb108-8"><a href="#cb108-8" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>){</span>
<span id="cb108-9"><a href="#cb108-9" tabindex="-1"></a>  <span class="fu">curve</span>(<span class="fu">calc_adaptive_cov_plot</span>(a.sims[i,],sigma2_y.sims[i,],beta[<span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>],x) , <span class="at">add=</span><span class="cn">TRUE</span> , <span class="at">lwd=</span><span class="dv">4</span> , <span class="at">col=</span>rethinking<span class="sc">::</span><span class="fu">col.alpha</span>(<span class="dv">1</span>,<span class="fl">0.15</span>))</span>
<span id="cb108-10"><a href="#cb108-10" tabindex="-1"></a>}</span>
<span id="cb108-11"><a href="#cb108-11" tabindex="-1"></a></span>
<span id="cb108-12"><a href="#cb108-12" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>){</span>
<span id="cb108-13"><a href="#cb108-13" tabindex="-1"></a>  <span class="fu">curve</span>(<span class="fu">calc_adaptive_cov_plot</span>(post<span class="sc">$</span>a[i],post<span class="sc">$</span>sigma2_y[i],post<span class="sc">$</span>beta[i,],x) , <span class="at">add=</span><span class="cn">TRUE</span> , <span class="at">lwd=</span><span class="dv">4</span> , <span class="at">col=</span>rethinking<span class="sc">::</span><span class="fu">col.alpha</span>(<span class="dv">2</span>,<span class="fl">0.5</span>))</span>
<span id="cb108-14"><a href="#cb108-14" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-53-1.png" width="700" /></p>
<div class="sourceCode" id="cb109"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" tabindex="-1"></a></span>
<span id="cb109-2"><a href="#cb109-2" tabindex="-1"></a><span class="co">#multiple traits</span></span>
<span id="cb109-3"><a href="#cb109-3" tabindex="-1"></a></span>
<span id="cb109-4"><a href="#cb109-4" tabindex="-1"></a></span>
<span id="cb109-5"><a href="#cb109-5" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="fl">0.25</span>,<span class="fl">0.25</span>))</span>
<span id="cb109-6"><a href="#cb109-6" tabindex="-1"></a>covariance.plot <span class="ot">&lt;-</span> <span class="fu">recordPlot</span>()</span>
<span id="cb109-7"><a href="#cb109-7" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb109-8"><a href="#cb109-8" tabindex="-1"></a><span class="co">#&gt; null device </span></span>
<span id="cb109-9"><a href="#cb109-9" tabindex="-1"></a><span class="co">#&gt;           1</span></span>
<span id="cb109-10"><a href="#cb109-10" tabindex="-1"></a></span>
<span id="cb109-11"><a href="#cb109-11" tabindex="-1"></a><span class="co">#Vt = sigma2_y /( 2 * a) * ((1 - exp(-2 * a * ta)) .* exp(-a * tij)); //From Hansen (1997)</span></span>
<span id="cb109-12"><a href="#cb109-12" tabindex="-1"></a></span>
<span id="cb109-13"><a href="#cb109-13" tabindex="-1"></a>covariance.plot</span></code></pre></div>
<p>Slope plots for direct and adaptive models with Measurement Error</p>
<div class="sourceCode" id="cb110"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" tabindex="-1"></a><span class="fu">library</span>(ggsci)</span>
<span id="cb110-2"><a href="#cb110-2" tabindex="-1"></a></span>
<span id="cb110-3"><a href="#cb110-3" tabindex="-1"></a>optima.sims<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="dv">100</span>,optima.prior[<span class="dv">1</span>],optima.prior[<span class="dv">2</span>])</span>
<span id="cb110-4"><a href="#cb110-4" tabindex="-1"></a>beta.sims<span class="ot">&lt;-</span><span class="fu">rnorm</span>(<span class="at">n=</span><span class="dv">100</span>,beta.prior[<span class="dv">1</span>],beta.prior[<span class="dv">2</span>])</span>
<span id="cb110-5"><a href="#cb110-5" tabindex="-1"></a></span>
<span id="cb110-6"><a href="#cb110-6" tabindex="-1"></a>optima.post<span class="ot">&lt;-</span>post<span class="sc">$</span>optima</span>
<span id="cb110-7"><a href="#cb110-7" tabindex="-1"></a></span>
<span id="cb110-8"><a href="#cb110-8" tabindex="-1"></a>beta.post<span class="fl">.1</span><span class="ot">&lt;-</span><span class="fu">data.frame</span>(post<span class="sc">$</span>beta[,<span class="dv">1</span>])</span>
<span id="cb110-9"><a href="#cb110-9" tabindex="-1"></a><span class="fu">names</span>(beta.post<span class="fl">.1</span>)<span class="ot">&lt;-</span><span class="st">&quot;post.beta.1&quot;</span></span>
<span id="cb110-10"><a href="#cb110-10" tabindex="-1"></a></span>
<span id="cb110-11"><a href="#cb110-11" tabindex="-1"></a>beta.post<span class="fl">.2</span><span class="ot">&lt;-</span><span class="fu">data.frame</span>(post<span class="sc">$</span>beta[,<span class="dv">2</span>])</span>
<span id="cb110-12"><a href="#cb110-12" tabindex="-1"></a><span class="fu">names</span>(beta.post<span class="fl">.2</span>)<span class="ot">&lt;-</span><span class="st">&quot;post.beta.2&quot;</span></span>
<span id="cb110-13"><a href="#cb110-13" tabindex="-1"></a></span>
<span id="cb110-14"><a href="#cb110-14" tabindex="-1"></a>mu.link<span class="fl">.11</span><span class="ot">&lt;-</span><span class="cf">function</span>(x.seq){optima.post[,<span class="dv">1</span>]<span class="sc">+</span>x.seq<span class="sc">*</span>beta.post<span class="fl">.1</span>}</span>
<span id="cb110-15"><a href="#cb110-15" tabindex="-1"></a>mu.link<span class="fl">.12</span><span class="ot">&lt;-</span><span class="cf">function</span>(x.seq){optima.post[,<span class="dv">2</span>]<span class="sc">+</span>x.seq<span class="sc">*</span>beta.post<span class="fl">.1</span>}</span>
<span id="cb110-16"><a href="#cb110-16" tabindex="-1"></a>mu.link<span class="fl">.21</span><span class="ot">&lt;-</span><span class="cf">function</span>(x.seq){optima.post[,<span class="dv">1</span>]<span class="sc">+</span>x.seq<span class="sc">*</span>beta.post<span class="fl">.2</span>}</span>
<span id="cb110-17"><a href="#cb110-17" tabindex="-1"></a>mu.link<span class="fl">.22</span><span class="ot">&lt;-</span><span class="cf">function</span>(x.seq){optima.post[,<span class="dv">2</span>]<span class="sc">+</span>x.seq<span class="sc">*</span>beta.post<span class="fl">.2</span>}</span>
<span id="cb110-18"><a href="#cb110-18" tabindex="-1"></a>x.seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from=</span><span class="fu">min</span>(Xs), <span class="at">to=</span><span class="fu">max</span>(Xs) , <span class="at">length.out=</span><span class="dv">100</span>)</span>
<span id="cb110-19"><a href="#cb110-19" tabindex="-1"></a>mu<span class="fl">.11</span> <span class="ot">&lt;-</span> <span class="fu">sapply</span>(x.seq , mu.link<span class="fl">.11</span> )</span>
<span id="cb110-20"><a href="#cb110-20" tabindex="-1"></a>mu<span class="fl">.12</span> <span class="ot">&lt;-</span> <span class="fu">sapply</span>(x.seq , mu.link<span class="fl">.12</span> )</span>
<span id="cb110-21"><a href="#cb110-21" tabindex="-1"></a>mu<span class="fl">.21</span> <span class="ot">&lt;-</span> <span class="fu">sapply</span>(x.seq , mu.link<span class="fl">.21</span> )</span>
<span id="cb110-22"><a href="#cb110-22" tabindex="-1"></a>mu<span class="fl">.22</span> <span class="ot">&lt;-</span> <span class="fu">sapply</span>(x.seq , mu.link<span class="fl">.22</span> )</span>
<span id="cb110-23"><a href="#cb110-23" tabindex="-1"></a>mu.mean<span class="fl">.11</span> <span class="ot">&lt;-</span><span class="fu">lapply</span>( mu<span class="fl">.11</span> , mean )</span>
<span id="cb110-24"><a href="#cb110-24" tabindex="-1"></a>mu.mean<span class="fl">.12</span> <span class="ot">&lt;-</span><span class="fu">lapply</span>( mu<span class="fl">.12</span> , mean )</span>
<span id="cb110-25"><a href="#cb110-25" tabindex="-1"></a>mu.mean<span class="fl">.21</span> <span class="ot">&lt;-</span><span class="fu">lapply</span>( mu<span class="fl">.21</span> , mean )</span>
<span id="cb110-26"><a href="#cb110-26" tabindex="-1"></a>mu.mean<span class="fl">.22</span> <span class="ot">&lt;-</span><span class="fu">lapply</span>( mu<span class="fl">.22</span> , mean )</span>
<span id="cb110-27"><a href="#cb110-27" tabindex="-1"></a></span>
<span id="cb110-28"><a href="#cb110-28" tabindex="-1"></a>mu.mean<span class="fl">.11</span><span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">as.numeric</span>(mu.mean<span class="fl">.11</span>))</span>
<span id="cb110-29"><a href="#cb110-29" tabindex="-1"></a>mu.mean<span class="fl">.12</span><span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">as.numeric</span>(mu.mean<span class="fl">.12</span>))</span>
<span id="cb110-30"><a href="#cb110-30" tabindex="-1"></a><span class="fu">names</span>(mu.mean<span class="fl">.11</span>)<span class="ot">&lt;-</span><span class="st">&quot;mu.mean.11&quot;</span></span>
<span id="cb110-31"><a href="#cb110-31" tabindex="-1"></a><span class="fu">names</span>(mu.mean<span class="fl">.12</span>)<span class="ot">&lt;-</span><span class="st">&quot;mu.mean.12&quot;</span></span>
<span id="cb110-32"><a href="#cb110-32" tabindex="-1"></a>mu.mean<span class="fl">.21</span><span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">as.numeric</span>(mu.mean<span class="fl">.21</span>))</span>
<span id="cb110-33"><a href="#cb110-33" tabindex="-1"></a>mu.mean<span class="fl">.22</span><span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">as.numeric</span>(mu.mean<span class="fl">.22</span>))</span>
<span id="cb110-34"><a href="#cb110-34" tabindex="-1"></a><span class="fu">names</span>(mu.mean<span class="fl">.21</span>)<span class="ot">&lt;-</span><span class="st">&quot;mu.mean.21&quot;</span></span>
<span id="cb110-35"><a href="#cb110-35" tabindex="-1"></a><span class="fu">names</span>(mu.mean<span class="fl">.22</span>)<span class="ot">&lt;-</span><span class="st">&quot;mu.mean.22&quot;</span></span>
<span id="cb110-36"><a href="#cb110-36" tabindex="-1"></a></span>
<span id="cb110-37"><a href="#cb110-37" tabindex="-1"></a>mu.CI<span class="fl">.11</span> <span class="ot">&lt;-</span> <span class="fu">lapply</span>( mu<span class="fl">.11</span> , rethinking<span class="sc">::</span>PI , <span class="at">prob=</span><span class="fl">0.89</span> )</span>
<span id="cb110-38"><a href="#cb110-38" tabindex="-1"></a>mu.CI<span class="fl">.12</span> <span class="ot">&lt;-</span> <span class="fu">lapply</span>( mu<span class="fl">.12</span> , rethinking<span class="sc">::</span>PI , <span class="at">prob=</span><span class="fl">0.89</span> )</span>
<span id="cb110-39"><a href="#cb110-39" tabindex="-1"></a>mu.CI<span class="fl">.11</span><span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">t</span>(<span class="fu">data.frame</span>(mu.CI<span class="fl">.11</span>)),x.seq)</span>
<span id="cb110-40"><a href="#cb110-40" tabindex="-1"></a>mu.CI<span class="fl">.12</span><span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">t</span>(<span class="fu">data.frame</span>(mu.CI<span class="fl">.12</span>)),x.seq)</span>
<span id="cb110-41"><a href="#cb110-41" tabindex="-1"></a></span>
<span id="cb110-42"><a href="#cb110-42" tabindex="-1"></a>mu.CI<span class="fl">.21</span> <span class="ot">&lt;-</span> <span class="fu">lapply</span>( mu<span class="fl">.21</span> , rethinking<span class="sc">::</span>PI , <span class="at">prob=</span><span class="fl">0.89</span> )</span>
<span id="cb110-43"><a href="#cb110-43" tabindex="-1"></a>mu.CI<span class="fl">.22</span> <span class="ot">&lt;-</span> <span class="fu">lapply</span>( mu<span class="fl">.22</span> , rethinking<span class="sc">::</span>PI , <span class="at">prob=</span><span class="fl">0.89</span> )</span>
<span id="cb110-44"><a href="#cb110-44" tabindex="-1"></a>mu.CI<span class="fl">.21</span><span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">t</span>(<span class="fu">data.frame</span>(mu.CI<span class="fl">.21</span>)),x.seq)</span>
<span id="cb110-45"><a href="#cb110-45" tabindex="-1"></a>mu.CI<span class="fl">.22</span><span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="fu">t</span>(<span class="fu">data.frame</span>(mu.CI<span class="fl">.22</span>)),x.seq)</span>
<span id="cb110-46"><a href="#cb110-46" tabindex="-1"></a></span>
<span id="cb110-47"><a href="#cb110-47" tabindex="-1"></a><span class="fu">names</span>(mu.CI<span class="fl">.11</span>)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">&quot;min.5.5&quot;</span>,<span class="st">&quot;max.94.5&quot;</span>,<span class="st">&quot;x.seq&quot;</span>)</span>
<span id="cb110-48"><a href="#cb110-48" tabindex="-1"></a><span class="fu">names</span>(mu.CI<span class="fl">.12</span>)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">&quot;min.5.5&quot;</span>,<span class="st">&quot;max.94.5&quot;</span>,<span class="st">&quot;x.seq&quot;</span>)</span>
<span id="cb110-49"><a href="#cb110-49" tabindex="-1"></a><span class="fu">names</span>(mu.CI<span class="fl">.21</span>)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">&quot;min.5.5&quot;</span>,<span class="st">&quot;max.94.5&quot;</span>,<span class="st">&quot;x.seq&quot;</span>)</span>
<span id="cb110-50"><a href="#cb110-50" tabindex="-1"></a><span class="fu">names</span>(mu.CI<span class="fl">.22</span>)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">&quot;min.5.5&quot;</span>,<span class="st">&quot;max.94.5&quot;</span>,<span class="st">&quot;x.seq&quot;</span>)</span>
<span id="cb110-51"><a href="#cb110-51" tabindex="-1"></a></span>
<span id="cb110-52"><a href="#cb110-52" tabindex="-1"></a>df<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">Y=</span>dat<span class="sc">$</span>Y_obs,<span class="at">X=</span>dat<span class="sc">$</span>X_obs,<span class="at">Regimes=</span>regimes_tip)</span>
<span id="cb110-53"><a href="#cb110-53" tabindex="-1"></a>df11<span class="ot">&lt;-</span><span class="fu">data.frame</span>(x.seq,mu.mean<span class="fl">.11</span>)</span>
<span id="cb110-54"><a href="#cb110-54" tabindex="-1"></a>df12<span class="ot">&lt;-</span><span class="fu">data.frame</span>(x.seq,mu.mean<span class="fl">.12</span>)</span>
<span id="cb110-55"><a href="#cb110-55" tabindex="-1"></a>df21<span class="ot">&lt;-</span><span class="fu">data.frame</span>(x.seq,mu.mean<span class="fl">.21</span>)</span>
<span id="cb110-56"><a href="#cb110-56" tabindex="-1"></a>df22<span class="ot">&lt;-</span><span class="fu">data.frame</span>(x.seq,mu.mean<span class="fl">.22</span>)</span>
<span id="cb110-57"><a href="#cb110-57" tabindex="-1"></a></span>
<span id="cb110-58"><a href="#cb110-58" tabindex="-1"></a>slope.plot.Xd<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>()<span class="sc">+</span>  </span>
<span id="cb110-59"><a href="#cb110-59" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">data=</span>df,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y=</span>Y,<span class="at">x=</span>X.Xd,<span class="at">color=</span>Regimes))<span class="sc">+</span></span>
<span id="cb110-60"><a href="#cb110-60" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_abline</span>(<span class="at">intercept=</span>optima.sims,<span class="at">slope=</span>beta.sims,<span class="at">alpha=</span><span class="fl">0.15</span>)<span class="sc">+</span> <span class="co">#Prior</span></span>
<span id="cb110-61"><a href="#cb110-61" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">data=</span>df11,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>x.seq,<span class="at">y=</span>mu.mean<span class="fl">.11</span>),<span class="at">linetype=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb110-62"><a href="#cb110-62" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_abline</span>(<span class="at">intercept=</span>beta[<span class="dv">1</span>],<span class="at">slope=</span>beta[<span class="dv">3</span>],<span class="at">alpha=</span><span class="fl">0.5</span>,<span class="at">linetype=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb110-63"><a href="#cb110-63" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_abline</span>(<span class="at">intercept=</span>beta[<span class="dv">2</span>],<span class="at">slope=</span>beta[<span class="dv">3</span>],<span class="at">alpha=</span><span class="fl">0.5</span>,<span class="at">linetype=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb110-64"><a href="#cb110-64" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_ribbon</span>(<span class="at">data=</span>mu.CI<span class="fl">.11</span>,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>x.seq,<span class="at">ymin=</span>min.<span class="fl">5.5</span>,<span class="at">ymax=</span>max.<span class="fl">94.5</span>),<span class="at">linetype=</span><span class="dv">2</span>,<span class="at">alpha=</span><span class="fl">0.25</span>)<span class="sc">+</span></span>
<span id="cb110-65"><a href="#cb110-65" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">data=</span>df12,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>x.seq,<span class="at">y=</span>mu.mean<span class="fl">.12</span>),<span class="at">linetype=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb110-66"><a href="#cb110-66" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_ribbon</span>(<span class="at">data=</span>mu.CI<span class="fl">.12</span>,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>x.seq,<span class="at">ymin=</span>min.<span class="fl">5.5</span>,<span class="at">ymax=</span>max.<span class="fl">94.5</span>),<span class="at">linetype=</span><span class="dv">2</span>,<span class="at">alpha=</span><span class="fl">0.25</span>)<span class="sc">+</span></span>
<span id="cb110-67"><a href="#cb110-67" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb110-68"><a href="#cb110-68" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb110-69"><a href="#cb110-69" tabindex="-1"></a>  <span class="at">panel.grid.major =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(),</span>
<span id="cb110-70"><a href="#cb110-70" tabindex="-1"></a>  <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb110-71"><a href="#cb110-71" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ylab</span>(<span class="st">&quot;Y&quot;</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">xlab</span>(<span class="st">&quot;Direct effect trait&quot;</span>)<span class="sc">+</span></span>
<span id="cb110-72"><a href="#cb110-72" tabindex="-1"></a>  ggsci<span class="sc">::</span><span class="fu">scale_color_npg</span>()</span>
<span id="cb110-73"><a href="#cb110-73" tabindex="-1"></a></span>
<span id="cb110-74"><a href="#cb110-74" tabindex="-1"></a>slope.plot.Xd</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-54-1.png" width="700" /></p>
<div class="sourceCode" id="cb111"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" tabindex="-1"></a></span>
<span id="cb111-2"><a href="#cb111-2" tabindex="-1"></a>slope.plot.Xa<span class="ot">&lt;-</span>ggplot2<span class="sc">::</span><span class="fu">ggplot</span>()<span class="sc">+</span>  </span>
<span id="cb111-3"><a href="#cb111-3" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_point</span>(<span class="at">data=</span>df,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">y=</span>Y,<span class="at">x=</span>X.Xa,<span class="at">color=</span>Regimes))<span class="sc">+</span></span>
<span id="cb111-4"><a href="#cb111-4" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_abline</span>(<span class="at">intercept=</span>optima.sims,<span class="at">slope=</span>beta.sims,<span class="at">alpha=</span><span class="fl">0.15</span>)<span class="sc">+</span> <span class="co">#Prior</span></span>
<span id="cb111-5"><a href="#cb111-5" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_abline</span>(<span class="at">intercept=</span>beta[<span class="dv">1</span>],<span class="at">slope=</span>beta[<span class="dv">4</span>],<span class="at">alpha=</span><span class="fl">0.5</span>,<span class="at">linetype=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb111-6"><a href="#cb111-6" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_abline</span>(<span class="at">intercept=</span>beta[<span class="dv">2</span>],<span class="at">slope=</span>beta[<span class="dv">4</span>],<span class="at">alpha=</span><span class="fl">0.5</span>,<span class="at">linetype=</span><span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb111-7"><a href="#cb111-7" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">data=</span>df21,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>x.seq,<span class="at">y=</span>mu.mean<span class="fl">.21</span>),<span class="at">linetype=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb111-8"><a href="#cb111-8" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_ribbon</span>(<span class="at">data=</span>mu.CI<span class="fl">.21</span>,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>x.seq,<span class="at">ymin=</span>min.<span class="fl">5.5</span>,<span class="at">ymax=</span>max.<span class="fl">94.5</span>),<span class="at">linetype=</span><span class="dv">2</span>,<span class="at">alpha=</span><span class="fl">0.25</span>)<span class="sc">+</span></span>
<span id="cb111-9"><a href="#cb111-9" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_line</span>(<span class="at">data=</span>df22,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>x.seq,<span class="at">y=</span>mu.mean<span class="fl">.22</span>),<span class="at">linetype=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb111-10"><a href="#cb111-10" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">geom_ribbon</span>(<span class="at">data=</span>mu.CI<span class="fl">.22</span>,ggplot2<span class="sc">::</span><span class="fu">aes</span>(<span class="at">x=</span>x.seq,<span class="at">ymin=</span>min.<span class="fl">5.5</span>,<span class="at">ymax=</span>max.<span class="fl">94.5</span>),<span class="at">linetype=</span><span class="dv">2</span>,<span class="at">alpha=</span><span class="fl">0.25</span>)<span class="sc">+</span></span>
<span id="cb111-11"><a href="#cb111-11" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb111-12"><a href="#cb111-12" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">theme</span>(</span>
<span id="cb111-13"><a href="#cb111-13" tabindex="-1"></a>  <span class="at">panel.grid.major =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>(),</span>
<span id="cb111-14"><a href="#cb111-14" tabindex="-1"></a>  <span class="at">panel.grid.minor =</span> ggplot2<span class="sc">::</span><span class="fu">element_blank</span>())<span class="sc">+</span></span>
<span id="cb111-15"><a href="#cb111-15" tabindex="-1"></a>  ggplot2<span class="sc">::</span><span class="fu">ylab</span>(<span class="st">&quot;Y&quot;</span>) <span class="sc">+</span> ggplot2<span class="sc">::</span><span class="fu">xlab</span>(<span class="st">&quot;Adaptive trait&quot;</span>)<span class="sc">+</span></span>
<span id="cb111-16"><a href="#cb111-16" tabindex="-1"></a>  ggsci<span class="sc">::</span><span class="fu">scale_color_npg</span>()</span>
<span id="cb111-17"><a href="#cb111-17" tabindex="-1"></a></span>
<span id="cb111-18"><a href="#cb111-18" tabindex="-1"></a>slope.plot.Xa</span></code></pre></div>
<p><img src="Multi-optima_Models-Examples_files/figure-html/unnamed-chunk-54-2.png" width="700" /></p>
<div class="sourceCode" id="cb112"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" tabindex="-1"></a><span class="co">#Next we run the Multilevel version of the same model</span></span>
<span id="cb112-2"><a href="#cb112-2" tabindex="-1"></a><span class="do">############################################################################################################</span></span>
<span id="cb112-3"><a href="#cb112-3" tabindex="-1"></a><span class="co">#Set Priors</span></span>
<span id="cb112-4"><a href="#cb112-4" tabindex="-1"></a>hl.prior<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fu">log</span>(<span class="fl">0.25</span>),<span class="fl">0.25</span>)</span>
<span id="cb112-5"><a href="#cb112-5" tabindex="-1"></a>vy.prior<span class="ot">&lt;-</span><span class="dv">5</span></span>
<span id="cb112-6"><a href="#cb112-6" tabindex="-1"></a>optima.prior<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fl">1.5</span>,<span class="fl">0.5</span>) <span class="co">#Informed by linear model</span></span>
<span id="cb112-7"><a href="#cb112-7" tabindex="-1"></a>beta.prior<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="fl">0.25</span>) <span class="co">#Informed by linear model</span></span>
<span id="cb112-8"><a href="#cb112-8" tabindex="-1"></a>sigma.prior<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span></code></pre></div>
<div class="sourceCode" id="cb113"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" tabindex="-1"></a><span class="do">############################################################################################################</span></span>
<span id="cb113-2"><a href="#cb113-2" tabindex="-1"></a><span class="co">#Make trdata file</span></span>
<span id="cb113-3"><a href="#cb113-3" tabindex="-1"></a>trdata<span class="sc">$</span>dat<span class="ot">&lt;-</span><span class="fu">cbind</span>(trdata<span class="sc">$</span>dat,<span class="fu">data.frame</span>(<span class="fu">cbind</span>(Y_with_error,Y_error,X_with_error,X_error)))</span></code></pre></div>
<div class="sourceCode" id="cb114"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" tabindex="-1"></a><span class="do">############################################################################################################</span></span>
<span id="cb114-2"><a href="#cb114-2" tabindex="-1"></a>dat<span class="ot">&lt;-</span><span class="fu">blouch.reg.direct.adapt.mlm.prep</span>(trdata,<span class="st">&quot;Y_with_error&quot;</span>,<span class="st">&quot;Y_error&quot;</span>,<span class="fu">c</span>(<span class="st">&quot;Xd&quot;</span>,<span class="st">&quot;Xa&quot;</span>),<span class="fu">c</span>(<span class="st">&quot;Xd_error&quot;</span>,<span class="st">&quot;Xa_error&quot;</span>),<span class="at">Z_direct=</span><span class="dv">1</span>,<span class="at">Z_adaptive=</span><span class="dv">1</span>,<span class="st">&quot;regimes&quot;</span>,hl.prior,vy.prior,optima.prior,beta.prior,sigma.prior)</span></code></pre></div>
<p>Next we run the Multilevel version of the same model</p>
<<<<<<< HEAD
<div class="sourceCode" id="cb115"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" tabindex="-1"></a>fit.reg.direct.adapt.mlm.vi<span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">sampling</span>(<span class="at">object =</span> blouch<span class="sc">:::</span>stanmodels<span class="sc">$</span>blouchOU_reg_direct_adapt_mlm_vi,<span class="at">data =</span> dat,<span class="at">chains =</span> <span class="dv">2</span>,<span class="at">cores=</span><span class="dv">2</span>,<span class="at">iter =</span><span class="dv">2000</span>)</span>
<span id="cb115-2"><a href="#cb115-2" tabindex="-1"></a><span class="co">#&gt; Found more than one class &quot;stanfit&quot; in cache; using the first, from namespace &#39;rstan&#39;</span></span>
<span id="cb115-3"><a href="#cb115-3" tabindex="-1"></a><span class="co">#&gt; Also defined by &#39;rethinking&#39;</span></span>
<span id="cb115-4"><a href="#cb115-4" tabindex="-1"></a><span class="co">#&gt; Found more than one class &quot;stanfit&quot; in cache; using the first, from namespace &#39;rstan&#39;</span></span>
<span id="cb115-5"><a href="#cb115-5" tabindex="-1"></a><span class="co">#&gt; Also defined by &#39;rethinking&#39;</span></span></code></pre></div>
<div class="sourceCode" id="cb116"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" tabindex="-1"></a><span class="fu">print</span>(fit.reg.direct.adapt.mlm.vi,<span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;hl&quot;</span>,<span class="st">&quot;vy&quot;</span>,<span class="st">&quot;optima&quot;</span>,<span class="st">&quot;beta&quot;</span>,<span class="st">&quot;beta_e&quot;</span>))</span>
<span id="cb116-2"><a href="#cb116-2" tabindex="-1"></a><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_adapt_mlm_vi.</span></span>
<span id="cb116-3"><a href="#cb116-3" tabindex="-1"></a><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span id="cb116-4"><a href="#cb116-4" tabindex="-1"></a><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span id="cb116-5"><a href="#cb116-5" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb116-6"><a href="#cb116-6" tabindex="-1"></a><span class="co">#&gt;           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span id="cb116-7"><a href="#cb116-7" tabindex="-1"></a><span class="co">#&gt; hl        0.22       0 0.05 0.13 0.18 0.21 0.25  0.33  1971    1</span></span>
<span id="cb116-8"><a href="#cb116-8" tabindex="-1"></a><span class="co">#&gt; vy        0.01       0 0.00 0.00 0.01 0.01 0.01  0.02  2190    1</span></span>
<span id="cb116-9"><a href="#cb116-9" tabindex="-1"></a><span class="co">#&gt; optima[1] 1.98       0 0.05 1.89 1.95 1.99 2.02  2.08  3294    1</span></span>
<span id="cb116-10"><a href="#cb116-10" tabindex="-1"></a><span class="co">#&gt; optima[2] 0.94       0 0.09 0.74 0.88 0.95 1.01  1.11  2435    1</span></span>
<span id="cb116-11"><a href="#cb116-11" tabindex="-1"></a><span class="co">#&gt; beta[1]   0.35       0 0.01 0.33 0.34 0.35 0.35  0.36  4130    1</span></span>
<span id="cb116-12"><a href="#cb116-12" tabindex="-1"></a><span class="co">#&gt; beta[2]   0.33       0 0.05 0.24 0.30 0.33 0.36  0.44  2101    1</span></span>
<span id="cb116-13"><a href="#cb116-13" tabindex="-1"></a><span class="co">#&gt; beta_e[1] 0.23       0 0.03 0.17 0.22 0.23 0.25  0.29  2702    1</span></span>
<span id="cb116-14"><a href="#cb116-14" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb116-15"><a href="#cb116-15" tabindex="-1"></a><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Fri Oct 10 16:27:00 2025.</span></span>
<span id="cb116-16"><a href="#cb116-16" tabindex="-1"></a><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span id="cb116-17"><a href="#cb116-17" tabindex="-1"></a><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span id="cb116-18"><a href="#cb116-18" tabindex="-1"></a><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span id="cb116-19"><a href="#cb116-19" tabindex="-1"></a>post<span class="ot">&lt;-</span>rstan<span class="sc">::</span><span class="fu">extract</span>(fit.reg.direct.adapt.mlm.vi)</span></code></pre></div>
<p>Finally we run the non-centered version of that model</p>
<div class="sourceCode" id="cb117"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" tabindex="-1"></a>fit.reg.direct.adapt.mlm.vi.nc<span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">sampling</span>(<span class="at">object =</span> blouch<span class="sc">:::</span>stanmodels<span class="sc">$</span>blouchOU_reg_direct_adapt_mlm_vi_nc,<span class="at">data =</span> dat,<span class="at">chains =</span> <span class="dv">1</span>,<span class="at">cores=</span><span class="dv">1</span>,<span class="at">iter =</span><span class="dv">2000</span>)</span>
<span id="cb117-2"><a href="#cb117-2" tabindex="-1"></a><span class="co">#&gt; Warning: There were 12 divergent transitions after warmup. See</span></span>
<span id="cb117-3"><a href="#cb117-3" tabindex="-1"></a><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span id="cb117-4"><a href="#cb117-4" tabindex="-1"></a><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span id="cb117-5"><a href="#cb117-5" tabindex="-1"></a><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span></code></pre></div>
<div class="sourceCode" id="cb118"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" tabindex="-1"></a><span class="fu">print</span>(fit.reg.direct.adapt.mlm.vi.nc,<span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;hl&quot;</span>,<span class="st">&quot;vy&quot;</span>,<span class="st">&quot;optima&quot;</span>,<span class="st">&quot;beta&quot;</span>,<span class="st">&quot;beta_e&quot;</span>))</span>
<span id="cb118-2"><a href="#cb118-2" tabindex="-1"></a><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_adapt_mlm_vi_nc.</span></span>
<span id="cb118-3"><a href="#cb118-3" tabindex="-1"></a><span class="co">#&gt; 1 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span id="cb118-4"><a href="#cb118-4" tabindex="-1"></a><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=1000.</span></span>
<span id="cb118-5"><a href="#cb118-5" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb118-6"><a href="#cb118-6" tabindex="-1"></a><span class="co">#&gt;           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span id="cb118-7"><a href="#cb118-7" tabindex="-1"></a><span class="co">#&gt; hl        0.22       0 0.05 0.13 0.18 0.21 0.25  0.34   893    1</span></span>
<span id="cb118-8"><a href="#cb118-8" tabindex="-1"></a><span class="co">#&gt; vy        0.01       0 0.00 0.00 0.01 0.01 0.01  0.02   776    1</span></span>
<span id="cb118-9"><a href="#cb118-9" tabindex="-1"></a><span class="co">#&gt; optima[1] 1.98       0 0.05 1.89 1.95 1.98 2.02  2.08   966    1</span></span>
<span id="cb118-10"><a href="#cb118-10" tabindex="-1"></a><span class="co">#&gt; optima[2] 0.94       0 0.09 0.74 0.88 0.94 1.00  1.10   905    1</span></span>
<span id="cb118-11"><a href="#cb118-11" tabindex="-1"></a><span class="co">#&gt; beta[1]   0.35       0 0.01 0.33 0.34 0.35 0.35  0.36  1532    1</span></span>
<span id="cb118-12"><a href="#cb118-12" tabindex="-1"></a><span class="co">#&gt; beta[2]   0.33       0 0.05 0.24 0.30 0.33 0.36  0.43   787    1</span></span>
<span id="cb118-13"><a href="#cb118-13" tabindex="-1"></a><span class="co">#&gt; beta_e[1] 0.23       0 0.03 0.17 0.21 0.23 0.25  0.28   892    1</span></span>
<span id="cb118-14"><a href="#cb118-14" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb118-15"><a href="#cb118-15" tabindex="-1"></a><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Fri Oct 10 16:28:48 2025.</span></span>
<span id="cb118-16"><a href="#cb118-16" tabindex="-1"></a><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span id="cb118-17"><a href="#cb118-17" tabindex="-1"></a><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span id="cb118-18"><a href="#cb118-18" tabindex="-1"></a><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span id="cb118-19"><a href="#cb118-19" tabindex="-1"></a>post<span class="ot">&lt;-</span>rstan<span class="sc">::</span><span class="fu">extract</span>(fit.reg.direct.adapt.mlm.vi.nc)</span></code></pre></div>
=======
<div class="sourceCode" id="cb115"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.direct.adapt.mlm.vi</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_direct_adapt_mlm_vi</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">2</span>,cores<span class="op">=</span><span class="fl">2</span>,iter <span class="op">=</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span>
<span><span class="co">#&gt; Found more than one class "stanfit" in cache; using the first, from namespace 'rstan'</span></span>
<span><span class="co">#&gt; Also defined by 'rethinking'</span></span></code></pre></div>
<div class="sourceCode" id="cb116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.direct.adapt.mlm.vi</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span>,<span class="st">"beta_e"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_adapt_mlm_vi.</span></span>
<span><span class="co">#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.22       0 0.05 0.13 0.18 0.21 0.25  0.33  1971    1</span></span>
<span><span class="co">#&gt; vy        0.01       0 0.00 0.00 0.01 0.01 0.01  0.02  2190    1</span></span>
<span><span class="co">#&gt; optima[1] 1.98       0 0.05 1.89 1.95 1.99 2.02  2.08  3294    1</span></span>
<span><span class="co">#&gt; optima[2] 0.94       0 0.09 0.74 0.88 0.95 1.01  1.11  2435    1</span></span>
<span><span class="co">#&gt; beta[1]   0.35       0 0.01 0.33 0.34 0.35 0.35  0.36  4130    1</span></span>
<span><span class="co">#&gt; beta[2]   0.33       0 0.05 0.24 0.30 0.33 0.36  0.44  2101    1</span></span>
<span><span class="co">#&gt; beta_e[1] 0.23       0 0.03 0.17 0.22 0.23 0.25  0.29  2702    1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Sat Oct 11 15:37:33 2025.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.direct.adapt.mlm.vi</span><span class="op">)</span></span></code></pre></div>
<p>Finally we run the non-centered version of that model</p>
<div class="sourceCode" id="cb117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.reg.direct.adapt.mlm.vi.nc</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_reg_direct_adapt_mlm_vi_nc</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">1</span>,cores<span class="op">=</span><span class="fl">1</span>,iter <span class="op">=</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: There were 12 divergent transitions after warmup. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">#&gt; to find out why this is a problem and how to eliminate them.</span></span>
<span><span class="co">#&gt; Warning: Examine the pairs() plot to diagnose sampling problems</span></span></code></pre></div>
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.reg.direct.adapt.mlm.vi.nc</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"optima"</span>,<span class="st">"beta"</span>,<span class="st">"beta_e"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_reg_direct_adapt_mlm_vi_nc.</span></span>
<span><span class="co">#&gt; 1 chains, each with iter=2000; warmup=1000; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=1000, total post-warmup draws=1000.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.22       0 0.05 0.13 0.18 0.21 0.25  0.34   893    1</span></span>
<span><span class="co">#&gt; vy        0.01       0 0.00 0.00 0.01 0.01 0.01  0.02   776    1</span></span>
<span><span class="co">#&gt; optima[1] 1.98       0 0.05 1.89 1.95 1.98 2.02  2.08   966    1</span></span>
<span><span class="co">#&gt; optima[2] 0.94       0 0.09 0.74 0.88 0.94 1.00  1.10   905    1</span></span>
<span><span class="co">#&gt; beta[1]   0.35       0 0.01 0.33 0.34 0.35 0.35  0.36  1532    1</span></span>
<span><span class="co">#&gt; beta[2]   0.33       0 0.05 0.24 0.30 0.33 0.36  0.43   787    1</span></span>
<span><span class="co">#&gt; beta_e[1] 0.23       0 0.03 0.17 0.21 0.23 0.25  0.28   892    1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Sat Oct 11 15:39:05 2025.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.reg.direct.adapt.mlm.vi.nc</span><span class="op">)</span></span></code></pre></div>
>>>>>>> dev-fixes-blouch1.0
<p>From there the posteriors should be explored, compared to the priors,
etc. See the Simulation Example for one example of how to do this.</p>
</div>
<div id="references" class="section level2">
<h2>References</h2>
<p>Hansen T.F. 1997. Stabilizing Selection and the Comparative Analysis
of Adaptation. Evolution. 51:1341–1351.</p>
<p>Hansen T.F., Pienaar J., Orzack S.H. 2008. A comparative method for
studying adaptation to a randomly evolving environment. Evolution.
62:1965–1977.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
<<<<<<< HEAD
    </nav></aside></div>
=======
    </nav></aside>
</div>
>>>>>>> dev-fixes-blouch1.0



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Mark Grabowski.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>


<<<<<<< HEAD
=======


>>>>>>> dev-fixes-blouch1.0



  </body></html>
