<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="blouch">
<title>Basic Models-Examples • blouch</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Basic Models-Examples">
<meta property="og:description" content="blouch">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">blouch</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Basic_Models-Examples.html">Basic Models-Examples</a>
    <a class="dropdown-item" href="../articles/Empirical-Example.html">Empirical Example</a>
    <a class="dropdown-item" href="../articles/Multi-optima_Models-Examples.html">Multi-optima Models-Examples</a>
    <a class="dropdown-item" href="../articles/Simulation-Example.html">Simulation Example</a>
    <a class="dropdown-item" href="../articles/Varying_Effects_Models-Examples.html">Varying Effects Models-Examples</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/mark-grabowski/blouch/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Basic Models-Examples</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mark-grabowski/blouch/blob/HEAD/vignettes/Basic_Models-Examples.Rmd" class="external-link"><code>vignettes/Basic_Models-Examples.Rmd</code></a></small>
      <div class="d-none name"><code>Basic_Models-Examples.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mark-grabowski/blouch" class="external-link">blouch</a></span><span class="op">)</span></span></code></pre></div>
<p>Here I walk you through the basic models of <em>Blouch</em>. By basic
I mean either the direct effect model, adaptive model, or model with a
combination of both types of predictors. This article is an abbreviated
versions of the Simulation Example article - most of the steps of
analysis will be the same and are not repeated here. Note that the Stan
runs are also too few iterations and use only 1 chain and 1 core.</p>
<div class="section level2">
<h2 id="direct-effect-model">Direct effect model<a class="anchor" aria-label="anchor" href="#direct-effect-model"></a>
</h2>
<p><em>Blouch</em> implements the model of constrained evolution (Hansen
&amp; Bartoszek, 2012) known as the direct effect model, previously
implemented in Grabowski et al. (2016; see also Grabowski et al. 2023),
which can be used to test for allometric constraints.</p>
</div>
<div class="section level2">
<h2 id="create-phylogeny">Create Phylogeny<a class="anchor" aria-label="anchor" href="#create-phylogeny"></a>
</h2>
<p>The <em>Blouch</em> package includes the primate phylogeny from the
10KTrees Project (Arnold et al. 2010), which is used for various
simulations and comes from <a href="https://10ktrees.nunn-lab.org/" class="external-link uri">https://10ktrees.nunn-lab.org/</a>. This is Version 3 of
their primate phylogeny with 301 tips. Here we randomly reduce the tip
number to 100 for a more manageable tree using functions from the
<em>ape</em> R package (Paradis et al. 2004)</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">########################################################################################################</span></span>
<span><span class="co">#Create phylogeny</span></span>
<span><span class="co">########################################################################################################</span></span>
<span><span class="va">N</span><span class="op">&lt;-</span><span class="fl">50</span> <span class="co">#Number of species</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="co">#Set seed to get same random species each time</span></span>
<span></span>
<span><span class="va">phy</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/drop.tip.html" class="external-link">keep.tip</a></span><span class="op">(</span><span class="va">tree.10K</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">tree.10K</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">]</span><span class="op">)</span> </span>
<span><span class="va">phy</span><span class="op">&lt;-</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/multi2di.html" class="external-link">multi2di</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span></span>
<span></span>
<span><span class="va">l.tree</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/branching.times.html" class="external-link">branching.times</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span><span class="op">)</span> <span class="co">## rescale tree to height 1</span></span>
<span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">/</span><span class="va">l.tree</span> </span>
<span></span>
<span><span class="va">tip.label</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="set-trueknown-parameter-values">Set true/known parameter values<a class="anchor" aria-label="anchor" href="#set-trueknown-parameter-values"></a>
</h2>
<p>Next we set our true/known parameter values. These are for the
half-life (hl), and stationary variance (vy), which in our simulation we
translate to <span class="math inline">\(\alpha\)</span> (a) and <span class="math inline">\(\sigma^2_y\)</span> (sigma2_y). We set the
ancestral value at the root (vX0) to 0, and the instantaneous variance
of the BM process (Sxx) to to 10.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">########################################################################################################</span></span>
<span><span class="co">#Direct Effect Model</span></span>
<span><span class="co">########################################################################################################</span></span>
<span><span class="co">#Setup parameters</span></span>
<span><span class="va">Z_direct</span><span class="op">&lt;-</span><span class="fl">1</span> <span class="co">#Number of traits</span></span>
<span><span class="va">hl</span><span class="op">&lt;-</span><span class="fl">0.1</span> <span class="co">#half life</span></span>
<span><span class="va">a</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span></span>
<span><span class="va">vy</span><span class="op">&lt;-</span><span class="fl">0.01</span> <span class="co">#0.25,0.5 - testing options</span></span>
<span><span class="va">sigma2_y</span><span class="op">&lt;-</span><span class="va">vy</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span><span class="op">)</span><span class="op">)</span>;</span>
<span></span>
<span><span class="va">vX0</span><span class="op">&lt;-</span><span class="fl">0</span> <span class="co">#value for ancestral state at the root node. </span></span>
<span><span class="va">vY0</span> <span class="op">&lt;-</span> <span class="fl">0</span> <span class="co">#value for ancestral state at the root node. </span></span>
<span></span>
<span><span class="va">Sxx</span><span class="op">&lt;-</span><span class="fl">10</span> <span class="co">#Variance of BM process</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="calculate-v-and-simulate-x-data">Calculate V and simulate X data<a class="anchor" aria-label="anchor" href="#calculate-v-and-simulate-x-data"></a>
</h2>
<p>We will use the <em>Blouch</em> helper R function calc_direct_V to
calculate the direct effect variance/covariance matrix, and the fastBM
function from phytools (Revell, 2011) to simulate the X variable
following a BM process.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">V</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/calc_direct_V.html">calc_direct_V</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">sigma2_y</span>,<span class="va">a</span><span class="op">)</span> <span class="co">#Calculate V - variance/covariance matrix</span></span>
<span><span class="va">X</span><span class="op">&lt;-</span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/fastBM.html" class="external-link">fastBM</a></span><span class="op">(</span><span class="va">phy</span>,a<span class="op">=</span><span class="va">vX0</span>,sig2<span class="op">=</span><span class="va">Sxx</span>,internal<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="co">#Simulate X BM variable on tree, with scaling 10</span></span>
<span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/phenogram.html" class="external-link">phenogram</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">X</span>,spread.labels<span class="op">=</span><span class="cn">TRUE</span>,spread.cost<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="co">#Plot X data</span></span>
<span><span class="co">#&gt; Optimizing the positions of the tip labels...</span></span></code></pre></div>
<p><img src="Basic_Models-Examples_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="simulate-y-data">Simulate Y data<a class="anchor" aria-label="anchor" href="#simulate-y-data"></a>
</h2>
<p>Next we set the intercept and slope parameters, and simulate mu
before using it and V to simulate Y. Finally we make a quick plot of the
results. We will set the intercept (alpha term) to 2 and the slope to
0.25.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">alpha</span><span class="op">&lt;-</span><span class="fl">2</span> <span class="co">#Intecept</span></span>
<span><span class="va">beta</span><span class="op">&lt;-</span><span class="fl">0.25</span> <span class="co">#Slope</span></span>
<span></span>
<span><span class="va">mu</span><span class="op">&lt;-</span><span class="va">alpha</span><span class="op">+</span><span class="va">X</span><span class="op">*</span><span class="va">beta</span> <span class="co">#Simulate mu for Y</span></span>
<span></span>
<span><span class="va">Y</span><span class="op">&lt;-</span><span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1</span>,<span class="va">mu</span>,<span class="va">V</span><span class="op">)</span> <span class="co">#Simulate direct effect Y trait</span></span>
<span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">Y</span>,X<span class="op">=</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Y"</span>,<span class="st">"X"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">X</span>,y<span class="op">=</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Basic_Models-Examples_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">X</span>,<span class="va">df</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = Y ~ X, data = df)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;       Min        1Q    Median        3Q       Max </span></span>
<span><span class="co">#&gt; -0.244026 -0.069756  0.007519  0.073226  0.211013 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept) 2.012890   0.016976  118.58   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; X           0.255071   0.004838   52.72   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 0.1067 on 48 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.983,  Adjusted R-squared:  0.9827 </span></span>
<span><span class="co">#&gt; F-statistic:  2779 on 1 and 48 DF,  p-value: &lt; 2.2e-16</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="simulating-measurement-error">Simulating measurement error<a class="anchor" aria-label="anchor" href="#simulating-measurement-error"></a>
</h2>
<p>Next we will simulate measurement error - we will use a standard
deviation of measurement error of 0.01, which we will provide to
<em>Blouch</em> as a vector (X_error and Y_error), and use the rnorm
function to add error to our X and Y variables. In other words, we are
telling <em>Blouch</em> that the estimated error on X and Y is 0.01, and
providing it with X and Y variables that are offset by a random amount
of error with this standard deviation.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">X_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Y_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Y_with_error</span><span class="op">&lt;-</span><span class="va">Y</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">X_with_error</span><span class="op">&lt;-</span><span class="va">X</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="combine-data-and-tree">Combine data and tree<a class="anchor" aria-label="anchor" href="#combine-data-and-tree"></a>
</h2>
<p>Next we will use the treeplyr package (Uyeda and Harmon, 2014)
make.treedata function to combine the data and tree based on the taxa
names. See <a href="https://github.com/uyedaj/treeplyr" class="external-link uri">https://github.com/uyedaj/treeplyr</a> for more on this
package.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Make trdata file</span></span>
<span><span class="va">trait.data</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Y_with_error</span>,<span class="va">Y_error</span>,<span class="va">X_with_error</span>,<span class="va">X_error</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu">treeplyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/treeplyr/man/make.treedata.html" class="external-link">make.treedata</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">trait.data</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data-setup-for-blouch">Data setup for <em>Blouch</em><a class="anchor" aria-label="anchor" href="#data-setup-for-blouch"></a>
</h2>
<p>We will use the helper function blouch.direct.prep to setup the dat
file for Stan. Here the name of the column in trdata$dat that contains
the response variable is “Y_with_error”, the associated error column
name is “Y_error,” the direct effect predictor column is named
“X_with_error”, and its associated errors is “X_error”. Finally, we give
the heloper function the number of predictor traits, 1 here.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Test Blouch prep code - direct effect model - blouch.direct.prep()</span></span>
<span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/blouch.direct.prep.html">blouch.direct.prep</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="st">"Y_with_error"</span>,<span class="st">"Y_error"</span>,<span class="st">"X_with_error"</span>,<span class="st">"X_error"</span>,Z_direct<span class="op">=</span><span class="va">Z_direct</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="exploring-priors">Exploring Priors<a class="anchor" aria-label="anchor" href="#exploring-priors"></a>
</h2>
<p>At this point one would want to explore if the priors are appropriate
- see Simulation Example article for one way to go about this.</p>
</div>
<div class="section level2">
<h2 id="running-models">Running models<a class="anchor" aria-label="anchor" href="#running-models"></a>
</h2>
<p>We will run the direct effect model first. Below are the priors used
for this simulation. See Grabowski (in revision) for more on setting
these priors. To change these values requires you to open the Stan
function, in this case blouchOU_direct, and manually edit them.
Unfortunately there is no way around this at present, but trust me - it
will be worth it.</p>
<p>For example, here are the four most important priors for the model
below - these values are explored in Grabowski (in revision). Remember,
always do prior predictive simulations first - in other words, look at
distributions of the values and see if they are actually biologically
possible - see the exploring priors step above.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">########################################################################################################</span></span>
<span><span class="co">#Priors</span></span>
<span><span class="co">#hl ~ lognormal(log(0.25),0.25);</span></span>
<span><span class="co">#vy ~ exponential(10);</span></span>
<span><span class="co">#alpha ~ normal(2.0,0,75);</span></span>
<span><span class="co">#beta ~ normal(0.25,1.5);</span></span></code></pre></div>
<p>And here are the lines of Stan code for setting these priors. To
change the values to make them appropriate for your own analyses, you
just need to change the numbers below. All Stan programs are in the
Blouch/inst/stan folder and named according to the model they run. See
Table S1 of Grabowski (in revision) for more on the models. Remember,
your priors should be based on what you know about the biological
processes underlying your research question and prior predictive
simulations (see McElreath 2020)</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="co">#Stan Code</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>  target <span class="sc">+</span><span class="er">=</span> <span class="fu">lognormal_lpdf</span>(hl<span class="sc">|</span><span class="fu">log</span>(<span class="fl">0.25</span>),<span class="fl">0.25</span>);</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>  target <span class="sc">+</span><span class="er">=</span> <span class="fu">exponential_lpdf</span>(vy<span class="sc">|</span><span class="dv">10</span>);</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>  target <span class="sc">+</span><span class="er">=</span> <span class="fu">normal_lpdf</span>(alpha<span class="sc">|</span><span class="fl">2.0</span>,<span class="fl">0.75</span>);</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>  target <span class="sc">+</span><span class="er">=</span> <span class="fu">normal_lpdf</span>(beta<span class="sc">|</span><span class="fl">0.25</span>,<span class="fl">1.5</span>);</span></code></pre></div>
<p>Now let’s run the direct effect model blouchOU_direct.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.direct</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_direct</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">1</span>,cores<span class="op">=</span><span class="fl">1</span>,iter <span class="op">=</span><span class="fl">400</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: The largest R-hat is NA, indicating chains have not mixed.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#r-hat</span></span>
<span><span class="co">#&gt; Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#bulk-ess</span></span>
<span><span class="co">#&gt; Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#tail-ess</span></span></code></pre></div>
<p>Now let’s look at the results</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.direct</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"alpha"</span>,<span class="st">"beta"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_direct.</span></span>
<span><span class="co">#&gt; 1 chains, each with iter=400; warmup=200; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=200, total post-warmup draws=200.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;         mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl      0.24       0 0.06 0.15 0.20 0.23 0.27  0.35   312    1</span></span>
<span><span class="co">#&gt; vy      0.02       0 0.00 0.01 0.01 0.02 0.02  0.03   303    1</span></span>
<span><span class="co">#&gt; alpha   1.99       0 0.04 1.91 1.97 1.99 2.02  2.08   460    1</span></span>
<span><span class="co">#&gt; beta[1] 0.26       0 0.01 0.24 0.25 0.26 0.26  0.27   460    1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Sun Sep 24 19:00:42 2023.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="co">#plot(rethinking::precis(fit.direct,depth=3,pars = c("hl","vy","alpha","beta"))) #For use with rethinking package</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.direct</span><span class="op">)</span> <span class="co">#Extract posterior distribution</span></span></code></pre></div>
<p>From there the posteriors should be explored, compared to the priors,
etc. See the Simulation Example for one example of how to do this.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="adaptive-model">Adaptive Model<a class="anchor" aria-label="anchor" href="#adaptive-model"></a>
</h2>
<p><em>Blouch</em> also implements the model of adaptive evolution
introduced by Hansen et al. (2008). Here the response variable evolves
according to an Ornstein-Uhlenbeck process towards an optimal state that
is modeled as a function of the predictor variable. Most of these steps
below are similar to those above for the direct effect model so I will
not go into them fully.</p>
<p>Again, we will create a phylogeny by randomly sampling from the 10K
Trees phylogeny.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">########################################################################################################</span></span>
<span><span class="co">#Create phylogeny</span></span>
<span><span class="co">########################################################################################################</span></span>
<span><span class="va">N</span><span class="op">&lt;-</span><span class="fl">50</span> <span class="co">#Number of species</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="co">#Set seed to get same random species each time</span></span>
<span></span>
<span><span class="va">phy</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/drop.tip.html" class="external-link">keep.tip</a></span><span class="op">(</span><span class="va">tree.10K</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">tree.10K</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">]</span><span class="op">)</span> </span>
<span><span class="va">phy</span><span class="op">&lt;-</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/multi2di.html" class="external-link">multi2di</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span></span>
<span></span>
<span><span class="va">l.tree</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/branching.times.html" class="external-link">branching.times</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span><span class="op">)</span> <span class="co">## rescale tree to height 1</span></span>
<span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">/</span><span class="va">l.tree</span> </span>
<span></span>
<span><span class="va">tip.label</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="set-trueknown-parameter-values-1">Set true/known parameter values<a class="anchor" aria-label="anchor" href="#set-trueknown-parameter-values-1"></a>
</h2>
<p>First we will simulate X and Y data using a generative model for the
adaptive model.</p>
<p>We will set our true/known parameter values. These are for the
half-life (hl), and stationary variance (vy), which in our simulation we
translate to <span class="math inline">\(\alpha\)</span> (a) and <span class="math inline">\(\sigma^2_y\)</span> (sigma2_y). We set the
ancestral value at the root (vX0) to 0, and the instantaneous variance
of the BM process (Sxx) to to 10.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">########################################################################################################</span></span>
<span><span class="co">#Adaptive Model</span></span>
<span><span class="co">########################################################################################################</span></span>
<span><span class="co">#Setup parameters</span></span>
<span><span class="va">Z_adaptive</span><span class="op">&lt;-</span><span class="fl">1</span> <span class="co">#Number of traits</span></span>
<span><span class="va">hl</span><span class="op">&lt;-</span><span class="fl">0.1</span></span>
<span><span class="va">a</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span></span>
<span><span class="va">vy</span><span class="op">&lt;-</span><span class="fl">0.1</span> <span class="co">#0.25,0.5 - testing options</span></span>
<span><span class="va">sigma2_y</span><span class="op">&lt;-</span><span class="va">vy</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span><span class="op">)</span><span class="op">)</span>;</span>
<span><span class="va">vX0</span><span class="op">&lt;-</span><span class="fl">0</span> <span class="co">#value for ancestral state at the root node. </span></span>
<span><span class="va">vY0</span><span class="op">&lt;-</span><span class="fl">0</span><span class="co">#value for ancestral state at the root node.</span></span></code></pre></div>
<p>We will use the the fastBM function from phytools (Revell, 2011) to
simulate the X variable following a BM process. Because this is a
simulation we are setting the instantaneous variance of the BM process
(sigma2_x) to 1, which needs to be in matrix format. Normally
<em>Blouch</em> estimates this as part of the blouch.adapt.prep helper
function.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sigma2_x</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span> <span class="co">#Variance of BM Process</span></span>
<span><span class="va">X</span><span class="op">&lt;-</span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/fastBM.html" class="external-link">fastBM</a></span><span class="op">(</span><span class="va">phy</span>,a<span class="op">=</span><span class="va">vX0</span>,sig2<span class="op">=</span><span class="va">sigma2_x</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>,internal<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="co">#Simulate X BM variable on tree, with scaling 10</span></span>
<span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/phenogram.html" class="external-link">phenogram</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">X</span>,spread.labels<span class="op">=</span><span class="cn">TRUE</span>,spread.cost<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="co">#Plot X data</span></span>
<span><span class="co">#&gt; Optimizing the positions of the tip labels...</span></span></code></pre></div>
<p><img src="Basic_Models-Examples_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="calculate-v-and-simulate-y-data">Calculate V and simulate Y data<a class="anchor" aria-label="anchor" href="#calculate-v-and-simulate-y-data"></a>
</h2>
<p>We will set the intercept (alpha) to 2 and the slope to 0.25. We will
use the <em>Blouch</em> helper functions calc_adaptive_dmX to calculate
the design matrix and calc_adaptive_V to calculate the
variance/covariance matrix.</p>
<p>Then we will simulate mu before using it and V to simulate Y. Finally
we make a quick plot of the results.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">alpha</span><span class="op">&lt;-</span><span class="fl">2</span> <span class="co">#Intecept</span></span>
<span><span class="va">beta</span><span class="op">&lt;-</span><span class="fl">0.25</span> <span class="co">#Slope</span></span>
<span></span>
<span><span class="va">dmX</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/calc_adaptive_dmX.html">calc_adaptive_dmX</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">a</span>,<span class="va">X</span><span class="op">)</span> <span class="co">#Calculate the design matrix</span></span>
<span><span class="va">V</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/calc_adaptive_V.html">calc_adaptive_V</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">a</span>, <span class="va">sigma2_y</span>, <span class="va">beta</span>,  <span class="va">sigma2_x</span>, <span class="va">Z_adaptive</span><span class="op">)</span> <span class="co">#Calculate adaptive variance/covariance matrix</span></span>
<span></span>
<span><span class="va">mu</span><span class="op">&lt;-</span><span class="va">alpha</span><span class="op">+</span><span class="va">dmX</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">beta</span> <span class="co">#Simulate mu for Y</span></span>
<span><span class="va">Y</span><span class="op">&lt;-</span><span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1</span>,<span class="va">mu</span>,<span class="va">V</span><span class="op">)</span> <span class="co">#Simulate adaptive model Y trait</span></span>
<span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">Y</span>,X<span class="op">=</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Y"</span>,<span class="st">"X"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">X</span>,y<span class="op">=</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Basic_Models-Examples_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">X</span>,<span class="va">df</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = Y ~ X, data = df)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co">#&gt; -0.77740 -0.27795 -0.00472  0.26880  0.79108 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  1.91334    0.05316  35.993  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; X            0.17356    0.04791   3.623 0.000702 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 0.334 on 48 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.2147, Adjusted R-squared:  0.1983 </span></span>
<span><span class="co">#&gt; F-statistic: 13.12 on 1 and 48 DF,  p-value: 0.0007023</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="simulating-measurement-error-1">Simulating measurement error<a class="anchor" aria-label="anchor" href="#simulating-measurement-error-1"></a>
</h2>
<p>Next we will simulate measurement error - we will use a standard
deviation of measurement error of 0.01, which we will provide to
<em>Blouch</em> as a vector (X_error and Y_error), and use the rnorm
function to add error to our X and Y variables. In other words, we are
telling <em>Blouch</em> that the estimated error on X and Y is 0.01, and
providing it with X and Y variables that are offset by a random amount
of error with this standard deviation.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">########################################################################################################</span></span>
<span><span class="co">#Simulate errors</span></span>
<span><span class="va">X_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Y_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Y_with_error</span><span class="op">&lt;-</span><span class="va">Y</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">X_with_error</span><span class="op">&lt;-</span><span class="va">X</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data-setup-for-blouch-1">Data setup for <em>Blouch</em><a class="anchor" aria-label="anchor" href="#data-setup-for-blouch-1"></a>
</h2>
<p>Next we will use the treeplyr package (Uyeda and Harmon, 2014)
make.treedata function to combine the data and tree based on the taxa
names. See <a href="https://github.com/uyedaj/treeplyr" class="external-link uri">https://github.com/uyedaj/treeplyr</a> for more on this
package.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Make trdata file</span></span>
<span><span class="va">trait.data</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Y_with_error</span>,<span class="va">Y_error</span>,<span class="va">X_with_error</span>,<span class="va">X_error</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu">treeplyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/treeplyr/man/make.treedata.html" class="external-link">make.treedata</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">trait.data</span><span class="op">)</span></span>
<span></span>
<span><span class="co">############################################################################################################</span></span></code></pre></div>
<p>We will use the helper function blouch.adapt.prep() to setup the dat
file for Stan. Here the name of the column in trdata$dat that contains
the response variable is “Y_with_error”, the associated error column
name is “Y_error,” the direct effect predictor column is named
“X_with_error”, and its associated errors is “X_error”. Finally, we give
the helper function the number of predictor traits, 1 here.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Test Blouch prep code - adaptive model</span></span>
<span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/blouch.adapt.prep.html">blouch.adapt.prep</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="st">"Y_with_error"</span>,<span class="st">"Y_error"</span>,<span class="st">"X_with_error"</span>,<span class="st">"X_error"</span>,Z_adaptive<span class="op">=</span><span class="va">Z_adaptive</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="exploring-priors-1">Exploring Priors<a class="anchor" aria-label="anchor" href="#exploring-priors-1"></a>
</h2>
<p>At this point one would want to explore if the priors are appropriate
- see Simulation Example article for one way to go about this.</p>
</div>
<div class="section level2">
<h2 id="running-models-1">Running models<a class="anchor" aria-label="anchor" href="#running-models-1"></a>
</h2>
<p>Below are the priors used for this simulation. See Grabowski (in
revision) for more on setting these priors. To change these values
requires you to open the Stan function, in this case blouchOU_direct,
and manually edit them. Unfortunately there is no way around this at
present, but trust me - it will be worth it.</p>
<p>For example, here are the four most important priors for the model
below - these values are explored in Grabowski (in revision). Remember,
always do prior predictive simulations first - in other words, look at
distributions of the values and see if they are actually biologically
possible - see the exploring priors step above.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">########################################################################################################</span></span>
<span><span class="co">#Priors</span></span>
<span><span class="co">#hl ~ lognormal(log(0.25),0.25);</span></span>
<span><span class="co">#vy ~ exponential(5);</span></span>
<span><span class="co">#alpha ~ normal(2.0,0,2);</span></span>
<span><span class="co">#beta ~ normal(0.25,0.1); </span></span></code></pre></div>
<p>And here are the lines of Stan code for setting these priors. To
change the values to make them appropriate for your own analyses, you
just need to change the numbers below. All Stan programs are in the
Blouch/inst/stan folder and named according to the model they run. See
Table S1 of Grabowski (in revision) for more on the models. Remember,
your priors should be based on what you know about the biological
processes underlying your research question and prior predictive
simulations (see McElreath 2020).</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="co">#Stan Code</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>  target <span class="sc">+</span><span class="er">=</span> <span class="fu">lognormal_lpdf</span>(hl<span class="sc">|</span><span class="fu">log</span>(<span class="fl">0.25</span>),<span class="fl">0.25</span>);</span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a>  target <span class="sc">+</span><span class="er">=</span> <span class="fu">exponential_lpdf</span>(vy<span class="sc">|</span><span class="dv">5</span>);</span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a>  target <span class="sc">+</span><span class="er">=</span> <span class="fu">normal_lpdf</span>(alpha<span class="sc">|</span><span class="dv">2</span>,<span class="fl">0.2</span>);</span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a>  target <span class="sc">+</span><span class="er">=</span> <span class="fu">normal_lpdf</span>(beta<span class="sc">|</span><span class="fl">0.25</span>,<span class="fl">0.1</span>);</span></code></pre></div>
<p>Now let’s run the adaptive model blouchOU_adapt</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.adapt</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_adapt</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">1</span>,cores<span class="op">=</span><span class="fl">1</span>,iter <span class="op">=</span><span class="fl">400</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: The largest R-hat is NA, indicating chains have not mixed.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#r-hat</span></span>
<span><span class="co">#&gt; Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#bulk-ess</span></span>
<span><span class="co">#&gt; Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#tail-ess</span></span></code></pre></div>
<p>Here the results include both the optimal regression, beta, and the
evolutionary regression, beta_e, following Hansen et al. (2008)</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.adapt</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"alpha"</span>,<span class="st">"beta"</span>,<span class="st">"beta_e"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_adapt.</span></span>
<span><span class="co">#&gt; 1 chains, each with iter=400; warmup=200; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=200, total post-warmup draws=200.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl        0.22    0.00 0.05 0.14 0.18 0.21 0.24  0.33   100 1.01</span></span>
<span><span class="co">#&gt; vy        0.17    0.00 0.04 0.11 0.15 0.17 0.20  0.27   169 1.00</span></span>
<span><span class="co">#&gt; alpha     1.97    0.01 0.10 1.80 1.90 1.98 2.04  2.16    56 1.01</span></span>
<span><span class="co">#&gt; beta[1]   0.18    0.02 0.08 0.05 0.12 0.16 0.23  0.35    16 1.00</span></span>
<span><span class="co">#&gt; beta_e[1] 0.12    0.01 0.06 0.03 0.08 0.11 0.16  0.27    17 1.00</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Sun Sep 24 19:00:55 2023.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="co">#plot(rethinking::precis(fit.adapt,depth=2,pars = c("hl","vy","alpha","beta")))</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.adapt</span><span class="op">)</span></span></code></pre></div>
<p>From there the posteriors should be explored, compared to the priors,
etc. See the Simulation Example for one example of how to do this.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="direct-effect-and-adaptive-models">Direct effect and adaptive models<a class="anchor" aria-label="anchor" href="#direct-effect-and-adaptive-models"></a>
</h2>
<p>Finally, we can look at models that are a combination of direct
effect and adaptive traits. Setup is similar to above except here we
have two predictors.</p>
<p>First we will create a phylogeny by randomly sampling from the 10K
Trees phylogeny</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">########################################################################################################</span></span>
<span><span class="co">#Create phylogeny</span></span>
<span><span class="co">########################################################################################################</span></span>
<span><span class="va">N</span><span class="op">&lt;-</span><span class="fl">50</span> <span class="co">#Number of species</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="co">#Set seed to get same random species each time</span></span>
<span></span>
<span><span class="va">phy</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/drop.tip.html" class="external-link">keep.tip</a></span><span class="op">(</span><span class="va">tree.10K</span>,<span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">tree.10K</span><span class="op">$</span><span class="va">tip.label</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">]</span><span class="op">)</span> </span>
<span><span class="va">phy</span><span class="op">&lt;-</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/multi2di.html" class="external-link">multi2di</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span></span>
<span></span>
<span><span class="va">l.tree</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/branching.times.html" class="external-link">branching.times</a></span><span class="op">(</span><span class="va">phy</span><span class="op">)</span><span class="op">)</span> <span class="co">## rescale tree to height 1</span></span>
<span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">edge.length</span><span class="op">/</span><span class="va">l.tree</span> </span>
<span></span>
<span><span class="va">tip.label</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="set-trueknown-parameter-values-2">Set true/known parameter values<a class="anchor" aria-label="anchor" href="#set-trueknown-parameter-values-2"></a>
</h2>
<p>We will simulate X and Y data using a generative model for the direct
effect and adaptive model. Here we will have 1 direct effect trait, Xd,
and one adaptive trait, Xa. An object Z always refers to the number of
traits, in this case Z_direct = number of direct effect traits, and
Z_adaptive = number of adaptive traits. Because this is a simulation we
are setting the instantaneous variance of the BM process (sigma2_x) to
1, which needs to be in matrix format. Normally <em>Blouch</em>
estimates this as part of the blouch.direct.adapt.prep helper
function.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Direct effect + Adaptive Model</span></span>
<span><span class="co">############################################################################################################</span></span>
<span><span class="va">hl</span><span class="op">&lt;-</span><span class="fl">0.1</span> <span class="co">#0.1, 0.25, 0.75 - testing options</span></span>
<span><span class="va">a</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span></span>
<span><span class="va">vy</span><span class="op">&lt;-</span><span class="fl">0.01</span> <span class="co">#0.25,0.5 - testing options</span></span>
<span><span class="va">sigma2_y</span><span class="op">&lt;-</span><span class="va">vy</span><span class="op">*</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">/</span><span class="va">hl</span><span class="op">)</span><span class="op">)</span>;</span>
<span></span>
<span><span class="va">vX0</span><span class="op">&lt;-</span><span class="fl">0</span></span>
<span><span class="va">vY0</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span><span class="va">Z_direct</span><span class="op">&lt;-</span><span class="fl">1</span></span>
<span><span class="va">Z_adaptive</span><span class="op">&lt;-</span><span class="fl">1</span></span>
<span><span class="va">Z</span><span class="op">&lt;-</span><span class="va">Z_direct</span><span class="op">+</span><span class="va">Z_adaptive</span></span>
<span><span class="va">sigma2_x</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span> <span class="co">#Variance of BM Process</span></span></code></pre></div>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Xd</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">Xd</span><span class="op">)</span><span class="op">&lt;-</span><span class="va">phy</span><span class="op">$</span><span class="va">tip.label</span></span>
<span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/phenogram.html" class="external-link">phenogram</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">Xd</span>,spread.labels<span class="op">=</span><span class="cn">TRUE</span>,spread.cost<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="co">#Plot X data</span></span>
<span><span class="co">#&gt; Optimizing the positions of the tip labels...</span></span></code></pre></div>
<p><img src="Basic_Models-Examples_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Xa</span><span class="op">&lt;-</span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/fastBM.html" class="external-link">fastBM</a></span><span class="op">(</span><span class="va">phy</span>,a<span class="op">=</span><span class="va">vX0</span>,sig2<span class="op">=</span><span class="va">sigma2_x</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>,internal<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="co">#Simulate X BM variable on tree, with scaling 10</span></span>
<span><span class="fu">phytools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/phenogram.html" class="external-link">phenogram</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">Xa</span>,spread.labels<span class="op">=</span><span class="cn">TRUE</span>,spread.cost<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="co">#Plot X data</span></span>
<span><span class="co">#&gt; Optimizing the positions of the tip labels...</span></span></code></pre></div>
<p><img src="Basic_Models-Examples_files/figure-html/unnamed-chunk-19-2.png" width="700"></p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#sigma2_x&lt;-ratematrix(phy,Xa) #Calculate evolutionary v/cv matrix</span></span>
<span><span class="va">Xs</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Xd</span>,<span class="va">Xa</span><span class="op">)</span></span></code></pre></div>
<p>We will have one intercept term here, but two slopes - the order in
<em>Blouch</em> is always direct effect predictors first, followed by
adaptive predictors. Thus the direct effect slope will be 0.35 and the
adaptive slope will be 0.25. Except for the <em>Blouch</em> helper
function calc_mixed_dmX, which is used when there are mixed design
matrices, the other functions are the same as the adaptive model above.
One complication is the beta term below in the calc_adaptive_V function
call - we are sending this function only the adaptive slope and the line
beta[(Z_direct+1):(Z_adaptive+Z_direct)] is one way of specifying only
that term.</p>
<p>Finally we make a quick plot of the results.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">alpha</span><span class="op">&lt;-</span><span class="fl">2</span> <span class="co">#Intecept</span></span>
<span><span class="va">beta</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.35</span>,<span class="fl">0.25</span><span class="op">)</span> <span class="co">#Slopes</span></span>
<span><span class="va">dmX</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/calc_mixed_dmX.html">calc_mixed_dmX</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">a</span>,<span class="va">Xs</span>,<span class="va">Z_direct</span>,<span class="va">Z_adaptive</span><span class="op">)</span></span>
<span><span class="va">mu</span><span class="op">&lt;-</span><span class="va">alpha</span><span class="op">+</span><span class="va">dmX</span><span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span><span class="va">beta</span> <span class="co">#Simulate mu for Y</span></span>
<span></span>
<span><span class="va">V</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/calc_adaptive_V.html">calc_adaptive_V</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">a</span>, <span class="va">sigma2_y</span>, <span class="va">beta</span><span class="op">[</span><span class="op">(</span><span class="va">Z_direct</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">Z_adaptive</span><span class="op">+</span><span class="va">Z_direct</span><span class="op">)</span><span class="op">]</span>,  <span class="va">sigma2_x</span><span class="op">)</span></span>
<span><span class="va">Y</span><span class="op">&lt;-</span><span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/mvrnorm.html" class="external-link">mvrnorm</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">1</span>,<span class="va">mu</span>,<span class="va">V</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Y<span class="op">=</span><span class="va">Y</span>,X<span class="op">=</span><span class="va">Xs</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">Xs</span>,<span class="va">df</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = Y ~ Xs, data = df)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;       Min        1Q    Median        3Q       Max </span></span>
<span><span class="co">#&gt; -0.226807 -0.077535 -0.000499  0.055419  0.189201 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  1.98088    0.01400  141.51   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; XsXd         0.34453    0.01026   33.58   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; XsXa         0.23978    0.01598   15.00   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 0.09835 on 47 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.9686, Adjusted R-squared:  0.9672 </span></span>
<span><span class="co">#&gt; F-statistic:   724 on 2 and 47 DF,  p-value: &lt; 2.2e-16</span></span>
<span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">X.Xd</span>,y<span class="op">=</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Basic_Models-Examples_files/figure-html/unnamed-chunk-20-1.png" width="700"></p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">X.Xd</span>,<span class="va">df</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = Y ~ X.Xd, data = df)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co">#&gt; -0.56393 -0.12628  0.00925  0.17768  0.45689 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  1.99274    0.03327   59.90   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; X.Xd         0.35755    0.02434   14.69   &lt;2e-16 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 0.2341 on 48 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.8181, Adjusted R-squared:  0.8143 </span></span>
<span><span class="co">#&gt; F-statistic: 215.8 on 1 and 48 DF,  p-value: &lt; 2.2e-16</span></span>
<span></span>
<span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">df</span>,<span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">X.Xa</span>,y<span class="op">=</span><span class="va">Y</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Basic_Models-Examples_files/figure-html/unnamed-chunk-20-2.png" width="700"></p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y</span><span class="op">~</span><span class="va">X.Xa</span>,<span class="va">df</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; lm(formula = Y ~ X.Xa, data = df)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;      Min       1Q   Median       3Q      Max </span></span>
<span><span class="co">#&gt; -0.96493 -0.30501 -0.07747  0.24245  1.26987 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Coefficients:</span></span>
<span><span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">#&gt; (Intercept)  2.02455    0.06894   29.36  &lt; 2e-16 ***</span></span>
<span><span class="co">#&gt; X.Xa         0.28516    0.07879    3.62 0.000709 ***</span></span>
<span><span class="co">#&gt; ---</span></span>
<span><span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residual standard error: 0.4865 on 48 degrees of freedom</span></span>
<span><span class="co">#&gt; Multiple R-squared:  0.2144, Adjusted R-squared:  0.198 </span></span>
<span><span class="co">#&gt; F-statistic:  13.1 on 1 and 48 DF,  p-value: 0.0007088</span></span></code></pre></div>
<p>Next we will simulate measurement error - we will use a standard
deviation of measurement error of 0.01, which we will provide to
<em>Blouch</em> as a vector (X_error and Y_error), and use the rnorm
function to add error to our X and Y variables. In other words, we are
telling <em>Blouch</em> that the estimated error on X and Y is 0.01, and
providing it with X and Y variables that are offset by a random amount
of error with this standard deviation. The complication here is we are
simulating error in more than one trait - both an adaptive and direct
effect trait - the extra lines of code below do this.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">########################################################################################################</span></span>
<span><span class="co">#Simulate errors - for use with blouchOU_reg_direct_adaptive_ME</span></span>
<span><span class="va">Z_X_error</span><span class="op">&lt;-</span><span class="fl">2</span> <span class="co">#Number of X traits with error</span></span>
<span><span class="va">X_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0.01</span>,nrow<span class="op">=</span><span class="va">N</span>,ncol<span class="op">=</span><span class="va">Z_X_error</span><span class="op">)</span></span>
<span><span class="va">X_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">X_error</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">X_error</span><span class="op">)</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Xd_error"</span>,<span class="st">"Xa_error"</span><span class="op">)</span></span>
<span><span class="va">Y_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.01</span>,<span class="va">N</span><span class="op">)</span></span>
<span><span class="va">Y_with_error</span><span class="op">&lt;-</span><span class="va">Y</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">X_with_error</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">Xs</span>,<span class="fl">2</span>,<span class="kw">function</span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">{</span><span class="va">X</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>,<span class="fl">0</span>,<span class="fl">0.01</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data-setup-for-blouch-2">Data setup for <em>Blouch</em><a class="anchor" aria-label="anchor" href="#data-setup-for-blouch-2"></a>
</h2>
<p>Next we will use the treeplyr package (Uyeda and Harmon, 2014)
make.treedata function to combine the data and tree based on the taxa
names. See <a href="https://github.com/uyedaj/treeplyr" class="external-link uri">https://github.com/uyedaj/treeplyr</a> for more on this
package.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Make trdata file</span></span>
<span><span class="co">#trdata&lt;-make.treedata(phy,trait.data)</span></span>
<span><span class="va">trait.data</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">Y_with_error</span>,<span class="va">Y_error</span>,<span class="va">X_with_error</span>,<span class="va">X_error</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">trdata</span><span class="op">&lt;-</span><span class="fu">treeplyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/treeplyr/man/make.treedata.html" class="external-link">make.treedata</a></span><span class="op">(</span><span class="va">phy</span>,<span class="va">trait.data</span><span class="op">)</span></span></code></pre></div>
<p>We will use the helper function blouch.direct.adapt.prep to setup the
dat file for Stan. Here the names of the direct effect and adaptive
columns are Xd, and Xa and their associated errors, with Z_direct and
Z_adaptive the number of direct effect and adaptive traits,
respectively.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">############################################################################################################</span></span>
<span><span class="co">#Test Blouch prep code - Direct effect + Adaptive Model</span></span>
<span><span class="va">dat</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/blouch.direct.adapt.prep.html">blouch.direct.adapt.prep</a></span><span class="op">(</span><span class="va">trdata</span>,<span class="st">"Y_with_error"</span>,<span class="st">"Y_error"</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Xd"</span>,<span class="st">"Xa"</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Xd_error"</span>,<span class="st">"Xa_error"</span><span class="op">)</span>,Z_direct<span class="op">=</span><span class="fl">1</span>,Z_adaptive<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>Priors are set as above, and the blouchOU_direct_adapt model is run
here.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit.direct.adapt</span><span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">sampling</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu">blouch</span><span class="fu">:::</span><span class="va">stanmodels</span><span class="op">$</span><span class="va">blouchOU_direct_adapt</span>,data <span class="op">=</span> <span class="va">dat</span>,chains <span class="op">=</span> <span class="fl">1</span>, cores<span class="op">=</span><span class="fl">1</span>,iter <span class="op">=</span><span class="fl">400</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: The largest R-hat is NA, indicating chains have not mixed.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#r-hat</span></span>
<span><span class="co">#&gt; Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#bulk-ess</span></span>
<span><span class="co">#&gt; Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.</span></span>
<span><span class="co">#&gt; Running the chains for more iterations may help. See</span></span>
<span><span class="co">#&gt; https://mc-stan.org/misc/warnings.html#tail-ess</span></span></code></pre></div>
<p>Here the results include, in order, the direct effect regression, the
optimal regression, and finally beta_e, the evolutionary regression,
following Hansen et al. (2008)</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit.direct.adapt</span>,pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hl"</span>,<span class="st">"vy"</span>,<span class="st">"alpha"</span>,<span class="st">"beta"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Inference for Stan model: blouchOU_direct_adapt.</span></span>
<span><span class="co">#&gt; 1 chains, each with iter=400; warmup=200; thin=1; </span></span>
<span><span class="co">#&gt; post-warmup draws per chain=200, total post-warmup draws=200.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;         mean se_mean   sd 2.5%  25%  50%  75% 97.5% n_eff Rhat</span></span>
<span><span class="co">#&gt; hl      0.22       0 0.05 0.14 0.18 0.22 0.25  0.34   279 1.00</span></span>
<span><span class="co">#&gt; vy      0.01       0 0.00 0.00 0.00 0.01 0.01  0.02   141 1.00</span></span>
<span><span class="co">#&gt; alpha   1.99       0 0.04 1.92 1.96 1.99 2.01  2.06   179 1.00</span></span>
<span><span class="co">#&gt; beta[1] 0.34       0 0.01 0.33 0.34 0.34 0.35  0.36   287 1.00</span></span>
<span><span class="co">#&gt; beta[2] 0.34       0 0.04 0.27 0.31 0.34 0.36  0.42    84 1.01</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Samples were drawn using NUTS(diag_e) at Sun Sep 24 19:01:12 2023.</span></span>
<span><span class="co">#&gt; For each parameter, n_eff is a crude measure of effective sample size,</span></span>
<span><span class="co">#&gt; and Rhat is the potential scale reduction factor on split chains (at </span></span>
<span><span class="co">#&gt; convergence, Rhat=1).</span></span>
<span><span class="co">#plot(rethinking::precis(fit.direct.adapt,depth=2,pars = c("hl","vy","alpha","beta")))</span></span>
<span><span class="va">post</span><span class="op">&lt;-</span><span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">fit.direct.adapt</span><span class="op">)</span></span></code></pre></div>
<p>From there the posteriors should be explored, compared to the priors,
etc. See the Simulation Example for one example of how to do this.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Grabowski M., Voje K.L., Hansen T.F. 2016. Evolutionary modeling and
correcting for observation error support a 3/5 brain-body allometry for
primates. J. Hum. Evol. 94:106–116.</p>
<p>Grabowski M., Kopperud B.T., Tsuboi M., Hansen T.F. 2023. Both Diet
and Sociality Affect Primate Brain-Size Evolution. Systematic
Biology.:syac075.</p>
<p>Hansen T.F., Bartoszek K. 2012. Interpreting the evolutionary
regression: the interplay between observational and biological errors in
phylogenetic comparative studies. Syst Biol. 61:413–425.</p>
<p>McElreath R. 2020. Statistical rethinking: A Bayesian course with
examples in R and Stan. CRC press.</p>
<p>Revell L.J. 2011. phytools: an R package for phylogenetic comparative
biology (and other things). Methods Ecol. Evol. 3:217–223.</p>
<p>Uyeda J.C., Harmon L.J. 2014. A Novel Bayesian Method for Inferring
and Interpreting the Dynamics of Adaptive Landscapes from Phylogenetic
Comparative Data. Systematic Biology. 63:902–918.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Mark Grabowski.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.9000.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
